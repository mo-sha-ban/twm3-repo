<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>لوحة الإدارة - روابط Udemy</title>
<link rel="stylesheet" href="css/normalize.css">
<link rel="stylesheet" href="css/style.css">
<style>
  body{font-family: 'Marhey', Arial, sans-serif;background:#f3f4f6;padding:28px}
  .admin-shell{max-width:980px;margin:0 auto;background:#ffffff;border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(2,6,23,0.08)}
  h1{margin:0 0 12px;font-size:20px}
  .course-row{display:flex;gap:8px;align-items:center;padding:10px;border-radius:10px;border:1px solid #eef2ff;margin-bottom:8px}
  .course-meta{flex:1}
  .course-title{font-weight:700}
  .course-desc{font-size:13px;color:#6b7280}
  input.udemy-input{width:320px;padding:8px 10px;border-radius:8px;border:1px solid #d1d5db}
  button.save-btn{padding:8px 12px;border-radius:8px;border:none;background:#4f46e5;color:white;font-weight:700;cursor:pointer}
  button.save-btn[disabled]{opacity:0.5;cursor:default}
  .small{font-size:12px;color:#6b7280}
  .status{font-size:12px;margin-left:8px}
</style>
</head>
<body>
  <div class="admin-shell">
    <h1>إدارة روابط Udemy للكورسات</h1>
    <p class="small">أدخل رابط Udemy لكل كورس. سيحاول النظام تحديث الـ API أولاً، وإن لم يُسمح سوف يُخزن الرابط محلياً في المتصفح (localStorage).</p>
    <div id="list"></div>
    <div style="margin-top:14px;color:#374151;font-size:13px">ملاحظة: التغييرات المحلية تظهر فقط على جهازك حتى تدعم الـ backend تعديل الحقول.</div>
  </div>

<script>
(async function(){
  const listEl = document.getElementById('list');
  const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:5000/api' : '/api';

  function loadLocalMap(){
    try{ return JSON.parse(localStorage.getItem('courseUdemyLinks')||'{}'); }catch(e){return {}}
  }
  function saveLocalMap(map){ localStorage.setItem('courseUdemyLinks', JSON.stringify(map)); }

  async function fetchCourses(){
    try{
      const res = await fetch(API_BASE + '/courses');
      if (!res.ok) throw new Error('API fetch failed');
      const data = await res.json();
      return Array.isArray(data)? data : (data.courses||[]);
    }catch(e){
      // fallback: try to load local static file
      try{
        const res2 = await fetch('courses.json');
        if (!res2.ok) throw e;
        const data2 = await res2.json();
        return data2;
      }catch(_){
        console.error('Failed to load courses', e);
        return [];
      }
    }
  }

  function createRow(course, localMap){
    const row = document.createElement('div');
    row.className = 'course-row';

    const meta = document.createElement('div');
    meta.className = 'course-meta';
    meta.innerHTML = `<div class="course-title">${escapeHtml(course.title||'بدون عنوان')} <span class="small">(ID: ${escapeHtml(String(course.id||course._id||''))})</span></div>
                      <div class="course-desc">${escapeHtml(course.description||'')}</div>`;

    const input = document.createElement('input');
    input.className = 'udemy-input';
    input.placeholder = 'https://www.udemy.com/...' ;

    // prefer server value then JSON then localMap
    const serverVal = course.udemyLink || course.udemylink || course.udemy || '';
    const localVal = localMap[String(course.id||course._id||'')] || '';
    input.value = serverVal || localVal || '';

    const saveBtn = document.createElement('button');
    saveBtn.className = 'save-btn';
    saveBtn.textContent = 'حفظ';

    const status = document.createElement('span');
    status.className = 'status small';

    saveBtn.addEventListener('click', async ()=>{
      const url = input.value.trim();
      saveBtn.disabled = true; status.textContent = 'جارٍ الحفظ...';

      // Attempt API PATCH
      let patched = false;
      try{
        const token = localStorage.getItem('token') || '';
        const cid = course.id||course._id||'';
        if (cid){
          const res = await fetch(API_BASE + '/courses/' + encodeURIComponent(cid), {
            method: 'PATCH',
            headers: { 'Content-Type':'application/json', 'Authorization': token? 'Bearer '+token : '' },
            body: JSON.stringify({ udemyLink: url })
          });
          if (res.ok) {
            patched = true;
            status.textContent = 'تم الحفظ في الخادم';
            // also update local map to keep consistency
            const map = loadLocalMap(); map[String(cid)] = url; saveLocalMap(map);
            // Refresh the courses list to show updated data
            setTimeout(() => fetchCourses(), 500);
          } else {
            const err = await res.text().catch(()=>res.statusText||'خطأ');
            console.warn('Patch failed', err);
          }
        }
      }catch(err){
        console.warn('API patch error', err);
      }

      if (!patched){
        // Save locally
        const map = loadLocalMap();
        const cid = course.id||course._id||'';
        if (!cid){ status.textContent = 'لا يوجد معرف للكورس؛ الحفظ موضعي فقط'; }
        else { map[String(cid)] = url; saveLocalMap(map); status.textContent = 'تم الحفظ محلياً'; }
      }

      setTimeout(()=>{ saveBtn.disabled = false; }, 700);
    });

    row.appendChild(meta);
    row.appendChild(input);
    row.appendChild(saveBtn);
    row.appendChild(status);
    return row;
  }

  function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // render list
  const courses = await fetchCourses();
  const localMap = loadLocalMap();
  if (!courses.length){ listEl.innerHTML = '<div class="small">لم يتم العثور على كورسات.</div>'; return; }
  courses.forEach(c=> listEl.appendChild(createRow(c, localMap)));

})();
</script>
</body>
</html>