<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
   <script>
      // Ù…Ù†Ø¹ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
      (function () {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) {
          window.location.replace("alert.html");
        }
      })();
   </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://www.youtube.com https://www.youtube-nocookie.com https://cdn.plyr.io https://cdnjs.cloudflare.com https://www.google.com https://apis.google.com https://ssl.gstatic.com https://www.gstatic.com https://*.youtube.com https://*.gstatic.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.plyr.io https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; frame-src 'self' https://www.youtube.com https://www.youtube-nocookie.com https://www.google.com; connect-src 'self' https: http:;">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/courses-carousel.css">
    <link rel="stylesheet" href="css/course-page-modern.css">
    <!-- <link rel="stylesheet" href="css/all.min.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Marhey:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="img/loogo.png">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <title>Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ±Ø³</title>
    <style>
      :root {
        --cp-bg: #e5e7eb;
        --cp-glass-bg: rgba(255, 255, 255, 0.70);
        --cp-glass-bg-soft: rgba(255, 255, 255, 0.58);
        --cp-glass-border: rgba(148, 163, 184, 0.55);
        --cp-glass-shadow: 0 28px 70px rgba(15, 23, 42, 0.22);
        --cp-surface: rgba(255, 255, 255, 0.90);
        --cp-surface-soft: rgba(255, 255, 255, 0.80);
        --cp-border-subtle: rgba(148, 163, 184, 0.25);
        --cp-text-main: #020617;
        --cp-text-muted: #6b7280;
        --cp-primary: #2563eb;
        --cp-primary-soft: rgba(37, 99, 235, 0.14);
        --cp-primary-strong: rgba(37, 99, 235, 0.40);
        --cp-accent: #22c55e;
        --cp-radius-xl: 24px;
        --cp-radius-lg: 18px;
        --cp-radius-md: 12px;
        --cp-shadow-soft: 0 22px 50px rgba(15, 23, 42, 0.16);
      }

      body.dark,
      :root.dark-theme {
        --cp-bg: #020617;
        --cp-glass-bg: rgba(15, 23, 42, 0.84);
        --cp-glass-bg-soft: rgba(15, 23, 42, 0.78);
        --cp-glass-border: rgba(148, 163, 184, 0.50);
        --cp-glass-shadow: 0 30px 90px rgba(0, 0, 0, 0.90);
        --cp-surface: rgba(15, 23, 42, 0.94);
        --cp-surface-soft: rgba(15, 23, 42, 0.88);
        --cp-border-subtle: rgba(30, 64, 175, 0.55);
        --cp-text-main: #e5e7eb;
        --cp-text-muted: #9ca3af;
        --cp-primary-soft: rgba(59, 130, 246, 0.26);
        --cp-primary-strong: rgba(59, 130, 246, 0.60);
        --cp-shadow-soft: 0 26px 70px rgba(15, 23, 42, 0.92);
      }

      body {
        background:
          radial-gradient(circle at top left, rgba(59, 130, 246, 0.26), transparent 55%),
          radial-gradient(circle at bottom right, rgba(16, 185, 129, 0.28), transparent 60%),
          var(--cp-bg);
      }

      /* ØªØ®Ø·ÙŠØ· ØµÙØ­Ø© Ø§Ù„ÙƒÙˆØ±Ø³ */
      .course-display {
        max-width: 1240px;
        margin: 112px auto 70px;
        padding: 0 16px;
        display: grid;
        grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
        gap: 18px;
      }

      @media (max-width: 992px) {
        .course-display {
          grid-template-columns: minmax(0, 1fr);
          margin-top: 100px;
        }
      }

      @media (max-width: 640px) {
        .course-display {
          padding: 0 10px;
          margin-top: 96px;
        }
      }

      /* Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙˆØ§Ù„Ø¯Ø±ÙˆØ³) Ø¨Ù†Ù…Ø· glass */
      .course-sidebar {
        background:
          radial-gradient(circle at top, rgba(59, 130, 246, 0.22), transparent 55%),
          radial-gradient(circle at bottom, rgba(16, 185, 129, 0.22), transparent 60%),
          var(--cp-glass-bg);
        border-radius: var(--cp-radius-xl);
        border: 1px solid var(--cp-glass-border);
        box-shadow: var(--cp-glass-shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 140px);
        backdrop-filter: blur(22px) saturate(160%);
        -webkit-backdrop-filter: blur(22px) saturate(160%);
      }

      @media (max-width: 992px) {
        .course-sidebar {
          max-height: none;
        }
      }

      .sidebar-header {
        padding: 14px 16px 10px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.55);
        background:
          radial-gradient(circle at top left, rgba(59, 130, 246, 0.40), transparent 65%),
          rgba(15, 23, 42, 0.92);
        color: #e5e7eb;
      }

      .sidebar-title {
        font-size: 16px;
        font-weight: 800;
        margin: 0 0 4px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .sidebar-title::before {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.30);
      }

      .sidebar-subtitle {
        margin: 0;
        font-size: 12px;
        color: rgba(209, 213, 219, 0.9);
      }

      .progress-section {
        background: linear-gradient(
          135deg,
          rgba(15, 23, 42, 0.85) 0%,
          rgba(15, 23, 42, 0.92) 100%
        );
        padding: 14px 16px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 13px;
      }

      .progress-text {
        color: rgba(209, 213, 219, 0.95);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .progress-text::before {
        content: 'ğŸ“Š';
        font-size: 14px;
      }

      .progress-percentage {
        font-size: 15px;
        font-weight: 800;
        background: linear-gradient(135deg, #22c55e, #4ade80);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
      }

      .progress-bar {
        position: relative;
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: linear-gradient(
          135deg,
          rgba(15, 23, 42, 0.6) 0%,
          rgba(15, 23, 42, 0.5) 100%
        );
        overflow: hidden;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(148, 163, 184, 0.15);
        box-shadow: 
          inset 0 1px 2px rgba(0, 0, 0, 0.2),
          0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .progress-fill {
        position: relative;
        height: 100%;
        width: 0%;
        border-radius: inherit;
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.85) 0%,
          rgba(16, 185, 129, 0.90) 50%,
          rgba(5, 150, 105, 0.95) 100%
        );
        box-shadow: 
          0 2px 12px rgba(34, 197, 94, 0.5),
          inset 0 1px 1px rgba(255, 255, 255, 0.2);
        transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
      }

      .progress-fill::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      .modules-list {
        flex: 1;
        overflow-y: auto;
        background: rgba(15, 23, 42, 0.92);
        padding: 6px 8px 10px;
      }

      .module-item {
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 12px;
        border: 2px solid rgba(31, 41, 55, 0.9);
        background:
          radial-gradient(circle at top left, rgba(37, 99, 235, 0.4), transparent 60%),
          rgba(15, 23, 42, 0.95);
        transform-style: preserve-3d;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 
          0 4px 16px rgba(0, 0, 0, 0.2),
          0 0 0 0 rgba(37, 99, 235, 0.2);
        position: relative;
      }

      .module-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
        border-radius: 16px;
      }

      .module-item:hover::before {
        opacity: 1;
      }

      .module-item:hover {
        transform: translateY(-4px) translateZ(10px) scale(1.02);
        border-color: rgba(37, 99, 235, 0.5);
        box-shadow: 
          0 12px 32px rgba(37, 99, 235, 0.3),
          0 0 0 2px rgba(37, 99, 235, 0.2);
      }

      .module-header {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        color: #e5e7eb;
        position: relative;
        z-index: 1;
        transition: all 0.3s ease;
        background: rgba(15, 23, 42, 0.5);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .module-header:hover {
        background: rgba(37, 99, 235, 0.2);
      }

      .module-header.active {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.3) 0%, rgba(139, 92, 246, 0.2) 100%);
      }

      .module-title {
        font-size: 13px;
        font-weight: 600;
      }

      .module-toggle {
        color: rgba(148, 163, 184, 0.9);
        transition: transform 0.25s ease, color 0.25s ease;
      }

      .module-header.active .module-toggle {
        transform: rotate(180deg);
        color: #facc15;
      }

      .lessons-list {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.25s ease;
        background: rgba(15, 23, 42, 0.96);
      }

      .lessons-list.expanded {
        max-height: 480px;
      }

      .lesson-item {
        margin: 6px 8px 10px;
        padding: 12px 16px 12px 40px;
        border-radius: 14px;
        border: 2px solid rgba(31, 41, 55, 0.95);
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.96) 0%, rgba(30, 41, 59, 0.9) 100%);
        cursor: pointer;
        position: relative;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform-style: preserve-3d;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 
          0 2px 8px rgba(0, 0, 0, 0.2),
          0 0 0 0 rgba(37, 99, 235, 0.2);
      }

      .lesson-item::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
        border-radius: 14px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
      }

      .lesson-item > * {
        position: relative;
        z-index: 1;
      }

      .lesson-item:hover {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.7) 0%, rgba(56, 189, 248, 0.6) 100%);
        transform: translateY(-3px) translateZ(8px) scale(1.02);
        border-color: rgba(37, 99, 235, 0.6);
        box-shadow: 
          0 8px 24px rgba(37, 99, 235, 0.4),
          0 0 0 2px rgba(37, 99, 235, 0.2);
      }

      .lesson-item:hover::after {
        opacity: 1;
      }

      .lesson-item.active {
        border-color: rgba(56, 189, 248, 0.98);
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.98) 0%, rgba(56, 189, 248, 0.98) 100%);
        box-shadow: 
          0 12px 32px rgba(37, 99, 235, 0.6),
          0 0 0 3px rgba(255, 255, 255, 0.2) inset,
          0 0 40px rgba(37, 99, 235, 0.4);
        transform: translateY(-2px) translateZ(10px) scale(1.03);
      }

      .lesson-item.completed {
        border-color: rgba(34, 197, 94, 0.95);
        background: rgba(22, 163, 74, 0.22);
      }

      .lesson-item.completed::before {
        content: '\2713';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #4ade80;
        font-size: 13px;
      }

      .lesson-item.active::before {
        content: '\25B6';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #fefce8;
        font-size: 11px;
      }

      .lesson-title-sidebar {
        font-size: 13px;
        color: rgba(226, 232, 240, 0.95);
        margin-bottom: 2px;
      }

      .lesson-duration {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.9);
      }

      .lesson-specialization {
        font-size: 10px;
        color: rgba(59, 130, 246, 0.95);
        margin-top: 6px;
        padding: 4px 8px;
        background: rgba(59, 130, 246, 0.15);
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .lesson-specialization i {
        font-size: 9px;
      }

      .lesson-item.active .lesson-title-sidebar,
      .lesson-item.active .lesson-duration,
      .lesson-item.active .lesson-specialization {
        color: #fefce8;
      }

      .lesson-item.active .lesson-specialization {
        background: rgba(255, 255, 255, 0.2);
        color: #fefce8;
      }

      /* Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ù…Ø· glass */
      .course-main {
        background:
          radial-gradient(circle at top right, rgba(59, 130, 246, 0.22), transparent 60%),
          radial-gradient(circle at bottom left, rgba(16, 185, 129, 0.22), transparent 60%),
          var(--cp-glass-bg-soft);
        border-radius: var(--cp-radius-xl);
        border: 1px solid var(--cp-glass-border);
        box-shadow: var(--cp-glass-shadow);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        backdrop-filter: blur(22px) saturate(160%);
        -webkit-backdrop-filter: blur(22px) saturate(160%);
      }

      .course-header {
        padding: 14px 18px 10px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.45);
        background:
          linear-gradient(135deg, rgba(37, 99, 235, 0.14), rgba(15, 23, 42, 0.02));
      }

      .course-title {
        font-size: 18px;
        font-weight: 800;
        color: var(--cp-text-main);
        margin: 0 0 4px;
      }

      .course-description {
        font-size: 13px;
        color: var(--cp-text-muted);
        line-height: 1.7;
        max-height: 3.6em;
        overflow: hidden;
        margin: 0;
      }

      .course-status {
        margin: 8px 0;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-badge.free {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
      }

      .status-badge.paid {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
      }

      .status-badge i {
        font-size: 10px;
      }

      .content-area {
        padding: 16px 16px 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: rgba(255, 255, 255, 0.25);
      }

      /* Udemy Button with Liquid Glass Effect */
      .udemy-button-container {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        padding: 0 16px;
      }

      .udemy-button {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 16px 32px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 700;
        font-size: 1.1rem;
        color: white;
        overflow: hidden;
        transform-style: preserve-3d;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1;
        border: 2px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        box-shadow: 
          0 8px 32px rgba(0, 0, 0, 0.2),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset,
          0 0 60px rgba(99, 102, 241, 0.3);
      }

      .udemy-button-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
        z-index: -1;
        transition: all 0.4s ease;
      }

      .udemy-button::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.4s ease;
        z-index: 0;
      }

      .udemy-button-shine {
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left 0.6s ease;
        z-index: 1;
      }

      .udemy-button-content {
        position: relative;
        z-index: 2;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .udemy-button-content i {
        font-size: 1.5rem;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }

      .udemy-button:hover {
        transform: translateY(-4px) translateZ(15px) scale(1.05);
        box-shadow: 
          0 16px 48px rgba(99, 102, 241, 0.4),
          0 0 0 2px rgba(255, 255, 255, 0.4) inset,
          0 0 80px rgba(99, 102, 241, 0.5);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .udemy-button:hover::before {
        opacity: 1;
      }

      .udemy-button:hover .udemy-button-shine {
        left: 100%;
      }

      .udemy-button:hover .udemy-button-bg {
        background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 50%, #f59e0b 100%);
        filter: brightness(1.1);
      }

      .udemy-button:active {
        transform: translateY(-2px) translateZ(10px) scale(1.02);
      }

      @keyframes udemyPulse {
        0%, 100% {
          box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.2),
            0 0 0 1px rgba(255, 255, 255, 0.1) inset,
            0 0 60px rgba(99, 102, 241, 0.3);
        }
        50% {
          box-shadow: 
            0 12px 40px rgba(99, 102, 241, 0.4),
            0 0 0 2px rgba(255, 255, 255, 0.2) inset,
            0 0 80px rgba(99, 102, 241, 0.5);
        }
      }

      .udemy-button {
        animation: udemyPulse 3s ease-in-out infinite;
      }

      /* ============================================
         Paid Course Page - Premium Design
         ============================================ */
      body.paid-course-page {
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.15) 0%, 
          rgba(139, 92, 246, 0.1) 50%,
          rgba(236, 72, 153, 0.08) 100%),
          var(--cp-bg);
      }

      body.paid-course-page .course-sidebar {
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.2) 0%, 
          rgba(139, 92, 246, 0.15) 50%,
          rgba(236, 72, 153, 0.1) 100%);
        border: 2px solid rgba(99, 102, 241, 0.4);
        box-shadow: 
          0 20px 60px rgba(99, 102, 241, 0.3),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset,
          0 0 80px rgba(99, 102, 241, 0.2);
      }

      body.paid-course-page .course-main {
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.15) 0%, 
          rgba(139, 92, 246, 0.1) 50%,
          rgba(236, 72, 153, 0.08) 100%);
        border: 2px solid rgba(99, 102, 241, 0.4);
        box-shadow: 
          0 20px 60px rgba(99, 102, 241, 0.3),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset,
          0 0 80px rgba(99, 102, 241, 0.2);
      }

      body.paid-course-page .course-header {
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.25) 0%, 
          rgba(139, 92, 246, 0.2) 100%);
        border-bottom: 2px solid rgba(99, 102, 241, 0.3);
      }

      body.paid-course-page .course-title {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 2px 4px rgba(99, 102, 241, 0.3));
      }

      body.paid-course-page .module-item {
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.2) 0%, 
          rgba(139, 92, 246, 0.15) 100%);
        border: 2px solid rgba(99, 102, 241, 0.4);
        box-shadow: 
          0 8px 24px rgba(99, 102, 241, 0.2),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset;
      }

      body.paid-course-page .module-item:hover {
        border-color: rgba(99, 102, 241, 0.6);
        box-shadow: 
          0 12px 32px rgba(99, 102, 241, 0.3),
          0 0 0 2px rgba(255, 255, 255, 0.2) inset;
      }

      body.paid-course-page .module-header {
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.3) 0%, 
          rgba(139, 92, 246, 0.25) 100%);
      }

      body.paid-course-page .module-header.active {
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.4) 0%, 
          rgba(139, 92, 246, 0.35) 100%);
      }

      body.paid-course-page .lesson-item {
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.15) 0%, 
          rgba(139, 92, 246, 0.1) 100%);
        border: 2px solid rgba(99, 102, 241, 0.3);
      }

      body.paid-course-page .lesson-item:hover {
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.4) 0%, 
          rgba(139, 92, 246, 0.35) 100%);
        border-color: rgba(99, 102, 241, 0.5);
      }

      body.paid-course-page .lesson-item.active {
        background: linear-gradient(135deg, 
          rgba(99, 102, 241, 0.6) 0%, 
          rgba(139, 92, 246, 0.55) 100%);
        border-color: rgba(99, 102, 241, 0.7);
        box-shadow: 
          0 12px 32px rgba(99, 102, 241, 0.4),
          0 0 0 2px rgba(255, 255, 255, 0.2) inset;
      }

      body.paid-course-page .nav-btn {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: 
          0 8px 24px rgba(99, 102, 241, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.2) inset;
      }

      body.paid-course-page .nav-btn:hover:not(:disabled) {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 
          0 12px 32px rgba(99, 102, 241, 0.5),
          0 0 0 2px rgba(255, 255, 255, 0.3) inset;
      }

      body.paid-course-page .udemy-button-container {
        margin-top: 24px;
      }

            body.paid-course-page .udemy-button {
                display: inline-flex !important;
                width: 100%;
                justify-content: center;
                font-size: 1.2rem;
                padding: 20px 40px;
            }

      body.dark .content-area,
      :root.dark-theme .content-area {
        background: rgba(15, 23, 42, 0.80);
      }

      /* ============================================
          Premium Paid Course Page Styles
          ============================================ */
      .paid-course-premium {
        min-height: calc(100vh - 200px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        background:
          radial-gradient(circle at top left, rgba(99, 102, 241, 0.15), transparent 50%),
          radial-gradient(circle at bottom right, rgba(139, 92, 246, 0.1), transparent 50%),
          radial-gradient(circle at center, rgba(236, 72, 153, 0.08), transparent 70%),
          var(--cp-bg);
      }

      body.dark .paid-course-premium,
      :root.dark-theme .paid-course-premium {
        background:
          radial-gradient(circle at top left, rgba(99, 102, 241, 0.25), transparent 50%),
          radial-gradient(circle at bottom right, rgba(139, 92, 246, 0.2), transparent 50%),
          radial-gradient(circle at center, rgba(236, 72, 153, 0.15), transparent 70%),
          var(--cp-bg);
      }

      .premium-container {
        width: 100%;
        background:
          linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(249, 250, 251, 0.90)),
          radial-gradient(circle at top, rgba(255, 193, 7, 0.1), transparent 60%);
        border-radius: 32px;
        border: 2px solid rgba(255, 193, 7, 0.3);
        box-shadow:
          0 32px 80px rgba(255, 193, 7, 0.3),
          0 0 0 1px rgba(255, 255, 255, 0.2) inset,
          0 0 100px rgba(255, 193, 7, 0.2);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        overflow: hidden;
        transform-style: preserve-3d;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      body.dark .premium-container,
      :root.dark-theme .premium-container {
        background:
          linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.90)),
          radial-gradient(circle at top, rgba(255, 193, 7, 0.2), transparent 60%);
        border-color: rgba(255, 193, 7, 0.5);
        box-shadow:
          0 32px 80px rgba(255, 193, 7, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset,
          0 0 100px rgba(255, 193, 7, 0.3);
      }


      .premium-header {
        text-align: center;
        padding: 40px 30px 30px;
        background:
          linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.08)),
          rgba(255, 255, 255, 0.5);
        border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        position: relative;
        overflow: hidden;
      }

      body.dark .premium-header,
      :root.dark-theme .premium-header {
        background:
          linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15)),
          rgba(15, 23, 42, 0.5);
        border-bottom-color: rgba(99, 102, 241, 0.3);
      }

      .premium-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: #92400e;
        border-radius: 50px;
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .premium-badge i {
        font-size: 16px;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
      }

      .premium-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--cp-text-main);
        margin: 0 0 16px;
        background: linear-gradient(135deg, #ffd700 0%, #ffb347 50%, #ffed4e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0 2px 4px rgba(255, 193, 7, 0.3));
        text-shadow: 0 4px 8px rgba(255, 193, 7, 0.2);
      }

      .premium-description {
        font-size: 1.1rem;
        color: var(--cp-text-muted);
        line-height: 1.7;
        margin: 0;
        max-width: 600px;
        margin: 0 auto;
      }

      .premium-content {
        padding: 40px 30px;
      }

      .premium-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
      }

      .feature-card {
        background:
          linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(249, 250, 251, 0.7)),
          radial-gradient(circle at top, rgba(99, 102, 241, 0.05), transparent 70%);
        border-radius: 20px;
        padding: 24px;
        text-align: center;
        border: 1px solid rgba(99, 102, 241, 0.2);
        box-shadow:
          0 8px 24px rgba(99, 102, 241, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        backdrop-filter: blur(15px) saturate(160%);
        -webkit-backdrop-filter: blur(15px) saturate(160%);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform-style: preserve-3d;
      }

      body.dark .feature-card,
      :root.dark-theme .feature-card {
        background:
          linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.7)),
          radial-gradient(circle at top, rgba(99, 102, 241, 0.1), transparent 70%);
        border-color: rgba(99, 102, 241, 0.3);
      }

      .feature-card:hover {
        transform: translateY(-6px) translateZ(15px) scale(1.05);
        box-shadow:
          0 16px 40px rgba(99, 102, 241, 0.25),
          0 0 0 2px rgba(255, 255, 255, 0.2) inset;
        border-color: rgba(99, 102, 241, 0.4);
      }

      .feature-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ffd700, #ffb347);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: #92400e;
        font-size: 24px;
        box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4);
        border: 3px solid rgba(255, 255, 255, 0.3);
      }

      .feature-card h3 {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--cp-text-main);
        margin: 0 0 8px;
      }

      .feature-card p {
        font-size: 0.95rem;
        color: var(--cp-text-muted);
        line-height: 1.6;
        margin: 0;
      }

      .premium-cta {
        text-align: center;
      }

      .udemy-premium-button-container {
        margin-bottom: 20px;
      }

            /* Ultimate Premium Udemy Button */
      .udemy-premium-button {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        padding: 20px 30px;
        background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 35%, #f6e05e 70%, #d97706 100%);
        background-size: 200% 200%;
        color: #78350f !important;
        text-decoration: none;
        font-weight: 800;
        font-size: 1.4rem;
        border-radius: 20px;
        border: 4px solid rgba(255, 255, 255, 0.4);
        box-shadow: 
          0 20px 50px rgba(245, 158, 11, 0.4),
          0 0 0 2px rgba(255, 255, 255, 0.2) inset,
          0 0 80px rgba(245, 158, 11, 0.3);
        overflow: hidden;
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 1;
        cursor: pointer;
        animation: premiumFloat 4s ease-in-out infinite, premiumBgShift 6s linear infinite;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      @keyframes premiumFloat {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-10px) rotate(1deg); }
      }

      @keyframes premiumBgShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      .udemy-premium-button-bg {
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        opacity: 0.5;
        z-index: -1;
      }

      .udemy-premium-button-shine {
        position: absolute;
        top: -50%;
        left: -100%;
        width: 100%;
        height: 200%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.6),
          transparent
        );
        transform: rotate(25deg);
        transition: all 0.8s ease;
        z-index: 1;
      }

      .udemy-premium-button:hover {
        transform: translateY(-8px) scale(1.05);
        box-shadow: 
          0 30px 70px rgba(245, 158, 11, 0.6),
          0 0 0 4px rgba(255, 255, 255, 0.5) inset,
          0 0 100px rgba(245, 158, 11, 0.5);
        border-color: rgba(255, 255, 255, 0.7);
        color: #451a03 !important;
      }

      .udemy-premium-button:hover .udemy-premium-button-shine {
        left: 150%;
      }

      .udemy-premium-button-content {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
      }

      .udemy-premium-button-content i {
        font-size: 2.2rem;
        margin-bottom: 2px;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
        transition: transform 0.4s ease;
      }

      .udemy-premium-button:hover .udemy-premium-button-content i {
        transform: scale(1.2) rotate(-10deg);
      }

      .udemy-premium-button-content span {
        font-size: 1.5rem;
        font-weight: 900;
        letter-spacing: -0.5px;
      }

      .udemy-premium-button-content small {
        font-size: 0.9rem;
        font-weight: 700;
        opacity: 0.8;
        background: rgba(0, 0, 0, 0.05);
        padding: 4px 12px;
        border-radius: 10px;
        margin-top: 4px;
      }

      .premium-note {
        font-size: 0.95rem;
        color: var(--cp-text-muted);
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 16px;
        background: rgba(99, 102, 241, 0.1);
        border-radius: 16px;
        border: 1px solid rgba(99, 102, 241, 0.2);
      }

      body.dark .premium-note,
      :root.dark-theme .premium-note {
        background: rgba(99, 102, 241, 0.2);
        border-color: rgba(99, 102, 241, 0.3);
      }

      .premium-note i {
        color: #ffd700;
        font-size: 1.1rem;
      }

      /* Introductory Video Section */
      .intro-video-section {
        margin-bottom: 40px;
        padding: 0;
        background: transparent;
        border-radius: 0;
        border: none;
        box-shadow: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      body.dark .intro-video-section,
      :root.dark-theme .intro-video-section {
        background: transparent;
        border-color: transparent;
      }

      .intro-video-header {
        text-align: center;
        margin-bottom: 24px;
        padding: 0 0 16px;
        border-bottom: 2px solid rgba(255, 193, 7, 0.2);
      }

      body.dark .intro-video-header,
      :root.dark-theme .intro-video-header {
        border-bottom-color: rgba(255, 193, 7, 0.15);
      }

      .intro-video-header h2 {
        font-size: 2rem;
        font-weight: 800;
        color: var(--cp-text-main);
        margin: 0 0 8px;
        background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -0.5px;
      }

      .intro-video-header p {
        font-size: 1.05rem;
        color: var(--cp-text-muted);
        margin: 0;
        font-weight: 500;
      }

      .intro-video-container {
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 
          0 20px 60px rgba(255, 193, 7, 0.25),
          0 0 0 1px rgba(255, 193, 7, 0.15) inset;
        background: #000;
        position: relative;
        transition: all 0.3s ease;
      }

      .intro-video-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at top left, rgba(255, 193, 7, 0.1), transparent 80%);
        pointer-events: none;
        z-index: 1;
      }

      .intro-video-container:hover {
        box-shadow: 
          0 28px 80px rgba(255, 193, 7, 0.35),
          0 0 0 1px rgba(255, 193, 7, 0.2) inset;
        transform: translateY(-4px);
      }

      .intro-video-container .video-container {
        position: relative;
        width: 100%;
        padding-top: 56.25%;
        background: #000;
        overflow: hidden;
      }

      .intro-video-container .video-container video,
      .intro-video-container .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
      }

      .intro-video-container .plyr__video-embed {
        width: 100%;
        height: auto;
        padding-top: 56.25%;
        position: relative;
      }

      .intro-video-container .plyr__video-embed iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      /* Golden styling for intro video player - COMPLETE */
      .intro-video-container .plyr {
        border-radius: 12px;
        overflow: hidden;
        background: #000;
      }

      .intro-video-container .plyr__controls {
        background: linear-gradient(to top, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.7)) !important;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* Hide duplicate controls */
      .intro-video-container .plyr__controls > * + * {
        margin-left: 5px;
      }

      /* All control buttons golden */
      .intro-video-container .plyr__control {
        color: #ffc107 !important;
        fill: #ffc107 !important;
        stroke: #ffc107 !important;
        transition: all 0.3s ease;
        background-color: #c5ab1ea3;
      }

      .intro-video-container .plyr__control:hover,
      .intro-video-container .plyr__control[aria-pressed="true"],
      .intro-video-container .plyr__control.active {
        color: #ffed4e !important;
        fill: #ffed4e !important;
        stroke: #ffed4e !important;
        text-shadow: 0 0 8px rgba(255, 237, 78, 0.4);
        background-color: #d6c318;
      }

      /* Progress bar golden */
      .intro-video-container .plyr__progress {
        background: rgba(255, 193, 7, 0.2) !important;
        height: 5px;
      }

      .intro-video-container .plyr__progress:hover {
        height: 8px;
      }

      .intro-video-container .plyr__progress__buffer {
        background: rgba(255, 193, 7, 0.4) !important;
      }

      .intro-video-container .plyr__progress__played {
        background: #ffc107 !important;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.6);
      }

      /* Slider thumb golden */
      .intro-video-container .plyr__progress input {
        accent-color: #ffc107;
        position: absolute;
        top: -7px;
      }

      .intro-video-container .plyr__progress input::-webkit-slider-thumb {
        background: #ffc107 !important;
        box-shadow: 0 0 12px rgba(255, 193, 7, 0.8);
        border: 2px solid #ffed4e;
      }

      .intro-video-container .plyr__progress input::-moz-range-thumb {
        background: #ffc107 !important;
        box-shadow: 0 0 12px rgba(255, 193, 7, 0.8);
        border: 2px solid #ffed4e;
      }

      /* Time display golden - Single time bar only */
      .intro-video-container .plyr__time,
      .intro-video-container .plyr__duration {
        color: #ffc107 !important;
        font-weight: bold;
        text-shadow: 0 0 4px rgba(255, 193, 7, 0.3);
      }

      /* Hide duplicate controls - Keep only first of each type */
      .intro-video-container .plyr__controls [data-plyr="current-time"]:not(:first-of-type),
      .intro-video-container .plyr__controls [data-plyr="duration"]:not(:first-of-type),
      .intro-video-container .plyr__controls [data-plyr="progress"]:not(:first-of-type) {
        display: none !important;
      }

      /* Ensure single clean time display */
      .intro-video-container .plyr__controls [data-plyr="current-time"],
      .intro-video-container .plyr__controls [data-plyr="duration"] {
        color: #ffc107 !important;
        min-width: 45px;
        text-align: center;
        display: inline-flex !important;
      }

      /* Remove extra margins from duplicates */
      .intro-video-container .plyr__controls > *:nth-child(n+3):nth-child(-n+5) {
        margin-left: 5px;
      }

      /* Volume slider golden - COMPLETE */
      .intro-video-container .plyr__volume {
        background: rgba(255, 193, 7, 0.2) !important;
            border-radius: 6px;
      }

      /* Remove duplicate progress bars - keep only one clean instance */
      .intro-video-container .plyr__progress:not(:first-of-type) {
        display: none !important;
        visibility: hidden !important;
      }

      /* Force progress bar styling */
      .intro-video-container .plyr__progress {
        -webkit-appearance: none !important;
        appearance: none !important;
        background: rgba(255, 193, 7, 0.2) !important;
      }

      /* Remove any blue styling */
      .intro-video-container .plyr__progress::-webkit-progress-bar {
        background: rgba(255, 193, 7, 0.2) !important;
      }

      .intro-video-container .plyr__progress::-webkit-progress-value {
        background: #ffc107 !important;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.6) !important;
      }

      .intro-video-container .plyr__progress::-moz-progress-bar {
        background: #ffc107 !important;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.6) !important;
      }

      /* Force remove blue range slider */
      .intro-video-container input[type="range"] {
        -webkit-appearance: none !important;
        appearance: none !important;
      }

      .intro-video-container input[type="range"]::-webkit-slider-runnable-track {
        background: rgba(255, 193, 7, 0.2) !important;
        border-radius: 5px;
        height: 5px;
      }

      .intro-video-container input[type="range"]::-moz-range-track {
        background: rgba(255, 193, 7, 0.2) !important;
        border-radius: 5px;
        height: 5px;
      }

      .intro-video-container .plyr__volume input {
        accent-color: #ffc107 !important;
        -webkit-appearance: none !important;
        appearance: none !important;
        width: 100% !important;
        height: 5px !important;
        border-radius: 3px !important;
        background: rgba(255, 193, 7, 0.2) !important;
        outline: none !important;
      }

      .intro-video-container .plyr__volume input::-webkit-slider-runnable-track {
        background: rgba(255, 193, 7, 0.2) !important;
        height: 5px !important;
        border-radius: 3px !important;
      }

      .intro-video-container .plyr__volume input::-moz-range-track {
        background: rgba(255, 193, 7, 0.2) !important;
        height: 5px !important;
        border-radius: 3px !important;
      }

      .intro-video-container .plyr__volume input::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #ffc107 !important;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.8);
        border: 2px solid #ffed4e;
      }

      .intro-video-container .plyr__volume input::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #ffc107 !important;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.8);
        border: 2px solid #ffed4e;
      }

      .intro-video-container .plyr__volume input::-moz-range-track {
        background: transparent;
        border: none;
      }

      .intro-video-container .plyr__volume input::-moz-range-progress {
        background: rgba(255, 193, 7, 0.6);
      }

      .intro-video-container .plyr__volume-control {
        color: #ffc107;
      }

      /* Settings menu golden */
      .intro-video-container .plyr__menu__container {
        background: rgba(0, 0, 0, 0.95) !important;
        border: 1px solid rgba(255, 193, 7, 0.3);
      }

      .intro-video-container .plyr__menu__container button {
        color: #ffc107 !important;
      }

      .intro-video-container .plyr__menu__container button:hover {
        background: rgba(255, 193, 7, 0.1);
        color: #ffed4e !important;
      }

      /* Tooltip golden */
      .intro-video-container .plyr__tooltip {
        background: rgba(255, 193, 7, 0.9);
        color: #000;
        border-color: #ffc107;
      }

      /* Caption and settings text */
      .intro-video-container .plyr__caption {
        color: #ffc107;
      }

      /* Fullscreen button golden */
      .intro-video-container .plyr__fullscreen-fallback {
        border: 2px solid #ffc107;
      }

      /* Plyr large button golden styling */
      .intro-video-container .plyr__play-large {
        background: rgba(255, 193, 7, 0.15) !important;
        border: 3px solid #ffc107 !important;
        box-shadow: inset 0 0 20px rgba(255, 193, 7, 0.3) !important;
      }

      .intro-video-container .plyr__play-large svg {
        fill: #ffed4e !important;
        stroke: #ffed4e !important;
      }

      .intro-video-container .plyr__play-large svg path,
      .intro-video-container .plyr__play-large svg polygon,
      .intro-video-container .plyr__play-large svg polyline,
      .intro-video-container .plyr__play-large svg circle {
        fill: #ffed4e !important;
        stroke: #ffed4e !important;
      }

      /* Loading spinner golden */
      .intro-video-container .plyr__loading {
        color: #ffc107;
      }

      /* Caption button and styling */
      .intro-video-container [data-plyr="captions"] {
        color: #ffc107 !important;
      }

      /* Responsive improvements */
      @media (max-width: 1024px) {
        .intro-video-container {
          border-radius: 14px;
          box-shadow: 0 18px 50px rgba(255, 193, 7, 0.2);
        }

        .intro-video-header {
          flex-direction: column;
          align-items: flex-start;
        }

        #downloadPromoBtn {
          width: 100%;
          justify-content: center;
        }
      }

      @media (max-width: 768px) {
        .intro-video-container {
          border-radius: 12px;
          box-shadow: 0 15px 40px rgba(255, 193, 7, 0.2);
        }

        .intro-video-container .plyr__controls {
          padding: 8px 12px;
        }

        .intro-video-container .plyr__control {
          font-size: 14px;
          padding: 6px 8px;
        }

        .intro-video-header {
          padding: 0 0 12px;
          flex-direction: column;
        }

        .intro-video-header > div {
          width: 100%;
        }

        .intro-video-header h2 {
          font-size: 1.3rem;
        }

        .intro-video-header p {
          font-size: 0.85rem;
        }
      }

      @media (max-width: 480px) {
        .intro-video-container {
          border-radius: 8px;
        }

        .intro-video-container .plyr__controls {
          padding: 6px 10px !important;
        }

        .intro-video-container .plyr__control {
          font-size: 11px;
          padding: 3px 5px;
        }

        .intro-video-container .plyr__time {
          font-size: 11px;
        }

        .intro-video-header {
          margin-bottom: 16px;
        }

        .intro-video-header h2 {
          font-size: 1.1rem;
        }

        .intro-video-header p {
          font-size: 0.75rem;
        }

        .intro-video-section {
          margin-bottom: 20px;
        }

        #downloadPromoBtn {
          font-size: 12px;
          padding: 6px 12px !important;
        }

        .intro-video-container .plyr__play-large {
          width: 60px;
          height: 60px;
        }
      }

      @media (max-width: 360px) {
        .intro-video-container {
          border-radius: 6px;
        }

        .intro-video-container .plyr__controls {
          padding: 4px 8px !important;
        }

        .intro-video-container .plyr__control {
          font-size: 10px;
          padding: 2px 4px;
        }

        .intro-video-header h2 {
          font-size: 1rem;
        }

        .intro-video-header p {
          font-size: 0.7rem;
        }

        #downloadPromoBtn {
          font-size: 11px;
          padding: 4px 10px !important;
        }
      }

      body.dark .intro-video-container,
      :root.dark-theme .intro-video-container {
        box-shadow: 
          0 20px 60px rgba(255, 193, 7, 0.15),
          0 0 0 1px rgba(255, 193, 7, 0.1) inset;
      }

      body.dark .intro-video-container:hover,
      :root.dark-theme .intro-video-container:hover {
        box-shadow: 
          0 28px 80px rgba(255, 193, 7, 0.25),
          0 0 0 1px rgba(255, 193, 7, 0.15) inset;
      }

      @media (max-width: 768px) {
        .paid-course-premium {
          padding: 20px 10px;
        }

        .premium-container {
          border-radius: 24px;
        }

        .premium-header {
          padding: 30px 20px 20px;
        }

        .premium-title {
          font-size: 2rem;
        }

        .premium-content {
          padding: 30px 20px;
        }

        .intro-video-header h2 {
          font-size: 1.5rem;
        }

        .intro-video-header p {
          font-size: 0.95rem;
        }

        .intro-video-header {
          flex-wrap: wrap !important;
        }

        .intro-video-header > div {
          width: 100% !important;
        }

        .intro-video-container {
          border-radius: 16px;
        }

        #downloadPromoBtn {
          width: auto !important;
          margin-top: 10px !important;
        }

        .premium-features {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .intro-video-section {
          width: 100%;
          box-sizing: border-box;
        }

        .intro-video-container {
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }

        .udemy-premium-button {
          padding: 16px 32px;
          font-size: 1.1rem;
          min-width: 280px;
        }

        .udemy-premium-button-content i {
          font-size: 1.5rem;
        }
      }

      @media (max-width: 480px) {
        .premium-title {
          font-size: 1.8rem;
        }

        .udemy-premium-button {
          padding: 14px 24px;
          font-size: 1rem;
          min-width: 250px;
        }

        .feature-card {
          padding: 20px;
        }
      }

      .video-container {
        background: #000;
        border-radius: var(--cp-radius-lg);
        overflow: hidden;
        position: relative;
        aspect-ratio: 16/9;
        width: 100%;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
      }

      .video-container .plyr,
      .video-container .js-player {
        width: 100%;
        height: 100%;
      }

      .plyr--video {
        --plyr-color-main: var(--cp-primary);
        border-radius: var(--cp-radius-lg);
      }

      .lesson-info {
        background: var(--cp-surface);
        border-radius: var(--cp-radius-lg);
        padding: 12px 14px 10px;
        border: 1px solid var(--cp-border-subtle);
        box-shadow: var(--cp-shadow-soft);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
      }

      .lesson-title {
        font-size: 15px;
        font-weight: 700;
        color: var(--cp-text-main);
        margin: 0 0 6px;
      }

      .lesson-description {
        font-size: 13px;
        color: var(--cp-text-muted);
        line-height: 1.7;
      }

      .navigation-buttons {
        margin-top: 4px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      .nav-btn {
        flex: 1;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, var(--cp-primary), #1d4ed8);
        color: #f9fafb;
        padding: 8px 0;
        font-size: 13px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: pointer;
        box-shadow: 0 10px 24px rgba(37, 99, 235, 0.55);
        transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      }

      .nav-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 14px 32px rgba(37, 99, 235, 0.65);
      }

      .nav-btn:disabled {
        background: rgba(148, 163, 184, 0.4);
        color: rgba(148, 163, 184, 0.95);
        box-shadow: none;
        cursor: not-allowed;
      }

      /* Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø®Ø·Ø£ */
      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 32px 16px;
        text-align: center;
        color: var(--cp-text-muted);
      }

      .loading-spinner {
        width: 38px;
        height: 38px;
        border-radius: 999px;
        border: 4px solid rgba(148, 163, 184, 0.4);
        border-top-color: var(--cp-primary);
        animation: spin 0.75s linear infinite;
        margin-bottom: 10px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Enhanced PDF Viewer Styles */
      .pdf-container.enhanced {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.94), rgba(31, 41, 55, 0.96));
        border-radius: var(--cp-radius-lg);
        overflow: hidden;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
        position: relative;
      }

      .pdf-viewer-enhanced {
        width: 100%;
        height: 600px;
        border: none;
        background: transparent;
      }

      /* PDF Fallback Styles */
      .pdf-fallback {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(31, 41, 55, 0.98));
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #e5e7eb;
        text-align: center;
      }

      .pdf-error-message {
        max-width: 400px;
      }

      .pdf-error-message i {
        font-size: 48px;
        color: #ef4444;
        margin-bottom: 16px;
      }

      .pdf-error-message h3 {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 8px;
        color: #f9fafb;
      }

      .pdf-error-message p {
        font-size: 14px;
        color: rgba(209, 213, 219, 0.9);
        margin: 0 0 16px;
      }

      .pdf-download-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #f9fafb;
        border-radius: 999px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.45);
      }

      .pdf-download-link:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 28px rgba(239, 68, 68, 0.55);
      }

      .pdf-download-link i {
        font-size: 16px;
      }

      /* Make PDF viewer responsive */
      @media (max-width: 768px) {
        .pdf-viewer-enhanced {
          height: 400px;
        }
      }

      /* PDF Loading Overlay */
      .pdf-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(31, 41, 55, 0.94));
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        color: #e5e7eb;
        transition: opacity 0.3s ease;
      }

      .pdf-loading-spinner {
        width: 48px;
        height: 48px;
        border-radius: 999px;
        border: 4px solid rgba(148, 163, 184, 0.3);
        border-top-color: var(--cp-primary);
        animation: spin 0.8s linear infinite;
        margin-bottom: 16px;
      }

      .pdf-loading-text {
        font-size: 14px;
        font-weight: 600;
        color: rgba(209, 213, 219, 0.95);
      }

      /* External Video Fallback Styles */
      .external-video-fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(31, 41, 55, 0.98));
        color: #e5e7eb;
        text-align: center;
        padding: 20px;
      }

      .external-video-message {
        max-width: 400px;
      }

      .external-video-message i {
        font-size: 48px;
        color: var(--cp-primary);
        margin-bottom: 16px;
      }

      .external-video-message h3 {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 8px;
        color: #f9fafb;
      }

      .external-video-message p {
        font-size: 14px;
        color: rgba(209, 213, 219, 0.9);
        margin: 0 0 16px;
      }

      .external-video-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background: linear-gradient(135deg, var(--cp-primary), #1d4ed8);
        color: #f9fafb;
        border-radius: 999px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.45);
      }

      .external-video-link:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 28px rgba(37, 99, 235, 0.55);
      }

      .external-video-link i {
        font-size: 16px;
      }

      .mark-complete-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #f9fafb;
        border: none;
        border-radius: 999px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.45);
        margin-top: 12px;
      }

      .mark-complete-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 28px rgba(34, 197, 94, 0.55);
      }

      .mark-complete-btn i {
        font-size: 16px;
      }

      .external-video-message i.fab,
      .external-video-message i.fas {
        font-size: 56px;
        color: var(--cp-primary);
        margin-bottom: 16px;
      }

      .error-container {
        text-align: center;
        padding: 24px 20px;
        background: var(--cp-surface);
        border-radius: var(--cp-radius-lg);
        margin: 12px;
        border: 1px solid rgba(239, 68, 68, 0.35);
        color: var(--cp-text-main);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
      }

      .error-container i {
        font-size: 40px;
        color: #ef4444;
        margin-bottom: 10px;
      }

      .error-container a {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 7px 16px;
        border-radius: 999px;
        background: #ef4444;
        color: #f9fafb;
        text-decoration: none;
        font-size: 13px;
      }

      @media (max-width: 640px) {
        .course-header {
          padding: 10px 10px 6px;
        }
        .content-area {
          padding: 12px 10px 10px;
        }
        .navigation-buttons {
          flex-direction: column;
        }
      }

      /* Simple Toast Styles */
      .course-toast-container {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .course-toast {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        font-weight: 600;
        font-size: 14px;
        max-width: 400px;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .course-toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .course-toast.error {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
      }

      .course-toast-title {
        font-weight: 800;
        font-size: 16px;
        margin-bottom: 4px;
      }

      .course-toast-close {
        position: absolute;
        top: 8px;
        left: 8px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .course-toast-content {
        padding-left: 32px;
      }

      @media (max-width: 640px) {
        .course-toast-container {
          left: 10px;
          right: 10px;
          bottom: 10px;
        }
        .course-toast {
          max-width: none;
        }

        /* Responsive lesson specialization on mobile */
        .lesson-specialization {
          font-size: 9px;
          padding: 3px 6px;
        }

        .lesson-specialization i {
          font-size: 8px;
        }

        .lesson-specialization span {
          display: none;
        }
      }

      @media (max-width: 480px) {
        /* Show icon only on very small screens */
        .lesson-specialization {
          width: 20px;
          height: 20px;
          padding: 2px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          background: rgba(59, 130, 246, 0.25);
          margin-top: 4px;
        }

        .lesson-specialization span {
          display: none;
        }

        /* Toggle specialization menu on tap */
        .lesson-specialization.expanded {
          width: auto;
          height: auto;
          padding: 4px 8px;
          background: rgba(59, 130, 246, 0.15);
        }

        .lesson-specialization.expanded span {
          display: inline;
        }
      }
    </style>
  </head>
  <body>
    <!-- -------------------------------------------Start Header-------------------------------- -->
    <div dir="rtl" class="header">
            <div class="container">
                <div class="logo">
                    <a href="index.html" aria-label="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"><img src="img/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹"></a>
                </div>
                <div id="list" class="links">
                    <ul>
                        <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠÙ‡</a></li>
                        <li><a href="courses.html">Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª </a></li>
                        <li><a href="portfolio.html">Ù…Ø´Ø§Ø±ÙŠØ¹Ù†Ø§ </a></li>
                        <li class="nav-dropdown"><a href="roadmap.html">Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„Ù… <i class="fa-solid fa-angle-down"></i></a>
                            <ul class="nav-dropdown-items">
                                <li><a href="frontendroadmap.html">Front End </a></li>
                                <li><a href="backendroadmap.html">Back End</a></li>
                                <li><a href="cybersecurityroadmap.html">Cyber security</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div  class="bars">
                    <i id="bars" class="fa-solid fa-bars "></i>
                </div>
                <div class="icon">
                    <div id="colorMode" class="theme">
                        <i  class="fa-solid fa-moon moon"></i>
                        <i  class="fa-solid fa-sun sun"></i>
                    </div>
                    <a href="store.html" aria-label="Ø§Ù„Ù…ØªØ¬Ø±" title="Ø§Ù„Ù…ØªØ¬Ø±"><i class="fa-solid fa-store store"></i></a>
                    <a href="login.html" aria-label="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"><i class="fa-solid fa-user user"></i></a>
                </div>
            </div>
        </div>
    <!-- ---------------------------------------------End Header--------------------------------------- -->

    <!-- Course Display Interface -->
    <div class="course-display" id="courseDisplay">
        <!-- Sidebar with Modules and Lessons -->
        <div class="course-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title" id="courseTitle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <p class="sidebar-subtitle" id="courseSubtitle">Ø§Ø®ØªØ± Ø¯Ø±Ø³Ø§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡</p>
            </div>

            <div class="progress-section">
                <div class="progress-info">
                    <span class="progress-text">Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„ÙƒÙˆØ±Ø³</span>
                    <span class="progress-percentage" id="progressPercentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="modules-list" id="modulesList">
                <div class="loading-container">
                    <div class="loading-spinner" aria-hidden="true"></div>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</p>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="course-main">
            <div class="course-header">
                <div class="course-title" id="mainCourseTitle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <div class="course-status" id="courseStatus"></div>
                <p class="course-description" id="mainCourseDescription">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ Ø§Ù„ÙƒÙˆØ±Ø³...</p>
            </div>

            <div class="content-area">
                <div id="contentContainer">
                    <div class="loading-container">
                        <div class="loading-spinner" aria-hidden="true"></div>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</p>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button class="nav-btn" id="prevBtn" onclick="goToPreviousLesson()" disabled>
                        <i class="fas fa-arrow-right"></i>
                        <span>Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø³Ø§Ø¨Ù‚</span>
                    </button>
                    <button class="nav-btn" id="nextBtn" onclick="goToNextLesson()" disabled>
                        <span>Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„ØªØ§Ù„ÙŠ</span>
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>

                <!-- Udemy Button with Liquid Glass Effect -->
                <div class="udemy-button-container">
                    <a href="javascript:void(0)" id="udemyButton" class="udemy-button" onclick="handleBuyNow()" style="display: none;">
                        <span class="udemy-button-bg"></span>
                        <span class="udemy-button-content">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Ø§Ø´ØªØ±ÙŠ Ø§Ù„Ø§Ù†</span>
                        </span>
                        <span class="udemy-button-shine"></span>
                    </a>
                </div>
            </div>
      </div>
    </div>

    <!-- Premium Paid Course Page -->
    <div class="paid-course-premium" id="paidCoursePremium">
        <div class="premium-container">
            <div class="premium-header">
                <div class="premium-badge">
                    <i class="fas fa-crown"></i>
                    <span>ÙƒÙˆØ±Ø³ Ù…Ø¯ÙÙˆØ¹ Ù…Ù…ÙŠØ²</span>
                </div>
                <h1 class="premium-title" id="premiumCourseTitle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
                <p class="premium-description" id="premiumCourseDescription">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ Ø§Ù„ÙƒÙˆØ±Ø³...</p>
            </div>

            <div class="premium-content">
                <!-- Introductory Video Section -->
                <div class="intro-video-section" id="introVideoSection" style="display: none;">
                    <div class="intro-video-header">
                        <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <h2>ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ø±ÙŠÙÙŠ Ù„Ù„ÙƒÙˆØ±Ø³</h2>
                                <p>Ø´Ø§Ù‡Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ±Ø³</p>
                            </div>
                            <a id="downloadPromoBtn" href="#" download style="display: none; padding: 8px 16px; background: linear-gradient(135deg, #ffc107, #ffed4e); color: #000; border-radius: 6px; text-decoration: none; font-weight: bold; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);">
                                <i class="fa-solid fa-download"></i>
                                <span>ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</span>
                            </a>
                        </div>
                    </div>
                    <div class="intro-video-container" id="introVideoContainer">
                        <!-- Video will be loaded here -->
                    </div>
                </div>

                <div class="premium-features">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <h3>Ù…Ø­ØªÙˆÙ‰ Ø´Ø§Ù…Ù„ ÙˆÙ…ÙØµÙ„</h3>
                        <p>Ø¯Ø±ÙˆØ³ Ù…ØµÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…Ø¹ Ø´Ø±Ø­ ØªÙØµÙŠÙ„ÙŠ Ù„ÙƒÙ„ Ù…ÙˆØ¶ÙˆØ¹</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <h3>Ù…Ø­ØªÙˆÙ‰ Ù…Ø­Ø¯Ø«</h3>
                        <p>Ù†Ø­Ø¯ÙŠØ«Ø§Øª Ù…Ø³ØªÙ…Ø±Ø© Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¯ÙˆÙ† Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ©</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Ø¯Ø¹Ù… ÙÙ†ÙŠ</h3>
                        <p>Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ¯Ø¹Ù… Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ† ÙˆØ§Ù„Ù…Ø¬ØªÙ…Ø¹</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3>Ù…ØªØ§Ø­ Ø¯Ø§Ø¦Ù…Ø§Ù‹</h3>
                        <p>Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª ÙˆÙ…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù†</p>
                    </div>
                </div>

                <div class="premium-cta">
                    <div class="udemy-premium-button-container">
                        <a href="javascript:void(0)" id="premiumUdemyButton" class="udemy-premium-button" onclick="handleBuyNow()">
                            <span class="udemy-premium-button-bg"></span>
                            <span class="udemy-premium-button-content">
                                <i class="fas fa-shopping-cart"></i>
                                <span>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ø¢Ù†</span>
                                <small>Ø§Ø´ØªØ±ÙŠ Ø§Ù„Ø¢Ù†</small>
                            </span>
                            <span class="udemy-premium-button-shine"></span>
                        </a>
                    </div>
                    <p class="premium-note">
                        <i class="fas fa-info-circle"></i>
                        Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ØŒ Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ ÙˆØµÙˆÙ„ ÙƒØ§Ù…Ù„ Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ±Ø³ Ùˆ Ø¯Ø¹Ù… Ø¯Ø§Ø¦Ù…  
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Footer  -->
    <footer id="footer">
        <div class="footer-container">
            <div class="footer-main">
                <div class="footer-brand">
                    <div class="brand-logo">
                        <img src="img/loogo.png" alt="TWM3 Logo" />
                    </div>
                    <h3>TWM3</h3>
                    <p>ÙØ±ÙŠÙ‚ Ø¹Ù…Ù„ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© ÙˆØ§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ</p>
                </div>

                <div class="footer-links">
                    <h4>Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h4>
                    <ul>
                        <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                        <li><a href="courses.html">Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</a></li>
                        <li><a href="portfolio.html">Ù…Ø´Ø§Ø±ÙŠØ¹Ù†Ø§</a></li>
                        <li><a href="roadmap.html">Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…</a></li>
                    </ul>
                </div>

                <div class="footer-social">
                    <h4>ØªØ§Ø¨Ø¹Ù†Ø§</h4>
                    <div class="social-links">
                        <a href="https://facebook.com/teamworkm3" target="_blank" class="social-link" title="Facebook">
                            <img src="img/Facebook-1.png" alt="Facebook" />
                        </a>
                        <a href="https://youtube.com/@twm3" target="_blank" class="social-link" title="YouTube">
                            <img src="img/Youtube-1.png" alt="YouTube" />
                        </a>
                        <a href="https://instagram.com/mo_hussien_20" target="_blank" class="social-link" title="Instagram">
                            <img src="img/Instagram-1.png" alt="Instagram" />
                        </a>
                        <a href="https://t.me/teamworkm3" target="_blank" class="social-link" title="Telegram">
                            <img src="img/Telegram-1.png" alt="Telegram" />
                        </a>
                    </div>
                </div>
            </div>

            <div class="footer-copyright">
                <p>&copy; <span id="yearData"></span> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„ÙØ±ÙŠÙ‚ <span class="brand-highlight">TWM3</span> <i class="fas fa-heart heart"></i></p>
            </div>

            <div class="footer-bg-effects">
                <div class="floating-particles">
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                </div>
                <div class="wave-effect"></div>
            </div>
        </div>
    </footer>
    <!-- End Footer  -->

    <!-- Start up tp top  -->
    <div class="up">
      <i class="fa-solid fa-arrow-up"></i>
    </div>
    <!-- End up tp top  -->

    <!-- Toast Container -->
    <div id="courseToastContainer" class="course-toast-container"></div>

    <script src="js/theme-manager.js"></script>
    <script src="js/ui-toast.js"></script>
    <script src="app.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script>window.disableGlobalPlyrAutoInit = true;</script>
    <script src="js/video-player.js"></script>
    
    <!-- Course Content Modal -->
    <div id="courseContentModal" class="modal">
      <div class="modal-content course-content-modal">
        <div class="modal-header">
          <h2 id="courseContentModalTitle">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ±Ø³</h2>
          <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
          <div id="modulesContainer">
            <!-- Units and lessons will be dynamically inserted here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Add the new course management system script -->
    <script src="twm3-backend/private/courses-system.js"></script>
    <script>
        // Replace the old displayCourseContent function with a new one that uses our system
        window.displayCourseContent = async function(course) {
            if (window.CourseSystem) {
                await window.CourseSystem.loadCourseContent(course._id);
            } else {
                console.error('CourseSystem not loaded');
            }
        };
        
        // Ensure the modal closing works properly
        document.addEventListener('DOMContentLoaded', function() {
            const closeButtons = document.querySelectorAll('.modal-close');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            });
            
            // Close modal when clicking outside of it
            window.addEventListener('click', function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            });
        });
    </script>
    
    <script src="getCourses.js"></script>
    <script src="modal-system.js"></script>
    <script src="sidebar-system.js"></script>
    <script>
        // Simple Toast System Wrapper for modern UI
        function showCourseToast(message, options = {}) {
            const { type = 'info', title = '', timeout = 5000 } = options;
            if (window.showToast) {
                return window.showToast(message, { type, title, timeout });
            }
            console.log('Toast Fallback:', message);
        }

        async function handleBuyNow() {
            if (!currentCourse) {
                showCourseToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙˆØ±Ø³', { type: 'error' });
                return;
            }

            try {
                // Check for external link (Udemy or similar)
                let udemyLink = currentCourse.udemyLink || currentCourse.udemylink || currentCourse.udemy || '';
                
                // Fallback to localStorage if not in course object
                if (!udemyLink) {
                    try {
                        const map = JSON.parse(localStorage.getItem('courseUdemyLinks') || '{}');
                        const cid = currentCourse.id || currentCourse._id || '';
                        if (cid && map[String(cid)]) udemyLink = map[String(cid)];
                    } catch (e) { /* ignore */ }
                }

                if (udemyLink) {
                    // Show modern toast for external redirect
                    showCourseToast("Ø¬Ø§Ø±ÙŠ ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ", { 
                        type: 'success', 
                        title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡',
                        timeout: 2000
                    });

                    // Redirect to external link after short delay
                    setTimeout(() => {
                        window.location.href = udemyLink;
                    }, 1200);
                } else {
                    // If no external link found, show error (as per requirement to NOT use cart)
                    showCourseToast('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ±Ø³', { 
                        type: 'error',
                        title: 'Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ØªÙˆÙØ±'
                    });
                }

            } catch (error) {
                console.error('Error in Buy Now:', error);
                showCourseToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡', { type: 'error' });
            }
        }

        let currentCourse = null;
        let currentModuleIndex = 0;
        let currentLessonIndex = 0;
        let completedLessons = new Set();
        let courseData = null;
        let _plyrInstances = [];
        let isLoadingLesson = false;
        let currentUserId = null; // Add user-specific identification

        let pdfJsLoadingPromise = null;
        function ensurePdfJsLoaded() {
            if (window.pdfjsLib) return Promise.resolve();
            if (pdfJsLoadingPromise) return pdfJsLoadingPromise;
            const sources = [
                {
                    core: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js',
                    worker: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js'
                },
                {
                    core: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js',
                    worker: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js'
                },
                {
                    core: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.js',
                    worker: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.js'
                }
            ];
            pdfJsLoadingPromise = new Promise((resolve) => {
                let index = 0;
                const tryLoad = () => {
                    if (index >= sources.length) {
                        resolve(false);
                        return;
                    }
                    const { core, worker } = sources[index++];
                    const script = document.createElement('script');
                    script.src = core;
                    script.crossOrigin = 'anonymous';
                    script.onload = () => {
                        try {
                            if (window['pdfjsLib']) {
                                window.pdfjsLib.GlobalWorkerOptions.workerSrc = worker;
                                resolve(true);
                            } else {
                                tryLoad();
                            }
                        } catch (_) {
                            tryLoad();
                        }
                    };
                    script.onerror = () => {
                        tryLoad();
                    };
                    document.head.appendChild(script);
                };
                tryLoad();
            });
            return pdfJsLoadingPromise;
        }

        function getLessonLink(lesson) {
            return (
                lesson.link?.trim() ||
                lesson.fileUrl?.trim() ||
                lesson.videoUrl?.trim() ||
                lesson.externalUrl?.trim() ||
                ''
            );
        }

        function isPdfLink(rawLink) {
            if (!rawLink) return false;
            const lower = rawLink.toLowerCase();
            if (lower.endsWith('.pdf')) return true;
            try {
                const u = new URL(rawLink);
                return u.pathname.toLowerCase().endsWith('.pdf');
            } catch (_) {
                return false;
            }
        }

        function isVideoLink(rawLink) {
            if (!rawLink) return false;
            const link = rawLink.toLowerCase();
            return (
                link.includes('youtube.com/watch?v=') ||
                link.includes('youtube.com/embed') ||
                link.includes('youtu.be/') ||
                link.includes('youtube.com/shorts/') ||
                link.includes('drive.google.com/file/d/') ||
                link.includes('pexels.com/') ||
                link.includes('vimeo.com/') ||
                link.includes('dailymotion.com/') ||
                link.includes('tiktok.com/') ||
                link.includes('instagram.com/') ||
                link.includes('facebook.com/') ||
                link.includes('fb.watch/') ||
                link.includes('telegram.org/') ||
                link.includes('t.me/') ||
                link.endsWith('.mp4') ||
                link.endsWith('.mov') ||
                link.endsWith('.webm') ||
                link.endsWith('.avi') ||
                link.endsWith('.mkv') ||
                link.includes('/uploads/') ||
                link.includes('/videos/')
            );
        }

        function getPlatformName(link) {
            const lowerLink = link.toLowerCase();
            if (lowerLink.includes('pexels.com')) return 'Pexels';
            if (lowerLink.includes('vimeo.com')) return 'Vimeo';
            if (lowerLink.includes('dailymotion.com')) return 'Dailymotion';
            if (lowerLink.includes('tiktok.com')) return 'TikTok';
            if (lowerLink.includes('instagram.com')) return 'Instagram';
            if (lowerLink.includes('facebook.com') || lowerLink.includes('fb.watch')) return 'Facebook';
            if (lowerLink.includes('telegram.org') || lowerLink.includes('t.me')) return 'Telegram';
            return 'Ù…Ù†ØµØ© Ø®Ø§Ø±Ø¬ÙŠØ©';
        }

        function getPlatformIcon(link) {
            const lowerLink = link.toLowerCase();
            if (lowerLink.includes('facebook.com') || lowerLink.includes('fb.watch')) return 'fab fa-facebook';
            if (lowerLink.includes('tiktok.com')) return 'fab fa-tiktok';
            if (lowerLink.includes('instagram.com')) return 'fab fa-instagram';
            if (lowerLink.includes('telegram.org') || lowerLink.includes('t.me')) return 'fab fa-telegram';
            if (lowerLink.includes('vimeo.com')) return 'fab fa-vimeo';
            return 'fas fa-external-link-alt';
        }

        // Function to manually mark external videos as complete
        window.markExternalVideoComplete = function(moduleIndex, lessonIndex) {
            const lessonKey = `${moduleIndex}-${lessonIndex}`;
            if (!completedLessons.has(lessonKey)) {
                markLessonAsCompleted(moduleIndex, lessonIndex);
            } else {
                showCourseToast('Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ù…ÙƒØªÙ…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„', {
                    type: 'info',
                    timeout: 6000,
                    title: 'Ù…Ø¹Ù„ÙˆÙ…Ø©'
                });
            }
        };

        // PDF Error Handling and Fallback
        function showPdfFallback(iframe, pdfSrc, lessonTitle) {
            // Hide the iframe
            iframe.style.display = 'none';

            // Show the fallback
            const fallback = iframe.nextElementSibling;
            if (fallback) {
                fallback.style.display = 'flex';
            }

            // Show error toast
            showCourseToast(`âš ï¸ ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ù…Ù„Ù PDF: ${lessonTitle}`, { type: 'error', timeout: 5000 });

            console.error('PDF viewing failed, showing fallback for:', pdfSrc);
        }

        // Navigation functions
        function goToPreviousLesson() {
            if (currentLessonIndex > 0) {
                loadLesson(currentModuleIndex, currentLessonIndex - 1);
            }
        }

        function goToNextLesson() {
            const unit = courseData?.units?.[currentModuleIndex];
            const totalInUnit = unit?.lessons?.length || 0;
            if (currentLessonIndex < totalInUnit - 1) {
                loadLesson(currentModuleIndex, currentLessonIndex + 1);
            }
        }

        function escapeHTML(str){
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m] || m));
        }

        function renderLessonDescription(desc){
            if (!desc) return '<div class="lesson-description">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³</div>';
            const lines = String(desc).split(/\r?\n/);
            const safe = lines.map(l => escapeHTML(l)).join('<br>');
            return `<div class="lesson-description">${safe}</div>`;
        }

        function countTotalLessons() {
            let total = 0;
            if (Array.isArray(courseData?.units)) {
                courseData.units.forEach(u => {
                    if (Array.isArray(u.lessons)) total += u.lessons.length;
                });
            }
            return total;
        }

        function updateCourseSubtitle() {
            const el = document.getElementById('courseSubtitle');
            if (!el) return;
            const total = countTotalLessons();
            el.textContent = total ? `${total} Ø¯Ø±Ø³` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ø¨Ø¹Ø¯';
        }

        function renderCourseContent() {
            const modulesList = document.getElementById('modulesList');
            modulesList.innerHTML = '';

            if (!courseData.units || courseData.units.length === 0) {
                const noEl = document.createElement('div');
                noEl.style.padding = '20px';
                noEl.style.textAlign = 'center';
                noEl.style.color = 'var(--cp-text-muted)';
                noEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ù…ØªØ§Ø­Ø©';
                modulesList.appendChild(noEl);
                return;
            }

            courseData.units.forEach((unit, moduleIndex) => {
                const moduleItem = document.createElement('div');
                moduleItem.className = 'module-item';

                const header = document.createElement('div');
                header.className = 'module-header' + (moduleIndex === 0 ? ' active' : '');
                header.addEventListener('click', () => toggleModule(moduleIndex));

                const title = document.createElement('div');
                title.className = 'module-title';
                title.textContent = unit.title || 'ÙˆØ­Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';

                const toggleIcon = document.createElement('i');
                toggleIcon.className = 'fas fa-chevron-down module-toggle';

                header.appendChild(title);
                header.appendChild(toggleIcon);

                const lessonsWrapper = document.createElement('div');
                lessonsWrapper.className = 'lessons-list' + (moduleIndex === 0 ? ' expanded' : '');
                lessonsWrapper.id = `lessons-${moduleIndex}`;

                if (Array.isArray(unit.lessons)) {
                    unit.lessons.forEach((lesson, lessonIndex) => {
                        const lessonEl = document.createElement('div');
                        lessonEl.className = 'lesson-item' + ((moduleIndex === 0 && lessonIndex === 0) ? ' active' : '');
                        if (completedLessons.has(`${moduleIndex}-${lessonIndex}`)) lessonEl.classList.add('completed');
                        lessonEl.dataset.module = moduleIndex;
                        lessonEl.dataset.lesson = lessonIndex;

                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'lesson-title-sidebar';
                        titleDiv.textContent = lesson.title || 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³';

                        const durDiv = document.createElement('div');
                        durDiv.className = 'lesson-duration';
                        durDiv.textContent = (lesson.duration ? (lesson.duration + ' Ø¯Ù‚Ø§Ø¦Ù‚') : '5 Ø¯Ù‚Ø§Ø¦Ù‚');

                        // Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø§Ù„ØªØ®ØµØµ
                        if (lesson.specialization) {
                            const specializationDiv = document.createElement('div');
                            specializationDiv.className = 'lesson-specialization';
                            
                            const specializationMap = {
                                'cybersecurity': 'Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ',
                                'networks': 'Ø§Ù„Ø´Ø¨ÙƒØ§Øª',
                                'hacking': 'Ø§Ù„Ù‡Ø§ÙƒÙŠÙ†Ø¬ ÙˆØ§Ù„Ø§Ø®ØªØ±Ø§Ù‚',
                                'linux': 'Ù„ÙŠÙ†ÙƒØ³',
                                'bug-bounty': 'Ø¨Ø§Ø¬ Ø¨Ø§ÙˆÙ†ØªÙŠ',
                                'ethical-hacking': 'Ø§Ù„Ù‡Ø§ÙƒÙŠÙ†Ø¬ Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ÙŠ',
                                'malware-analysis': 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø§Ù„Ø®Ø¨ÙŠØ«Ø©',
                                'penetration-testing': 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚',
                                'web-security': 'Ø£Ù…Ø§Ù† Ø§Ù„ÙˆÙŠØ¨',
                                'network-security': 'Ø£Ù…Ø§Ù† Ø§Ù„Ø´Ø¨ÙƒØ§Øª',
                                'incident-response': 'Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø­ÙˆØ§Ø¯Ø«',
                                'forensics': 'Ø§Ù„Ø·Ø¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ Ø§Ù„Ø±Ù‚Ù…ÙŠ',
                                'reverse-engineering': 'Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¹ÙƒØ³ÙŠØ©',
                                'cryptography': 'Ø§Ù„ØªØ´ÙÙŠØ±'
                            };
                            
                            const specText = specializationMap[lesson.specialization] || lesson.specialization;
                            specializationDiv.innerHTML = `<i class="fas fa-tag"></i> <span>${specText}</span>`;
                            lessonEl.appendChild(specializationDiv);
                        }

                        lessonEl.appendChild(titleDiv);
                        lessonEl.appendChild(durDiv);

                        lessonEl.addEventListener('click', () => selectLessonDebounced(moduleIndex, lessonIndex));

                        lessonsWrapper.appendChild(lessonEl);
                    });
                }

                moduleItem.appendChild(header);
                moduleItem.appendChild(lessonsWrapper);
                modulesList.appendChild(moduleItem);
            });

            updateProgress();
            updateCourseSubtitle();
        }

        function loadLessonContent(moduleIndex, lessonIndex, lesson) {
            const contentContainer = document.getElementById('contentContainer');
            if (!lesson) {
                console.error('Lesson is not defined');
                contentContainer.innerHTML = '<div class="error-container"><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù…ØªØ§Ø­.</p></div>';
                return;
            }

            if (isLoadingLesson) return;
            isLoadingLesson = true;

            try {
                if (Array.isArray(_plyrInstances) && _plyrInstances.length) {
                    _plyrInstances.forEach(p => { try { if (p && p.pause) p.pause(); if (p && p.destroy) p.destroy(); } catch(_) {} });
                }
            } catch(_) {}
            _plyrInstances = [];

            contentContainer.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</p>
                </div>
            `;

            setTimeout(async () => {
                try {
                    let link = getLessonLink(lesson);
                    if (!link) {
                        contentContainer.innerHTML = '<div class="error-container"><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù…ØªØ§Ø­ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.</p></div>';
                        return;
                    }

                    let html = '';

                    if (isPdfLink(link)) {
                        let pdfSrc = link;
                        if (!/^https?:\/\//.test(pdfSrc) && !pdfSrc.startsWith('/uploads/') && !pdfSrc.startsWith('/pdfjs/')) {
                            pdfSrc = '/uploads/' + pdfSrc.replace(/^\/+/, '');
                        }
                        const pdfId = `pdf-${moduleIndex}-${lessonIndex}`;
                        // Enhanced PDF viewer with better parameters for improved experience
                        html += `<div class="pdf-container enhanced" id="${pdfId}">
                            <iframe class="pdf-viewer-enhanced" src="/pdfjs/web/viewer.html?file=${encodeURIComponent(pdfSrc)}#zoom=auto&scrollbar=1&toolbar=1&navpanes=1&view=FitH" title="${lesson.title || 'Ù…Ù„Ù PDF'}"></iframe>
                        </div>`;
                        setTimeout(() => { setupPdfCompletionTracking(moduleIndex, lessonIndex, pdfId); }, 500);
                    } else if (isVideoLink(link)) {
                        // Check if it's a YouTube link
                        const isYoutube = link.includes('youtube.com') || link.includes('youtu.be');
                        // Check if it's an external video link (Pexels, Vimeo, etc.)
                        const isExternalVideo = link.includes('pexels.com/') || link.includes('vimeo.com/') || link.includes('dailymotion.com/');
                        // Check if it's a social media video link
                        const isSocialMedia = link.includes('tiktok.com/') || link.includes('instagram.com/') || link.includes('facebook.com/') || link.includes('fb.watch/') || link.includes('telegram.org/') || link.includes('t.me/');

                        if (isYoutube) {
                            let videoId = '';
                            if (link.includes('youtu.be/')) videoId = link.split('youtu.be/')[1].split('?')[0];
                            else if (link.includes('youtube.com/watch')) { try { videoId = new URL(link).searchParams.get('v'); } catch(_) {} }
                            else if (link.includes('youtube.com/embed/')) videoId = link.split('embed/')[1].split('?')[0];
                            else if (link.includes('youtube.com/shorts/')) { const m = link.match(/youtube\.com\/shorts\/([a-zA-Z0-9_-]+)/); videoId = m?.[1] || ''; }

                            if (videoId) {
                                const ytSrc = `https://www.youtube-nocookie.com/embed/${videoId}?playsinline=1&rel=0&modestbranding=1&iv_load_policy=3`;
                                const safeTitle = (lesson && lesson.title) ? escapeHTML(String(lesson.title)) : 'YouTube video';
                                html += `<div class="video-container"><div class="plyr__video-embed"><iframe src="${ytSrc}" title="${safeTitle}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen sandbox="allow-same-origin allow-scripts allow-presentation allow-popups"></iframe></div></div>`;
                            } else {
                                html += `<div class='error-container'><p>Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± ØµØ§Ù„Ø­.</p></div>`;
                            }
                        } else if (isExternalVideo || isSocialMedia) {
                            // Try to embed common providers; if blocked, fallback to external link
                            const lower = link.toLowerCase();
                            const safeTitle = (lesson && lesson.title) ? escapeHTML(String(lesson.title)) : 'External video';

                            if (lower.includes('drive.google.com/file/d/') && lower.includes('/preview')) {
                                // Google Drive preview embeds
                                html += `<div class="video-container"><iframe src="${link}" title="${safeTitle}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe></div>`;
                            } else if (lower.includes('vimeo.com')) {
                                const m = link.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
                                const vid = m ? m[1] : '';
                                if (vid) {
                                    html += `<div class="video-container"><iframe src="https://player.vimeo.com/video/${vid}" title="${safeTitle}" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>`;
                                } else {
                                    const platformName = getPlatformName(link);
                                    html += `<div class=\"video-container external-video-fallback\"><div class=\"external-video-message\"><i class=\"fas fa-external-link-alt\"></i><h3>Ù…Ù‚Ø·Ø¹ ÙÙŠØ¯ÙŠÙˆ Ø®Ø§Ø±Ø¬ÙŠ</h3><p>Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù…Ù† ${platformName} ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ï¿½ï¿½Ø±Ø¶Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§</p><a href=\"${link}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"external-video-link\"><i class=\"fas fa-play-circle\"></i><span>ÙØªØ­ Ø§Ù„Ù…Ù‚Ø·Ø¹ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©</span></a></div></div>`;
                                }
                            } else if (lower.includes('dailymotion.com')) {
                                const m = link.match(/dailymotion\.com\/video\/([a-z0-9]+)/i);
                                const id = m ? m[1] : '';
                                if (id) {
                                    html += `<div class="video-container"><iframe src="https://www.dailymotion.com/embed/video/${id}" title="${safeTitle}" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>`;
                                } else {
                                    const platformName = getPlatformName(link);
                                    html += `<div class=\"video-container external-video-fallback\"><div class=\"external-video-message\"><i class=\"fas fa-external-link-alt\"></i><h3>Ù…Ù‚Ø·Ø¹ ÙÙŠØ¯ÙŠÙˆ Ø®Ø§Ø±Ø¬ÙŠ</h3><p>Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù…Ù† ${platformName} ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§</p><a href=\"${link}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"external-video-link\"><i class=\"fas fa-play-circle\"></i><span>ÙØªØ­ Ø§Ù„Ù…Ù‚Ø·Ø¹ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©</span></a></div></div>`;
                                }
                            } else if (lower.includes('facebook.com') || lower.includes('fb.watch') || lower.includes('tiktok.com') || lower.includes('instagram.com') || lower.includes('telegram.org') || lower.includes('t.me')) {
                                // Social media videos cannot be embedded due to CSP restrictions
                                // Show a nice fallback with platform-specific styling
                                const platformName = getPlatformName(link);
                                const platformIcon = getPlatformIcon(link);
                                html += `<div class="video-container external-video-fallback">
                                    <div class="external-video-message">
                                        <i class="${platformIcon}"></i>
                                        <h3>Ù…Ù‚Ø·Ø¹ ÙÙŠØ¯ÙŠÙˆ Ù…Ù† ${platformName}</h3>
                                        <p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù…Ù‚Ø§Ø·Ø¹ ${platformName} Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù†</p>
                                        <a href="${link}" target="_blank" rel="noopener noreferrer" class="external-video-link">
                                            <i class="fas fa-play-circle"></i>
                                            <span>ÙØªØ­ Ø§Ù„Ù…Ù‚Ø·Ø¹ ÙÙŠ ${platformName}</span>
                                        </a>
                                        <button class="mark-complete-btn" onclick="markExternalVideoComplete(${moduleIndex}, ${lessonIndex})">
                                            <i class="fas fa-check-circle"></i>
                                            <span>ØªØ¹Ù„ÙŠÙ… ÙƒÙ…ÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
                                        </button>
                                    </div>
                                </div>`;
                            } else {
                                // Generic attempt via oEmbed (noembed)
                                try {
                                    const resp = await fetch('https://noembed.com/embed?url=' + encodeURIComponent(link));
                                    if (resp.ok) {
                                        const data = await resp.json();
                                        if (data && data.html) {
                                            html += `<div class="video-container">${data.html}</div>`;
                                        } else {
                                            throw new Error('No oEmbed html');
                                        }
                                    } else {
                                        throw new Error('oEmbed failed');
                                    }
                                } catch (_) {
                                    const platformName = getPlatformName(link);
                                    html += `<div class="video-container external-video-fallback">
                                        <div class="external-video-message">
                                            <i class="fas fa-external-link-alt"></i>
                                            <h3>Ù…Ù‚Ø·Ø¹ ÙÙŠØ¯ÙŠÙˆ Ø®Ø§Ø±Ø¬ÙŠ</h3>
                                            <p>Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù…Ù† ${platformName} ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§</p>
                                            <a href="${link}" target="_blank" rel="noopener noreferrer" class="external-video-link">
                                                <i class="fas fa-play-circle"></i>
                                                <span>ÙØªØ­ Ø§Ù„Ù…Ù‚Ø·Ø¹ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                                            </a>
                                        </div>
                                    </div>`;
                                }
                            }
                        } else {
                            // Handle local video files
                            let videoSrc = link;
                            // Ensure proper path for local videos
                            if (!videoSrc.startsWith('http') && !videoSrc.startsWith('/')) {
                                videoSrc = '/' + videoSrc.replace(/^\/+/, '');
                            }
                            const safeTitle = (lesson && lesson.title) ? escapeHTML(String(lesson.title)) : 'Local video';
                            html += `<div class="video-container">
                                <video id="local-video-${moduleIndex}-${lessonIndex}" class="js-player" playsinline controls>
                                    <source src="${videoSrc}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>`;
                        }
                    } else if (link.startsWith('http')) {
                        html += `<div class="lesson-info"><p class="lesson-description"><a href="${link}" target="_blank" rel="noopener noreferrer">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ÙØªØ­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</a></p></div>`;
                    } else {
                        html += `<div class="error-container"><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ ØµØ§Ù„Ø­ Ù„Ù„Ø¹Ø±Ø¶.</p></div>`;
                    }

                    const descHtml = renderLessonDescription(lesson.description);
                    html += `<div class="lesson-info"><div class="lesson-title"></div>${descHtml}</div>`;

                    contentContainer.innerHTML = html;

                    try {
                        const titleEl = contentContainer.querySelector('.lesson-title');
                        if (titleEl){
                            titleEl.textContent = lesson.title || 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³';
                        }
                    } catch(_) {}

                    if (window.Plyr) {
                        const nodes = Array.from(contentContainer.querySelectorAll('video.js-player, .plyr, .plyr__video-embed'));
                        const created = await initPlyrSequential(nodes);
                        _plyrInstances.push(...created);
                        attachVideoCompletionHandlers(created, moduleIndex, lessonIndex);
                    }

                    updateNavigationButtons();

                } catch (err) {
                    console.error('Error loading lesson content', err);
                    contentContainer.innerHTML = '<div class="error-container"><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p></div>';
                } finally {
                    setTimeout(() => { isLoadingLesson = false; }, 250);
                }
            }, 80);
        }

        let _lastLessonClick = 0;
        function selectLessonDebounced(moduleIndex, lessonIndex) {
            const now = Date.now();
            if (now - _lastLessonClick < 300) return;
            _lastLessonClick = now;
            if (isLoadingLesson) return;
            loadLesson(moduleIndex, lessonIndex);
        }

        function initPlyrSequential(nodeList) {
            return new Promise(resolve => {
                if (!nodeList || nodeList.length === 0) return resolve([]);
                const created = [];
                let i = 0;
                function next() {
                    if (i >= nodeList.length) {
                        resolve(created);
                        return;
                    }
                    try {
                        const p = new Plyr(nodeList[i], {
                            blankVideo: '',
                            youtube: {
                                noCookie: false,
                                rel: 0,
                                iv_load_policy: 3,
                                modestbranding: 1,
                                playsinline: 1
                            }
                        });
                        created.push(p);
                    } catch (e) {
                        console.warn('Plyr init failed for node', e);
                    }
                    i++;
                    requestAnimationFrame(next);
                }
                requestAnimationFrame(next);
            });
        }

        function attachVideoCompletionHandlers(players, moduleIndex, lessonIndex) {
            if (!players || !players.length) return;
            const lessonKey = `${moduleIndex}-${lessonIndex}`;
            players.forEach(p => {
                try {
                    const container = p?.elements?.container;
                    if (container && container.dataset.completionBound === '1') return;
                    if (container) container.dataset.completionBound = '1';
                    
                    // Handle video completion
                    p.on('ended', () => {
                        if (!completedLessons.has(lessonKey)) {
                            markLessonAsCompleted(moduleIndex, lessonIndex);
                        }
                    });

                    // Also track when user watches 90% of the video
                    let hasMarkedAt90 = false;
                    p.on('timeupdate', () => {
                        if (hasMarkedAt90 || completedLessons.has(lessonKey)) return;
                        const duration = p.duration;
                        const currentTime = p.currentTime;
                        if (duration > 0 && currentTime > 0 && (currentTime / duration) >= 0.9) {
                            hasMarkedAt90 = true;
                            markLessonAsCompleted(moduleIndex, lessonIndex);
                        }
                    });
                } catch(_) {}
            });
        }

        function updateProgress() {
            const existingKeys = new Set();
            let totalLessons = 0;
            if (Array.isArray(courseData?.units)) {
                courseData.units.forEach((unit, mIdx) => {
                    if (Array.isArray(unit.lessons)) {
                        unit.lessons.forEach((_, lIdx) => {
                            existingKeys.add(`${mIdx}-${lIdx}`);
                            totalLessons += 1;
                        });
                    }
                });
            }

            // Debug: Log all existing lesson keys
            console.log('Existing lesson keys:', Array.from(existingKeys));

            const prunedCompleted = new Set();
            completedLessons.forEach(key => {
                if (existingKeys.has(key)) prunedCompleted.add(key);
            });
            completedLessons = prunedCompleted;

            // Debug: Log pruned completed lessons
            console.log('Pruned completed lessons:', Array.from(completedLessons));

            const completedCount = completedLessons.size;
            let percentage = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;
            percentage = Math.max(0, Math.min(100, percentage));

            const percEl = document.getElementById('progressPercentage');
            const fillEl = document.getElementById('progressFill');
            if (percEl) percEl.textContent = `${percentage}%`;
            if (fillEl) fillEl.style.width = `${percentage}%`;

            // Detailed debug logging
            console.log('Progress Calculation:', {
                totalLessons,
                completedCount,
                percentage,
                completedLessons: Array.from(completedLessons),
                existingLessons: Array.from(existingKeys)
            });

            // Synchronize visual completion indicators with actual completion data
            document.querySelectorAll('.lesson-item').forEach(lessonItem => {
                const moduleIndex = parseInt(lessonItem.dataset.module);
                const lessonIndex = parseInt(lessonItem.dataset.lesson);
                const lessonKey = `${moduleIndex}-${lessonIndex}`;

                if (completedLessons.has(lessonKey)) {
                    lessonItem.classList.add('completed');
                } else {
                    lessonItem.classList.remove('completed');
                }
            });

            // Force re-calculation if there's a mismatch
            const visualCompletedCount = document.querySelectorAll('.lesson-item.completed').length;
            if (visualCompletedCount !== completedCount) {
                console.warn('Mismatch detected! Visual completed:', visualCompletedCount, 'vs actual completed:', completedCount);

                // Determine which one is more likely correct
                // If we have server-loaded progress, trust the visual indicators
                // If we're calculating from scratch, trust the completedLessons set
                if (visualCompletedCount > completedCount && completedCount > 0) {
                    // Visual indicators show more completions than our set
                    // This suggests server progress was loaded and visuals were updated
                    // Trust the visual indicators in this case
                    console.log('Trusting visual indicators as they show more completions (likely from server load)');
                    const visuallyCompleted = new Set();
                    document.querySelectorAll('.lesson-item.completed').forEach(item => {
                        const moduleIndex = parseInt(item.dataset.module);
                        const lessonIndex = parseInt(item.dataset.lesson);
                        visuallyCompleted.add(`${moduleIndex}-${lessonIndex}`);
                    });
                    completedLessons = visuallyCompleted;
                } else if (completedCount > visualCompletedCount) {
                    // Our set shows more completions than visual indicators
                    // This suggests local tracking is ahead of visuals
                    // Trust our completedLessons set and update visuals
                    console.log('Trusting completedLessons set as it shows more completions (local tracking ahead)');
                    document.querySelectorAll('.lesson-item').forEach(lessonItem => {
                        const moduleIndex = parseInt(lessonItem.dataset.module);
                        const lessonIndex = parseInt(lessonItem.dataset.lesson);
                        const lessonKey = `${moduleIndex}-${lessonIndex}`;

                        if (completedLessons.has(lessonKey)) {
                            lessonItem.classList.add('completed');
                        } else {
                            lessonItem.classList.remove('completed');
                        }
                    });
                }

                // Recalculate with the correct data
                const newCompletedCount = completedLessons.size;
                const newPercentage = totalLessons > 0 ? Math.round((newCompletedCount / totalLessons) * 100) : 0;
                if (percEl) percEl.textContent = `${newPercentage}%`;
                if (fillEl) fillEl.style.width = `${newPercentage}%`;
                console.log('Recalculated progress after sync:', newPercentage + '%');
            }
        }

        function markLessonAsCompleted(moduleIndex, lessonIndex) {
            const lessonKey = `${moduleIndex}-${lessonIndex}`;
            if (completedLessons.has(lessonKey)) {
                console.log(`Lesson ${lessonKey} already completed, skipping`);
                return;
            }

            completedLessons.add(lessonKey);

            const lessonItem = document.querySelector(`[data-module="${moduleIndex}"][data-lesson="${lessonIndex}"]`);
            if (lessonItem) {
                lessonItem.classList.add('completed');
            }

            // Force immediate progress update and save
            updateProgress();
            saveProgress();

            // Show toast notification for lesson completion
            const lesson = courseData?.units?.[moduleIndex]?.lessons?.[lessonIndex];
            const lessonTitle = lesson?.title || 'Ø§Ù„Ø¯Ø±Ø³';

            // Use setTimeout to ensure toast shows after DOM updates
            setTimeout(() => {
                showCourseToast(`ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ${lessonTitle} Ø¨Ù†Ø¬Ø§Ø­!`, {
                    type: 'success',
                    timeout: 5000,
                    title: 'Ø¥Ù†Ø¬Ø§Ø² Ø±Ø§Ø¦Ø¹! ğŸ‰'
                });
            }, 100);
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const unit = courseData?.units?.[currentModuleIndex];
            const totalInUnit = unit?.lessons?.length || 0;
            if (prevBtn) prevBtn.disabled = currentLessonIndex === 0;
            if (nextBtn) nextBtn.disabled = totalInUnit === 0 || currentLessonIndex === totalInUnit - 1;
        }

        function toggleModule(moduleIndex) {
            const lessonsList = document.getElementById(`lessons-${moduleIndex}`);
            if (!lessonsList) return;
            const moduleHeader = lessonsList.previousElementSibling;
            if (moduleHeader) moduleHeader.classList.toggle('active');
            lessonsList.classList.toggle('expanded');
        }

        function loadLesson(moduleIndex, lessonIndex) {
            if (!courseData || !courseData.units || !courseData.units[moduleIndex] || !courseData.units[moduleIndex].lessons[lessonIndex]) {
                return;
            }

            const lesson = courseData.units[moduleIndex].lessons[lessonIndex];

            currentModuleIndex = moduleIndex;
            currentLessonIndex = lessonIndex;

            document.querySelectorAll('.lesson-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const currentLessonItem = document.querySelector(`[data-module="${moduleIndex}"][data-lesson="${lessonIndex}"]`);
            if (currentLessonItem) {
                currentLessonItem.classList.add('active');
            }

            loadLessonContent(moduleIndex, lessonIndex, lesson);
            updateNavigationButtons();
        }

        async function saveProgress() {
            updateProgress();
            const progressData = {
                courseId: courseId,
                userId: currentUserId,
                completedLessons: Array.from(completedLessons),
                lastAccessed: new Date().toISOString()
            };
            // Use user-specific key to prevent cross-user progress sharing
            const storageKey = `courseProgress_${currentUserId}_${courseId}`;
            localStorage.setItem(storageKey, JSON.stringify(progressData));
            console.log(`Saved user-specific progress for ${currentUserId}:`, progressData);

            // Also sync to server - send each completed lesson individually
            try {
                const token = localStorage.getItem('token');
                if (token && courseData && completedLessons.size > 0) {
                    // First, get the actual lesson IDs from course data
                    const lessonIdMap = {};
                    courseData.units?.forEach((unit, moduleIndex) => {
                        unit.lessons?.forEach((lesson, lessonIndex) => {
                            const lessonKey = `${moduleIndex}-${lessonIndex}`;
                            if (lesson._id) {
                                lessonIdMap[lessonKey] = {
                                    unitId: unit._id,
                                    lessonId: lesson._id
                                };
                            }
                        });
                    });

                    console.log('Lesson ID mapping:', lessonIdMap);

                    // Send progress for each completed lesson to ensure all are saved
                    const savePromises = Array.from(completedLessons).map(async (lessonKey) => {
                        try {
                            const [moduleIndex, lessonIndex] = lessonKey.split('-');
                            const lessonInfo = lessonIdMap[lessonKey];

                            if (!lessonInfo) {
                                console.error(`No valid lesson ID found for ${lessonKey}`);
                                return false;
                            }

                            const response = await fetch('/api/progress/complete', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + token
                                },
                                body: JSON.stringify({
                                    courseId: courseId,
                                    unitId: lessonInfo.unitId,
                                    lessonId: lessonInfo.lessonId
                                })
                            });

                            if (!response.ok) {
                                const errorText = await response.text().catch(() => 'Unknown error');
                                console.error(`Failed to save lesson ${lessonKey} progress (${lessonInfo.lessonId}):`, response.status, errorText);
                                return false;
                            }
                            return true;
                        } catch (error) {
                            console.error(`Error saving lesson ${lessonKey} progress:`, error);
                            return false;
                        }
                    });

                    const results = await Promise.all(savePromises);
                    const successCount = results.filter(r => r).length;
                    console.log(`Server progress sync: ${successCount}/${completedLessons.size} lessons saved successfully`);

                    // Also update the overall course progress
                    const totalLessons = courseData.units?.reduce((sum, unit) =>
                        sum + (unit.lessons?.length || 0), 0) || 0;
                    const completedCount = completedLessons.size;
                    const progressPercent = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;

                    // Fetch updated progress summary to ensure we have latest data
                    const summaryResponse = await fetch('/api/progress/summary', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    if (summaryResponse.ok) {
                        const summary = await summaryResponse.json();
                        console.log('Updated progress summary from server:', summary);
                    } else {
                        console.error('Failed to fetch progress summary:', summaryResponse.status);
                    }
                }
            } catch (error) {
                console.error('Failed to sync progress to server:', error);
            }
        }

        function loadProgress() {
            // Use user-specific key to prevent cross-user progress sharing
            const storageKey = `courseProgress_${currentUserId}_${courseId}`;
            const progressData = localStorage.getItem(storageKey);

            if (progressData) {
                try {
                    const data = JSON.parse(progressData);
                    completedLessons = new Set(data.completedLessons || []);
                    console.log('Loaded user-specific progress:', {
                        userId: currentUserId,
                        courseId: courseId,
                        completedLessons: Array.from(completedLessons),
                        count: completedLessons.size
                    });

                    // First update visual completion indicators
                    completedLessons.forEach(lessonKey => {
                        const [moduleIndex, lessonIndex] = lessonKey.split('-');
                        const lessonItem = document.querySelector(`[data-module="${moduleIndex}"][data-lesson="${lessonIndex}"]`);
                        if (lessonItem) {
                            lessonItem.classList.add('completed');
                        }
                    });

                    // Then force update progress to ensure UI is synchronized
                    updateProgress();

                } catch (error) {
                    console.error('Error loading user-specific progress:', error);
                }
            } else {
                console.log('No local progress data found for user:', currentUserId, 'course:', courseId);
                // If no local progress, we'll rely on server progress
                // which will be fetched in the next step
            }
        }

        async function fetchServerProgress() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const response = await fetch('/api/courses/progress/summary', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    console.error('Failed to fetch server progress:', response.status);
                    return;
                }

                const summaries = await response.json();
                const courseSummary = Array.isArray(summaries) ? summaries.find(s => s.courseId === courseId) : null;

                if (courseSummary) {
                    // Validate server data integrity
                    const validationResult = validateServerProgressData(courseSummary);
                    if (!validationResult.valid) {
                        console.error('Invalid server progress data:', validationResult.message);
                        if (validationResult.severe) {
                            // Report this issue to the server for correction
                            reportServerDataIssue(courseSummary);
                        }
                        return;
                    }

                    const serverProgress = Math.max(0, Math.min(100, Math.round(courseSummary.progressPercent)));
                    const percEl = document.getElementById('progressPercentage');
                    const fillEl = document.getElementById('progressFill');

                    // Get current local progress calculation
                    const currentProgress = percEl ? parseInt(percEl.textContent) || 0 : 0;

                    console.log(`Server progress: ${serverProgress}%, Local progress: ${currentProgress}%`);

                    // Enhanced logic with real-time synchronization
                    if (completedLessons.size === 0 && serverProgress > 0) {
                        console.log(`Initializing progress from server: ${currentProgress}% -> ${serverProgress}%`);
                        if (percEl) percEl.textContent = `${serverProgress}%`;
                        if (fillEl) fillEl.style.width = `${serverProgress}%`;

                        // Sync with server data if available
                        if (courseSummary.completedLessons && Array.isArray(courseSummary.completedLessons)) {
                            syncWithServerCompletedLessons(courseSummary.completedLessons);
                        } else {
                            // Estimate based on percentage
                            const totalLessons = countTotalLessons();
                            if (totalLessons > 0) {
                                const estimatedCompleted = Math.round((serverProgress / 100) * totalLessons);
                                console.log(`Server indicates ~${estimatedCompleted} lessons completed`);
                            }
                        }
                    } else if (Math.abs(serverProgress - currentProgress) > 5) {
                        console.log(`Significant progress difference detected: local ${currentProgress}% vs server ${serverProgress}%`);

                        // Implement conflict resolution strategy
                        const resolution = resolveProgressConflict(currentProgress, serverProgress, courseSummary);
                        if (resolution.action === 'use_server') {
                            console.log(`Resolved conflict: Using server progress (${serverProgress}%) as more reliable`);
                            if (percEl) percEl.textContent = `${serverProgress}%`;
                            if (fillEl) fillEl.style.width = `${serverProgress}%`;

                            // Sync completed lessons from server if available
                            if (courseSummary.completedLessons) {
                                syncWithServerCompletedLessons(courseSummary.completedLessons);
                            }
                        } else {
                            console.log(`Resolved conflict: Keeping local progress (${currentProgress}%) as more accurate`);
                            // Send local progress to server to correct it
                            syncLocalProgressToServer();
                        }
                    } else {
                        console.log(`Progress is consistent: local ${currentProgress}% matches server ${serverProgress}%`);
                        // Still do periodic sync to ensure no drift
                        if (Math.random() < 0.1) { // 10% chance to sync periodically
                            syncLocalProgressToServer();
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching server progress:', error);
                // If error persists, try to recover from local storage
                if (completedLessons.size === 0) {
                    console.log('Attempting to recover progress from local storage...');
                    loadProgress();
                }
            }
        }

        function validateServerProgressData(summary) {
            // Validate the server progress data for corruption
            const errors = [];

            // Check if progress percent is within valid range
            if (typeof summary.progressPercent !== 'number' ||
                isNaN(summary.progressPercent) ||
                summary.progressPercent < 0 ||
                summary.progressPercent > 100) {
                errors.push(`Invalid progressPercent: ${summary.progressPercent} (must be 0-100)`);
            }

            // Check if completed count makes sense with total lessons
            if (typeof summary.completedCount === 'number' &&
                typeof summary.totalLessons === 'number' &&
                summary.totalLessons > 0) {
                const calculatedPercent = (summary.completedCount / summary.totalLessons) * 100;
                const percentDiff = Math.abs(calculatedPercent - (summary.progressPercent || 0));

                if (summary.completedCount > summary.totalLessons) {
                    errors.push(`Completed count (${summary.completedCount}) exceeds total lessons (${summary.totalLessons})`);
                }

                if (percentDiff > 10) { // Allow 10% tolerance for rounding
                    errors.push(`Progress percent (${summary.progressPercent}%) doesn't match completed/total ratio (${calculatedPercent.toFixed(1)}%)`);
                }
            }

            // Check for impossible values
            if (summary.completedCount > 1000 || summary.totalLessons > 1000) {
                errors.push(`Unrealistic lesson counts: completed=${summary.completedCount}, total=${summary.totalLessons}`);
            }

            // Check for negative values
            if (summary.completedCount < 0 || summary.totalLessons < 0) {
                errors.push(`Negative lesson counts detected`);
            }

            return {
                valid: errors.length === 0,
                message: errors.join('; '),
                severe: errors.some(err => err.includes('exceeds') || err.includes('Unrealistic') || err.includes('Negative'))
            };
        }

        function resolveProgressConflict(localProgress, serverProgress, serverData) {
            // Strategy for resolving conflicts between local and server progress

            // If server has more recent timestamp, prefer server
            if (serverData.updatedAt && new Date(serverData.updatedAt) > new Date(Date.now() - 300000)) {
                // Server data updated in last 5 minutes - likely more current
                return { action: 'use_server', reason: 'server_data_recent' };
            }

            // If local has more detailed tracking (individual lessons), prefer local
            if (completedLessons.size > 0 && (!serverData.completedLessons || serverData.completedLessons.length === 0)) {
                return { action: 'use_local', reason: 'local_has_detailed_tracking' };
            }

            // If server progress is higher and seems reasonable, prefer server
            if (serverProgress > localProgress && serverProgress <= 100) {
                return { action: 'use_server', reason: 'server_shows_higher_progress' };
            }

            // Default: prefer local as it's more granular and real-time
            return { action: 'use_local', reason: 'local_more_granular' };
        }

        function syncWithServerCompletedLessons(serverCompletedLessons) {
            if (!Array.isArray(serverCompletedLessons)) return;

            console.log('Syncing with server completed lessons:', serverCompletedLessons);

            // Validate each lesson key from server
            const validServerLessons = serverCompletedLessons.filter(lessonKey => {
                if (typeof lessonKey !== 'string') return false;
                const parts = lessonKey.split('-');
                return parts.length === 2 &&
                       !isNaN(parseInt(parts[0])) &&
                       !isNaN(parseInt(parts[1]));
            });

            // Merge server lessons with local lessons
            const newCompletedLessons = new Set(completedLessons);

            validServerLessons.forEach(lessonKey => {
                // Check if this lesson actually exists in our course data
                const [moduleIndex, lessonIndex] = lessonKey.split('-').map(Number);
                const unit = courseData?.units?.[moduleIndex];
                const lesson = unit?.lessons?.[lessonIndex];

                if (unit && lesson) {
                    newCompletedLessons.add(lessonKey);
                } else {
                    console.warn(`Server lesson ${lessonKey} doesn't exist in current course data`);
                }
            });

            // Only update if server provided valid additional completions
            if (newCompletedLessons.size > completedLessons.size) {
                completedLessons = newCompletedLessons;
                console.log(`Synced ${newCompletedLessons.size - completedLessons.size} additional lessons from server`);

                // Update visual indicators
                updateVisualCompletionIndicators();
                updateProgress();
                saveProgress();
            }
        }

        function updateVisualCompletionIndicators() {
            // Update all lesson items to reflect current completion status
            document.querySelectorAll('.lesson-item').forEach(lessonItem => {
                const moduleIndex = parseInt(lessonItem.dataset.module);
                const lessonIndex = parseInt(lessonItem.dataset.lesson);
                const lessonKey = `${moduleIndex}-${lessonIndex}`;

                if (completedLessons.has(lessonKey)) {
                    lessonItem.classList.add('completed');
                } else {
                    lessonItem.classList.remove('completed');
                }
            });
        }

        async function syncLocalProgressToServer() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('No auth token, cannot sync to server');
                    return;
                }

                // Get the actual lesson IDs for server sync
                const lessonIdMap = {};
                let hasValidLessonIds = false;

                if (courseData?.units) {
                    courseData.units.forEach((unit, moduleIndex) => {
                        if (unit._id && unit.lessons) {
                            unit.lessons.forEach((lesson, lessonIndex) => {
                                if (lesson._id) {
                                    const lessonKey = `${moduleIndex}-${lessonIndex}`;
                                    lessonIdMap[lessonKey] = {
                                        unitId: unit._id,
                                        lessonId: lesson._id
                                    };
                                }
                            });
                        }
                    });
                    hasValidLessonIds = Object.keys(lessonIdMap).length > 0;
                }

                if (!hasValidLessonIds) {
                    console.log('No valid lesson IDs available for server sync');
                    return;
                }

                console.log('Syncing local progress to server...');
                const completedLessonIds = [];

                // Convert our lesson keys to server format
                completedLessons.forEach(lessonKey => {
                    const lessonInfo = lessonIdMap[lessonKey];
                    if (lessonInfo) {
                        completedLessonIds.push({
                            unitId: lessonInfo.unitId,
                            lessonId: lessonInfo.lessonId
                        });
                    }
                });

                const response = await fetch('/api/progress/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        courseId: courseId,
                        completedLessons: completedLessonIds,
                        progressPercent: calculateCurrentProgressPercentage()
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Successfully synced progress to server:', result);
                    showCourseToast('ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†Ø¬Ø§Ø­', {
                        type: 'success',
                        timeout: 3000,
                        title: 'Ù…Ø²Ø§Ù…Ù†Ø© Ù†Ø§Ø¬Ø­Ø©'
                    });
                } else {
                    console.error('Failed to sync progress to server:', response.status);
                    const errorText = await response.text().catch(() => 'Unknown error');
                    console.error('Server response:', errorText);
                }

            } catch (error) {
                console.error('Error syncing progress to server:', error);
                // Queue for retry later
                setTimeout(syncLocalProgressToServer, 30000);
            }
        }

        function calculateCurrentProgressPercentage() {
            const totalLessons = countTotalLessons();
            const completedCount = completedLessons.size;
            return totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;
        }

        async function reportServerDataIssue(issueData) {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                console.log('Reporting server data issue to backend...');

                await fetch('/api/courses/progress/report-issue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        courseId: courseId,
                        issueType: 'data_corruption',
                        issueData: issueData,
                        clientInfo: {
                            userAgent: navigator.userAgent,
                            timestamp: new Date().toISOString(),
                            localProgress: {
                                completedCount: completedLessons.size,
                                totalLessons: countTotalLessons(),
                                progressPercent: calculateCurrentProgressPercentage()
                            }
                        }
                    })
                });

            } catch (error) {
                console.error('Failed to report server data issue:', error);
            }
        }

        function showError(message) {
            const contentContainer = document.getElementById('contentContainer');
            const modulesList = document.getElementById('modulesList');
            
            contentContainer.innerHTML = `
                <div class="error-container">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>${message}</h3>
                    <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p>
                    <a href="courses.html"><i class="fa-solid fa-arrow-right"></i><span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙƒÙˆØ±Ø³Ø§Øª</span></a>
                </div>
            `;

            if (modulesList) {
                modulesList.innerHTML = `
                    <div class="error-container">
                        <p>Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ±Ø³</p>
                    </div>
                `;
            }

            document.getElementById('progressPercentage').textContent = '0%';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('courseTitle').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£';
            document.getElementById('mainCourseTitle').textContent = 'Ø­Ø¯Ø« Ø®Ø·ï¿½ï¿½';
            document.getElementById('mainCourseDescription').textContent = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ Ø§Ù„ÙƒÙˆØ±Ø³';
        }

        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');

        function loadIntroductoryVideo(course) {
            const introVideoSection = document.getElementById('introVideoSection');
            const introVideoContainer = document.getElementById('introVideoContainer');

            if (!introVideoSection || !introVideoContainer) {
                console.warn('Intro video elements not found');
                return;
            }

            // Check if course has an introductory video
            // Priority: promoVideo > introVideo > introductoryVideo > (paid courses) first lesson > search in units
            let introVideoUrl = null;

            // Check for promo video first (for paid courses)
            if (course.promoVideo) {
                console.log('Found promoVideo:', course.promoVideo);
                introVideoUrl = course.promoVideo;
            } else if (course.introVideo || course.introductoryVideo) {
                console.log('Found introVideo or introductoryVideo');
                introVideoUrl = course.introVideo || course.introductoryVideo;
            } else if (!course.isFree && course.units && course.units.length > 0) {
                // For paid courses: use the first lesson from the first unit as promo video
                console.log('Paid course detected - using first lesson as promo video');
                const firstUnit = course.units[0];
                if (firstUnit && firstUnit.lessons && firstUnit.lessons.length > 0) {
                    const firstLesson = firstUnit.lessons[0];
                    console.log('Using first lesson as promo:', firstLesson.title);
                    introVideoUrl = getLessonLink(firstLesson);
                }
            }

            // If still no video and course has units, search for marked introductory lesson
            if (!introVideoUrl && course.units && course.units.length > 0) {
                console.log('Searching in units for introductory lesson');
                // Look for a lesson marked as introductory
                for (const unit of course.units) {
                    if (unit.lessons && unit.lessons.length > 0) {
                        const introLesson = unit.lessons.find(lesson =>
                            lesson.title && (lesson.title.includes('ØªØ¹Ø±ÙŠÙÙŠ') ||
                                           lesson.title.includes('Ù…Ù‚Ø¯Ù…Ø©') ||
                                           lesson.title.includes('intro') ||
                                           lesson.isIntroductory)
                        );
                        if (introLesson) {
                            console.log('Found introductory lesson:', introLesson.title);
                            introVideoUrl = getLessonLink(introLesson);
                            break;
                        }
                    }
                }
            }

            if (introVideoUrl) {
                console.log('Loading intro video:', introVideoUrl);
                // Show the intro video section
                introVideoSection.style.display = 'block';

                // Load the video using Plyr (same as course lessons)
                if (isVideoLink(introVideoUrl)) {
                    // YouTube video
                    if (introVideoUrl.includes('youtube.com') || introVideoUrl.includes('youtu.be')) {
                        let videoId = '';
                        if (introVideoUrl.includes('youtu.be/')) {
                            videoId = introVideoUrl.split('youtu.be/')[1].split('?')[0];
                        } else if (introVideoUrl.includes('youtube.com/watch')) {
                            try { videoId = new URL(introVideoUrl).searchParams.get('v'); } catch(_) {}
                        } else if (introVideoUrl.includes('youtube.com/embed/')) {
                            videoId = introVideoUrl.split('embed/')[1].split('?')[0];
                        }
                        
                        if (videoId) {
                            // Use Plyr with YouTube provider
                            introVideoContainer.innerHTML = `<div class="plyr__video-embed" id="intro-player">
                                <iframe src="https://www.youtube-nocookie.com/embed/${videoId}?origin=${window.location.origin}" 
                                        allowfullscreen 
                                        allow="autoplay; encrypted-media; picture-in-picture"
                                        sandbox="allow-same-origin allow-scripts allow-presentation allow-popups">
                                </iframe>
                            </div>`;
                        }
                    } else {
                        // Local video file
                        let videoSrc = introVideoUrl;
                        if (!videoSrc.startsWith('http') && !videoSrc.startsWith('/')) {
                            videoSrc = '/' + videoSrc.replace(/^\/+/, '');
                        }
                        introVideoContainer.innerHTML = `<video id="intro-player" class="js-player" playsinline controls>
                            <source src="${videoSrc}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>`;
                    }

                    // Initialize Plyr for the intro video
                    if (window.Plyr) {
                        setTimeout(() => {
                            const introPlayer = introVideoContainer.querySelector('.plyr__video-embed, video.js-player');
                            if (introPlayer) {
                                new Plyr(introPlayer, {
                                    controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
                                    quality: { default: 720, options: [360, 720, 1080] }
                                });

                                // Clean up duplicate progress bars after Plyr initialization
                                setTimeout(() => {
                                    const plyrInstance = introVideoContainer.querySelector('.plyr');
                                    if (plyrInstance) {
                                        // Hide duplicate progress bars - keep only first
                                        const progressBars = plyrInstance.querySelectorAll('.plyr__progress');
                                        if (progressBars.length > 1) {
                                            for (let i = 1; i < progressBars.length; i++) {
                                                progressBars[i].style.display = 'none';
                                                progressBars[i].style.visibility = 'hidden';
                                                progressBars[i].style.pointerEvents = 'none';
                                            }
                                        }
                                        
                                        // Ensure play button SVG is bright golden
                                        const playBtn = plyrInstance.querySelector('.plyr__play-large svg');
                                        if (playBtn) {
                                            playBtn.setAttribute('style', 'fill: #ffed4e !important; stroke: #ffed4e !important;');
                                            playBtn.querySelectorAll('*').forEach(el => {
                                                el.setAttribute('style', 'fill: #ffed4e !important; stroke: #ffed4e !important;');
                                            });
                                        }
                                    }
                                }, 200);
                            }
                        }, 300);
                    }

                    // Setup download button for local videos
                    const downloadBtn = document.getElementById('downloadPromoBtn');
                    if (downloadBtn && !introVideoUrl.includes('youtube')) {
                        // For local videos or videos served from /uploads
                        if (introVideoUrl.includes('/uploads/') || introVideoUrl.startsWith('/')) {
                            downloadBtn.style.display = 'inline-flex';
                            downloadBtn.style.alignItems = 'center';
                            downloadBtn.style.gap = '6px';
                            downloadBtn.href = introVideoUrl;
                            downloadBtn.download = course.title ? `${course.title}-promo.mp4` : 'promo-video.mp4';
                        }
                    }
                }
            } else {
                // Hide the intro video section if no video found
                console.log('No introductory video found for this course');
                introVideoSection.style.display = 'none';
            }
        }

        async function initializeCourse() {
            const contentContainer = document.getElementById('contentContainer');
            if (!courseId) {
                showError("Ù…Ø¹Ø±Ù Ø§Ù„ÙƒÙˆØ±Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
                return;
            }

            // Initialize user ID for user-specific progress tracking
            try {
                const user = JSON.parse(localStorage.getItem("user"));
                currentUserId = user?._id || user?.id || 'anonymous';
                console.log('Initialized user ID for progress tracking:', currentUserId);
            } catch (error) {
                console.error('Error getting user ID:', error);
                currentUserId = 'anonymous';
            }

            try {
                contentContainer.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ±Ø³...</p>
                    </div>
                `;

                const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') 
                    ? 'http://localhost:5000/api' 
                    : '/api';

                let response = await fetch(`${API_BASE_URL}/courses/${courseId}`);
                
                if (!response.ok) {
                    throw new Error(`ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³: ${response.status}`);
                }

                const course = await response.json();
                
                if (!course) {
                    showError("Ø§Ù„ÙƒÙˆØ±Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
                    return;
                }
                
                courseData = course;
                currentCourse = course;
                
                // determine if course is paid and add paid styling
                const payField = (String(course.pay || '')).toLowerCase();
                const rawPrice = course.price;
                const priceIsStringFree = (typeof rawPrice === 'string' && rawPrice.toLowerCase() === 'free');
                const priceIsZero = rawPrice === 0 || rawPrice === '0' || rawPrice === null || rawPrice === undefined;
                const isFreeFlag = payField === 'free' || priceIsStringFree || priceIsZero || course.isFree === true;
                const isPaid = !isFreeFlag;
                if (isPaid) document.body.classList.add('paid-course-page'); else document.body.classList.remove('paid-course-page');

                // Show premium page for paid courses, regular course display for free courses
                const courseDisplay = document.getElementById('courseDisplay');
                const paidCoursePremium = document.getElementById('paidCoursePremium');

                if (isPaid) {
                    courseDisplay.style.display = 'none';
                    paidCoursePremium.style.display = 'block';

                    // Populate premium page content
                    document.getElementById('premiumCourseTitle').textContent = course.title;
                    document.getElementById('premiumCourseDescription').textContent = course.full_description || course.description || '';

                    // Load introductory video if available
                    loadIntroductoryVideo(course);

                    // Set premium Udemy button click handler
                    const premiumUdemyButton = document.getElementById('premiumUdemyButton');
                    if (premiumUdemyButton) {
                        premiumUdemyButton.onclick = (e) => { 
                            e.preventDefault(); 
                            handleBuyNow(); 
                        };
                    }
                } else {
                    courseDisplay.style.display = 'grid';
                    paidCoursePremium.style.display = 'none';
                }
                
                document.getElementById('courseTitle').textContent = course.title;
                document.getElementById('mainCourseTitle').textContent = course.title;
                document.getElementById('mainCourseDescription').textContent = course.full_description || course.description || '';
                updateCourseSubtitle();
                document.title = course.title;

                // Set course status badge
                const courseStatusEl = document.getElementById('courseStatus');
                if (courseStatusEl) {
                    const statusClass = isPaid ? 'paid' : 'free';
                    const statusText = isPaid ? 'ÙƒÙˆØ±Ø³ Ù…Ø¯ÙÙˆØ¹' : 'ÙƒÙˆØ±Ø³ Ù…Ø¬Ø§Ù†ÙŠ';
                    const statusIcon = isPaid ? 'fas fa-crown' : 'fas fa-check-circle';
                    courseStatusEl.innerHTML = `<span class="status-badge ${statusClass}"><i class="${statusIcon}"></i>${statusText}</span>`;
                }
                
                // Set Udemy button link if available (check server value then localStorage fallback)
                const udemyButton = document.getElementById('udemyButton');
                if (udemyButton) {
                    // helper to show placeholder
                    function showUdemyPlaceholder(){
                        udemyButton.style.display = 'inline-flex';
                        udemyButton.href = '#';
                        udemyButton.onclick = (e) => { e.preventDefault(); alert('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Udemy Ù‚Ø±ÙŠØ¨Ø§Ù‹'); };
                    }

                    let udemyLink = courseData.udemyLink || courseData.udemylink || courseData.udemy || '';
                    if (!udemyLink) {
                        try{
                            const map = JSON.parse(localStorage.getItem('courseUdemyLinks') || '{}');
                            const cid = courseData.id || courseData._id || '';
                            if (cid && map[String(cid)]) udemyLink = map[String(cid)];
                        }catch(e){ /* ignore */ }
                    }

                    // Only show the Udemy button for paid courses. If the course is free, always hide it,
                    // even when a Udemy link exists (prevents showing an external purchase link for free courses).
                    if (isPaid) {
                        udemyButton.style.display = 'inline-flex';
                        udemyButton.onclick = (e) => { 
                            e.preventDefault(); 
                            handleBuyNow(); 
                        };
                    } else {
                      udemyButton.style.display = 'none';
                    }
                }
                
                renderCourseContent();
                
                if (course.units && course.units.length > 0) {
                    let foundModule = -1;
                    let foundLesson = -1;

                    for (let m = 0; m < course.units.length; m++) {
                        const unit = course.units[m];
                        if (!Array.isArray(unit.lessons)) continue;
                        for (let l = 0; l < unit.lessons.length; l++) {
                            const link = getLessonLink(unit.lessons[l]);
                            if (isVideoLink(link)) {
                                foundModule = m;
                                foundLesson = l;
                                break;
                            }
                        }
                        if (foundModule !== -1) break;
                    }

                    if (foundModule === -1) {
                        const firstUnitIndex = course.units.findIndex(u => Array.isArray(u.lessons) && u.lessons.length > 0);
                        if (firstUnitIndex !== -1) {
                            foundModule = firstUnitIndex;
                            foundLesson = 0;
                        }
                    }

                    if (foundModule !== -1 && foundLesson !== -1) {
                        loadLesson(foundModule, foundLesson);
                    }
                }
                
                // Load local progress first
                loadProgress();

                // Give a small delay to ensure local progress is fully processed
                setTimeout(() => {
                    // Then fetch server progress (but local will take precedence)
                    fetchServerProgress();
                }, 100);
                
            } catch (error) {
                console.error('Error loading course:', error);
                showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³");
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (courseId) {
                initializeCourse();
            } else {
                showError("Ù…Ø¹Ø±Ù Ø§Ù„ÙƒÙˆØ±Ø³ ØºÙŠØ± ØµØ­ÙŠØ­");
            }
        });

        function setupPdfCompletionTracking(moduleIndex, lessonIndex, pdfContainerId) {
            const lessonKey = `${moduleIndex}-${lessonIndex}`;
            if (completedLessons.has(lessonKey)) return;
            
            const container = document.getElementById(pdfContainerId);
            if (!container) return;
            
            const iframe = container.querySelector('iframe');
            if (!iframe) return;
            
            let lastPageNumber = 0;
            let totalPages = 0;
            let checkInterval = null;
            let hasReachedLastPage = false;
            
            function checkPdfProgress() {
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (!iframeWindow || !iframeWindow.PDFViewerApplication) return;
                    
                    const pdfViewer = iframeWindow.PDFViewerApplication;
                    if (!pdfViewer || !pdfViewer.pdfDocument) return;
                    
                    if (totalPages === 0 && pdfViewer.pagesCount) {
                        totalPages = pdfViewer.pagesCount;
                    }
                    
                    const currentPage = pdfViewer.page || pdfViewer.currentPageNumber || 0;
                    
                    if (currentPage !== lastPageNumber) {
                        lastPageNumber = currentPage;
                        
                        if (totalPages > 0 && currentPage >= totalPages && !hasReachedLastPage) {
                            hasReachedLastPage = true;
                            if (!completedLessons.has(lessonKey)) {
                                markLessonAsCompleted(moduleIndex, lessonIndex);
                            }
                            
                            if (checkInterval) {
                                clearInterval(checkInterval);
                                checkInterval = null;
                            }
                        }
                    }
                } catch (e) {
                    try {
                        const iframeWindow = iframe.contentWindow;
                        if (iframeWindow && iframeWindow.location && iframeWindow.location.hash) {
                            const hash = iframeWindow.location.hash;
                            const pageMatch = hash.match(/page=(\d+)/);
                            if (pageMatch) {
                                const currentPage = parseInt(pageMatch[1], 10);
                                const numPagesEl = iframe.contentDocument?.getElementById('numPages');
                                if (numPagesEl) {
                                    const totalText = numPagesEl.textContent || '';
                                    const totalMatch = totalText.match(/(\d+)/);
                                    if (totalMatch) {
                                        totalPages = parseInt(totalMatch[1], 10);
                                        if (currentPage >= totalPages && !hasReachedLastPage) {
                                            hasReachedLastPage = true;
                                            if (!completedLessons.has(lessonKey)) {
                                                markLessonAsCompleted(moduleIndex, lessonIndex);
                                            }
                                            if (checkInterval) {
                                                clearInterval(checkInterval);
                                                checkInterval = null;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } catch (e2) {
                        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                    }
                }
            }
            
            iframe.addEventListener('load', () => {
                setTimeout(() => {
                    checkInterval = setInterval(checkPdfProgress, 1500);
                }, 3000);
            }, { once: true });
        }
    </script>
    
  </body>
</html>
