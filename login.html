<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Marhey:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="img/loogo.png">
    <title>تسجيل الدخول - TWM3</title>
</head>
<body>
    <!-- Header -->
    <div dir="rtl" class="header">
        <div class="container">
            <div class="logo">
                <a href="index.html"><img src="img/logo.png" alt="TWM3"></a>
            </div>
            <div id="list" class="links">
                <ul>
                    <li><a href="index.html">الرئيسيه</a></li>
                    <li><a href="courses.html">الكورسات</a></li>
                    <li><a href="portfolio.html">مشاريعنا</a></li>
                    <li class="nav-dropdown">
                        <a href="roadmap.html">مسارات التعلم <i class="fa-solid fa-angle-down"></i></a>
                        <ul class="nav-dropdown-items">
                            <li><a href="frontendroadmap.html">Front End</a></li>
                            <li><a href="backendroadmap.html">Back End</a></li>
                            <li><a href="cybersecurityroadmap.html">Cyber security</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="bars">
                <i id="bars" class="fa-solid fa-bars"></i>
            </div>
            <div class="icon">
                <div id="colorMode" class="theme">
                    <i class="fa-solid fa-moon moon"></i>
                    <i class="fa-solid fa-sun sun"></i>
                </div>
                <a href="store.html"><i class="fa-solid fa-store store"></i></a>
                <a href="login.html"><i class="fa-solid fa-user user"></i></a>
            </div>
        </div>
    </div>

    <!-- Main Login Section -->
    <div class="auth-page">
        <div class="auth-container">
            <!-- Login Form -->
            <div class="auth-form-wrapper login-form active" id="loginForm">
                <div class="auth-header">
                    <div class="auth-icon">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <h2>مرحباً بعودتك</h2>
                    <p>سجل دخولك للوصول إلى حسابك</p>
                </div>

                <form action="/signup" method="post" class="auth-form">
                    <div class="form-group">
                        <label for="login-email">
                            <i class="fas fa-envelope"></i>
                            البريد الإلكتروني
                        </label>
                        <input
                            id="login-email"
                            type="email"
                            name="email"
                            autocomplete="email"
                            placeholder="example@domain.com"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="login-password">
                            <i class="fas fa-lock"></i>
                            كلمة المرور
                        </label>
                        <input
                            id="login-password"
                            type="password"
                            name="password"
                            autocomplete="current-password"
                            placeholder="••••••••"
                            required
                        >
                    </div>

                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" name="remember">
                            <span>تذكرني</span>
                        </label>
                        <a href="#" class="forgot-link">نسيت كلمة المرور؟</a>
                    </div>

                    <button type="button" class="auth-submit-btn" id="login-submit-btn">
                        <span>تسجيل الدخول</span>
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </form>

                <div class="divider">
                    <span>أو سجل دخولك عبر</span>
                </div>

                <div class="social-login">
                    <a href="/api/auth/google" class="social-btn google-btn">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                        <span>Google</span>
                    </a>
                    <a href="/api/auth/github" class="social-btn github-btn">
                        <i class="fab fa-github"></i>
                        <span>GitHub</span>
                    </a>
                </div>

                <div class="auth-switch">
                    <p>ليس لديك حساب؟ <a href="#" id="showSignup">إنشاء حساب جديد</a></p>
                </div>
            </div>

            <!-- Signup Form -->
            <div class="auth-form-wrapper signup-form" id="signupForm">
                <div class="auth-header">
                    <div class="auth-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h2>إنشاء حساب جديد</h2>
                    <p>انضم إلينا وابدأ رحلتك التعليمية</p>
                </div>

                <form action="/signup" method="post" class="auth-form">
                    <div class="form-group">
                        <label for="username">
                            <i class="fas fa-user"></i>
                            اسم المستخدم
                        </label>
                        <input
                            id="username"
                            type="text"
                            name="username"
                            autocomplete="username"
                            placeholder="اسمك الكامل"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="signup-email">
                            <i class="fas fa-envelope"></i>
                            البريد الإلكتروني
                        </label>
                        <input
                            id="signup-email"
                            type="email"
                            name="email"
                            autocomplete="email"
                            placeholder="example@gmail.com"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="signup-password">
                            <i class="fas fa-lock"></i>
                            كلمة المرور
                        </label>
                        <input
                            id="signup-password"
                            type="password"
                            name="password"
                            autocomplete="new-password"
                            placeholder="••••••••"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="repassword">
                            <i class="fas fa-lock"></i>
                            تأكيد كلمة المرور
                        </label>
                        <input
                            id="repassword"
                            type="password"
                            name="password_confirm"
                            autocomplete="new-password"
                            placeholder="••••••••"
                            required
                        >
                    </div>

                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" name="terms" required>
                            <span>أوافق على <a href="terms.html">الشروط والأحكام</a></span>
                        </label>
                    </div>

                    <button type="button" class="auth-submit-btn" id="signup-submit-btn">
                        <span>إنشاء حساب</span>
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </form>

                <div class="divider">
                    <span>أو سجل عبر</span>
                </div>

                <div class="social-login">
                    <a href="/api/auth/google?state=signup" class="social-btn google-btn">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                        <span>Google</span>
                    </a>
                    <a href="/api/auth/github?state=signup" class="social-btn github-btn">
                        <i class="fab fa-github"></i>
                        <span>GitHub</span>
                    </a>
                </div>

                <div class="auth-switch">
                    <p>لديك حساب بالفعل؟ <a href="#" id="showLogin">تسجيل الدخول</a></p>
                </div>
            </div>

            <!-- Decorative Elements -->
            <div class="auth-decoration">
                <div class="decoration-circle circle-1"></div>
                <div class="decoration-circle circle-2"></div>
                <div class="decoration-circle circle-3"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer id="footer">
        <div class="container">
            <div class="social">
                <h4>Social</h4>
                <div class="img">
                    <a href="index.html"><img src="img/logo.png" alt="TWM3" /></a>
                </div>
                <ul>
                    <a target="_blank" href="https://facebook.com/teamworkm3"><img src="img/Facebook-1.png" alt="Facebook" /></a>
                    <a target="_blank" href="https://youtube.com/@twm3"><img src="img/Youtube-1.png" alt="YouTube" /></a>
                    <a target="_blank" href="https://instagram.com/mo_hussien_20"><img src="img/Instagram-1.png" alt="Instagram" /></a>
                    <a target="_blank" href="https://t.me/teamworkm3"><img src="img/Telegram-1.png" alt="Telegram" /></a>
                </ul>
            </div>
            <div class="pages">
                <h4>pages</h4>
                <ul>
                    <li><a href="index.html">الرئيسيه</a></li>
                    <li><a href="courses.html">الكورسات</a></li>
                    <li><a href="portfolio.html">مشاريعنا</a></li>
                    <li><a href="roadmap.html">مسارات التعلم</a></li>
                </ul>
            </div>
            <div class="news">
                <h4>Blog</h4>
                <ul>
                    <li><a target="_blank" href="blog-details.html">ازالة قفل الهاتف</a></li>
                    <li><a target="_blank" href="blog-details2.html">تغيير موقعك على الخريطه</a></li>
                    <li><a target="_blank" href="blog-details3.html">الربح من ثغرات الويب</a></li>
                    <li><a target="_blank" href="blog-details4.html">ازاى تحمى نفسك من الاختراق</a></li>
                </ul>
            </div>
        </div>
        <p>all copy Rights Reserved © <span id="yearData"></span>, created by <span>❤</span> by twm3</p>
        <div class="shape">
            <img class="footer-shape1" src="img/footer-shape-1.svg" alt="" />
            <img class="footer-shape2" src="img/footer-shape-2.svg" alt="" />
        </div>
    </footer>

    <!-- Up to Top Button -->
    <div class="up">
        <i class="fa-solid fa-arrow-up"></i>
    </div>

    <script src="app.js"></script>
    <script>
        // Form Toggle
        const showSignupBtn = document.getElementById('showSignup');
        const showLoginBtn = document.getElementById('showLogin');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');

        showSignupBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.remove('active');
            signupForm.classList.add('active');
        });

        showLoginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            signupForm.classList.remove('active');
            loginForm.classList.add('active');
        });

        // OAuth Token Capture
        (function(){
            function decodeJwtPayload(t){
                try {
                    const base = t.split('.')[1];
                    const json = atob(base.replace(/-/g,'+').replace(/_/g,'/'));
                    return JSON.parse(decodeURIComponent(escape(json)));
                } catch(e){ return null; }
            }
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                const picture = urlParams.get('picture');
                const state = urlParams.get('state');
                if (token) {
                    localStorage.setItem('token', token);
                    const payload = decodeJwtPayload(token);
                    if (payload && (payload.email || payload.username || payload.name)) {
                        let avatarUrl = picture || payload.picture || '';
                        if (!avatarUrl && payload.providerId && payload.provider === 'google') {
                            avatarUrl = `https://lh3.googleusercontent.com/a/${payload.providerId}`;
                        }
                        const minUser = { 
                            _id: payload._id || payload.id || '', 
                            email: payload.email || '', 
                            username: payload.username || '', 
                            name: payload.name || '',
                            avatarUrl: avatarUrl,
                            provider: payload.provider || 'google',
                            providerId: payload.providerId || ''
                        };
                        localStorage.setItem('user', JSON.stringify(minUser));
                    }
                    fetch('/api/user', { headers: { 'Authorization': 'Bearer ' + token } })
                        .then(r => r.ok ? r.json() : null)
                        .then(u => {
                            if (u && u.email) {
                                if (picture && !u.avatarUrl) {
                                    u.avatarUrl = picture;
                                    return fetch('/api/users/me/profile', {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': 'Bearer ' + token
                                        },
                                        body: JSON.stringify({ avatarUrl: picture })
                                    }).then(() => u);
                                }
                                return u;
                            }
                            return null;
                        })
                        .then(u => {
                            if (u) {
                                localStorage.setItem('user', JSON.stringify(u));
                            }
                        })
                        .catch(()=>{})
                        .finally(() => {
                            window.location.replace('/profile.html');
                        });
                }
            } catch(e) { console.error('OAuth token capture failed', e); }
        })();
    </script>
    <script src="config.js"></script>
    <script src="login.js"></script>
</body>
</html>