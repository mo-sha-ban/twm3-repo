<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Marhey:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="img/loogo.png">
    <title>TWM3/Community</title>
    <style>
        .community-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .community-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .community-filters select,
        .community-filters input {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 14px;
            min-width: 160px;
        }
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        .member-card {
            background: #fff;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .member-card:hover {
            transform: translateY(-2px);
        }
        .member-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 12px;
            object-fit: cover;
        }
        .member-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .member-role {
            color: #64748b;
            font-size: 0.9em;
            margin-bottom: 12px;
        }
        .member-stats {
            font-size: 0.85em;
            color: #94a3b8;
        }
        .new-post-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .new-post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .new-post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }
        .new-post-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .new-post-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            resize: vertical;
        }
        .new-post-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .posts-grid {
            display: grid;
            gap: 20px;
        }
        .post-card {
            background:var(--sec-back-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .post-user-info {
            flex: 1;
        }
        .post-username {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-color);
        }
        .post-time {
            color: #64748b;
            font-size: 0.9em;
        }
        .post-content {
            margin-bottom: 16px;
            line-height: 1.6;
            color: var(--text-color);
        }
        .post-actions {
            display: flex;
            gap: 16px;
            color: #64748b;
            font-size: 0.9em;
        }
        .post-action {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .post-action:hover {
            color: #2563eb;
        }
        .btn-primary {
            background: #2563eb;
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-primary:hover {
            background: #1d4ed8;
        }
        .category-label {
            background: #f1f5f9;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.9em;
            color: #475569;
        }
        [data-theme="dark"] .post-card,
        [data-theme="dark"] .new-post-card,
        [data-theme="dark"] .member-card {
            background: #1e293b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .category-label {
            background: #334155;
            color: #e2e8f0;
        }
        [data-theme="dark"] .new-post-input {
            background: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div dir="rtl" class="header">
        <div class="container">
            <div class="logo">
                <a href="index.html"><img src="img/logo.png" alt=""></a>
            </div>
            <div id="list" class="links">
                <ul>
                    <li><a href="index.html">الرئيسيه</a></li>
                    <li><a href="courses.html">الكورسات </a></li>
                    <li><a href="portfolio.html">مشاريعنا </a></li>
                    <li class="nav-dropdown">
                        <a href="roadmap.html">مسارات التعلم <i class="fa-solid fa-angle-down"></i></a>
                        <ul class="nav-dropdown-items">
                            <li><a href="frontendroadmap.html">Front End </a></li>
                            <li><a href="backendroadmap.html">Back End</a></li>
                            <li><a href="cybersecurityroadmap.html">Cyber security</a></li>
                        </ul>
                    </li>
                    <li><a class="blog" href="community.html">المجتمع</a></li>
                </ul>
            </div>
            <div class="bars">
                <i id="bars" class="fa-solid fa-bars"></i>
            </div>
            <div class="icon">
                <div id="colorMode" class="theme">
                    <i class="fa-solid fa-moon moon"></i>
                    <i class="fa-solid fa-sun sun"></i>
                </div>
                <a href="login.html"><i class="fa-solid fa-user user"></i></a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="community-container">
        <div class="main-title" title="المجتمع">
            <h1>المجتمع</h1>
        </div>

        <!-- Filters -->
        <div class="community-filters">
            <select id="categoryFilter">
                <option value="">كل الأقسام</option>
                <option value="questions">أسئلة</option>
                <option value="discussions">نقاشات</option>
                <option value="resources">مصادر</option>
                <option value="projects">مشاريع</option>
            </select>
            <input type="text" id="searchInput" placeholder="ابحث في المنشورات...">
        </div>

        <!-- New Post Form -->
        <div class="new-post-card">
            <div class="new-post-header">
                <img src="img/profile.png" alt="صورة المستخدم" class="new-post-avatar" id="userAvatar">
                <div class="post-user-info">
                    <div class="post-username" id="userName">اسم المستخدم</div>
                </div>
            </div>
            <form class="new-post-form" id="newPostForm">
                <textarea class="new-post-input" placeholder="شارك فكرة، سؤال، أو مصدر مفيد..." required></textarea>
                <div class="new-post-actions">
                    <select name="category" required>
                        <option value="">اختر القسم</option>
                        <option value="questions">سؤال</option>
                        <option value="discussions">نقاش</option>
                        <option value="resources">مصدر</option>
                        <option value="projects">مشروع</option>
                    </select>
                    <button type="submit" class="btn-primary">نشر</button>
                </div>
            </form>
        </div>

        <!-- Members Grid -->
        <h2>أعضاء نشطون</h2>
        <div class="members-grid" id="membersGrid">
            <!-- سيتم تعبئة الأعضاء ديناميكياً -->
        </div>

        <!-- Posts Grid -->
        <div class="posts-grid" id="postsGrid">
            <!-- سيتم تعبئة المنشورات ديناميكياً -->
        </div>
    </main>

    <!-- Footer -->
    <footer id="footer">
        <div class="container">
            <div class="social">
                <h4>تواصل معنا</h4>
                <div class="img">
                    <a href="index.html"><img src="img/logo.png" alt="" /></a>
                </div>
                <ul>
                    <a target="_blank" href="https://facebook.com/teamworkm3"><img src="img/Facebook-1.png" alt="" /></a>
                    <a target="_blank" href="https://youtube.com/@twm3"><img src="img/Youtube-1.png" alt="" /></a>
                    <a target="_blank" href="https://instagram.com/mo_hussien_20"><img src="img/Instagram-1.png" alt=""/></a>
                    <a target="_blank" href="https://t.me/teamworkm3"><img src="img/Telegram-1.png" alt="" /></a>
                </ul>
            </div>
            <div class="pages">
                <h4>الصفحات</h4>
                <ul>
                    <li><a href="index.html">الرئيسية</a></li>
                    <li><a href="courses.html">الكورسات</a></li>
                    <li><a href="portfolio.html">مشاريعنا</a></li>
                    <li><a href="roadmap.html">مسارات التعلم</a></li>
                </ul>
            </div>
            <div class="news">
                <h4>المجتمع</h4>
                <ul>
                    <li><a href="#questions">الأسئلة الشائعة</a></li>
                    <li><a href="#discussions">النقاشات النشطة</a></li>
                    <li><a href="#resources">مصادر التعلم</a></li>
                    <li><a href="#projects">مشاريع الأعضاء</a></li>
                </ul>
            </div>
        </div>
        <p>© جميع الحقوق محفوظة - TeamWork M3</p>
    </footer>

    <!-- Scripts -->
    <script src="app.js"></script>
    <script src="js/ui-toast.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Load current user data
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');

            // Update user info in new post form
            if (user) {
                document.getElementById('userName').textContent = user.name || user.username || 'مستخدم';
                if (user.avatarUrl) {
                    document.getElementById('userAvatar').src = user.avatarUrl;
                }
            }

            // Load active members
            try {
                const membersRes = await fetch('/api/users/active', {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });
                if (membersRes.ok) {
                    const members = await membersRes.json();
                    displayMembers(members);
                }
            } catch (err) {
                console.error('Failed to load members:', err);
            }

            // Load posts
            await loadPosts();

            // Add event listeners
            document.getElementById('categoryFilter').addEventListener('change', loadPosts);
            document.getElementById('searchInput').addEventListener('input', debounce(loadPosts, 300));
            document.getElementById('newPostForm').addEventListener('submit', handleNewPost);
        });

        function displayMembers(members) {
            const grid = document.getElementById('membersGrid');
            if (!Array.isArray(members)) return;

            grid.innerHTML = members.slice(0, 12).map(member => `
                <div class="member-card">
                    <img src="${member.avatarUrl || 'img/profile.png'}" alt="${escapeHtml(member.name)}" class="member-avatar">
                    <div class="member-name">${escapeHtml(member.name || member.username)} ${member.isVerified ? '<i title="موثق" class="fa-solid fa-badge-check" style="color:#06b6d4;margin-inline-start:6px"></i>' : ''}</div>
                    <div class="member-role">${member.isAdmin ? 'مدير' : 'عضو'}</div>
                    <div class="member-stats">
                        ${member.postsCount || 0} منشور • ${member.commentsCount || 0} تعليق
                    </div>
                </div>
            `).join('');
        }

        async function loadPosts() {
            const category = document.getElementById('categoryFilter').value;
            const search = document.getElementById('searchInput').value;
            const token = localStorage.getItem('token');

            try {
                const url = new URL('/api/community/posts', window.location.origin);
                if (category) url.searchParams.set('category', category);
                if (search) url.searchParams.set('search', search);

                const postsRes = await fetch(url, {
                    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
                });

                if (!postsRes.ok) throw new Error('Failed to load posts');
                const posts = await postsRes.json();
                displayPosts(posts);
            } catch (err) {
                console.error('Failed to load posts:', err);
                showToast('خطأ', 'فشل في تحميل المنشورات', 'error');
            }
        }

        function displayPosts(posts) {
            const grid = document.getElementById('postsGrid');
            if (!Array.isArray(posts)) return;

            grid.innerHTML = posts.map(post => `
                <div class="post-card" data-id="${post._id}">
                    <div class="post-header">
                        <img src="${post.author?.avatarUrl || 'img/profile.png'}" alt="" class="new-post-avatar">
                        <div class="post-user-info">
                            <div class="post-username">${escapeHtml(post.author?.name || post.author?.username || 'مستخدم')} ${post.author?.isVerified ? '<i title="موثق" class="fa-solid fa-badge-check" style="color:#06b6d4;margin-inline-start:6px"></i>' : ''}</div>
                            <div class="post-time">${formatDate(post.createdAt)}</div>
                        </div>
                        <span class="category-label">${getCategoryLabel(post.category)}</span>
                    </div>
                    <div class="post-content">${escapeHtml(post.content)}</div>

                    <!-- replies toggle and list -->
                    <div style="margin-top:12px">
                        <button class="btn-primary" type="button" onclick="toggleReplies('${post._id}')">عرض الردود (${Array.isArray(post.replies) ? post.replies.length : 0})</button>
                    </div>
                    <div class="replies-area" id="replies-${post._id}" style="display:none;margin-top:12px">
                        <div class="replies-list">
                            ${Array.isArray(post.replies) ? post.replies.slice(0,5).map(reply => `
                                <div class="reply-item" style="display:flex;gap:10px;margin-top:10px;align-items:flex-start">
                                    <img src="${reply.author?.avatarUrl || 'img/profile.png'}" style="width:40px;height:40px;border-radius:50%;object-fit:cover">
                                    <div style="flex:1">
                                        <div style="font-weight:600">${escapeHtml(reply.author?.name || reply.author?.username || 'مستخدم')} ${reply.author?.isVerified ? '<i title="موثق" class="fa-solid fa-badge-check" style="color:#06b6d4;margin-inline-start:6px"></i>' : ''} <span style="color:#64748b;font-weight:400;font-size:0.85em">• ${formatDate(reply.createdAt)}</span></div>
                                        <div style="margin-top:6px">${escapeHtml(reply.content)}</div>
                                    </div>
                                </div>
                            `).join('') : ''}
                        </div>

                        <!-- inline reply form -->
                        <form class="reply-form" data-post-id="${post._id}" style="margin-top:12px;display:flex;gap:8px;align-items:flex-start">
                            <img src="${(localStorage.getItem('user') && JSON.parse(localStorage.getItem('user')).avatarUrl) || 'img/profile.png'}" style="width:40px;height:40px;border-radius:50%;object-fit:cover">
                            <div style="flex:1">
                                <textarea name="reply" rows="2" placeholder="اكتب ردك..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #e2e8f0"></textarea>
                            </div>
                            <div>
                                <button class="btn-primary" type="submit">رد</button>
                            </div>
                        </form>
                    </div>

                    <div class="post-actions" style="margin-top:12px">
                        <div class="post-action like-action" onclick="handleLike('${post._id}')">
                            <i class="fas fa-heart"></i>
                            <span>${typeof post.likesCount === 'number' ? post.likesCount : (post.likes ? post.likes.length : 0)}</span>
                        </div>
                        <div class="post-action comment-action" onclick="toggleReplies('${post._id}')">
                            <i class="fas fa-comment"></i>
                            <span>${Array.isArray(post.replies) ? post.replies.length : 0}</span>
                        </div>
                        <div class="post-action share-action" onclick="handleShare('${post._id}')">
                            <i class="fas fa-share"></i>
                        </div>
                    </div>
                </div>
            `).join('');

            // attach reply form listeners
            document.querySelectorAll('.reply-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const postId = form.dataset.postId;
                    const textarea = form.querySelector('textarea[name="reply"]');
                    const content = textarea && textarea.value && textarea.value.trim();
                    const token = localStorage.getItem('token');
                    if (!token) { showToast('تنبيه','يجب تسجيل الدخول للتعليق','error'); return; }
                    if (!content) { showToast('تنبيه','اكتب رسالة للرد','error'); return; }
                    try {
                        const res = await fetch(`/api/community/posts/${postId}/replies`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + token
                            },
                            body: JSON.stringify({ content })
                        });
                        if (!res.ok) {
                            const err = await res.json().catch(()=>({error:'فشل'}));
                            throw new Error(err && (err.error || err.message) ? (err.error || err.message) : 'فشل في إضافة الرد');
                        }
                        textarea.value = '';
                        showToast('تم','تم إضافة ردك','success');
                        await loadPosts();
                    } catch (err) {
                        console.error('Reply failed', err);
                        showToast('خطأ', err.message || 'فشل في إضافة الرد', 'error');
                    }
                });
            });
        }

        async function handleNewPost(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('تنبيه', 'يجب تسجيل الدخول لنشر محتوى', 'error');
                return;
            }

            const form = e.target;
            const content = form.querySelector('textarea').value;
            const category = form.querySelector('select').value;

            try {
                const res = await fetch('/api/community/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ content, category })
                });

                if (!res.ok) throw new Error('فشل في إنشاء المنشور');
                
                form.reset();
                showToast('نجاح', 'تم نشر المحتوى بنجاح', 'success');
                await loadPosts();
            } catch (err) {
                console.error('Failed to create post:', err);
                showToast('خطأ', err.message, 'error');
            }
        }

        async function handleLike(postId) {
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('تنبيه', 'يجب تسجيل الدخول للتفاعل', 'error');
                return;
            }

            try {
                const res = await fetch(`/api/community/posts/${postId}/like`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!res.ok) throw new Error('فشل في تسجيل الإعجاب');
                await loadPosts();
            } catch (err) {
                showToast('خطأ', err.message, 'error');
            }
        }

        function handleComment(postId) {
            const token = localStorage.getItem('token');
            if (!token) { showToast('تنبيه', 'يجب تسجيل الدخول للتعليق', 'error'); return; }
            const reply = prompt('اكتب ردك على المنشور:');
            if (!reply) return;
            (async () => {
                try {
                    const res = await fetch(`/api/community/posts/${postId}/replies`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ content: reply })
                    });
                    if (!res.ok) throw new Error('فشل في إضافة الرد');
                    showToast('تم', 'تم إضافة ردك', 'success');
                    await loadPosts();
                } catch (err) {
                    console.error('Reply failed', err);
                    showToast('خطأ', err.message || 'فشل في إضافة الرد', 'error');
                }
            })();
        }

        function handleShare(postId) {
            // TODO: Implement sharing functionality
            const url = `${window.location.origin}/community.html?post=${postId}`;
            navigator.clipboard.writeText(url)
                .then(() => showToast('تم', 'تم نسخ رابط المنشور', 'success'))
                .catch(() => showToast('خطأ', 'فشل في نسخ الرابط', 'error'));
        }

        function getCategoryLabel(category) {
            const labels = {
                'questions': 'سؤال',
                'discussions': 'نقاش',
                'resources': 'مصدر',
                'projects': 'مشروع'
            };
            if (!category) return 'عام';
            return labels[category] || category;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 60) return `منذ ${minutes} دقيقة`;
            if (hours < 24) return `منذ ${hours} ساعة`;
            if (days < 30) return `منذ ${days} يوم`;
            return date.toLocaleDateString('ar-EG');
        }

        function escapeHtml(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function toggleReplies(postId) {
            const repliesArea = document.getElementById(`replies-${postId}`);
            if (repliesArea) {
                const isShowing = repliesArea.style.display !== 'none';
                repliesArea.style.display = isShowing ? 'none' : 'block';
            }
        }

        function showToast(title, message, type = 'info') {
            if (window.__TW_TOAST__) {
                window.__TW_TOAST__.show({
                    title: title,
                    desc: message,
                    danger: type === 'error',
                    durationMs: 3000
                });
            } else {
                alert(`${title}: ${message}`);
            }
        }
    </script>
</body>
</html>