<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Course Modal Test</title>
  <link rel="stylesheet" href="../../css/dashboard.css">
  <style>
    body { font-family: Cairo, sans-serif; padding: 20px; }
    .test-area { max-width: 800px; margin: 0 auto; }
  </style>
</head>
<body>
  <div class="test-area">
    <h2>اختبار نافذة إضافة الكورس</h2>
    <button id="add-course-button" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة كورس</button>

    <!-- Reuse the modal markup from dashboard -->
    <div id="courseModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="courseModalTitle">إضافة / تعديل كورس</h3>
          <button class="modal-close" onclick="window.Courses && window.Courses.closeCourseModal ? window.Courses.closeCourseModal() : document.getElementById('courseModal').classList.remove('show')">&times;</button>
        </div>
        <form id="addCourseForm">
          <div class="form-group">
            <label for="courseTitle">عنوان الكورس</label>
            <input type="text" id="courseTitle" required />
          </div>
          <div class="form-group">
            <label for="courseDescription">وصف الكورس</label>
            <textarea id="courseDescription" rows="3" placeholder="أدخل وصفًا مختصرًا للكورس..."></textarea>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="window.Courses && window.Courses.closeCourseModal ? window.Courses.closeCourseModal() : document.getElementById('courseModal').classList.remove('show')">إلغاء</button>
            <button type="submit" class="btn btn-primary">حفظ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Load scripts: fontawesome, module, delegators already present in dash.js are not needed here -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="./courses.js"></script>
  <script>
    // Avoid automatic fetch in the test harness (no backend running here)
    window.COURSES_SKIP_AUTO_FETCH = true;

    // Lightweight fetch mock: intercept POST/PUT to /api/courses to simulate success
    (function installFetchMock(){
      if (!window.fetch) return;
      const originalFetch = window.fetch.bind(window);
      const mockCourses = [];
      window.fetch = async function(input, init){
        const url = (typeof input === 'string') ? input : (input && input.url) || '';
        const method = (init && init.method) ? init.method.toUpperCase() : 'GET';

        // GET /api/courses -> return current mock list
        if (url && url.endsWith('/api/courses') && method === 'GET') {
          console.log('Mock fetch intercepted GET', url);
          await new Promise(r=>setTimeout(r, 60));
          return new Response(JSON.stringify(mockCourses), { status: 200, headers: { 'Content-Type': 'application/json' } });
        }

        // POST /api/courses -> create a new mock course and return it
        if (url && url.endsWith('/api/courses') && method === 'POST') {
          console.log('Mock fetch intercepted POST', url);
          await new Promise(r=>setTimeout(r, 120));
          let payload = {};
          try { payload = init && init.body ? JSON.parse(init.body) : {}; } catch(e) { payload = {}; }
          const created = Object.assign({ _id: 'mock-course-' + Date.now() }, payload);
          mockCourses.push(created);
          return new Response(JSON.stringify(created), { status: 200, headers: { 'Content-Type': 'application/json' } });
        }

        // PUT /api/courses/:id -> update mock course
        if (url && /\/api\/courses\/[^\/]+$/.test(url) && (method === 'PUT' || method === 'PATCH')) {
          console.log('Mock fetch intercepted PUT/PATCH', url);
          await new Promise(r=>setTimeout(r, 80));
          const id = url.split('/').pop();
          let payload = {};
          try { payload = init && init.body ? JSON.parse(init.body) : {}; } catch(e) { payload = {}; }
          const idx = mockCourses.findIndex(c => c._id === id);
          if (idx >= 0) {
            mockCourses[idx] = Object.assign({}, mockCourses[idx], payload);
            return new Response(JSON.stringify(mockCourses[idx]), { status: 200, headers: { 'Content-Type': 'application/json' } });
          }
          return new Response(JSON.stringify({ error: 'not found' }), { status: 404, headers: { 'Content-Type': 'application/json' } });
        }

        return originalFetch(input, init);
      };
      console.log('Fetch mock installed for /api/courses');
    })();

    // Initialize the module
    try { if (window.Courses && typeof window.Courses.init === 'function') window.Courses.init(); } catch(e){ console.error(e); }

    // Small console helpers
    console.log('Course modal test page loaded. window.Courses:', !!window.Courses);
    document.getElementById('add-course-button').addEventListener('click', function(e){
      e.preventDefault();
      if (window.Courses && typeof window.Courses.openAddCourseModal === 'function') {
        window.Courses.openAddCourseModal();
        console.log('Called window.Courses.openAddCourseModal');
      } else {
        console.warn('Courses module not available');
      }
    });
  </script>
</body>
</html>