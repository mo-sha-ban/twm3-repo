<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Marhey:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="img/loogo.png">
    <title>تسجيل الدخول - TWM3</title>
</head>
<body>
    <!-- Header -->
    <div dir="rtl" class="header">
        <div class="container">
            <div class="logo">
                <a href="index.html"><img src="img/logo.png" alt="TWM3"></a>
            </div>
            <div id="list" class="links">
                <ul>
                    <li><a href="index.html">الرئيسيه</a></li>
                    <li><a href="courses.html">الكورسات</a></li>
                    <li><a href="portfolio.html">مشاريعنا</a></li>
                    <li class="nav-dropdown">
                        <a href="roadmap.html">مسارات التعلم <i class="fa-solid fa-angle-down"></i></a>
                        <ul class="nav-dropdown-items">
                            <li><a href="frontendroadmap.html">Front End</a></li>
                            <li><a href="backendroadmap.html">Back End</a></li>
                            <li><a href="cybersecurityroadmap.html">Cyber security</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="bars">
                <i id="bars" class="fa-solid fa-bars"></i>
            </div>
            <div class="icon">
                <div id="colorMode" class="theme">
                    <i class="fa-solid fa-moon moon"></i>
                    <i class="fa-solid fa-sun sun"></i>
                </div>
                <a href="store.html"><i class="fa-solid fa-store store"></i></a>
                <a href="login.html"><i class="fa-solid fa-user user"></i></a>
            </div>
        </div>
    </div>

    <!-- Main Login Section -->
    <div class="auth-page">
        <div class="auth-container">
            <!-- OAuth Login Form -->
            <div class="auth-form-wrapper oauth-form active" id="oauthForm">
                <div class="auth-header">
                    <div class="auth-icon">
                        <i class="fas fa-sign-in-alt"></i>
                    </div>
                    <h2>مرحباً بك في TWM3</h2>
                    <p>سجل دخولك أو أنشئ حساباً جديداً عبر إحدى المنصات التالية</p>
                </div>

                <div class="oauth-section">
                    <div class="oauth-buttons">
                         <a href="#" class="oauth-btn google-btn">
                             <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                             <span>المتابعة باستخدام Google</span>
                         </a>

                         <a href="#" class="oauth-btn github-btn">
                             <i class="fab fa-github"></i>
                             <span>المتابعة باستخدام GitHub</span>
                         </a>

                         <a href="#" class="oauth-btn microsoft-btn">
                             <i class="fab fa-microsoft"></i>
                             <span>المتابعة باستخدام Microsoft</span>
                         </a>
                 </div>

                    <div class="oauth-info">
                        <p class="oauth-note">
                            <i class="fas fa-info-circle"></i>
                            سيتم إنشاء حساب تلقائياً إذا لم يكن لديك حساب مسبق
                        </p>
                        <p class="oauth-privacy">
                            <i class="fas fa-shield-alt"></i>
                            نحن نحترم خصوصيتك ونستخدم بياناتك بأمان تام
                        </p>
                    </div>
                </div>

                <div class="auth-footer">
                    <p>من خلال المتابعة، أنت توافق على <a href="terms.html">الشروط والأحكام</a></p>
                </div>
            </div>

            <!-- Decorative Elements -->
            <div class="auth-decoration">
                <div class="decoration-circle circle-1"></div>
                <div class="decoration-circle circle-2"></div>
                <div class="decoration-circle circle-3"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer id="footer">
        <div class="footer-container">
            <div class="footer-main">
                <div class="footer-brand">
                    <div class="brand-logo">
                        <img src="img/logo.png" alt="TWM3 Logo" />
                        <div class="logo-glow"></div>
                    </div>
                    <h3>TWM3</h3>
                    <p>فريق عمل متخصص في البرمجة والأمن السيبراني</p>
                </div>

                <div class="footer-links">
                    <h4>روابط سريعة</h4>
                    <ul>
                        <li><a href="index.html">الرئيسية</a></li>
                        <li><a href="courses.html">الكورسات</a></li>
                        <li><a href="portfolio.html">مشاريعنا</a></li>
                        <li><a href="roadmap.html">مسارات التعلم</a></li>
                    </ul>
                </div>

                <div class="footer-social">
                    <h4>تابعنا</h4>
                    <div class="social-links">
                        <a href="https://facebook.com/teamworkm3" target="_blank" class="social-link" title="Facebook">
                            <img src="img/Facebook-1.png" alt="Facebook" />
                        </a>
                        <a href="https://youtube.com/@twm3" target="_blank" class="social-link" title="YouTube">
                            <img src="img/Youtube-1.png" alt="YouTube" />
                        </a>
                        <a href="https://instagram.com/mo_hussien_20" target="_blank" class="social-link" title="Instagram">
                            <img src="img/Instagram-1.png" alt="Instagram" />
                        </a>
                        <a href="https://t.me/teamworkm3" target="_blank" class="social-link" title="Telegram">
                            <img src="img/Telegram-1.png" alt="Telegram" />
                        </a>
                    </div>
                </div>
            </div>

            <div class="footer-copyright">
                <p>&copy; <span id="yearData"></span> جميع الحقوق محفوظة لفريق <span class="brand-highlight">TWM3</span> <i class="fas fa-heart heart"></i></p>
            </div>

            <div class="footer-bg-effects">
                <div class="floating-particles">
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                    <div class="particle"></div>
                </div>
                <div class="wave-effect"></div>
            </div>
        </div>
    </footer>

    <!-- Up to Top Button -->
    <div class="up">
        <i class="fa-solid fa-arrow-up"></i>
    </div>

    <script src="app.js"></script>
    <script src="js/ui-toast.js"></script>
    <script src="js/alert-to-toast.js"></script>
    <script>
        // Load config from backend endpoint /api/config
        document.addEventListener('DOMContentLoaded', function() {
            // Using relative paths is safer and works for both local and prod if served from same origin/proxy
            const googleBtn = document.querySelector('.google-btn');
            const githubBtn = document.querySelector('.github-btn');
            const microsoftBtn = document.querySelector('.microsoft-btn');
            
            // Default to relative paths which should work if /api is proxied
            if (googleBtn) googleBtn.href = '/auth/google';
            if (githubBtn) githubBtn.href = '/auth/github';
            if (microsoftBtn) microsoftBtn.href = '/auth/microsoft';

            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    // Only override if we specifically get a different valid URL and we are not in simple proxy mode
                    // But for this setup, hardcoding relative paths or using the config strictly if needed is key.
                    // The issue was it was falling back to localhost. 
                    
                    // If we want to use the config's base url ONLY if it is not localhost (or if we are on localhost)
                    const apiBaseUrl = config.FRONTEND_BASE_URL;
                    // Intentionally NOT overwriting with apiBaseUrl if it looks like we are in prod but getting localhost
                    // For now, the relative paths set above /auth/google are likely correct given the root mounting in server.js
                })
                .catch(error => console.error('Error loading config:', error));
        });
    </script>
    <script>
        // OAuth Token Capture
        (function(){
            function decodeJwtPayload(t){
                try {
                    const base = t.split('.')[1];
                    const json = atob(base.replace(/-/g,'+').replace(/_/g,'/'));
                    return JSON.parse(decodeURIComponent(escape(json)));
                } catch(e){ return null; }
            }
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                const picture = urlParams.get('picture');
                const state = urlParams.get('state');
                if (token) {
                    localStorage.setItem('token', token);
                    const payload = decodeJwtPayload(token);
                    if (payload && (payload.email || payload.username || payload.name)) {
                        let avatarUrl = picture || payload.picture || '';
                        if (!avatarUrl && payload.providerId && payload.provider === 'google') {
                            avatarUrl = `https://lh3.googleusercontent.com/a/${payload.providerId}`;
                        }
                        const minUser = {
                            _id: payload._id || payload.id || '',
                            email: payload.email || '',
                            username: payload.username || '',
                            name: payload.name || '',
                            avatarUrl: avatarUrl,
                            provider: payload.provider || 'google',
                            providerId: payload.providerId || ''
                        };
                        localStorage.setItem('user', JSON.stringify(minUser));
                    }
                    fetch('/api/user', { headers: { 'Authorization': 'Bearer ' + token } })
                        .then(r => r.ok ? r.json() : null)
                        .then(u => {
                            if (u && u.email) {
                                if (picture && !u.avatarUrl) {
                                    u.avatarUrl = picture;
                                    return fetch('/api/users/me/profile', {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': 'Bearer ' + token
                                        },
                                        body: JSON.stringify({ avatarUrl: picture })
                                    }).then(() => u);
                                }
                                return u;
                            }
                            return null;
                        })
                        .then(u => {
                            if (u) {
                                localStorage.setItem('user', JSON.stringify(u));
                            }
                        })
                        .catch(()=>{})
                        .finally(() => {
                            window.location.replace('index.html');
                        });
                }
            } catch(e) { console.error('OAuth token capture failed', e); }
        })();
    </script>
    <script src="login.js"></script>
</body>
</html>
