<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Tracking Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            direction: ltr;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .test-result {
            padding: 10px;
            margin-top: 10px;
            border-radius: 3px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Progress Tracking Fix Test</h1>
    <p>This test simulates the exact scenario from the logs to verify the fix works correctly.</p>

    <div class="test-section">
        <div class="test-title">Test Scenario: 8/9 Lessons Completed (89% Progress)</div>

        <div class="test-result info">
            <strong>Expected Behavior:</strong>
            <ul>
                <li>Initial calculation should show 0% progress</li>
                <li>After loading server progress (8 completed lessons), should show 89% progress</li>
                <li>Should NOT incorrectly update to 100%</li>
                <li>Visual indicators should match actual completion data</li>
            </ul>
        </div>

        <button onclick="runTest()">Run Test</button>
        <button onclick="resetTest()">Reset Test</button>

        <div id="testOutput" style="margin-top: 20px;"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Test Results Summary</div>
        <div id="summaryOutput"></div>
    </div>

    <script>
        // Mock data to simulate the exact scenario from logs
        const mockCourseData = {
            units: [
                {
                    title: "Module 0",
                    lessons: [
                        { title: "Lesson 0-0" },
                        { title: "Lesson 0-1" },
                        { title: "Lesson 0-2" },
                        { title: "Lesson 0-3" },
                        { title: "Lesson 0-4" },
                        { title: "Lesson 0-5" },
                        { title: "Lesson 0-6" },
                        { title: "Lesson 0-7" },
                        { title: "Lesson 0-8" }
                    ]
                }
            ]
        };

        // Simulated completed lessons from server (8 out of 9)
        const mockServerCompletedLessons = ['0-0', '0-2', '0-1', '0-4', '0-6', '0-7', '0-5', '0-8'];

        let completedLessons = new Set();
        let testResults = [];

        function logTestResult(message, type = 'info') {
            const outputDiv = document.getElementById('testOutput');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            outputDiv.appendChild(resultDiv);

            testResults.push({ message, type, timestamp: new Date() });
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function countTotalLessons() {
            let total = 0;
            if (Array.isArray(mockCourseData?.units)) {
                mockCourseData.units.forEach(u => {
                    if (Array.isArray(u.lessons)) total += u.lessons.length;
                });
            }
            return total;
        }

        function calculateProgress() {
            const totalLessons = countTotalLessons();
            const completedCount = completedLessons.size;
            const percentage = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;

            return {
                totalLessons,
                completedCount,
                percentage: Math.max(0, Math.min(100, percentage)),
                completedLessons: Array.from(completedLessons)
            };
        }

        function simulateLoadProgress() {
            // Simulate loading server progress
            logTestResult('Simulating loadProgress() with server data...', 'info');

            // This simulates the server loading 8 completed lessons
            completedLessons = new Set(mockServerCompletedLessons);

            logTestResult(`Loaded completed lessons: ${Array.from(completedLessons).join(', ')}`, 'info');
            logTestResult(`Total completed lessons: ${completedLessons.size}`, 'info');

            // Calculate progress after loading
            const progress = calculateProgress();
            logTestResult(`Progress calculation after load: ${progress.percentage}% (${progress.completedCount}/${progress.totalLessons})`, 'success');

            return progress;
        }

        function simulateFetchServerProgress(currentProgress) {
            // Simulate the server having 89% progress
            const serverProgress = 89;

            logTestResult(`Simulating fetchServerProgress() - Server progress: ${serverProgress}%`, 'info');
            logTestResult(`Current local progress: ${currentProgress}%`, 'info');

            // This is the fixed logic - should NOT update to 100%
            if (completedLessons.size === 0 && serverProgress > 0) {
                logTestResult(`Initializing progress from server: 0% -> ${serverProgress}%`, 'info');
                return serverProgress;
            } else if (Math.abs(serverProgress - currentProgress) > 5) {
                logTestResult(`Significant progress difference detected: local ${currentProgress}% vs server ${serverProgress}%`, 'warning');
                logTestResult(`Keeping local progress calculation as it's more accurate`, 'success');
                return currentProgress;
            } else {
                logTestResult(`Progress is consistent: local ${currentProgress}% matches server ${serverProgress}%`, 'success');
                return currentProgress;
            }
        }

        function runTest() {
            // Clear previous results
            document.getElementById('testOutput').innerHTML = '';
            testResults = [];
            completedLessons = new Set();

            logTestResult('=== Starting Progress Tracking Test ===', 'info');

            // Step 1: Initial state
            logTestResult('Step 1: Initial state - no lessons completed', 'info');
            let progress = calculateProgress();
            logTestResult(`Initial progress: ${progress.percentage}% (${progress.completedCount}/${progress.totalLessons})`, 'info');

            // Step 2: Load server progress (8 completed lessons)
            logTestResult('Step 2: Loading server progress...', 'info');
            progress = simulateLoadProgress();

            // Step 3: Fetch server progress (should NOT change to 100%)
            logTestResult('Step 3: Fetching server progress...', 'info');
            const finalProgress = simulateFetchServerProgress(progress.percentage);

            // Step 4: Verify the fix
            logTestResult('Step 4: Verifying fix...', 'info');

            if (finalProgress === 89) {
                logTestResult('✅ SUCCESS: Progress correctly shows 89% (not 100%)', 'success');
                logTestResult('✅ The fix is working correctly!', 'success');
            } else {
                logTestResult(`❌ FAILURE: Progress shows ${finalProgress}% instead of expected 89%`, 'error');
                logTestResult('❌ The fix is NOT working correctly!', 'error');
            }

            // Update summary
            updateSummary();
        }

        function resetTest() {
            document.getElementById('testOutput').innerHTML = '';
            testResults = [];
            completedLessons = new Set();
            document.getElementById('summaryOutput').innerHTML = '';
            logTestResult('Test has been reset.', 'info');
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summaryOutput');
            summaryDiv.innerHTML = '';

            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const warningCount = testResults.filter(r => r.type === 'warning').length;
            const infoCount = testResults.filter(r => r.type === 'info').length;

            const summaryHtml = `
                <div class="test-result ${errorCount > 0 ? 'error' : 'success'}">
                    <strong>Test Summary:</strong>
                    <ul>
                        <li>Total test steps: ${testResults.length}</li>
                        <li>Success messages: ${successCount}</li>
                        <li>Error messages: ${errorCount}</li>
                        <li>Warning messages: ${warningCount}</li>
                        <li>Info messages: ${infoCount}</li>
                    </ul>
                </div>

                <div class="test-result info" style="margin-top: 15px;">
                    <strong>Test Conclusion:</strong>
                    ${errorCount > 0 ?
                        '<p style="color: #721c24;">❌ Test FAILED - Issues detected in progress tracking</p>' :
                        '<p style="color: #155724;">✅ Test PASSED - Progress tracking is working correctly</p>'}
                </div>
            `;

            summaryDiv.innerHTML = summaryHtml;
        }
    </script>
</body>
</html>