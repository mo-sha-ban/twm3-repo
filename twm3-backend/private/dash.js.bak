
// إصلاح التهيئة مع الدوال العالمية

// Compatibility shim: setupModalEvents may be called early in older code paths.
// Provide a small delegator to ModalSystem.setupEvents if present, otherwise
// attach a minimal fallback so callers won't get ReferenceError.
function setupModalEvents() {
    try {
        if (typeof ModalSystem !== 'undefined' && ModalSystem && typeof ModalSystem.setupEvents === 'function') {
            return ModalSystem.setupEvents();
        }
    } catch (e) {
        console.warn('setupModalEvents: ModalSystem delegation failed', e);
    }

    // Minimal fallback implementation: close buttons, backdrop click, Esc key
    try {
        document.querySelectorAll('.modal .modal-close').forEach(btn => {
            try { btn.removeEventListener('click', btn.__modal_close__); } catch(e) {}
            const handler = function() {
                const modal = this.closest('.modal');
                if (modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            };
            btn.addEventListener('click', handler);
            btn.__modal_close__ = handler;
        });

        document.querySelectorAll('.modal').forEach(modal => {
            try { modal.removeEventListener('click', modal.__modal_backdrop__); } catch(e) {}
            const handler = function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                    this.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            };
            modal.addEventListener('click', handler);
            modal.__modal_backdrop__ = handler;
        });

        try { document.removeEventListener('keydown', document.__modal_esc__); } catch(e) {}
        const escHandler = function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(m => {
                    try { m.style.display = 'none'; m.classList.remove('show'); } catch(e) {}
                });
                document.body.style.overflow = 'auto';
            }
        };
        document.addEventListener('keydown', escHandler);
        document.__modal_esc__ = escHandler;
    } catch (err) {
        console.warn('setupModalEvents fallback failed', err);
    }
}

// Ensure legacy callers can access the function
try { if (typeof window !== 'undefined') window.setupModalEvents = setupModalEvents; } catch(e) { /* ignore */ }

// Utility function to escape HTML entities (prevent XSS)
function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&"'<>]/g, function (s) {
      return ({'&':'&amp;','"':'&quot;',"'":'&#39;','<':'&lt;','>':'&gt;'})[s];
    });
}

function initializeCoursesModule() {
    console.log('Initializing Courses module with global modal functions...');
    
    if (window.Courses && typeof window.Courses.init === 'function') {
        console.log('Courses module found, calling init...');
            return window.Courses.init();
        
        // ربط الدوال العامة مع الدوال العالمية
        window.openAddCourseModal = function() {
            console.log('Delegating to Courses.openAddCourseModal with global modal');
                if (window.Courses.openAddCourseModal) { 
                window.Courses.openAddCourseModal();
            } else {
                // Fallback مباشر
                openModal('courseModal');
            }
        };
        
        window.editCourse = function(courseId) {
            console.log('Delegating to Courses.openEditCourse for:', courseId);
                if (window.Courses.openEditCourse) { 
                window.Courses.openEditCourse(courseId);
            }
        };
        
        window.manageCourseContent = function(courseId, courseTitle) {
            console.log('Delegating to Courses.manageCourseContent for:', courseId);
                if (window.Courses.manageCourseContent) { 
                window.Courses.manageCourseContent(courseId, courseTitle);
            } else {
                // Fallback مباشر
                openModal('courseContentModal');
            }
        };
        
        window.closeCourseModal = function() {
            console.log('Delegating to Courses.closeCourseModal');
                if (window.Courses.closeCourseModal) { 
                window.Courses.closeCourseModal();
            } else {
                closeModal('courseModal');
            }
        };
        
        window.handleAddCourseSubmit = function(e) {
            console.log('Delegating to Courses.handleAddCourseSubmit');
                if (window.Courses.handleAddCourseSubmit) { 
                window.Courses.handleAddCourseSubmit(e);
            }
        };
        
        console.log('Courses module initialization complete');
        return true;
    } else { 
        console.error('Courses module not available');
        
        // Fallback كامل
        window.openAddCourseModal = function() {
            console.log('Using fallback openAddCourseModal');
            openModal('courseModal');
        };
        
        window.manageCourseContent = function() {
            console.log('Using fallback manageCourseContent');
            openModal('courseContentModal');
        };
        
        window.closeCourseModal = function() {
            console.log('Using fallback closeCourseModal');
            closeModal('courseModal');
        };
        
        return false;
    }
}

// Create simple Courses module if not exists
if (!window.Courses) {
    window.Courses = {
        // دالة فتح نموذج إضافة كورس
        openAddCourseModal: function() {
            console.log('Opening add course modal...');
            const modal = document.getElementById('courseModal');
            if (!modal) {
                console.error('Course modal not found');
                return;
            }
            
            document.getElementById('courseModalTitle').textContent = 'إضافة كورس جديد';
            const form = document.getElementById('addCourseForm');
            if (form) {
                form.reset();
                // Remove any existing hidden id input
                const existingHiddenId = form.querySelector('input[name="id"]');
                if (existingHiddenId) {
                    existingHiddenId.remove();
                }
                // Clear dataset courseId
                delete form.dataset.courseId;
                // Uncheck all checkboxes
                try {
                    document.querySelectorAll('input[name="courseCategories"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    document.querySelectorAll('.category-input').forEach(input => {
                        input.checked = false;
                    });
                } catch (e) { /* ignore */ }
                // Remove any existing listeners and add new one
                form.onsubmit = this.handleAddCourseSubmit.bind(this);
            }
            
            window.editingCourseId = null;
            window.mediaItems = [];
            window.currentPromoVideoId = null;
            
            modal.style.display = 'flex';
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Render empty media grid for new course
            if (typeof window.renderMediaGrid === 'function') {
                setTimeout(() => {
                    window.renderMediaGrid();
                }, 100);
            }
        },

        // دالة معالجة إضافة كورس
        handleAddCourseSubmit: async function(e) {
            e && e.preventDefault && e.preventDefault();
            // prevent double-submit
            if (window._courseSubmitting) {
                console.warn('Course submission already in progress - ignoring duplicate submit');
                return;
            }
            window._courseSubmitting = true;

            // disable submit button(s)
            try { 
                const form = document.getElementById('addCourseForm');
                if (form) {
                    const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.dataset._origText = submitBtn.innerText || submitBtn.value || '';
                        if (submitBtn.tagName.toLowerCase() === 'button') submitBtn.innerText = 'جاري الحفظ...';
                    }
                }
            } catch (e2) { /* ignore */ }

            try {
                const form = document.getElementById('addCourseForm') || document.querySelector('form#courseForm') || null;
                const resolvedTitle = (document.getElementById('courseTitle') && document.getElementById('courseTitle').value.trim()) || (form && (form.querySelector('[name="title"]') && form.querySelector('[name="title"]').value.trim())) || '';
                const resolvedDescription = (document.getElementById('courseDescription') && document.getElementById('courseDescription').value.trim()) || (form && (form.querySelector('[name="description"]') && form.querySelector('[name="description"]').value.trim())) || '';
                const resolvedInstructor = (document.getElementById('courseInstructor') && document.getElementById('courseInstructor').value.trim()) || (form && (form.querySelector('[name="instructor"]') && form.querySelector('[name="instructor"]').value.trim())) || '';
                const resolvedDuration = (document.getElementById('courseDuration') && parseInt(document.getElementById('courseDuration').value)) || (form && (form.querySelector('[name="duration"]') && parseInt(form.querySelector('[name="duration"]').value))) || 1;
                const resolvedPrice = (document.getElementById('coursePrice') && parseFloat(document.getElementById('coursePrice').value)) || (form && (form.querySelector('[name="price"]') && parseFloat(form.querySelector('[name="price"]').value))) || 0;
                const resolvedCategories = (function(){
                    // Try new checkbox method first
                    const checkboxNodes = document.querySelectorAll('input[name="courseCategories"]:checked');
                    if (checkboxNodes && checkboxNodes.length) {
                        // Return array of strings (الأمان السيبراني، تطوير الويب، إلخ)
                        return Array.from(checkboxNodes).map(checkbox => checkbox.value);
                    }
                    
                    // Fallback to old category-input method if available
                    const nodes = document.querySelectorAll('.category-input:checked');
                    if (nodes && nodes.length) return Array.from(nodes).map(i => ({ mainCategory: i.value }));
                    
                    if (form) {
                        const checked = form.querySelectorAll('.category-input:checked');
                        if (checked && checked.length) return Array.from(checked).map(i => ({ mainCategory: i.value }));
                    }
                    return [];
                })();
                const resolvedTags = (function(){
                    const el = document.getElementById('courseTags') || (form && form.querySelector('[name="tags"]'));
                    return el ? (el.value || '').split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                })();
                const resolvedIcon = (document.getElementById('courseIcon') && document.getElementById('courseIcon').value.trim()) || (form && (form.querySelector('[name="icon"]') && form.querySelector('[name="icon"]').value.trim())) || '';

                // attempt to determine editing id from multiple sources (global, hidden input, data attr)
                const editingIdFromForm = (form && (form.querySelector('[name="id"]') && form.querySelector('[name="id"]').value)) || (form && form.dataset && form.dataset.courseId) || null;
                const editingId = window.editingCourseId || editingIdFromForm || null;
                
                // Debug logging
                console.log('handleAddCourseSubmit: editingId determination:', {
                    'window.editingCourseId': window.editingCourseId,
                    'editingIdFromForm': editingIdFromForm,
                    'form.dataset.courseId': form && form.dataset && form.dataset.courseId,
                    'hidden input value': form && form.querySelector('[name="id"]') ? form.querySelector('[name="id"]').value : 'N/A',
                    'final editingId': editingId
                });

                const formData = {
                    title: resolvedTitle,
                    description: resolvedDescription,
                    instructor: resolvedInstructor,
                    duration: resolvedDuration,
                    price: resolvedPrice,
                    isFree: (document.getElementById('pricingFree') && document.getElementById('pricingFree').checked === true),
                    categories: resolvedCategories,
                    tags: resolvedTags,
                    icon: resolvedIcon,
                    promoVideoId: window.currentPromoVideoId || null,
                    udemyLink: (document.getElementById('courseUdemyLink') && document.getElementById('courseUdemyLink').value.trim()) || ''
                };

                // include id in payload for defensive server-side handling (POST edit fallback)
                if (editingId) formData.id = editingId;

                if (!formData.title) {
                    alert('عنوان الكورس مطلوب');
                    return;
                }

                const method = editingId ? 'PUT' : 'POST';
                const url = editingId ? `/api/courses/${editingId}` : '/api/courses';

                console.log('Sending course data:', { method, url, formData });

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(()=>({}));
                    throw new Error(errorData.message || errorData.error || 'فشل في حفظ الكورس');
                }

                const result = await response.json();
                console.log('Course saved successfully:', result);
                
                const successMsg = editingId ? 'تم تحديث الكورس بنجاح!' : 'تم إضافة الكورس بنجاح!';
                alert(successMsg);
                this.closeCourseModal();
                if (typeof fetchCourses === 'function') {
                    fetchCourses();
                }

            } catch (error) {
                console.error('Error saving course:', error);
                alert(`خطأ: ${error.message}`);
            } finally {
                // re-enable submit button and clear submitting flag
                try {
                    const form = document.getElementById('addCourseForm');
                    if (form) {
                        const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            if (submitBtn.tagName.toLowerCase() === 'button') submitBtn.innerText = submitBtn.dataset._origText || 'حفظ';
                        }
                    }
                } catch (e3) { /* ignore */ }
                window._courseSubmitting = false;
            }
        },

        // دالة إغلاق مودال الكورس
        closeCourseModal: function() {
            const modal = document.getElementById('courseModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
                window.editingCourseId = null;
                window.currentPromoVideoId = null;
                window.mediaItems = [];
                
                const form = document.getElementById('addCourseForm');
                if (form) form.reset();
            }
        },

        // دالة فتح تعديل كورس
        openEditCourse: function(courseId) {
            console.log('Opening edit course for:', courseId);
            if (!courseId) {
                alert('معرف الكورس غير صالح');
                return;
            }

            fetch(`/api/courses/${courseId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('فشل في جلب بيانات الكورس');
                return response.json();
            })
            .then(course => {
                const modal = document.getElementById('courseModal');
                if (!modal) return;

                document.getElementById('courseModalTitle').textContent = 'تعديل الكورس';
                document.getElementById('courseTitle').value = course.title || '';
                document.getElementById('courseDescription').value = course.description || '';
                document.getElementById('courseInstructor').value = course.instructor || '';
                document.getElementById('courseDuration').value = course.duration || 1;
                document.getElementById('coursePrice').value = course.price || 0;
                
                // Set Udemy link if available
                try {
                    const udemyLinkInput = document.getElementById('courseUdemyLink');
                    if (udemyLinkInput) {
                        udemyLinkInput.value = course.udemyLink || '';
                    }
                } catch (e) { console.warn('Failed to load Udemy link:', e); }
                
                // Set pricing type based on isFree field
                try {
                    const pricingFree = document.getElementById('pricingFree');
                    const pricingPaid = document.getElementById('pricingPaid');
                    const isFree = course.isFree !== false; // Default to true if not specified
                    
                    if (pricingFree) pricingFree.checked = isFree;
                    if (pricingPaid) pricingPaid.checked = !isFree;
                    
                    // Trigger the toggle to show/hide pricing fields
                    if (typeof window.togglePricingFields === 'function') {
                        window.togglePricingFields();
                    }
                } catch (e) { console.warn('Failed to set pricing type:', e); }
                
                // Set categories checkboxes - both old and new methods
                try {
                    // Method 1: New checkbox method
                    const newCheckboxes = document.querySelectorAll('input[name="courseCategories"]');
                    const categories = Array.isArray(course.categories) ? course.categories : [];
                    
                    newCheckboxes.forEach(checkbox => {
                        // Check if this category is in the course's categories
                        const isChecked = categories.some(cat => {
                            // Handle both string and object formats
                            const catValue = typeof cat === 'string' ? cat : cat.mainCategory;
                            return catValue === checkbox.value;
                        });
                        checkbox.checked = isChecked;
                    });
                    
                    // Method 2: Old category-input method (if available)
                    document.querySelectorAll('.category-input').forEach(input => {
                        input.checked = categories && Array.isArray(categories) && categories.some(c => c.mainCategory === input.value);
                    });
                } catch (e) { /* ignore if elements not present */ }
                
                (function(){ const el = document.getElementById('courseTags'); if (el) el.value = (course.tags || []).join(', '); })();
                document.getElementById('courseIcon').value = course.icon || '';

                window.editingCourseId = courseId;
                
                // Set promo video ID if available
                if (course.promoVideoId) {
                    window.currentPromoVideoId = String(course.promoVideoId);
                } else {
                    window.currentPromoVideoId = null;
                }

                // Ensure a hidden input with the course id exists in the form
                try {
                    const formEl = document.getElementById('addCourseForm');
                    if (formEl) {
                        let hid = formEl.querySelector('input[name="id"]');
                        if (!hid) {
                            hid = document.createElement('input');
                            hid.type = 'hidden';
                            hid.name = 'id';
                            hid.id = 'courseId';
                            formEl.appendChild(hid);
                        }
                        hid.value = courseId;
                        formEl.dataset.courseId = courseId;
                    }
                } catch (e) { console.warn('Failed to inject hidden course id into form', e); }
                
                // Reset media items and set promo video if exists
                if (typeof window.renderMediaGrid === 'function') {
                    window.mediaItems = []; // Clear media items (fresh load for new course editing)
                    window.currentPromoVideoId = course.promoVideoId ? String(course.promoVideoId) : null;
                    setTimeout(() => {
                        if (typeof window.renderMediaGrid === 'function') {
                            window.renderMediaGrid();
                        }
                    }, 100);
                }

                modal.style.display = 'flex';
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';

            })
            .catch(error => {
                console.error('Error loading course:', error);
                alert(`خطأ: ${error.message}`);
            });
        },

        // دالة إدارة محتوى الكورس
        manageCourseContent: function(courseId, courseTitle) {
            console.log('Managing course content:', courseId, courseTitle);
            if (!courseId || !courseTitle) {
                alert('بيانات الكورس غير مكتملة');
                return;
            }

            window.currentCourseId = courseId;
            window.currentCourseTitle = courseTitle;

            const modal = document.getElementById('courseContentModal');
            if (!modal) {
                console.error('Course content modal not found');
                return;
            }

            document.getElementById('courseContentModalTitle').textContent = `إدارة محتوى: ${courseTitle}`;

            // Fetch both course details and content
            Promise.all([
                fetch(`/api/courses/${courseId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                }),
                fetch(`/api/courses/${courseId}/content`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                })
            ])
            .then(([courseResponse, contentResponse]) => {
                if (!courseResponse.ok) throw new Error('فشل في جلب بيانات الكورس');
                if (!contentResponse.ok) throw new Error('فشل في جلب محتوى الكورس');
                return Promise.all([courseResponse.json(), contentResponse.json()]);
            })
            .then(([course, courseContent]) => {
                this.displayCourseContent(courseContent, course);
                modal.style.display = 'flex';
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            })
            .catch(error => {
                console.error('Error loading course content:', error);
                alert(`خطأ: ${error.message}`);
            });
        },

        // دالة عرض محتوى الكورس
        displayCourseContent: function(courseContent, course) {
            const container = document.getElementById('modulesContainer');
            if (!container) {
                console.error('modulesContainer not found');
                return;
            }

            let html = '';

            // Add promotional video section for paid courses
            const isPaid = course && !course.isFree;
            console.log('Course data:', course);
            console.log('Is paid course:', isPaid);
            if (isPaid) {
                console.log('Adding promotional video section for course');
                html += `
                    <div class="promo-video-section" style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">
                        <h4 style="margin: 0 0 15px 0; color: #333;">فيديو ترويجي للكورس</h4>
                        <div class="promo-video-form" style="display: flex; flex-direction: column; gap: 10px;">
                            <div class="form-group">
                                <label for="promoVideoUrl" style="display: block; margin-bottom: 5px; font-weight: bold;">رابط الفيديو الترويجي (YouTube أو Google Drive):</label>
                                <input type="url" id="promoVideoUrl" placeholder="https://www.youtube.com/watch?v=... أو https://drive.google.com/file/d/..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" value="${course.promoVideo || ''}">
                            </div>
                            <div class="form-group">
                                <label for="promoVideoFile" style="display: block; margin-bottom: 5px; font-weight: bold;">أو رفع ملف فيديو:</label>
                                <input type="file" id="promoVideoFile" accept="video/*" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <div class="form-group">
                                <label for="promoThumbnailFile" style="display: block; margin-bottom: 5px; font-weight: bold;">صورة مصغرة (Thumbnail):</label>
                                <input type="file" id="promoThumbnailFile" accept="image/*" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            <button onclick="updatePromoVideo('${window.currentCourseId}')" class="btn btn-primary" style="align-self: flex-start; padding: 8px 16px;">
                                <i class="fas fa-save"></i> حفظ الفيديو الترويجي
                            </button>
                        </div>
                    </div>
                `;
            }

            if (!courseContent.units || courseContent.units.length === 0) {
                html += '<p style="text-align: center; padding: 20px; color: #666;">لا توجد وحدات لهذا الكورس</p>';
            } else {
                html += courseContent.units.map((unit, unitIndex) => `
                    <div class="module-item" style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px;">
                        <div class="module-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0;">الوحدة ${unitIndex + 1}: ${unit.title}</h4>
                            <div class="module-actions">
                                <button onclick="addLessonToUnit('${window.currentCourseId}', '${unit._id}')"
                                        class="btn btn-sm btn-primary" style="margin-left: 8px;">
                                    <i class="fas fa-plus"></i> إضافة درس
                                </button>
                                <button onclick="deleteUnit('${window.currentCourseId}', '${unit._id}')"
                                        class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                        </div>
                        <div class="lessons-list" style="margin-top: 15px;">
                            ${unit.lessons && unit.lessons.length > 0 ?
                                unit.lessons.map((lesson, lessonIndex) => `
                                    <div class="lesson-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                                        <span>الدرس ${lessonIndex + 1}: ${lesson.title}</span>
                                        <div class="lesson-actions">
                                            <button onclick="editLesson('${window.currentCourseId}', '${unit._id}', '${lesson._id}')"
                                                    class="btn btn-sm btn-secondary" style="margin-left: 5px;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteLesson('${window.currentCourseId}', '${unit._id}', '${lesson._id}')"
                                                    class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')
                                : '<p style="text-align: center; color: #999; margin: 10px 0;">لا توجد دروس في هذه الوحدة</p>'
                            }
                        </div>
                    </div>
                `).join('');
            }

            container.innerHTML = html;
        },

        // دالة تحديث الفيديو الترويجي للكورس
        updatePromoVideo: async function(courseId) {
            console.log('updatePromoVideo called with courseId:', courseId);
            const videoUrlInput = document.getElementById('promoVideoUrl');
            const videoFileInput = document.getElementById('promoVideoFile');
            const thumbnailFileInput = document.getElementById('promoThumbnailFile');

            if (!videoUrlInput || !videoFileInput || !thumbnailFileInput) {
                alert('عناصر النموذج غير متوفرة');
                return;
            }

            const videoUrl = videoUrlInput.value.trim();
            const videoFile = videoFileInput.files[0];
            const thumbnailFile = thumbnailFileInput.files[0];

            if (!videoUrl && !videoFile) {
                alert('يرجى إدخال رابط الفيديو أو رفع ملف فيديو');
                return;
            }

            if (videoUrl && videoFile) {
                alert('يرجى اختيار إما رابط الفيديو أو رفع ملف، لا كليهما');
                return;
            }

            const formData = new FormData();

            if (videoUrl) {
                formData.append('promoVideo', videoUrl);
            }

            if (videoFile) {
                formData.append('promoVideoFile', videoFile);
            }

            if (thumbnailFile) {
                formData.append('promoThumbnailFile', thumbnailFile);
            }

            try {
                const response = await fetch(`/api/courses/${courseId}/promo-video`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'فشل في تحديث الفيديو الترويجي');
                }

                const result = await response.json();
                alert('تم تحديث الفيديو الترويجي بنجاح!');

                // Clear file inputs
                videoFileInput.value = '';
                thumbnailFileInput.value = '';

            } catch (error) {
                console.error('Error updating promo video:', error);
                alert(`خطأ: ${error.message}`);
            }
        },

        // دالة إغلاق مودال المحتوى
        closeCourseContentModal: function() {
            const modal = document.getElementById('courseContentModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
                window.currentCourseId = null;
                window.currentCourseTitle = null;
            }
        },

        // جلب الكورسات من الخادم وعرضها
        fetchCourses: async function() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.warn('No token found when fetching courses');
                    return [];
                }
                const resp = await fetch('/api/courses', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!resp.ok) {
                    console.error('Failed to fetch courses', resp.status);
                    return [];
                }
                const data = await resp.json();
                // Delegate to module renderer
                if (typeof this.renderCourses === 'function') this.renderCourses(data);
                return data;
            } catch (err) {
                console.error('Error in Courses.fetchCourses:', err);
                return [];
            }
        },

        // عرض الكورسات في الجدول
    renderCourses(courses) {
      const tbody = document.getElementById('courses-table');
      if (!tbody) return;
      if (!Array.isArray(courses) || courses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">لا توجد كورسات</td></tr>';
        return;
      }
      tbody.innerHTML = courses.map((course, idx) => {
        return `
          <tr>
            <td>${idx + 1}</td>
            <td>${escapeHtml(course.title || '')}</td>
            <td>${escapeHtml((course.description || '').substring(0, 80))}</td>
            <td>${escapeHtml(course.instructor || '')}</td>
            <td>${course.duration || 0} ساعة</td>
            <td>${course.isFree ? 'مجاني' : (course.price || 0) + ' جنيه'}</td>
            <!-- Categories column HIDDEN -->
            <!-- <td>${course.categories && Array.isArray(course.categories) && course.categories.length ? 
              course.categories.map(cat => escapeHtml(getCategoryName(cat.mainCategory))).join('، ') 
              : '---'}</td> -->
            <td>
              <div class="action-buttons">
                  <button class="btn btn-primary" onclick="editCourse('${course._id}')" title="تعديل"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-secondary" onclick="manageCourseContent('${course._id}','${(course.title||'').replace(/'/g, "\\'")}' )" title="محتوى"><i class="fas fa-folder-open"></i></button>
                  <button class="btn btn-danger" onclick="deleteCourse('${course._id}')" title="حذف"><i class="fas fa-trash"></i></button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    },

        // تهيئة الوحدة
        init: function() {
            console.log('Courses module initialized');
        }
    };
}

// Initialize Courses module immediately
if (window.Courses && typeof window.Courses.init === 'function') {
    window.Courses.init();
}





// Format video link for YouTube/Drive embeds
function formatVideoLink(link) {
    if (!link) return '';
    if (link.includes("youtube.com/watch?v=")) {
        const videoId = link.split("v=")[1].split("&")[0];
        return `https://www.youtube.com/embed/${videoId}`;
    }
    if (link.includes("drive.google.com/file/d/")) {
        const match = link.match(/\/d\/(.+?)\//);
        if (match && match[1]) {
            return `https://drive.google.com/file/d/${match[1]}/preview`;
        }
    }
    return link;
}



// فتح نموذج الإضافة
function openAddModal() {
    // Open the Add User modal used in the dashboard HTML (#addUserModal)
    const modal = document.getElementById('addUserModal');
    if (!modal) return console.warn('openAddModal: addUserModal not found');
    modal.classList.add('show');
    const form = document.getElementById('addUserForm');
    if (form && typeof form.reset === 'function') form.reset();
    window.editingUserId = null;
    if (form) {
        try { form.removeEventListener('submit', handleUpdateUserSubmit); } catch(e) {}
        try { form.removeEventListener('submit', addUser); } catch(e) {}
        form.addEventListener('submit', addUser);
    }
}

// إغلاق النموذج
function closeModal() {
    const modal = document.getElementById('addUserModal');
    if (!modal) return console.warn('closeModal: addUserModal not found');
    modal.classList.remove('show');
    window.editingUserId = null;
    const form = document.getElementById('addUserForm');
    if (form) {
        try { form.removeEventListener('submit', handleUpdateUserSubmit); } catch(e) {}
        try { form.removeEventListener('submit', addUser); } catch(e) {}
    }
}



let users = []; // تعريف مصفوفة المستخدمين بشكل عام
// (إزالة تكرار التحميل الأولي للمستخدمين) سيتم التحميل من init الرئيسي


// دالة لجلب البيانات من الخادم
async function fetchUsers() {
    try {
        const token = localStorage.getItem("token");
        if (!token) {
            alert("يجب تسجيل الدخول أولاً!");
            window.location.href = "../../login.html";
            return;
        }

        const response = await fetch("/api/admin/users", {
            headers: {
                Authorization: `Bearer ${token}`,
                Accept: "application/json",
            },
        });

        if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
                alert("انتهت صلاحية الجلسة، يرجى تسجيل الدخول مرة أخرى");
                localStorage.removeItem("token");
                localStorage.removeItem("user");
                window.location.href = "../../login.html";
                return;
            }
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
            throw new Error("Invalid response format");
        }

        const data = await response.json();

        // تحديث المصفوفة 'users' هنا بعد تحميل البيانات
        users = data;

        // بعد تحميل البيانات، نقوم بإعادة رسم المستخدمين في الجدول
        renderUsers(users);  // استدعاء دالة renderUsers لعرض البيانات في الجدول
        console.log("Data fetched:", data);

    } catch (error) {
        console.error("Fetch Error:", error);
        alert(`Error: ${error.message}`);
        if (error.message.includes("401") || error.message.includes("403")) {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            window.location.href = "../../login.html";
        }
    }
}

// دالة لعرض البيانات في الجدول
function renderUsers(users) {
    const tbody = document.getElementById("users-table");
    if (!tbody) {
        console.warn('users-table element not found. Skipping renderUsers');
        return;
    }
    tbody.innerHTML = "";

    if (users.length === 0) {
        tbody.innerHTML = "<tr><td colspan='8'>لا توجد بيانات مستخدمين</td></tr>";
        return;
    }

    users.forEach((user, index) => {
        // Use avatarUrl if provided by backend, otherwise fallback to default profile image
        const avatarSrc = (user && (user.avatarUrl || user.avatar || user.photo)) || '/img/profile.png';

        const row = `
            <tr>
                <td>${index + 1}</td>
                <td>
                    <img src="${avatarSrc}" alt="صورة المستخدم" class="user-avatar" onerror="this.onerror=null;this.src='/img/profile.png'" />
                </td>
                <td>${user.name || ''}</td>
                <td>${user.username || ''}</td>
                <td>${user.email || ''}</td>
                <td>${user.phone || "غير مسجل"}</td>
                <td>
                    <span class="status ${user.isAdmin ? "admin" : "user"}">
                        ${user.isAdmin ? "مدير" : "مستخدم عادي"}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-edit-user" data-userid="${user._id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-delete-user" data-userid="${user._id}">
                            <i class="fas fa-trash"></i> 
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}


// دالة تسجيل الخروج
async function logout() {
    const confirmed = await showConfirm({
        title: 'تأكيد تسجيل الخروج',
        message: 'هل أنت متأكد من تسجيل الخروج من لوحة التحكم؟',
        confirmText: 'نعم، سجل خروجي',
        cancelText: 'إلغاء'
    });
    if (confirmed) {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "../../login.html";
    }
}

// Course delegators are attached later in this file to ensure the Courses module is loaded and to avoid duplicates.


// Ensure functions are in global scope for onclick handlers
window.selectContentType = selectContentType;
window.handleVideoFileSelected = handleVideoFileSelected;
window.removeVideo = removeVideo;
window.handlePdfFileSelected = handlePdfFileSelected;
window.removePdf = removePdf;
window.validateVideoUrl = validateVideoUrl;
window.removeVideoUrl = removeVideoUrl;
window.validatePdfUrl = validatePdfUrl;
window.validateExternalUrl = validateExternalUrl;

// Override delegators to use direct functions
window.openAddCourseModal = function() {
    console.log('Direct openAddCourseModal called');
    if (window.Courses && typeof window.Courses.openAddCourseModal === 'function') {
        return window.Courses.openAddCourseModal();
    } else {
        // Fallback direct implementation
        const modal = document.getElementById('courseModal');
        if (modal) {
            document.getElementById('courseModalTitle').textContent = 'إضافة كورس جديد';
            const form = document.getElementById('addCourseForm');
            if (form) {
                form.reset();
                // Remove any existing hidden id input
                const existingHiddenId = form.querySelector('input[name="id"]');
                if (existingHiddenId) {
                    existingHiddenId.remove();
                }
                // Clear dataset courseId
                delete form.dataset.courseId;
            }
            window.editingCourseId = null;
            window.mediaItems = [];
            window.currentPromoVideoId = null;
            modal.style.display = 'flex';
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            if (typeof window.renderMediaGrid === 'function') {
                setTimeout(() => {
                    window.renderMediaGrid();
                }, 100);
            }
        }
    }
};

window.editCourse = function(courseId) {
    if (window.Courses && typeof window.Courses.openEditCourse === 'function') {
        return window.Courses.openEditCourse(courseId);
    }
};

window.manageCourseContent = function(courseId, courseTitle) {
    if (window.Courses && typeof window.Courses.manageCourseContent === 'function') {
        return window.Courses.manageCourseContent(courseId, courseTitle);
    }
};

window.closeCourseModal = function() {
    if (window.Courses && typeof window.Courses.closeCourseModal === 'function') {
        return window.Courses.closeCourseModal();
    }
};

window.closeCourseContentModal = function() {
    if (window.Courses && typeof window.Courses.closeCourseContentModal === 'function') {
        return window.Courses.closeCourseContentModal();
    }
};

window.updatePromoVideo = function(courseId) {
    if (window.Courses && typeof window.Courses.updatePromoVideo === 'function') {
        return window.Courses.updatePromoVideo(courseId);
    }
};


// تعريف دالة إعداد القائمة الجانبية
function setupSidebarMenu() {
    console.log('Setting up sidebar menu listeners...');
    
    const menuItems = document.querySelectorAll('.menu-item');
    console.log('Found menu items:', menuItems.length);
    
    menuItems.forEach((item, index) => {
        const sectionId = item.getAttribute('href').replace('#', '');
        console.log(`Menu item ${index}:`, sectionId);
        
        // إزالة أي event listeners موجودة مسبقاً
        const newItem = item.cloneNode(true);
        item.parentNode.replaceChild(newItem, item);
        
        // إضافة event listener جديدة
        newItem.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const clickedSectionId = this.getAttribute('href').replace('#', '');
            console.log('Menu item clicked:', clickedSectionId);
            
            switchSection(clickedSectionId);
        });
    });
    
    console.log('Sidebar menu setup complete');
}



// تهيئة الصفحة النهائية
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DASHBOARD INITIALIZATION STARTED ===');
    
    if (window.__dashInit) return;
    window.__dashInit = true;

    // 1. تهيئة أحداث الـ Modals أولاً
    console.log('Step 1: Setting up modal events');
    setupModalEvents();

    // 2. تهيئة Courses module
    console.log('Step 2: Initializing Courses module');
    initializeCoursesModule();

    // 3. تهيئة القائمة الجانبية
    console.log('Step 3: Setting up sidebar menu');
    setupSidebarMenu();

    // 4. ربط أزرار الكورس
    console.log('Step 4: Setting up course buttons');
    const addCourseBtn = document.getElementById('add-course-button');
    if (addCourseBtn) {
        console.log('Found add course button');
        addCourseBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add course button clicked');

            // Diagnostic: ensure modal element exists
            const modal = document.getElementById('courseModal');
            if (!modal) {
                console.error('courseModal element not found');
                return;
            }

            // Prefer canonical API if available
            if (window.Courses && typeof window.Courses.openAddCourseModal === 'function') {
                try {
                    window.Courses.openAddCourseModal();
                    console.log('Called Courses.openAddCourseModal()');
                    return;
                } catch (err) {
                    console.warn('Courses.openAddCourseModal threw', err);
                }
            }

            // Fallback: force show the modal directly
            try {
                console.log('Fallback: forcing courseModal visible');
                modal.style.display = 'flex';
                modal.classList.add('show');
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.zIndex = '20000';
                document.body.style.overflow = 'hidden';
                const first = modal.querySelector('input, textarea, select, button');
                if (first) first.focus();
                // log computed style to help debugging
                const cs = window.getComputedStyle(modal);
                console.log('Modal computed display:', cs.display, 'visibility:', cs.visibility, 'opacity:', cs.opacity);
            } catch (err) {
                console.error('Failed to force-show courseModal', err);
            }
        });
    }

    // 5. ربط نموذج الكورس
    console.log('Step 5: Setting up course form');
    const addCourseForm = document.getElementById('addCourseForm');
    if (addCourseForm) {
        // Replace any existing onsubmit handler so only one handler runs.
        addCourseForm.onsubmit = function(e) {
            e = e || window.event;
            if (e && typeof e.preventDefault === 'function') e.preventDefault();
            console.log('Course form submitted (delegated via onsubmit)');
            try {
                // Prefer Courses module canonical handler
                if (window.Courses && typeof window.Courses.handleAddCourseSubmit === 'function') {
                    return window.Courses.handleAddCourseSubmit(e);
                }
                if (typeof window.handleAddCourseSubmit === 'function') {
                    return window.handleAddCourseSubmit(e);
                }
                alert('وظيفة حفظ الكورس غير متاحة حالياً');
                closeModal('courseModal');
            } catch (err) {
                console.error('Course form delegation failed', err);
                alert('حدث خطأ أثناء حفظ الكورس');
            }
        };
    }

    // 6. تحميل البيانات الأولية
    console.log('Step 6: Loading initial data');
    fetchUsers();
    if (typeof fetchCourses === 'function') fetchCourses();
    if (typeof fetchComments === 'function') fetchComments();

    // 7. تعيين القسم الافتراضي
    console.log('Step 7: Setting default section');
    switchSection('users');

    // 8. Set up user action handlers with event delegation
    document.addEventListener('click', function(e) {
        const editBtn = e.target.closest('.btn-edit-user');
        const deleteBtn = e.target.closest('.btn-delete-user');
        
        if (editBtn) {
            e.preventDefault();
            const userId = editBtn.dataset.userid;
            if (userId) editUser(userId);
        }
        
        if (deleteBtn) {
            e.preventDefault();
            const userId = deleteBtn.dataset.userid;
            if (userId) deleteUser(userId);
        }
    });

    console.log('=== DASHBOARD INITIALIZATION COMPLETE ===');
});






// Modal close functions are now delegated to Courses module


// دالة إضافة كورس (متروكة للتوافق مع الكود القديم)
async function addCourse(courseData) {
    console.log('addCourse function called with:', courseData);
    // هذه الدالة لم تعد مستخدمة، تم استبدالها بـ handleAddCourseSubmit
    // يمكن حذفها لاحقاً
    return Promise.resolve();
}



// دالة إغلاق المودال
// Modal close functions - making them available globally
window.closeCourseModal = function() {
    const modal = document.getElementById('courseModal');
    if (!modal) return;
    
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    const form = document.getElementById('addCourseForm');
    if (form) {
        form.reset();
    }
    
    window.editingCourseId = null;
};

window.closeCourseContentModal = function() {
    const modal = document.getElementById('courseContentModal');
    if (!modal) return;
    
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    window.currentCourseId = null;
    window.currentCourseTitle = null;
};



// دالة إضافة مستخدم معدلة
async function addUser(e) {
    e.preventDefault();
    
    // منع الإرسال المتكرر
    const submitBtn = e.target.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'جاري الإضافة...';
    }

    try {
        // التحقق من وجود العناصر
        const getElement = (id) => {
            const el = document.getElementById(id);
            if (!el) throw new Error(`عنصر ${id} غير موجود`);
            return el;
        };

        const formData = {
            username: getElement('username').value.trim(),
            name: getElement('name').value.trim(),
            email: getElement('email').value.trim(),
            phone: getElement('phone').value.trim(),
            isAdmin: getElement('isAdmin').checked,
            role: getElement('isAdmin').checked ? 'admin' : 'user',
            password: getElement('password').value,
        };

        // التحقق من البيانات المطلوبة
        if (!formData.username || !formData.email || !formData.password || !formData.name) {
            throw new Error('الاسم والمستخدم والبريد وكلمة المرور مطلوبة');
        }

        // إرسال البيانات
        const response = await fetch('/api/admin/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.details || data.error || 'خطأ غير معروف');
        }

        alert('تمت الإضافة بنجاح!');
        document.getElementById('addUserForm').reset();
        closeAddModal();
        fetchUsers();

    } catch (error) {
        console.error('Full Error:', error);
        alert(`فشلت العملية: ${error.message}`);
    } finally {
        // إعادة تفعيل الزر
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'إضافة';
        }
    }
}

// delete user
async function deleteUser(userId) {
    const confirmed = await showConfirm({
        title: 'تأكيد الحذف',
        message: 'هل أنت متأكد من حذف هذا المستخدم؟ لا يمكن التراجع عن هذا الإجراء.',
        confirmText: 'نعم، احذف المستخدم',
        cancelText: 'إلغاء'
    });
    if (!confirmed) return;

    try {
        const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        // التحقق من نوع المحتوى أولاً
        const contentType = response.headers.get('content-type');
        let data;

        if (contentType?.includes('application/json')) {
            data = await response.json();
        } else {
            throw new Error('رد غير متوقع من الخادم');
        }

        if (!response.ok) {
            throw new Error(data.error || 'فشلت عملية الحذف');
        }

        fetchUsers(); // إعادة تحميل البيانات
        alert('تم الحذف بنجاح!');

    } catch (error) {
        console.error('Error:', error);
        alert(`خطأ: ${error.message}`);

        // إعادة توجيه إذا كان الخطأ مصادقة
        if (error.message.includes('401') || error.message.includes('403')) {
            window.location.href = 'login.html';
        }
    }
}






async function editUser(userId) {
    // In your editUser function, make sure the ID is correct
    console.log('Editing user ID:', userId); // Add this to verify
    const confirmed = await showConfirm({
        title: 'تأكيد التعديل',
        message: 'هل أنت متأكد من تعديل بيانات هذا المستخدم؟',
        confirmText: 'نعم، عدل البيانات',
        cancelText: 'إلغاء'
    });
    if (!confirmed) return; // Confirm the action

    // Check if users array is populated
    if (users.length === 0) {
        alert('لا توجد بيانات مستخدمين.');
        return;
    }

    // Find the user based on the userId
    const user = users.find(u => u._id === userId);

    if (!user) {
        alert("المستخدم غير موجود!");
        return;
    }

    // Populate the edit user modal fields with user data
    document.getElementById('editUserId').value = user._id || '';
    document.getElementById('editUserName').value = user.name || '';
    document.getElementById('editUserUsername').value = user.username || '';
    document.getElementById('editUserEmail').value = user.email || '';
    document.getElementById('editUserPhone').value = user.phone || '';
    document.getElementById('editUserRole').value = user.isAdmin ? 'admin' : 'user';

    // Open the edit user modal
    const modal = document.getElementById('editUserModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    // Set the editingUserId in the global scope
window.editingUserId = userId;
const form = document.getElementById('addUserForm');
form.removeEventListener('submit', addUser);
form.addEventListener('submit', handleUpdateUserSubmit);
}

async function handleUpdateUserSubmit(event) {
    event.preventDefault();
    if (!window.editingUserId) {
        alert('No user selected for editing!');
        return;
    }
    // Read from multiple possible field IDs (compatibility across dashboard variants)
    const getVal = (ids) => {
        for (const id of ids) {
            const el = document.getElementById(id);
            if (el) return el.value;
        }
        return '';
    };

    const updatedUserData = {
        name: (getVal(['userName','name','editUserName']) || '').trim(),
        username: (getVal(['userUsername','username','editUserUsername']) || '').trim(),
        email: (getVal(['userEmail','email','editUserEmail']) || '').trim(),
        phone: (getVal(['userPhone','phone','editUserPhone']) || '').trim(),
    };

    // Determine isAdmin from checkbox or role select
    let isAdminVal = null;
    const isAdminEl = document.getElementById('isAdmin');
    if (isAdminEl && (isAdminEl.type === 'checkbox' || isAdminEl.type === 'radio')) {
        isAdminVal = !!isAdminEl.checked;
    }
    if (isAdminVal === null) {
        const roleVal = getVal(['userRole','role','editUserRole']);
        if (roleVal) isAdminVal = roleVal === 'admin' || roleVal === 'true' || roleVal === '1';
    }
    if (isAdminVal !== null) updatedUserData.isAdmin = !!isAdminVal;

    const password = (getVal(['userPassword','password']) || '').trim();
    if (password) {
        updatedUserData.password = password;
    }
    try {
        const response = await fetch(`/api/admin/users/${window.editingUserId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
            },
            body: JSON.stringify(updatedUserData),
        });
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || 'فشلت عملية التعديل');
        }
        alert('تم التعديل بنجاح!');
        closeModal();
        fetchUsers();
    } catch (error) {
        alert(`خطأ: ${error.message}`);
    }
}








// دالة جلب الكورسات - مفوضة إلى Courses module
async function fetchCourses() {
    console.log('fetchCourses called - delegating to Courses module');
    if (window.Courses && typeof window.Courses.fetchCourses === 'function') {
        return window.Courses.fetchCourses();
    } else {
        console.error('Courses.fetchCourses not available');
        // عرض رسالة في الجدول
        const tbody = document.getElementById('courses-table');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="9">وحدة الكورسات غير متاحة</td></tr>';
        }
    }
}

// دالة عرض الكورسات
// وصف الدرس: أزرار رفع صورة/PDF وإدراج رابط
(function setupDescriptionToolbar(){
  document.addEventListener('DOMContentLoaded', () => {
    const uploadBtn = document.getElementById('btnUploadLessonAsset');
    const linkBtn = document.getElementById('btnInsertLink');
    const fileInput = document.getElementById('lessonAssetInput');
    const descTextarea = document.getElementById('lessonDescription');
    if (!uploadBtn || !fileInput || !descTextarea) return;

    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try {
        const fd = new FormData();
        fd.append('file', file);
        const token = localStorage.getItem('token') || '';
        const res = await fetch('http://localhost:5000/api/uploads/lesson-asset', {
          method: 'POST',
          headers: token ? { 'Authorization': 'Bearer ' + token } : {},
          body: fd
        });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || 'فشل رفع الملف');
        }
        const data = await res.json();
        // إدراج الرابط حسب النوع
        if (data.type === 'image') {
          // Markdown صورة
          const url = data.url;
          insertAtCursor(descTextarea, `![صورة الدرس](${url})`);
        } else if (data.type === 'pdf') {
          const url = data.url;
          // رابط PDF يفتح داخل العارض تلقائياً في صفحة الكورس
          insertAtCursor(descTextarea, `[فتح ملف PDF](${url})`);
        }
      } catch (err) {
        alert(err.message || 'فشل رفع الملف');
      } finally {
        e.target.value = '';
      }
    });

    if (linkBtn) {
      linkBtn.addEventListener('click', () => {
        const url = prompt('أدخل الرابط:', 'https://');
        if (!url) return;
        const text = prompt('نص الرابط (اختياري):', 'رابط');
        insertAtCursor(descTextarea, text ? `[${text}](${url})` : url);
      });
    }
  });

  function insertAtCursor(textarea, text){
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);
    textarea.value = before + text + after;
    const pos = start + text.length;
    textarea.selectionStart = textarea.selectionEnd = pos;
    textarea.focus();
  }
})();

function renderCourses(courses) {
    // delegated to Courses module if available
    if (window.Courses && typeof window.Courses.renderCourses === 'function') {
        return window.Courses.renderCourses(courses);
    }
}

// دالة لتحويل رمز التصنيف إلى اسم عربي
function getCategoryName(category) {
    const categories = {
        'programming': 'البرمجة',
        'cybersecurity': 'الأمن السيبراني',
        'web-development': 'تطوير الويب',
        'mobile-development': 'تطوير الموبايل',
        'other': 'أخرى'
    };
    return categories[category] || category;
}


async function deleteCourse(courseId) {
    const confirmed = await showConfirm({
        title: 'تأكيد حذف الكورس',
        message: 'هل أنت متأكد من حذف هذا الكورس؟ سيتم حذف جميع الوحدات والدروس المرتبطة به.',
        confirmText: 'نعم، احذف الكورس',
        cancelText: 'إلغاء'
    });
    if (!confirmed) return;

    try {
        // Validate courseId
        if (!courseId || typeof courseId !== 'string') {
            throw new Error('معرف الكورس غير صالح');
        }

        console.log('Attempting to delete course ID:', courseId); // Debug log

        const response = await fetch(`/api/courses/${courseId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Accept': 'application/json' // Explicitly request JSON
            }
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const errorText = await response.text();
            console.error('Server returned HTML instead of JSON:', errorText);
            throw new Error('استجابة غير متوقعة من الخادم');
        }

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || `فشل في حذف الكورس (${response.status})`);
        }

        const result = await response.json();
        console.log('Delete successful:', result); // Debug log
        alert('تم حذف الكورس بنجاح!');
        fetchCourses(); // Refresh the courses list

    } catch (error) {
        console.error('Error deleting course:', error);
        alert(`خطأ في حذف الكورس: ${error.message}`);
        
        // If unauthorized, redirect to login
        if (error.message.includes('401') || error.message.includes('403')) {
            window.location.href = 'login.html';
        }
    }
}






// Course actions - making them available globally
// توحيد دوال فتح المودالات الخاصة بالكورسات
window.editCourse = function(courseId) {
    // delegate
    if (window.Courses && typeof window.Courses.openEditCourse === 'function') {
        return window.Courses.openEditCourse(courseId);
    }
};

window.manageCourseContent = function(courseId, courseTitle) {
    if (window.Courses && typeof window.Courses.manageCourseContent === 'function') {
        return window.Courses.manageCourseContent(courseId, courseTitle);
    }
};
// Delegate update course submission to Courses module
async function handleUpdateCourseSubmit(e) {
    if (window.Courses && typeof window.Courses.handleAddCourseSubmit === 'function') {
        return window.Courses.handleAddCourseSubmit(e);
    }
    e && e.preventDefault && e.preventDefault();
    console.warn('handleUpdateCourseSubmit delegated: Courses module not available');
}

// دالة إضافة كورس (موجودة لديك بالفعل)








// Comment management functions
async function fetchComments(page = 1, filter = 'all', search = '') {
    try {
        const response = await fetch(`/api/comments?page=${page}&filter=${filter}&search=${search}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (response.status === 404) {
            console.warn('Comments API returned 404 — comments endpoint may not be implemented on backend');
            renderComments([]);
            updatePagination(0, 0);
            return;
        }

        if (!response.ok) {
            throw new Error('فشل في جلب التعليقات');
        }

        const data = await response.json();
        renderComments(data.comments);
        updatePagination(data.currentPage, data.totalPages);
    } catch (error) {
        console.error('Error fetching comments:', error);
        alert(`خطأ: ${error.message}`);
    }
}

function renderComments(comments) {
    const container = document.getElementById('comments-container');
    if (!container) return;

    if (!comments || comments.length === 0) {
        container.innerHTML = '<div class="no-comments">لا توجد تعليقات</div>';
        return;
    }

    container.innerHTML = comments.map(comment => `
        <div class="comment-item" data-id="${comment._id}">
            <div class="comment-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="comment-content">
                <div class="comment-header">
                    <h4 class="comment-author">${(comment.user && comment.user.name) || (comment.author && comment.author.name) || 'مستخدم'}</h4>
                    <span class="comment-date">
                        <i class="fas fa-clock"></i>
                        ${formatDate(comment.createdAt)}
                    </span>
                </div>
                <p class="comment-text">${comment.content}</p>
                <div class="comment-meta">
                    <span class="comment-blog">
                        <i class="fas fa-blog"></i>
                        ${((comment.blog && (comment.blog.title || comment.blog.name)) || comment.blog || '---')}
                    </span>
                    <span class="comment-status ${comment.status}">
                        ${getStatusText(comment.status)}
                    </span>
                </div>
                <div class="comment-actions">
                    ${getCommentActions(comment)}
                </div>
            </div>
        </div>
    `).join('');

    // Add event listeners to action buttons
    attachCommentActionListeners();
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (minutes < 60) {
        return `منذ ${minutes} دقيقة`;
    } else if (hours < 24) {
        return `منذ ${hours} ساعة`;
    } else if (days < 30) {
        return `منذ ${days} يوم`;
    } else {
        return date.toLocaleDateString('ar-EG');
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'قيد المراجعة',
        'approved': 'تمت الموافقة',
        'rejected': 'مرفوض'
    };
    return statusMap[status] || status;
}

function getCommentActions(comment) {
    if (comment.status === 'pending') {
        return `
            <button class="comment-action-btn approve" onclick="approveComment('${comment._id}')">
                <i class="fas fa-check"></i>
                موافقة
            </button>
            <button class="comment-action-btn reject" onclick="rejectComment('${comment._id}')">
                <i class="fas fa-times"></i>
                رفض
            </button>
            <button class="comment-action-btn delete" onclick="deleteComment('${comment._id}')">
                <i class="fas fa-trash"></i>
                حذف
            </button>
        `;
    }
    return `
        <button class="comment-action-btn delete" onclick="deleteComment('${comment._id}')">
            <i class="fas fa-trash"></i>
            حذف
        </button>
    `;
}

function attachCommentActionListeners() {
    // Search functionality
    const searchInput = document.getElementById('commentSearch');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(function() {
            const filter = document.getElementById('commentFilter').value;
            fetchComments(1, filter, this.value);
        }, 300));
    }

    // Filter functionality
    const filterSelect = document.getElementById('commentFilter');
    if (filterSelect) {
        filterSelect.addEventListener('change', function() {
            const search = document.getElementById('commentSearch').value;
            fetchComments(1, this.value, search);
        });
    }
}

function updatePagination(currentPage, totalPages) {
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');

    if (pageInfo) pageInfo.textContent = `صفحة ${currentPage} من ${totalPages}`;
    if (prevBtn) prevBtn.disabled = currentPage <= 1;
    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
}

// Comment actions
async function approveComment(commentId) {
    await updateCommentStatus(commentId, 'approved');
}

async function rejectComment(commentId) {
    await updateCommentStatus(commentId, 'rejected');
}

async function updateCommentStatus(commentId, status) {
    try {
        const response = await fetch(`/api/comments/${commentId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ status })
        });

        if (!response.ok) {
            throw new Error('فشل في تحديث حالة التعليق');
        }

        // Refresh comments
        const filter = document.getElementById('commentFilter').value;
        const search = document.getElementById('commentSearch').value;
        fetchComments(1, filter, search);
    } catch (error) {
        console.error('Error updating comment:', error);
        alert(`خطأ: ${error.message}`);
    }
}

async function deleteComment(commentId) {
    const confirmed = await showConfirm({
        title: 'تأكيد حذف التعليق',
        message: 'هل أنت متأكد من حذف هذا التعليق؟',
        confirmText: 'نعم، احذف التعليق',
        cancelText: 'إلغاء'
    });
    if (!confirmed) return;

    try {
        const response = await fetch(`/api/comments/${commentId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (!response.ok) {
            throw new Error('فشل في حذف التعليق');
        }

        // Refresh comments
        const filter = document.getElementById('commentFilter').value;
        const search = document.getElementById('commentSearch').value;
        fetchComments(1, filter, search);
    } catch (error) {
        console.error('Error deleting comment:', error);
        alert(`خطأ: ${error.message}`);
    }
}

// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Module Management Functions
function showAddModuleForm() {
    const modal = document.getElementById('addUnitModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.style.alignItems = 'flex-start';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '3000';
        const content = modal.querySelector('.modal-content');
        if (content) content.style.zIndex = '3100';
    }

    const form = document.getElementById('addUnitForm');
    if (form) {
        form.onsubmit = async function(e) {
            e.preventDefault();
            showLoadingOverlay('جاري إضافة الوحدة...');

            try {
                const title = document.getElementById('unitTitle').value.trim();
                const description = document.getElementById('unitDescription').value.trim();
                const order = parseInt(document.getElementById('unitOrder').value) || 1;

                if (!title) {
                    throw new Error('عنوان الوحدة مطلوب');
                }

                if (!window.currentCourseId) {
                    throw new Error('معرف الكورس غير موجود');
                }

                const response = await fetch(`/api/courses/${window.currentCourseId}/units`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        order
                    })
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'فشل في إضافة الوحدة');
                }

                // Refresh course content
                const contentResponse = await fetch(`/api/courses/${window.currentCourseId}/content`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const courseContent = await contentResponse.json();
                displayCourseContent(courseContent);

                closeAddUnitModal();
                form.reset();

            } catch (error) {
                console.error('Error adding unit:', error);
                alert(`خطأ: ${error.message}`);
            } finally {
                hideLoadingOverlay();
            }
        };
    }
}

// Make functions available globally
window.showAddModuleForm = showAddModuleForm;

// Canonical lesson edit flow injection (ensures edit button opens modal prefilled and submits PUT)
(function ensureCanonicalLessonEdit(){
  function getAuthHeader(){
    const token = localStorage.getItem('token');
    return token ? { 'Authorization': 'Bearer ' + token } : {};
  }

  function fillLessonForm(lesson){
    try{
      const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };
      const setChk = (id, v) => { const el = document.getElementById(id); if (el) el.checked = !!v; };

      setVal('lessonTitle', lesson.title || '');
      setVal('lessonDescription', lesson.description || '');
      setVal('lessonDuration', (lesson.duration || 30));
      setChk('lessonIsFree', lesson.isFree !== false);

      // Determine type and corresponding fields
      const type = lesson.type || (lesson.videoUrl ? 'video' : (lesson.fileUrl ? 'pdf' : (lesson.externalUrl ? 'url' : 'video')));
      try { selectContentType(type); } catch(e){ setVal('lessonType', type); }

      if (type === 'video'){
        const url = lesson.videoUrl || lesson.content || '';
        setVal('lessonVideoUrl', url);
        // Show preview for local/same-origin videos without triggering strict validation
        try {
          const isLocal = url && (url.startsWith('/uploads') || url.startsWith(window.location.origin) || url.startsWith('/'));
          if (isLocal) {
            const preview = document.getElementById('videoPreview');
            if (preview) {
              const vid = preview.querySelector('video');
              if (vid) {
                vid.src = url;
                preview.style.display = 'block';
                const ph = document.querySelector('#videoDropZone .upload-placeholder');
                if (ph) ph.style.display = 'none';
              }
            }
          } else if (url) {
            // For YouTube/Drive links, use validator to build embed preview
            validateVideoUrl();
          }
        } catch(e){}
        try { const file = document.getElementById('videoFileInput'); if (file) file.value=''; } catch(e){}
      } else if (type === 'pdf'){
        const url = lesson.fileUrl || lesson.content || '';
        setVal('lessonPdfUrl', url);
        // Avoid strict validation for local PDFs; just reflect filename/preview if present
        try {
          const preview = document.getElementById('pdfPreview');
          if (preview) {
            const nameEl = preview.querySelector('.filename');
            if (nameEl && url) nameEl.textContent = url.split('/').pop();
            if (url) preview.style.display = 'block';
          }
        } catch(e){}
        try { const file = document.getElementById('pdfFileInput'); if (file) file.value=''; } catch(e){}
      } else if (type === 'url'){
        const url = lesson.externalUrl || lesson.content || '';
        setVal('lessonExternalUrl', url);
        try { if (url) validateExternalUrl(); } catch(e){}
      }
    } catch(err){ console.error('fillLessonForm failed', err); }
  }

  async function canonicalHandleEditLessonSubmit(e){
    e.preventDefault();
    try{
      const title = (document.getElementById('lessonTitle')?.value || '').trim();
      const description = (document.getElementById('lessonDescription')?.value || '').trim();
      const duration = parseInt(document.getElementById('lessonDuration')?.value) || 30;
      const type = (document.getElementById('lessonType')?.value || 'video');
      const isFree = !!(document.getElementById('lessonIsFree')?.checked);
      if (!title) return alert('عنوان الدرس مطلوب');

      // Build payload (URL-first; file uploads ليست جزء من PUT الحالي)
      const payload = { title, description, duration, type, isFree };
      if (type === 'video') {
        const videoUrl = (document.getElementById('lessonVideoUrl')?.value || '').trim();
        payload.videoUrl = videoUrl;
      } else if (type === 'pdf') {
        const fileUrl = (document.getElementById('lessonPdfUrl')?.value || '').trim();
        payload.fileUrl = fileUrl;
      } else if (type === 'url') {
        const externalUrl = (document.getElementById('lessonExternalUrl')?.value || '').trim();
        payload.externalUrl = externalUrl;
      }

      if (!window.currentUnitId || !window.currentLessonId) {
        console.error('Missing currentUnitId/currentLessonId for PUT');
        return alert('حدث خطأ داخلي: معرّفات الدرس غير معروفة');
      }

      const res = await fetch(`/api/courses/${window.currentCourseId}/units/${window.currentUnitId}/lessons/${window.currentLessonId}` , {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', ...getAuthHeader() },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        let msg = '';
        try { msg = (await res.json()).error || ''; } catch(e){}
        throw new Error(msg || ('فش�� تحديث الدرس ('+res.status+')'));
      }

      if (window.showToast) {
        window.showToast('تم تحديث الدرس بنجاح!', {
          type: 'success',
          timeout: 4000,
          title: 'نجح التحديث',
          icon: 'fas fa-check-circle'
        });
      } else {
        alert('تم تحديث الدرس بنجاح!');
      }
      try { closeAddLessonModal(); } catch(e){}

      // Refresh course content in the modal
      if (window.currentCourseId) {
        try {
          const r = await fetch(`/api/courses/${window.currentCourseId}/content`, { headers: getAuthHeader() });
          if (r.ok) {
            const data = await r.json();
            try { if (typeof displayCourseContent === 'function') displayCourseContent(data); } catch(e){}
            try { if (window.Courses && typeof window.Courses.displayCourseContent === 'function') window.Courses.displayCourseContent(data); } catch(e){}
          }
        } catch(e){ console.warn('Refresh content after edit failed', e); }
      }
    } catch(err){
      console.error('Edit lesson submit failed', err);
      alert(err.message || 'فشل في تحديث الدرس');
    }
  }

  async function canonicalEditLesson(courseId, unitId, lessonId){
    try{
      if (!courseId || !unitId || !lessonId) return alert('بيانات الدرس غير مكتملة');
      window.currentCourseId = courseId;
      window.currentUnitId = unitId;
      window.currentLessonId = lessonId;

      const res = await fetch(`/api/courses/${courseId}/content`, { headers: getAuthHeader() });
      if (!res.ok) throw new Error('فشل في جلب محتوى الكورس');
      const content = await res.json();
      const unit = (content.units || []).find(u => String(u._id) === String(unitId));
      if (!unit) return alert('لم يتم العثور على الوحدة');
      const lesson = (unit.lessons || []).find(l => String(l._id) === String(lessonId));
      if (!lesson) return alert('لم يتم العثور على الدرس');

      // Open modal and populate
      const modal = document.getElementById('addLessonModal');
      if (!modal) return alert('نموذج الدرس غير متاح');
      fillLessonForm(lesson);
      modal.style.display = 'flex';
      modal.classList.add('show');
      try { modal.style.zIndex = '20000'; } catch(e){}
      document.body.classList.add('modal-open');
      try { (document.getElementById('lessonTitle')||{}).focus && document.getElementById('lessonTitle').focus(); } catch(e){}

      // Wire submit to PUT
      const form = document.getElementById('addLessonForm');
      if (form){
        try { form.removeEventListener('submit', handleAddLessonSubmit); } catch(e){}
        try { form.removeEventListener('submit', canonicalHandleEditLessonSubmit); } catch(e){}
        form.addEventListener('submit', canonicalHandleEditLessonSubmit);
        const btn = form.querySelector('button[type="submit"]');
        if (btn) btn.textContent = 'تحديث الدرس';
      }

      // Update modal title
      try {
        const titleEl = modal.querySelector('.modal-header h3, h3');
        if (titleEl) titleEl.textContent = 'تعديل الدرس';
      } catch(e){}

    } catch(err){
      console.error('canonicalEditLesson failed', err);
      alert(err.message || 'تعذر فتح تعديل الدرس');
    }
  }

  // Expose globally and override any previous conflicting definitions
  try { window.editLesson = canonicalEditLesson; } catch(e){}
})();

// تهيئة الصفحة
document.addEventListener('DOMContentLoaded', () => {
    if (window.__dashInit) return;
    window.__dashInit = true;
    
    // تهيئة أزرار الكورس
    const addCourseBtn = document.getElementById('add-course-button');
    if (addCourseBtn) {
        console.log('Found add course button');
        try { addCourseBtn.onclick = null; } catch(e){}
        addCourseBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Add course button clicked');

            // Try canonical Courses API first
            if (window.Courses && typeof window.Courses.openAddCourseModal === 'function') {
                try {
                    window.Courses.openAddCourseModal();
                    console.log('Called window.Courses.openAddCourseModal()');
                    return;
                } catch (err) {
                    console.warn('window.Courses.openAddCourseModal threw:', err);
                }
            }

            // Fallback: force-show the modal and record diagnostics
            const modal = document.getElementById('courseModal');
            if (!modal) {
                console.error('Fallback: courseModal element not found');
                return;
            }

            console.log('Fallback: forcing courseModal visible. current styles:', {
                display: modal.style.display,
                classes: modal.className,
                computed: window.getComputedStyle(modal).cssText
            });

            const show = () => {
                modal.style.display = 'flex';
                modal.classList.add('show');
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.zIndex = '20000';
                document.body.style.overflow = 'hidden';
                // focus first input
                const first = modal.querySelector('input, textarea, select, button');
                if (first) try { first.focus(); } catch(e){}
            };

            show();
            // Retry shortly in case something else toggles it
            setTimeout(show, 60);
        });
    } else {
        console.warn('Add course button not found');
    }
    
    // تحميل البيانات الأولية
    fetchUsers();
    fetchCourses();
    fetchComments(); // Add initial comments load
    
    // تعيين القسم الافتراضي
    switchSection('users');
}); // Close DOMContentLoaded event listener



function switchSection(sectionId) {
    console.log('=== SWITCHING SECTION TO:', sectionId, '===');
    
    // قائمة جميع الأقسام المعروفة
    const allSections = [
        'users-section',
        'courses-section', 
        'comments-section',
        'settings-section',
        'products-section'
    ];
    
    // 1. إخفاء جميع الأقسام
    allSections.forEach(sectionName => {
        const section = document.getElementById(sectionName);
        if (section) {
            section.style.display = 'none';
            section.classList.remove('active');
            console.log('Hidden:', sectionName);
        } else {
            console.warn('Section not found:', sectionName);
        }
    });

    // 2. إظهار القسم المطلوب
    const targetSection = document.getElementById(`${sectionId}-section`);
    if (targetSection) {
        targetSection.style.display = 'block';
        targetSection.classList.add('active');
        console.log('✓ Displayed section:', sectionId);
    } else {
        console.error('❌ Target section not found:', `${sectionId}-section`);
        return; // إيقاف إذا لم يتم العثور على القسم
    }
    
    // 3. تحديث القائمة الجانبية
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const activeMenuItem = document.querySelector(`.menu-item[href="#${sectionId}"]`);
    if (activeMenuItem) {
        activeMenuItem.classList.add('active');
        console.log('✓ Activated menu item:', sectionId);
    } else {
        console.error('❌ Menu item not found for:', sectionId);
    }
    
    // 4. تحميل البيانات حسب القسم
    console.log('Loading data for section:', sectionId);
    switch(sectionId) {
        case 'courses':
            if (typeof fetchCourses === 'function') {
                fetchCourses();
            } else {
                console.error('fetchCourses function not found');
            }
            break;
        case 'users':
            if (typeof fetchUsers === 'function') {
                fetchUsers();
            } else {
                console.error('fetchUsers function not found');
            }
            break;
        case 'comments':
            if (typeof fetchComments === 'function') {
                fetchComments();
            } else {
                console.error('fetchComments function not found');
            }
            break;
        case 'settings':
            console.log('Settings section - no data to load');
            break;
        case 'products':
            if (typeof loadProducts === 'function') {
                loadProducts();
            } else if (typeof initProducts === 'function') {
                // Fallback for older naming
                initProducts();
            } else {
                console.error('loadProducts function not found');
            } 
            break;
        default:
            console.warn('Unknown section:', sectionId);
    }
    
    console.log('=== SECTION SWITCH COMPLETE ===');
}

// تأكد من وجود Quill في النطاق العام
let Quill = window.Quill;
const BlockEmbed = (window.Quill && window.Quill.import)
  ? window.Quill.import('blots/block/embed')
  : class { static create(){ return document.createElement('div'); } static value(){ return ''; } };
class CustomVideo extends BlockEmbed {
  static create(value) {
    const node = super.create();
    node.setAttribute('src', value);
    node.setAttribute('controls', true);
    node.setAttribute('style', 'max-width:100%;border-radius:10px;margin:10px 0;');
    return node;
  }
  static value(node) {
    return node.getAttribute('src');
  }
}



























// Course Content Management Functions
// متغيرات عامة
let modules = [];
let currentCourseId = null;
let currentCourseTitle = null;
let currentUnitId = null;
let currentLessonId = null;

// دالة معالجة إضافة درس جديد
async function handleAddLessonSubmit(e) {
    e.preventDefault();
    console.log('Handling lesson submission...');

    try {
        showLoadingOverlay('جاري إضافة الدرس...');

        if (!currentCourseId || !currentUnitId) {
            throw new Error('لم يتم تحديد الكورس أو الوحدة');
        }
        
        // التأكد من حفظ المتغيرات العامة
        const courseIdToUse = currentCourseId || window.currentCourseId;
        const courseTitleToUse = currentCourseTitle || window.currentCourseTitle;

        // جمع بيانات النموذج
        const lessonData = {
            title: document.getElementById('lessonTitle').value.trim(),
            description: document.getElementById('lessonDescription').value.trim(),
            duration: parseInt(document.getElementById('lessonDuration').value) || 30,
            category: document.getElementById('lessonCategory')?.value.trim() || '',
            type: document.getElementById('lessonType').value,
            isFree: document.getElementById('lessonIsFree').checked
        };

        // التحقق من البيانات المطلوبة
        if (!lessonData.title) {
            throw new Error('عنوان الدرس مطلوب');
        }

        // إضافة الرابط أو الملف حسب نوع المحتوى
        switch (lessonData.type) {
            case 'video':
                const videoUrl = document.getElementById('lessonVideoUrl').value.trim();
                const videoFile = document.getElementById('videoFileInput').files[0];
                
                if (videoUrl) {
                    lessonData.content = videoUrl;
                } else if (videoFile) {
                    const formData = new FormData();
                    formData.append('video', videoFile);
                    
                    const uploadResponse = await fetch('/api/uploads/lesson-video', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error('فشل في رفع ملف الفيديو');
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    lessonData.content = uploadResult.url;
                } else {
                    throw new Error('يجب إضافة رابط فيديو أو رفع ملف');
                }
                break;

            case 'pdf':
                const pdfUrl = document.getElementById('lessonPdfUrl').value.trim();
                const pdfFile = document.getElementById('pdfFileInput').files[0];
                
                if (pdfUrl) {
                    lessonData.content = pdfUrl;
                } else if (pdfFile) {
                    const formData = new FormData();
                    formData.append('pdf', pdfFile);
                    
                    const uploadResponse = await fetch('/api/uploads/lesson-pdf', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error('فشل في رفع ملف PDF');
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    lessonData.content = uploadResult.url;
                } else {
                    throw new Error('يجب إضافة رابط PDF أو رفع ملف');
                }
                break;

            case 'url':
                const externalUrl = document.getElementById('lessonExternalUrl').value.trim();
                if (!externalUrl) {
                    throw new Error('يجب إضافة رابط خارجي');
                }
                lessonData.content = externalUrl;
                break;
        }

        console.log('Submitting edit lesson data:', lessonData, 'to', `/api/courses/${currentCourseId}/units/${currentUnitId}/lessons/${currentLessonId}`);
        // إرسال البيانات إلى الخادم
        const response = await fetch(`/api/courses/${currentCourseId}/units/${currentUnitId}/lessons`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(lessonData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'فشل في إضافة الدرس');
        }

        alert('تم إضافة الدرس بنجاح!');
        
        // إعادة تحميل محتوى الكورس قبل إغلاق النموذج
        try {
            const contentResponse = await fetch(`/api/courses/${currentCourseId}/content`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const content = await contentResponse.json();
            console.log('Refreshed course content after add:', content);
            displayCourseContent(content);
        } catch (refreshError) {
            console.error('Error refreshing course content:', refreshError);
        }
        
        // إغلاق النموذج بعد انتهاء التحديث
        closeAddLessonModal();

    } catch (error) {
        console.error('Error adding lesson:', error);
        alert(`خطأ: ${error.message}`);
    } finally {
        hideLoadingOverlay();
    }
}

// دالة لإضافة درس جديد
async function addLessonToUnit(courseId, unitId) {
    if (!courseId || !unitId) {
        alert('خطأ: لم يتم تحديد الكورس أو الوحدة');
        return;
    }
    
    currentCourseId = courseId;
    currentUnitId = unitId;
    const modal = document.getElementById('addLessonModal');
    if (modal) {
        console.log('Opening lesson modal for unit:', unitId);
        const form = document.getElementById('addLessonForm');
        if (form) {
            form.reset();
            form.removeEventListener('submit', handleAddLessonSubmit);
            form.addEventListener('submit', handleAddLessonSubmit);
        }
        
        // Reset content type to video by default
        selectContentType('video');
        
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    } else {
        console.error('Lesson modal not found');
    }
}

// دالة لتحديد نوع المحتوى
function selectContentType(type) {
    // تحديث قيمة نوع المحتوى
    document.getElementById('lessonType').value = type;
    
    // إزالة الكلاس active من جميع الأزرار
    document.querySelectorAll('.content-type-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // إضافة الكلاس active للزر المحدد
    const selectedBtn = document.querySelector(`.content-type-btn[data-type="${type}"]`);
    if (selectedBtn) {
        selectedBtn.classList.add('active');
    }
    
    // إخفاء جميع أقسام المحتوى
    document.querySelectorAll('.content-input-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // إظهار قسم المحتوى المناسب
    const selectedSection = document.getElementById(`${type}InputSection`);
    if (selectedSection) {
        selectedSection.classList.add('active');
    }
}

// دالة لإغلاق مودال الدرس
function closeAddLessonModal() {
    const modal = document.getElementById('addLessonModal');
    try {
        // hide modal
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
        }

        // reset form fields and previews
        const form = document.getElementById('addLessonForm');
        if (form) {
            try { form.reset(); } catch (e) { /* ignore */ }
        }

        // remove any selected files / previews
        try { removeVideo(); } catch(e) { /* ignore */ }
        try { removePdf(); } catch(e) { /* ignore */ }

        // clear URL inputs
        const vUrl = document.getElementById('lessonVideoUrl'); if (vUrl) vUrl.value = '';
        const pUrl = document.getElementById('lessonPdfUrl'); if (pUrl) pUrl.value = '';
        const extUrl = document.getElementById('lessonExternalUrl'); if (extUrl) extUrl.value = '';

        // reset content type and button text
        try { selectContentType('video'); } catch(e) {}
        const submitBtn = document.querySelector('#addLessonForm button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'إضافة الدرس';
        }

        // Reset lesson ID and form handler
        currentLessonId = null;
        // Reuse form variable from above
        if (form) {
            form.removeEventListener('submit', handleEditLessonSubmit);
            form.addEventListener('submit', handleAddLessonSubmit);
        }

        // Reset modal title
        const modalTitle = modal?.querySelector('h3') || modal?.querySelector('.modal-header h3');
        if (modalTitle) {
            modalTitle.textContent = 'إضافة درس جديد';
        }

    } finally {
        document.body.style.overflow = 'auto';
    }
}

// Make functions globally available
window.addLessonToUnit = addLessonToUnit;
window.selectContentType = selectContentType;
window.closeAddLessonModal = closeAddLessonModal;

// Delegate manageCourseContent to Courses module when available
async function manageCourseContent(courseId, courseTitle) {
    console.log('manageCourseContent called with courseId:', courseId, 'courseTitle:', courseTitle);
    try {
        // تعيين المتغيرات العامة
        currentCourseId = courseId;
        window.currentCourseId = courseId;
        currentCourseTitle = courseTitle;
        window.currentCourseTitle = courseTitle;

        // Fetch both course details and content
        const [courseRes, contentRes] = await Promise.all([
            fetch(`/api/courses/${courseId}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            }),
            fetch(`/api/courses/${courseId}/content`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            })
        ]);

        if (!courseRes.ok) throw new Error('فشل في جلب بيانات الكورس');
        if (!contentRes.ok) throw new Error('فشل في جلب محتوى الكورس');

        const course = await courseRes.json();
        const content = await contentRes.json();

        console.log('Course and content fetched:', course, content);
        displayCourseContent(content, course);

        // Show modal
        const modal = document.getElementById('courseContentModal');
        if (modal) {
            modal.style.display = 'flex';
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    } catch (error) {
        console.error('manageCourseContent error:', error);
        alert(`خطأ في تحميل محتوى الكورس: ${error.message}`);
    }
}

// دالة لعرض محتوى الكورس
function displayCourseContent(courseContent, course) {
    console.log('displayCourseContent called with:', courseContent, course);
    // Diagnostic: show both global and window-scoped currentCourseId
    try { console.log('DIAG currentCourseId (local):', typeof currentCourseId !== 'undefined' ? currentCourseId : '<<undefined>>', 'window.currentCourseId:', window.currentCourseId); } catch(e) { console.warn('DIAG log failed', e); }

    const container = document.getElementById('modulesContainer');
    if (!container) {
        console.error('modulesContainer element not found');
        return;
    }

    let html = '';

    // Add promotional video section for paid courses
    const isPaid = course && !course.isFree;
    console.log('Course data:', course);
    console.log('Is paid course:', isPaid);
    if (isPaid) {
        console.log('Adding promotional video section for paid course');
        html += `
            <div class="promo-video-section" style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">
                <h4 style="margin: 0 0 15px 0; color: #333;">فيديو ترويجي للكورس</h4>
                <div class="promo-video-form" style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="form-group">
                        <label for="promoVideoUrl" style="display: block; margin-bottom: 5px; font-weight: bold;">رابط الفيديو الترويجي (YouTube أو Google Drive):</label>
                        <input type="url" id="promoVideoUrl" placeholder="https://www.youtube.com/watch?v=... أو https://drive.google.com/file/d/..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" value="${course && course.promoVideo ? course.promoVideo : ''}">
                    </div>
                    <div class="form-group">
                        <label for="promoVideoFile" style="display: block; margin-bottom: 5px; font-weight: bold;">أو رفع ملف فيديو:</label>
                        <input type="file" id="promoVideoFile" accept="video/*" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label for="promoThumbnailFile" style="display: block; margin-bottom: 5px; font-weight: bold;">صورة مصغرة (Thumbnail):</label>
                        <input type="file" id="promoThumbnailFile" accept="image/*" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <button onclick="updatePromoVideo('${window.currentCourseId || currentCourseId}')" class="btn btn-primary" style="align-self: flex-start; padding: 8px 16px;">
                        <i class="fas fa-save"></i> حفظ الفيديو الترويجي
                    </button>
                </div>
            </div>
        `;
    }

    if (!courseContent.units || courseContent.units.length === 0) {
        html += '<p>لا توجد وحدات لهذا الكورس</p>';
    } else {
        // التأكد من أن currentCourseId محدد
        const courseIdToUse = currentCourseId || window.currentCourseId;
        if (!courseIdToUse) {
            console.error('currentCourseId غير محدد');
            html += '<p>خطأ: لم يتم تحديد الكورس</p>';
        } else {
    
        courseContent.units.forEach((unit, unitIndex) => {
            html += `
                <div class="module-item" style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px;">
                    <div class="module-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0;">الوحدة ${unitIndex + 1}: ${unit.title}</h4>
                        <div class="module-actions">
                            <button onclick="addLessonToUnit('${courseIdToUse}', '${unit._id}')" class="btn btn-sm btn-primary" style="margin-left: 8px;">
                                <i class="fas fa-plus"></i> إضافة درس
                            </button>
                            <button onclick="deleteUnit('${courseIdToUse}', '${unit._id}')" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                    <div class="lessons-list" style="margin-top: 15px;">
                        ${unit.lessons && unit.lessons.length > 0 ?
                            unit.lessons.map((lesson, lessonIndex) => `
                                <div class="lesson-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                                    <span>الدرس ${lessonIndex + 1}: ${lesson.title}</span>
                                    <div class="lesson-actions">
                                        <button onclick="editLesson('${courseIdToUse}', '${unit._id}', '${lesson._id}')" class="btn btn-sm btn-secondary" style="margin-left: 5px;">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteLesson('${courseIdToUse}', '${unit._id}', '${lesson._id}')" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')
                            : '<p style="text-align: center; color: #999; margin: 10px 0;">لا توجد دروس في هذه الوحدة</p>'
                        }
                    </div>
                </div>
            `;
        });
    }

    container.innerHTML = html;
}

function closeCourseContentModal() {
    const modal = document.getElementById('courseContentModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
    }
    currentCourseId = null;
    currentCourseTitle = null;
}

// Simple loading overlay helpers to be used by forms
function showLoadingOverlay(message) {
    try {
        const overlay = document.getElementById('loadingOverlay');
        if (!overlay) return;
        if (message) {
            const p = overlay.querySelector('p');
            if (p) p.textContent = message;
        }
        overlay.classList.add('show');
    } catch (e) {
        console.warn('showLoadingOverlay failed', e);
    }
}

function hideLoadingOverlay() {
    try {
        const overlay = document.getElementById('loadingOverlay');
        if (!overlay) return;
        // restore default text
        const p = overlay.querySelector('p');
        if (p) p.textContent = 'جاري التحميل...';
        overlay.classList.remove('show');
    } catch (e) {
        console.warn('hideLoadingOverlay failed', e);
    }
}
// Canonical Modal Management System
const ModalSystem = {
    openModal(modalId, closeOthers = true) {
        console.log(`Opening modal: ${modalId}, closeOthers: ${closeOthers}`);
        const modal = document.getElementById(modalId);
        if (!modal) {
            console.error(`Modal not found: ${modalId}`);
            return false;
        }

        // Close any open modals first if requested
        if (closeOthers) {
            this.closeAllModals();
        }

        // Show the requested modal
        modal.style.display = 'flex';
        modal.classList.add('show');
        document.body.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
        // Prevent immediate backdrop click (from the click that opened the modal) closing it
        try {
            modal.dataset.ignoreBackdropClick = 'true';
            setTimeout(() => delete modal.dataset.ignoreBackdropClick, 250);
        } catch (e) {}
        return true;
    },
    
    closeModal(modalId) {
        console.log(`Closing modal: ${modalId}`);
        const modal = document.getElementById(modalId);
        if (!modal) {
            console.warn(`Modal not found: ${modalId}`);
            return false;
        }
        
        modal.style.display = 'none';
        modal.classList.remove('show');
        // Only remove modal-open if no other modal remains shown
        const anyShown = Array.from(document.querySelectorAll('.modal')).some(m => m.classList.contains('show'));
        if (!anyShown) {
            document.body.classList.remove('modal-open');
            document.body.style.overflow = 'auto';
        }
        document.body.style.overflow = 'auto';
        return true;
    },
    
    closeAllModals() {
        console.log('Closing all modals');
        document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = 'none';
            modal.classList.remove('show');
        });
        document.body.classList.remove('modal-open');
        document.body.style.overflow = 'auto';
    },
    
    setupEvents() {
        console.log('Setting up modal events...');
        
        // Close button handler
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => {
                const modal = btn.closest('.modal');
                if (modal) this.closeModal(modal.id);
            });
        });
        
        // Backdrop click handler
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    // If modal is marked to ignore backdrop clicks, don't close
                    if (modal.dataset && modal.dataset.ignoreBackdropClick) {
                        console.log(`Modal backdrop click ignored for ${modal.id}`);
                        return;
                    }
                    console.log(`Modal backdrop click detected for ${modal.id} - closing`);
                    this.closeModal(modal.id);
                }
            });
        });
        
        // ESC key handler
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') this.closeAllModals();
        });
        
        console.log('Modal events setup complete');
    }
};

// Set up event handlers immediately
document.addEventListener('DOMContentLoaded', () => ModalSystem.setupEvents());

// Expose modal functions globally
window.openModal = (id) => ModalSystem.openModal(id);
window.closeModal = (id) => ModalSystem.closeModal(id);
window.closeAllModals = () => ModalSystem.closeAllModals();

// Make functions global
window.openAddCourseModal = openAddCourseModal;
window.editCourse = editCourse;
window.manageCourseContent = manageCourseContent;
window.closeCourseModal = closeCourseModal;
window.closeCourseContentModal = closeCourseContentModal;

function addModule() {
    // Use the new form instead of prompt
    toggleAddModuleForm();
}

async function deleteModule(moduleId) {
    const confirmed = await showConfirm({
        title: 'تأكيد حذف الوحدة',
        message: 'هل أنت متأكد من حذف هذه الوحدة؟',
        confirmText: 'نعم، احذف الوحدة',
        cancelText: 'إلغاء'
    });
    if (!confirmed) return;

    modules = modules.filter(module => module.id !== moduleId);
    renderModules();
}

function toggleModule(moduleId) {
    const module = modules.find(m => m.id === moduleId);
    if (module) {
        module.isExpanded = !module.isExpanded;
        renderModules();
    }
}











// Handle content type selection
function selectContentType(type) {
    // Update hidden input
    document.getElementById('lessonType').value = type;
    
    // Update button states
    document.querySelectorAll('.content-type-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.content-type-btn[data-type="${type}"]`).classList.add('active');
    
    // Show corresponding section
    document.querySelectorAll('.content-input-section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(`${type}InputSection`).classList.add('active');
}

// Handle video file selection
function handleVideoFileSelected(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.match('video/*')) {
        alert('يرجى اختيار ملف فيديو صحيح');
        event.target.value = '';
        return;
    }

    // Validate file size (100MB)
    if (file.size > 100 * 1024 * 1024) {
        alert('حجم الفيديو يجب أن يكون أقل من 100 ميجابايت');
        event.target.value = '';
        return;
    }

    // Show preview
    const previewDiv = document.getElementById('videoPreview');
    const video = previewDiv.querySelector('video') || document.createElement('video');
    video.src = URL.createObjectURL(file);
    if (!previewDiv.querySelector('video')) {
        previewDiv.insertBefore(video, previewDiv.firstChild);
    }
    previewDiv.style.display = 'block';
    document.querySelector('.upload-placeholder').style.display = 'none';
}

// Remove selected video
function removeVideo() {
    const fileInput = document.getElementById('videoFileInput');
    const previewDiv = document.getElementById('videoPreview');
    const placeholder = document.querySelector('.upload-placeholder');
    
    fileInput.value = '';
    previewDiv.style.display = 'none';
    placeholder.style.display = 'block';
    
    const video = previewDiv.querySelector('video');
    if (video) {
        URL.revokeObjectURL(video.src);
        video.remove();
    }
}

// Handle PDF file selection
function handlePdfFileSelected(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file type
    if (file.type !== 'application/pdf') {
        alert('يرجى اختيار ملف PDF صحيح');
        event.target.value = '';
        return;
    }

    // Validate file size (50MB)
    if (file.size > 50 * 1024 * 1024) {
        alert('حجم الملف يجب أن يكون أقل من 50 ميجابايت');
        event.target.value = '';
        return;
    }

    // Show preview
    const previewDiv = document.getElementById('pdfPreview');
    const filenameSpan = previewDiv.querySelector('.filename');
    filenameSpan.textContent = file.name;
    previewDiv.style.display = 'block';
    document.querySelector('#pdfDropZone .upload-placeholder').style.display = 'none';
}

// Remove selected PDF
function removePdf() {
    const fileInput = document.getElementById('pdfFileInput');
    const previewDiv = document.getElementById('pdfPreview');
    const placeholder = document.querySelector('#pdfDropZone .upload-placeholder');
    
    fileInput.value = '';
    previewDiv.style.display = 'none';
    placeholder.style.display = 'block';
}

// Validate video URL
async function validateVideoUrl() {
    const urlInput = document.getElementById('lessonVideoUrl');
    const url = urlInput.value.trim();
    
    if (!url) {
        alert('يرجى إدخال رابط الفيديو');
        return;
    }

    // Check if it's a valid YouTube or Google Drive URL
    if (!isValidVideoUrl(url)) {
        alert('يرجى إدخال رابط صحيح من YouTube أو Google Drive');
        return;
    }

    // Show preview
    const previewDiv = document.getElementById('urlVideoPreview');
    const frame = previewDiv.querySelector('.preview-frame');
    frame.innerHTML = `<iframe src="${getEmbedUrl(url)}" frameborder="0" allowfullscreen></iframe>`;
    previewDiv.style.display = 'block';
}

// Remove video URL
function removeVideoUrl() {
    const urlInput = document.getElementById('lessonVideoUrl');
    const previewDiv = document.getElementById('urlVideoPreview');
    
    urlInput.value = '';
    previewDiv.style.display = 'none';
    previewDiv.querySelector('.preview-frame').innerHTML = '';
}

// Validate PDF URL
async function validatePdfUrl() {
    const urlInput = document.getElementById('lessonPdfUrl');
    const url = urlInput.value.trim();
    
    if (!url) {
        alert('يرجى إدخال رابط ملف PDF');
        return;
    }

    try {
        const response = await fetch(url, { method: 'HEAD' });
        if (!response.ok) throw new Error('الرابط غير صالح');
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('pdf')) {
            throw new Error('الملف ليس بصيغة PDF');
        }

        alert('✅ تم التحقق من الرابط بنجاح');
    } catch (error) {
        alert(`خطأ: ${error.message}`);
        urlInput.value = '';
    }
}

// Validate external URL
async function validateExternalUrl() {
    const urlInput = document.getElementById('lessonExternalUrl');
    const url = urlInput.value.trim();
    
    if (!url) {
        alert('يرجى إدخال الرابط');
        return;
    }

    try {
        // Use host detection to avoid CORS errors for well-known hosts that do not allow cross-origin HEAD checks
        const parsed = new URL(url);
        const hostname = (parsed.hostname || '').toLowerCase();

        // YouTube and Google Drive block CORS for direct HEAD requests to watch/preview pages
        if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
            // Simple validation: make sure the URL contains a video id and that we can convert to an embed URL
            const embedUrl = getEmbedUrl(url);
            if (!embedUrl || !embedUrl.includes('youtube.com/embed/')) throw new Error('رابط YouTube غير صالح');
            // Accept the YouTube link without issuing a cross-origin HEAD request
            alert('✅ تم التحقق من رابط YouTube وسيتم عرضه عبر embedded player');
            return;
        }

        if (hostname.includes('drive.google.com')) {
            // Extract drive file id and ensure we can construct a preview link
            const embedUrl = getEmbedUrl(url);
            if (!embedUrl || !embedUrl.includes('/file/d/')) throw new Error('رابط Google Drive غير صالح');
            alert('✅ تم التحقق من رابط Google Drive وسيتم عرضه عبر embedded preview');
            return;
        }

        // Fallback: try a HEAD request for other hosts (may still be blocked by some hosts)
        const response = await fetch(url, { method: 'HEAD' });
        if (!response.ok) throw new Error('الرابط غير صالح');
        alert('✅ تم التحقق من الرابط بنجاح');
    } catch (error) {
        alert(`خطأ: ${error.message}`);
        urlInput.value = '';
    }
}

// Helper functions for URL validation
function isValidVideoUrl(url) {
    const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+/;
    const driveRegex = /^(https?:\/\/)?(www\.)?(drive\.google\.com)\/.+/;
    return youtubeRegex.test(url) || driveRegex.test(url);
}

function getEmbedUrl(url) {
    // YouTube URL
    if (url.includes('youtube.com') || url.includes('youtu.be')) {
        let videoId = '';
        if (url.includes('youtube.com/watch?v=')) {
            videoId = url.split('v=')[1];
        } else if (url.includes('youtu.be/')) {
            videoId = url.split('youtu.be/')[1];
        }
        if (videoId.includes('&')) {
            videoId = videoId.split('&')[0];
        }
        return `https://www.youtube.com/embed/${videoId}`;
    }
    
    // Google Drive URL
    if (url.includes('drive.google.com')) {
        const fileId = url.match(/[-\w]{25,}/);
        if (fileId) {
            return `https://drive.google.com/file/d/${fileId[0]}/preview`;
        }
    }
    
    return url;
}

// Make sure these functions are available in the global scope (delegators)
window.openAddCourseModal = function() {
    if (window.Courses && typeof window.Courses.openAddCourseModal === 'function') return window.Courses.openAddCourseModal();
    console.warn('openAddCourseModal delegated: Courses module not available');
};

window.editCourse = function(courseId) {
    if (window.Courses && typeof window.Courses.openEditCourse === 'function') return window.Courses.openEditCourse(courseId);
    console.warn('editCourse delegated: Courses module not available');
};

window.manageCourseContent = function(courseId, courseTitle) {
    if (window.Courses && typeof window.Courses.manageCourseContent === 'function') return window.Courses.manageCourseContent(courseId, courseTitle);
    console.warn('manageCourseContent delegated: Courses module not available');
};

async function deleteLesson(courseId, unitId, lessonId) {
    const confirmed = await showConfirm({
        title: 'تأكيد حذف الدرس',
        message: 'هل أنت متأكد من حذف هذا الدرس؟',
        confirmText: 'نعم، احذف الدرس',
        cancelText: 'إلغاء'
    });
    if (!confirmed) {
        return;
    }

    fetch(`/api/courses/${courseId}/units/${unitId}/lessons/${lessonId}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('فشل حذف الدرس');
        return response.json();
    })
    .then(() => {
        manageCourseContent(courseId); // Refresh content
        alert('تم حذف الدرس بنجاح');
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء حذف الدرس');
    });
}

function editLesson(courseId, unitId, lessonId) {
    const modal = document.getElementById('addLessonModal');
    if (!modal) return;

    // Set current IDs
    currentCourseId = courseId;
    currentUnitId = unitId;
    currentLessonId = lessonId;

    // Fetch lesson data
    fetch(`/api/courses/${courseId}/units/${unitId}/lessons/${lessonId}`, {
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('فشل في جلب بيانات الدرس');
        return response.json();
    })
    .then(lesson => {
        // Populate the form
        document.getElementById('lessonTitle').value = lesson.title || '';
        document.getElementById('lessonDescription').value = lesson.description || '';
        document.getElementById('lessonDuration').value = lesson.duration || 30;
        document.getElementById('lessonSpecialization').value = lesson.specialization || 'cybersecurity';
        document.getElementById('lessonIsFree').checked = lesson.isFree || false;
        
        // Set content type
        const lessonType = lesson.type || 'video';
        selectContentType(lessonType);
        
        // Handle content based on type
        if (lessonType === 'video') {
            const videoUrl = lesson.videoUrl || lesson.content || '';
            if (videoUrl) {
                if (videoUrl.startsWith('http') || videoUrl.startsWith('/uploads/')) {
                    document.getElementById('lessonVideoUrl').value = videoUrl;
                    validateVideoUrl();
                } else {
                    // If it's a local file path, show it in preview
                    document.getElementById('lessonVideoUrl').value = videoUrl;
                }
            }
            // Clear file input
            const videoFileInput = document.getElementById('videoFileInput');
            if (videoFileInput) videoFileInput.value = '';
        } else if (lessonType === 'pdf') {
            const pdfUrl = lesson.fileUrl || lesson.content || '';
            if (pdfUrl) {
                document.getElementById('lessonPdfUrl').value = pdfUrl;
                validatePdfUrl();
            }
            // Clear file input
            const pdfFileInput = document.getElementById('pdfFileInput');
            if (pdfFileInput) pdfFileInput.value = '';
        } else if (lessonType === 'url') {
            const externalUrl = lesson.externalUrl || lesson.content || '';
            document.getElementById('lessonExternalUrl').value = externalUrl;
        } else if (lessonType === 'text') {
            const textContent = lesson.content || '';
            document.getElementById('lessonTextContent').value = textContent;
        }
        
        // Update modal title
        const modalTitle = modal.querySelector('h3') || modal.querySelector('.modal-header h3');
        if (modalTitle) {
            modalTitle.textContent = 'تعديل الدرس';
        }
        
        // Update form submit handler
        const form = document.getElementById('addLessonForm');
        if (form) {
            form.removeEventListener('submit', handleAddLessonSubmit);
            form.removeEventListener('submit', handleEditLessonSubmit);
            form.addEventListener('submit', handleEditLessonSubmit);
        }
        
        modal.style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء تحميل بيانات الدرس: ' + error.message);
    });
}

// دالة معالجة تعديل درس
async function handleEditLessonSubmit(e) {
    e.preventDefault();
    console.log('Handling lesson edit submission...');

    try {
        if (!currentCourseId || !currentUnitId || !currentLessonId) {
            throw new Error('لم يتم تحديد الكورس أو الوحدة أو الدرس');
        }

        showLoadingOverlay('جاري تحديث الدرس...');

        // جمع بيانات النموذج
        const lessonData = {
            title: document.getElementById('lessonTitle').value.trim(),
            description: document.getElementById('lessonDescription').value.trim(),
            duration: parseInt(document.getElementById('lessonDuration').value) || 30,
            specialization: document.getElementById('lessonSpecialization')?.value.trim() || 'cybersecurity',
            type: document.getElementById('lessonType').value,
            isFree: document.getElementById('lessonIsFree').checked
        };

        // التحقق من البيانات المطلوبة
        if (!lessonData.title) {
            throw new Error('عنوان الدرس مطلوب');
        }

        // إضافة الرابط أو الملف حسب نوع المحتوى
        switch (lessonData.type) {
            case 'video':
                const videoUrl = document.getElementById('lessonVideoUrl').value.trim();
                const videoFile = document.getElementById('videoFileInput').files[0];
                
                if (videoUrl) {
                    lessonData.videoUrl = videoUrl;
                } else if (videoFile) {
                    const formData = new FormData();
                    formData.append('video', videoFile);
                    
                    const uploadResponse = await fetch('/api/uploads/lesson-video', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error('فشل في رفع ملف الفيديو');
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    lessonData.videoUrl = uploadResult.url;
                } else {
                    throw new Error('يجب إضافة رابط فيديو أو رفع ملف');
                }
                break;

            case 'pdf':
                const pdfUrl = document.getElementById('lessonPdfUrl').value.trim();
                const pdfFile = document.getElementById('pdfFileInput').files[0];
                
                if (pdfUrl) {
                    lessonData.fileUrl = pdfUrl;
                } else if (pdfFile) {
                    const formData = new FormData();
                    formData.append('pdf', pdfFile);
                    
                    const uploadResponse = await fetch('/api/uploads/lesson-pdf', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error('فشل في رفع ملف PDF');
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    lessonData.fileUrl = uploadResult.url;
                } else {
                    throw new Error('يجب إضافة رابط PDF أو رفع ملف');
                }
                break;

            case 'url':
                const externalUrl = document.getElementById('lessonExternalUrl').value.trim();
                if (!externalUrl) {
                    throw new Error('يجب إضافة رابط خارجي');
                }
                lessonData.externalUrl = externalUrl;
                break;

            case 'text':
                const textContent = document.getElementById('lessonTextContent').value.trim();
                lessonData.content = textContent;
                break;
        }

        // إرسال البيانات إلى الخادم
        const response = await fetch(`/api/courses/${currentCourseId}/units/${currentUnitId}/lessons/${currentLessonId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(lessonData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || error.message || 'فشل في تحديث الدرس');
        }

        alert('تم تحديث الدرس بنجاح!');
        
        // إعادة تحميل محتوى الكورس قبل إغلاق النموذج
        try {
            const contentResponse = await fetch(`/api/courses/${currentCourseId}/content`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const content = await contentResponse.json();
            displayCourseContent(content);
        } catch (refreshError) {
            console.error('Error refreshing course content:', refreshError);
            // Try alternative refresh method
            try {
                if (typeof window.Courses !== 'undefined' && typeof window.Courses.manageCourseContent === 'function') {
                    window.Courses.manageCourseContent(currentCourseId, window.currentCourseTitle);
                }
            } catch (e) {
                console.error('Alternative refresh failed:', e);
            }
        }
        
        // إغلاق النموذج بعد انتهاء التحديث
        closeAddLessonModal();

    } catch (error) {
        console.error('Error editing lesson:', error);
        alert(`خطأ: ${error.message}`);
    } finally {
        hideLoadingOverlay();
    }
}

function renderModules() {
    const container = document.getElementById('modulesContainer');
    
    if (modules.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">لا توجد وحدات. اضغط "إضافة وحدة" لبدء إضافة المحتوى.</p>';
        return;
    }
    
    container.innerHTML = modules.map(module => `
        <div class="module-card">
            <div class="module-header" onclick="toggleModule(${module.id})">
                <h4>${module.title} (${module.lessons.length} درس)</h4>
                <div class="module-actions">
                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); addLesson(${module.id})" title="إضافة درس">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteModule(${module.id})" title="حذف الوحدة">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="module-content ${module.isExpanded ? 'active' : ''}">
                ${module.lessons.length === 0 ? 
                    '<p style="text-align: center; color: #666; padding: 10px;">لا توجد دروس في هذه الوحدة.</p>' :
                    module.lessons.map(lesson => `
                        <div class="lesson-item">
                            <div class="lesson-info">
                                <div class="lesson-title">${lesson.title}</div>
                                <span class="lesson-type">
                                    <i class="fas ${lesson.type === 'video' ? 'fa-play' : 'fa-file-pdf'}"></i>
                                    ${lesson.type === 'video' ? 'فيديو' : 'PDF'}
                                </span>
                                ${lesson.description ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">${lesson.description}</div>` : ''}
                            </div>
                            <div class="lesson-actions">
                                <button class="btn btn-sm btn-primary" onclick="editLesson(${module.id}, ${lesson.id})" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteLesson(${module.id}, ${lesson.id})" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')
                }
            </div>
        </div>
    `).join('');
}

async function saveCourseContent() {
    if (!currentState.courseId) {
        alert('لا يوجد كورس محدد');
        return;
    }
    
    try {
        const response = await fetch(`/api/courses/${currentState.courseId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ units: modules }) // Send the updated modules array
        });
        
        const result = await response.json();
        if (!response.ok) throw new Error(result.message || 'فشل في حفظ محتوى الكورس');
        
        alert('تم حفظ محتوى الكورس بنجاح!');
        closeCourseContentModal();
        fetchCourses(); // Refresh the courses list
    } catch (error) {
        console.error('Error saving course content:', error);
        alert(`خطأ في حفظ محتوى الكورس: ${error.message}`);
    }
}

// Enhanced Content Addition Functions
let uploadedFiles = {};

// Toggle content input sections based on selected type
// function toggleContentInput() {
//     const contentType = document.getElementById('quickLessonType').value;
//     const videoSection = document.getElementById('videoUploadSection');
//     const pdfSection = document.getElementById('pdfUploadSection');
//     const urlSection = document.getElementById('urlInputSection');
    
//     // Hide all sections
//     videoSection.style.display = 'none';
//     pdfSection.style.display = 'none';
//     urlSection.style.display = 'none';
    
//     // Show selected section
//     switch(contentType) {
//         case 'video':
//             videoSection.style.display = 'block';
//             break;
//         case 'pdf':
//             pdfSection.style.display = 'block';
//             break;
//         case 'url':
//             urlSection.style.display = 'block';
//             break;
//     }
// }

// Handle video file upload
function handleVideoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.startsWith('video/')) {
        alert('يرجى اختيار ملف فيديو صحيح');
        event.target.value = '';
        return;
    }
    
    // Validate file size (100MB limit)
    if (file.size > 100 * 1024 * 1024) {
        alert('حجم الملف يجب أن يكون أقل من 100 ميجابايت');
        event.target.value = '';
        return;
    }
    
    // Show upload progress
    const progressSection = document.getElementById('videoUploadProgress');
    const progressFill = document.getElementById('videoProgressFill');
    const progressText = document.getElementById('videoProgressText');
    
    progressSection.style.display = 'block';
    
    // Simulate upload progress
    simulateUpload(file, progressFill, progressText, 'video');
}

// Handle PDF file upload
function handlePdfUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (file.type !== 'application/pdf') {
        alert('يرجى اختيار ملف PDF صحيح');
        event.target.value = '';
        return;
    }
    
    // Validate file size (50MB limit)
    if (file.size > 50 * 1024 * 1024) {
        alert('حجم الملف يجب أن يكون أقل من 50 ميجابايت');
        event.target.value = '';
        return;
    }
    
    // Show upload progress
    const progressSection = document.getElementById('pdfUploadProgress');
    const progressFill = document.getElementById('pdfProgressFill');
    const progressText = document.getElementById('pdfProgressText');
    
    progressSection.style.display = 'block';
    
    // Simulate upload progress
    simulateUpload(file, progressFill, progressText, 'pdf');
}

// Simulate file upload with progress
function simulateUpload(file, progressFill, progressText, type) {
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            
            // Store uploaded file info
            uploadedFiles[type] = {
                name: file.name,
                size: file.size,
                type: file.type,
                file: file
            };
            
            // Show success message
            progressText.textContent = 'تم الرفع بنجاح!';
            progressFill.style.background = '#27ae60';
            
            setTimeout(() => {
                document.getElementById(`${type}UploadProgress`).style.display = 'none';
                progressFill.style.background = 'var(--main-color)';
                progressFill.style.width = '0%';
                progressText.textContent = '0%';
            }, 2000);
        } else {
            progressFill.style.width = progress + '%';
            progressText.textContent = Math.round(progress) + '%';
        }
    }, 200);
}

// Quick add lesson function
function quickAddLesson() {
    const title = document.getElementById('quickLessonTitle').value.trim();
    const contentType = document.getElementById('quickLessonType').value;
    const description = document.getElementById('quickLessonDescription').value.trim();
    
    // Validate required fields
    if (!title) {
        alert('يرجى إدخال عنوان الدرس');
        return;
    }
    
    let content = '';
    let lessonType = '';
    
    // Get content based on type
    switch(contentType) {
        case 'video':
            if (!uploadedFiles.video) {
                alert('يرجى رفع ملف الفيديو');
                return;
            }
            content = uploadedFiles.video.name; // In real implementation, this would be the uploaded URL
            lessonType = 'video';
            break;
            
        case 'pdf':
            if (!uploadedFiles.pdf) {
                alert('يرجى رفع ملف PDF');
                return;
            }
            content = uploadedFiles.pdf.name; // In real implementation, this would be the uploaded URL
            lessonType = 'pdf';
            break;
            
        case 'url':
            const url = document.getElementById('lessonUrl').value.trim();
            if (!url) {
                alert('يرجى إدخال رابط المحتوى');
                return;
            }
            content = url;
            lessonType = 'url';
            break;
    }
    
    // Create lesson object
    const lesson = {
        id: Date.now().toString(),
        title: title,
        type: lessonType,
        content: content,
        description: description,
        duration: '5 دقائق' // Default duration
    };
    
    // Add lesson to selected module or first module
    let targetModule;
    if (modules.length === 0) {
        // Create a default module if none exists
        const defaultModule = {
            id: Date.now().toString(),
            title: 'الوحدة الأولى',
            lessons: [],
            isExpanded: true
        };
        modules.push(defaultModule);
        targetModule = defaultModule;
    } else if (modules.length === 1) {
        // If only one module exists, use it
        targetModule = modules[0];
    } else {
        // If multiple modules exist, ask user which one to add to
        const moduleOptions = modules.map((module, index) => `${index + 1}. ${module.title}`).join('\n');
        const moduleChoice = prompt(`اختر الوحدة لإضافة الدرس إليها:\n${moduleOptions}\n\nأدخل رقم الوحدة:`);
        
        if (!moduleChoice) return;
        
        const moduleIndex = parseInt(moduleChoice) - 1;
        if (isNaN(moduleIndex) || moduleIndex < 0 || moduleIndex >= modules.length) {
            alert('اختيار غير صحيح');
            return;
        }
        
        targetModule = modules[moduleIndex];
    }
    
    targetModule.lessons.push(lesson);
    
    // Update UI
    renderModules();
    
    // Clear form
    clearQuickForm();
    
    // Show success message
    alert('تم إضافة الدرس بنجاح!');
}

// Clear quick form
function clearQuickForm() {
    const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
    setVal('quickLessonTitle', '');
    setVal('quickLessonDescription', '');
    setVal('lessonUrl', '');
    const vf = document.getElementById('videoFile'); if (vf) vf.value = '';
    const pf = document.getElementById('pdfFile'); if (pf) pf.value = '';

    // Hide progress sections
    const vProgress = document.getElementById('videoUploadProgress'); if (vProgress) vProgress.style.display = 'none';
    const pProgress = document.getElementById('pdfUploadProgress'); if (pProgress) pProgress.style.display = 'none';

    // Clear uploaded files
    uploadedFiles = {};

    // Reset content type to video
    const qType = document.getElementById('quickLessonType'); if (qType) qType.value = 'video';
    try { toggleContentInput(); } catch(e) { /* ignore if not present */ }
}

// Initialize enhanced content features
function initializeEnhancedContent() {
    // Set up drag and drop for file uploads
    setupDragAndDrop();
    
    // Set up file validation
    setupFileValidation();
    
    // Initialize content type toggle
    // toggleContentInput();
}

// Set up drag and drop functionality
function setupDragAndDrop() {
    const videoInput = document.getElementById('videoFile');
    const pdfInput = document.getElementById('pdfFile');
    
    [videoInput, pdfInput].forEach(input => {
        if (input) {
            input.addEventListener('dragover', (e) => {
                e.preventDefault();
                input.style.borderColor = 'var(--main-color)';
                input.style.background = '#f0f8ff';
            });
            
            input.addEventListener('dragleave', (e) => {
                e.preventDefault();
                input.style.borderColor = '#dee2e6';
                input.style.background = '#f8f9fa';
            });
            
            input.addEventListener('drop', (e) => {
                e.preventDefault();
                input.style.borderColor = '#dee2e6';
                input.style.background = '#f8f9fa';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    input.dispatchEvent(new Event('change'));
                }
            });
        }
    });
}

// Set up file validation
function setupFileValidation() {
    // Add real-time file size validation
    const videoInput = document.getElementById('videoFile');
    const pdfInput = document.getElementById('pdfFile');
    
    if (videoInput) {
        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.size > 100 * 1024 * 1024) {
                alert('حجم ملف الفيديو يجب أن يكون أقل من 100 ميجابايت');
                e.target.value = '';
            }
        });
    }
    
    if (pdfInput) {
        pdfInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.size > 50 * 1024 * 1024) {
                alert('حجم ملف PDF يجب أن يكون أقل من 50 ميجابايت');
                e.target.value = '';
            }
        });
    }
}

// Initialize enhanced content when course content modal is opened
const originalManageCourseContent = manageCourseContent;
manageCourseContent = function(courseId, courseTitle) {
    originalManageCourseContent(courseId, courseTitle);
    setTimeout(initializeEnhancedContent, 100);
};

CustomVideo.blotName = 'customVideo';
CustomVideo.tagName = 'video';
window.Quill && window.Quill.register && window.Quill.register(CustomVideo);

// نموذج إضافة وحدة (module)
function toggleAddModuleForm() {
  const form = document.getElementById('addModuleForm');
  if (form.style.display === 'none' || form.style.display === '') {
    form.style.display = 'block';
    document.getElementById('moduleTitleInput').focus();
  } else {
    form.style.display = 'none';
    document.getElementById('moduleTitleInput').value = '';
  }
}

function submitAddModule() {
  const input = document.getElementById('moduleTitleInput');
  const title = input.value.trim();
  if (!title) {
    input.style.borderColor = '#e74c3c';
    input.placeholder = 'يرجى إدخال اسم الوحدة';
    input.focus();
    setTimeout(() => { input.style.borderColor = ''; }, 1200);
    return;
  }
  
  // إضافة الوحدة للمصفوفة modules
  const newModule = {
    id: Date.now().toString(),
    title: title,
    lessons: [],
    isExpanded: true
  };
  modules.push(newModule);
  renderModules();
  toggleAddModuleForm();
}

// دالة لحفظ محتوى الكورس
async function saveCourseContent(courseId, units) {
    try {
        if (!courseId) {
            throw new Error('معرف الكورس مطلوب لحفظ المحتوى');
        }

        const response = await fetch(`/api/courses/${courseId}/content`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ units })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'فشل في حفظ محتوى الكورس');
        }

        const result = await response.json();
        console.log('تم حفظ محتوى الكورس بنجاح:', result);
        return result;
    } catch (error) {
        console.error('خطأ في حفظ محتوى الكورس:', error);
        throw error;
    }
}

// دالة لحفظ محتوى الكورس بالبيانات الحالية
async function saveCourseContentWithCurrentData() {
    try {
        if (!currentState.courseId) {
            alert('خطأ: لم يتم تحديد الكورس');
            return;
        }

        // جلب محتوى الكورس الحالي
        const response = await fetch(`/api/courses/${currentState.courseId}/content`);
        if (!response.ok) {
            throw new Error('فشل في جلب محتوى الكورس');
        }

        const courseContent = await response.json();
        const units = courseContent.units || [];

        // حفظ المحتوى
        await saveCourseContent(currentCourseId, units);
        alert('تم حفظ محتوى الكورس بنجاح!');
        
    } catch (error) {
        console.error('خطأ في حفظ محتوى الكورس:', error);
        alert(`خطأ: ${error.message}`);
    }
}

// دالة لإضافة وحدة جديدة (API)
async function addUnitToCourseAPI(courseId, unitData) {
    try {
        const response = await fetch(`/api/courses/${courseId}/units`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(unitData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'فشل في إضافة الوحدة');
        }

        const result = await response.json();
        console.log('تم إضافة الوحدة بنجاح:', result);
        return result;
    } catch (error) {
        console.error('خطأ في إضافة الوحدة:', error);
        throw error;
    }
}

// // دالة لإضافة درس جديد (API)
// async function addLessonToUnitAPI(courseId, unitId, lessonData, file) {
//     const formData = new FormData();
//     formData.append("title", lessonData.title);
//     formData.append("description", lessonData.description);
//     formData.append("duration", lessonData.duration);
//     formData.append("type", lessonData.type);
//     if (lessonData.type === "video" && file) {
//         formData.append("videoFile", file);
//     } else if (lessonData.type === "url" && lessonData.externalUrl) {
//         formData.append("externalUrl", lessonData.externalUrl);
//     }
//     const response = await fetch(`/api/courses/${courseId}/units/${unitId}/lessons`, {
//         method: "POST",
//         body: formData
//     });
//     if (!response.ok) {
//         throw new Error("فشل رفع الدرس");
//     }
//     return await response.json();
// }/units/${unitId}/lessons`, {
//             method: 'POST',
//             headers: {
//                 'Content-Type': 'application/json',
//                 'Authorization': `Bearer ${localStorage.getItem('token')}`
//             },
//             body: JSON.stringify(lessonData)
//         });

//         if (!response.ok) {
//             const error = await response.json();
//             throw new Error(error.error || 'فشل في إضافة الدرس');
//         }

//         const result = await response.json();
//         console.log('تم إضافة الدرس بنجاح:', result);
//         return result;
//     } catch (error) {
//         console.error('خطأ في إضافة الدرس:', error);
//         throw error;
//     }
// }


async function addLessonToUnitAPI(courseId, unitId, lessonData, file) {
    const formData = new FormData();

    formData.append('title', lessonData.title);
    formData.append('description', lessonData.description || '');
    formData.append('duration', String(lessonData.duration || 30));
    formData.append('type', lessonData.type);
    formData.append('isFree', lessonData.isFree ? 'true' : 'false');

    if (lessonData.type === 'video') {
        if (file) {
            formData.append('lessonFile', file);
        } else if (lessonData.videoUrl) {
            formData.append('videoUrl', lessonData.videoUrl);
        } else {
            throw new Error('يجب رفع ملف فيديو أو إدخال رابط فيديو');
        }
    } else if (lessonData.type === 'pdf') {
        if (file) {
            formData.append('lessonFile', file);
        } else if (lessonData.fileUrl) {
            formData.append('fileUrl', lessonData.fileUrl);
        } else {
            throw new Error('يرجى إدخال رابط ملف PDF');
        }
    } else if (lessonData.type === 'url') {
        if (lessonData.externalUrl) {
            formData.append('externalUrl', lessonData.externalUrl);
        } else {
            throw new Error('يرجى إدخال الرابط الخارجي');
        }
    }
    
    const response = await fetch(`/api/courses/${courseId}/units/${unitId}/lessons`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
        },
        body: formData
    });

    const resText = await response.text(); // قراءة مرة واحدة
    let resData;
    try {
        resData = JSON.parse(resText);
    } catch {
        console.error('Server response is not JSON:', resText);
    }

    if (!response.ok) {
        throw new Error((resData && resData.error) || 'فشل رفع الدرس');
    }

    return resData;
}





// متغيرات عامة لتتبع الكورس والوحدة الحالية
const currentState = {
    courseId: null,
    courseTitle: null,
    unitId: null
};

// دالة لإضافة وحدة جديدة
async function addUnitToCourse(courseId) {
    console.log('addUnitToCourse called with arg:', courseId);
    // Resolve courseId from multiple possible sources to be resilient to legacy/global differences
    const resolvedCourseId = courseId
        || (typeof window !== 'undefined' && window.currentCourseId)
        || (typeof window !== 'undefined' && window.currentState && window.currentState.courseId)
        || (typeof currentState !== 'undefined' && currentState.courseId)
        || null;

    if (!resolvedCourseId) {
        alert('خطأ: لم يتم تحديد الكورس');
        return;
    }

    // Normalize state in all known locations so other code paths can rely on a single source
    try { currentState.courseId = resolvedCourseId; } catch (e) { /* ignore */ }
    if (typeof window !== 'undefined') {
        window.currentState = window.currentState || {};
        window.currentState.courseId = resolvedCourseId;
        window.currentCourseId = resolvedCourseId;
    }

    // Open unit modal without closing content modal
    openAddUnitModal(false); // Pass false to not close other modals
}

// Expose to window for inline onclick handlers and external callers
try { if (typeof window !== 'undefined') window.addUnitToCourse = addUnitToCourse; } catch(e) { /* ignore */ }

// دالة فتح مودال إضافة وحدة
function openAddUnitModal(closeOthers = true) {
    console.log('openAddUnitModal called, closeOthers:', closeOthers);
    const modal = document.getElementById('addUnitModal');
    if (!modal) return console.error('openAddUnitModal: addUnitModal not found');

    // Reset the form
    const form = document.getElementById('addUnitForm');
    if (form) {
        try { form.removeEventListener('submit', handleAddUnitSubmit); } catch(e) {}
        form.addEventListener('submit', handleAddUnitSubmit);
        form.reset();
    }

    // Prefer ModalSystem if available
    try {
        if (typeof ModalSystem !== 'undefined' && ModalSystem && typeof ModalSystem.openModal === 'function') {
            ModalSystem.openModal('addUnitModal', closeOthers);
            // focus first input after a short delay
            setTimeout(() => { const first = modal.querySelector('input, textarea, select, button'); if (first) try { first.focus(); } catch(e) {} }, 60);
            return;
        }
    } catch (err) {
        console.warn('openAddUnitModal: ModalSystem.openModal failed', err);
    }

    // Fallback display
    if (closeOthers) {
        // Close other modals
        document.querySelectorAll('.modal').forEach(m => {
            if (m.id !== 'addUnitModal') {
                m.style.display = 'none';
                m.classList.remove('show');
            }
        });
    }
    modal.style.display = 'flex';
    modal.classList.add('show');
    modal.style.zIndex = '30000';
    document.body.style.overflow = 'hidden';
    const first = modal.querySelector('input, textarea, select, button');
    if (first) try { first.focus(); } catch(e) {}
}

// دالة إغلاق مودال إضافة وحدة
function closeAddUnitModal() {
    const modal = document.getElementById('addUnitModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// دالة معالجة إرسال نموذج إضافة وحدة
async function handleAddUnitSubmit(e) {
    e.preventDefault();
    
    const unitTitle = document.getElementById('unitTitle').value.trim();
    const unitDescription = document.getElementById('unitDescription').value.trim();
    const unitOrder = parseInt(document.getElementById('unitOrder').value) || 1;
    
    if (!unitTitle) {
        alert('يرجى إدخال عنوان الوحدة');
        return;
    }
    
    try {
        const unitData = {
            title: unitTitle,
            description: unitDescription,
            order: unitOrder
        };
        
        // استخدام currentState أو currentCourseId
        const courseId = currentState.courseId || currentCourseId || window.currentCourseId;
        const courseTitle = currentState.courseTitle || currentCourseTitle || window.currentCourseTitle || 'الكورس';
        
        if (!courseId) {
            throw new Error('لم يتم تحديد معرف الكورس');
        }
        
        await addUnitToCourseAPI(courseId, unitData);
        alert('تم إضافة الوحدة بنجاح!');
        
        // إغلاق النموذج أولاً
        closeAddUnitModal();
        
        // ثم إعادة تحميل محتوى الكورس بدون فتح مودال جديد
        try {
            const res = await fetch(`/api/courses/${courseId}/content`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
            });
            if (res.ok) {
                const content = await res.json();
                console.log('Updated course content:', content);
                displayCourseContent(content);
            }
        } catch (refreshError) {
            console.error('Error refreshing course content:', refreshError);
        }
        
    } catch (error) {
        console.error('خطأ في إضافة الوحدة:', error);
        alert(`خطأ: ${error.message}`);
    }
}

// دالة لإضافة درس جديد
async function addLessonToUnit(courseId, unitId) {
    if (!courseId || !unitId) {
        alert('خطأ: لم يتم تحديد الكورس أو الوحدة');
        return;
    }

    // Update global state first
    window.currentState = window.currentState || {};
    window.currentState.courseId = courseId;
    window.currentState.unitId = unitId;
    
    const modal = document.getElementById('addLessonModal');
    if (modal) {
        console.log('Opening lesson modal for unit:', unitId);
        const form = document.getElementById('addLessonForm');
        if (form) {
            form.reset();
            form.removeEventListener('submit', handleAddLessonSubmit);
            form.addEventListener('submit', handleAddLessonSubmit);
        }
        
        // Reset content type to video by default
        selectContentType('video');
        
        modal.style.display = 'flex';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    } else {
        console.error('Lesson modal not found');
    }
}

// دالة فتح مودال إضافة درس
function openAddLessonModal() {
    const modal = document.getElementById('addLessonModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // إعادة تعيين النموذج
    document.getElementById('addLessonForm').reset();
    
    // إخفاء جميع أقسام المحتوى
    document.querySelectorAll('.content-input-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // إعادة تعيين معالج النموذج للإضافة
    document.getElementById('addLessonForm').onsubmit = handleAddLessonSubmit;
    
    // تغيير نص الزر
    const submitBtn = document.querySelector('#addLessonForm button[type="submit"]');
    submitBtn.textContent = 'إضافة الدرس';
    
    // مسح معرف الدرس الحالي
    window.currentLessonId = null;
}

// دالة إغلاق مودال إضافة درس
function closeAddLessonModal() {
    const modal = document.getElementById('addLessonModal');
    try {
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('show');
        }
        // reset form and previews
        const form = document.getElementById('addLessonForm');
        if (form) try { form.reset(); } catch(e) {}
        try { removeVideo(); } catch(e) {}
        try { removePdf(); } catch(e) {}
        const vUrl = document.getElementById('lessonVideoUrl'); if (vUrl) vUrl.value = '';
        const pUrl = document.getElementById('lessonPdfUrl'); if (pUrl) pUrl.value = '';
        const extUrl = document.getElementById('lessonExternalUrl'); if (extUrl) extUrl.value = '';
        try { selectContentType('video'); } catch(e) {}
        const submitBtn = document.querySelector('#addLessonForm button[type="submit"]');
        if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'إضافة الدرس'; }
    } finally {
        document.body.style.overflow = 'auto';
    }
}

// دالة تبديل حقول المحتوى حسب النوع
function toggleLessonContentInput() {
    const lessonType = document.getElementById('lessonType').value;
    
    // إخفاء جميع أقسام المحتوى
    document.querySelectorAll('.content-input-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // إظهار القسم المناسب
    switch(lessonType) {
        case 'video':
            document.getElementById('videoInputSection').style.display = 'block';
            break;
        case 'pdf':
            document.getElementById('pdfInputSection').style.display = 'block';
            break;
        case 'url':
            document.getElementById('urlInputSection').style.display = 'block';
            break;
    }
}






// دالة معالجة إرسال نموذج إضافة درس
// async function handleAddLessonSubmit(e) {
//     const fileInput = document.getElementById("videoFileInput");
//     const file = fileInput ? fileInput.files[0] : null;

//     e.preventDefault();
    
//     const lessonTitle = document.getElementById('lessonTitle').value.trim();
//     const lessonDescription = document.getElementById('lessonDescription').value.trim();
//     const lessonType = document.getElementById('lessonType').value;
//     const lessonDuration = parseInt(document.getElementById('lessonDuration').value) || 30;
//     const lessonIsFree = document.getElementById('lessonIsFree').checked;
    
//     if (!lessonTitle) {
//         alert('يرجى إدخال عنوان الدرس');
//         return;
//     }
    
//     if (!lessonType) {
//         alert('يرجى اختيار نوع المحتوى');
//         return;
//     }
    
//     try {
//         let lessonData = {
//             title: lessonTitle,
//             description: lessonDescription,
//             duration: lessonDuration,
//             type: lessonType,
//             isFree: lessonIsFree
//         };
        
//         // إضافة المحتوى حسب النوع
//         switch(lessonType) {
//             case 'video':
//                 const videoUrl = document.getElementById('lessonVideoUrl').value.trim();
//                 if (!videoUrl) {
//                     alert('يرجى إدخال رابط الفيديو');
//                     return;
//                 }
//                 lessonData.videoUrl = videoUrl;
//                 break;
                
//             case 'pdf':
//                 const pdfUrl = document.getElementById('lessonPdfUrl').value.trim();
//                 if (!pdfUrl) {
//                     alert('يرجى إدخال رابط ملف PDF');
//                     return;
//                 }
//                 lessonData.fileUrl = pdfUrl;
//                 break;
                
//             case 'url':
//                 const externalUrl = document.getElementById('lessonExternalUrl').value.trim();
//                 if (!externalUrl) {
//                     alert('يرجى إدخال الرابط الخارجي');
//                     return;
//                 }
//                 lessonData.externalUrl = externalUrl;
//                 break;
//         }
        
//         await addLessonToUnitAPI(currentCourseId, currentUnitId, lessonData);
//         alert('تم إضافة الدرس بنجاح!');
        
//         closeAddLessonModal();
        
//         // إعادة تحميل محتوى الكورس
//         manageCourseContent(currentCourseId, currentCourseTitle);
        console.log('Handling lesson form submission...');
        showLoadingOverlay(); // Add loading indicator
        
//     } catch (error) {
//         console.error('خطأ في إضافة الدرس:', error);
//         alert(`خطأ: ${error.message}`);
//     }
// }




// async function handleAddLessonSubmit(e) {
// e.preventDefault();

// const fileInput = document.getElementById("videoFileInput");
// const file = fileInput ? fileInput.files[0] : null;

// const lessonTitle = document.getElementById('lessonTitle').value.trim();
// const lessonDescription = document.getElementById('lessonDescription').value.trim();
// const lessonType = document.getElementById('lessonType').value;
// const lessonDuration = parseInt(document.getElementById('lessonDuration').value) || 30;
// const lessonIsFree = document.getElementById('lessonIsFree').checked;

// if (!lessonTitle) {
//     alert('يرجى إدخال عنوان الدرس');
//     return;
// }

// if (!lessonType) {
//     alert('يرجى اختيار نوع المحتوى');
//     return;
// }

// const lessonData = {
//     title: lessonTitle,
//     description: lessonDescription,
//     duration: lessonDuration,
//     type: lessonType,
//     isFree: lessonIsFree
// };

// try {
//     switch (lessonType) {
//     case 'video':
//         const videoUrl = document.getElementById('lessonVideoUrl')?.value.trim();
//         if (!file && !videoUrl) {
//         alert('يرجى رفع ملف فيديو أو إدخال رابط فيديو');
//         return;
//         }
//         if (videoUrl) lessonData.videoUrl = videoUrl;
//         break;

//     case 'pdf':
//         const pdfUrl = document.getElementById('lessonPdfUrl')?.value.trim();
//         if (!pdfUrl) {
//         alert('يرجى إدخال رابط ملف PDF');
//         return;
//         }
//         lessonData.fileUrl = pdfUrl;
//         break;

//     case 'url':
//         const externalUrl = document.getElementById('lessonExternalUrl')?.value.trim();
//         if (!externalUrl) {
//         alert('يرجى إدخال الرابط الخارجي');
//         return;
//         }
//         lessonData.externalUrl = externalUrl;
//         break;
//     }

//     await addLessonToUnitAPI(currentCourseId, currentUnitId, lessonData, file);
//     alert('تم إضافة الدرس بنجاح!');
//     closeAddLessonModal();
//     manageCourseContent(currentCourseId, currentCourseTitle);

        hideLoadingOverlay(); // Remove loading indicator
// } catch (error) {
//     console.error('خطأ في إضافة الدرس:', error);
//     alert(`خطأ: ${error.message}`);
// }
// }
async function handleAddLessonSubmit(e) {
    e.preventDefault();
    console.log('Handling lesson form submission...');

    const submitBtn = document.querySelector('#addLessonForm button[type="submit"]');
    if (submitBtn) {
        try { submitBtn.dataset.origText = submitBtn.textContent || 'إضافة الدرس'; } catch(e) {}
        submitBtn.disabled = true;
        submitBtn.textContent = 'جاري الرفع...';
    }
    try { showLoadingOverlay('جاري رفع الدرس...'); } catch(e) { console.warn('showLoadingOverlay not available'); }

    if (!window.currentState?.courseId || !window.currentState?.unitId) {
        console.error('Missing courseId or unitId', window.currentState);
        alert('خطأ: لم يتم تحديد الكورس أو الوحدة');
        return;
    }

    const lessonTitle = document.getElementById('lessonTitle').value.trim();
    const lessonDescription = document.getElementById('lessonDescription').value.trim();
    const lessonType = document.getElementById('lessonType').value;
    const lessonDuration = parseInt(document.getElementById('lessonDuration').value) || 30;
    const lessonIsFree = document.getElementById('lessonIsFree').checked;
    const lessonSpecialization = document.getElementById('lessonSpecialization')?.value.trim() || 'cybersecurity';

    if (!lessonTitle) return alert('يرجى إدخال عنوان الدرس');
    if (!lessonType) return alert('يرجى اختيار نوع المحتوى');

    // تجهيز FormData
    const formData = new FormData();
    formData.append('title', lessonTitle);
    formData.append('description', lessonDescription);
    formData.append('duration', lessonDuration.toString());
    formData.append('type', lessonType);
    formData.append('isFree', lessonIsFree.toString());
    formData.append('specialization', lessonSpecialization);

    try {
        switch (lessonType) {
            case 'video':
                const videoUrl = document.getElementById('lessonVideoUrl')?.value.trim();
                const videoFile = document.getElementById('videoFileInput')?.files[0];
                if (!videoFile && !videoUrl) return alert('يرجى رفع ملف فيديو أو إدخال رابط فيديو');
                if (videoUrl) formData.append('videoUrl', videoUrl);
                if (videoFile) {
                    console.log('Adding video file:', videoFile.name, videoFile.type);
                    formData.append('lessonFile', videoFile);
                }
                break;

            case 'pdf':
                const pdfUrl = document.getElementById('lessonPdfUrl')?.value.trim();
                const pdfFile = document.getElementById('pdfFileInput')?.files[0];
                if (!pdfFile && !pdfUrl) return alert('يرجى رفع ملف PDF أو إدخال رابط PDF');
                if (pdfUrl) formData.append('fileUrl', pdfUrl);
                if (pdfFile) formData.append('lessonFile', pdfFile);
                break;

            case 'url':
                const externalUrl = document.getElementById('lessonExternalUrl')?.value.trim();
                if (!externalUrl) return alert('يرجى إدخال الرابط الخارجي');
                formData.append('externalUrl', externalUrl);
                break;
        }

        console.log('Submitting lesson to:', window.currentState.courseId, window.currentState.unitId);

        // رفع الدرس
        const res = await fetch(`/api/courses/${window.currentState.courseId}/units/${window.currentState.unitId}/lessons`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: formData
        });

        // Read response text first
        const responseText = await res.text();
        console.log('Server response:', responseText);

        // Try to parse as JSON, but handle HTML error pages
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            console.error('Failed to parse response as JSON:', e);
            // Check if it's an HTML error page and extract the error message
            if (responseText.includes('<!DOCTYPE html>')) {
                const match = responseText.match(/Error: ([^<]+)/);
                if (match && match[1]) {
                    throw new Error(match[1]); // Use the error message from the HTML
                }
            }
            throw new Error('صيغة الملف غير مسموح بها، الرجاء استخدام ملف فيديو بصيغة mp4 أو mov.');
        }

        if (!res.ok) {
            throw new Error(data.error || data.message || 'فشل رفع الدرس');
        }

        alert('تم إضافة الدرس بنجاح!');
        closeAddLessonModal();
        // Close unit modal if it's open
        closeAddUnitModal();
        // Refresh the course content modal if it's open
        const courseContentModal = document.getElementById('courseContentModal');
        if (courseContentModal && courseContentModal.classList.contains('show')) {
            try {
                const res = await fetch(`/api/courses/${window.currentState.courseId}/content`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (res.ok) {
                    const content = await res.json();
                    displayCourseContent(content);
                }
            } catch (refreshError) {
                console.error('Error refreshing course content:', refreshError);
            }
        }

    } catch (error) {
        console.error('خطأ في إضافة الدرس:', error);
        // Give a more helpful message for file type errors
        if (error.message && error.message.includes('صيغة الملف غير مسموح بها')) {
            alert('خطأ: صيغة الملف غير مسموح بها. الرجاء استخدام ملف فيديو بصيغة MP4 أو MOV أو ملف PDF.');
        } else {
            alert(`خطأ: ${error.message || error}`);
        }
    } finally {
        try { hideLoadingOverlay(); } catch(e) { /* ignore */ }
        if (submitBtn) {
            submitBtn.disabled = false;
            try { submitBtn.textContent = submitBtn.dataset.origText || 'إضافة الدرس'; } catch(e) { submitBtn.textContent = 'إضافة الدرس'; }
        }
    }
}



// دالة لحذف وحدة (API)
async function deleteUnit(courseId, unitId) {
    const confirmed = await showConfirm({
        title: 'تأكيد حذف الوحدة',
        message: 'هل أنت متأكد من حذف هذه الوحدة؟ سيتم حذف جميع الدروس المرتبطة بها.',
        confirmText: 'نعم، احذف الوحدة',
        cancelText: 'إلغاء'
    });
    if (!confirmed) return;

    try {
        const response = await fetch(`/api/courses/${courseId}/units/${unitId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'فشل في حذف الوحدة');
        }

        alert('تم حذف الوحدة بنجاح!');
        // Refresh the course content modal if it's open
        const courseContentModal = document.getElementById('courseContentModal');
        if (courseContentModal && courseContentModal.classList.contains('show')) {
            try {
                const res = await fetch(`/api/courses/${courseId}/content`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (res.ok) {
                    const content = await res.json();
                    displayCourseContent(content);
                }
            } catch (refreshError) {
                console.error('Error refreshing course content:', refreshError);
            }
        }
    } catch (error) {
        console.error('خطأ في حذف الوحدة:', error);
        alert(`خطأ: ${error.message}`);
    }
}

// دالة لتعديل درس (API)
async function editLesson(courseId, unitId, lessonId) {
    try {
        // جلب بيانات الدرس الحالية
        const response = await fetch(`/api/courses/${courseId}/units/${unitId}/lessons/${lessonId}`);
        if (!response.ok) {
            throw new Error('فشل في جلب بيانات الدرس');
        }
        
        const lesson = await response.json();
        
        // استخدام المودال الجديد لتعديل الدرس
        currentState.courseId = courseId;
        currentState.unitId = unitId;
        openEditLessonModal(lesson);
    } catch (error) {
        console.error('خطأ في جلب بيانات الدرس:', error);
        alert(`خطأ: ${error.message}`);
    }
}

// دالة لحذف درس (API)
async function deleteLesson(courseId, unitId, lessonId) {
    const confirmed = await showConfirm({
        title: 'تأكيد حذف الدرس',
        message: 'هل أنت متأكد من حذف هذا الدرس؟',
        confirmText: 'نعم، احذف الدرس',
        cancelText: 'إلغاء'
    });
    if (!confirmed) return;

    try {
        const response = await fetch(`/api/courses/${courseId}/units/${unitId}/lessons/${lessonId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'فشل في حذف الدرس');
        }

        alert('تم حذف الدرس بنجاح!');
        // Refresh the course content modal if it's open
        const courseContentModal = document.getElementById('courseContentModal');
        if (courseContentModal && courseContentModal.classList.contains('show')) {
            try {
                const res = await fetch(`/api/courses/${courseId}/content`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (res.ok) {
                    const content = await res.json();
                    displayCourseContent(content);
                }
            } catch (refreshError) {
                console.error('Error refreshing course content:', refreshError);
            }
        }
    } catch (error) {
        console.error('خطأ في حذف الدرس:', error);
        alert(`خطأ: ${error.message}`);
    }
}

// دالة فتح مودال تعديل درس
function openEditLessonModal(lesson) {
    const modal = document.getElementById('addLessonModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // حفظ معرف الدرس للتحديث
    window.currentLessonId = lesson._id;
    
    // ملء النموذج ببيانات الدرس الحالية
    document.getElementById('lessonTitle').value = lesson.title || '';
    document.getElementById('lessonDescription').value = lesson.description || '';
    document.getElementById('lessonDuration').value = lesson.duration || 30;
    document.getElementById('lessonIsFree').checked = lesson.isFree !== false;
    
    // تحديد نوع المحتوى
    document.getElementById('lessonType').value = lesson.type || '';
    toggleLessonContentInput();
    
    // ملء محتوى النوع المحدد
    switch(lesson.type) {
        case 'video':
            document.getElementById('lessonVideoUrl').value = lesson.videoUrl || '';
            break;
        case 'pdf':
            document.getElementById('lessonPdfUrl').value = lesson.fileUrl || '';
            break;
        case 'url':
            document.getElementById('lessonExternalUrl').value = lesson.externalUrl || '';
            break;

    }
    
    // تغيير نص الزر
    const submitBtn = document.querySelector('#addLessonForm button[type="submit"]');
    submitBtn.textContent = 'تحديث الدرس';
    
    // تغيير معالج النموذج
    document.getElementById('addLessonForm').onsubmit = handleUpdateLessonSubmit;
}

// دالة معالجة تحديث درس
async function handleUpdateLessonSubmit(e) {
    e.preventDefault();
    const lessonTitle = document.getElementById('lessonTitle').value.trim();
    const lessonDescription = document.getElementById('lessonDescription').value.trim();
    const lessonType = document.getElementById('lessonType').value;
    const lessonDuration = parseInt(document.getElementById('lessonDuration').value) || 30;
    const lessonIsFree = document.getElementById('lessonIsFree').checked;
    
    if (!lessonTitle) {
        alert('يرجى إدخال عنوان الدرس');
        return;
    }
    if (!lessonType) {
        alert('يرجى اختيار نوع المحتوى');
        return;
    }
    
    try {
        let lessonData = {
            title: lessonTitle,
            description: lessonDescription,
            duration: lessonDuration,
            type: lessonType,
            isFree: lessonIsFree
        };
        
        switch(lessonType) {
            case 'video':
                const videoUrl = document.getElementById('lessonVideoUrl').value.trim();
                if (!videoUrl) {
                    alert('يرجى إدخال رابط الفيديو');
                    return;
                }
                lessonData.videoUrl = videoUrl;
                break;
            case 'pdf':
                const pdfUrl = document.getElementById('lessonPdfUrl').value.trim();
                if (!pdfUrl) {
                    alert('يرجى إدخال رابط ملف PDF');
                    return;
                }
                lessonData.fileUrl = pdfUrl;
                break;
            case 'url':
                const externalUrl = document.getElementById('lessonExternalUrl').value.trim();
                if (!externalUrl) {
                    alert('يرجى إدخال الرابط الخارجي');
                    return;
                }
                lessonData.externalUrl = externalUrl;
                break;

        }
        
        // استخدام API لتحديث الدرس
        const response = await fetch(`/api/courses/${currentCourseId}/units/${currentUnitId}/lessons/${window.currentLessonId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(lessonData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'فشل في تحديث الدرس');
        }
        
        alert('تم تحديث الدرس بنجاح!');
        closeAddLessonModal();
        manageCourseContent(currentCourseId, currentCourseTitle);
    } catch (error) {
        console.error('خطأ في تحديث الدرس:', error);
        alert(`خطأ: ${error.message}`);
    }
}











// if (typeof quill === 'undefined') {
//     var quill = new Quill('#editor', { theme: 'snow' });
// }

// Attach canonical global modal handlers (override duplicates, add logging)
// Modal Management Functions
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
    }
}

// Close modal on ESC and clicking backdrop
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' || e.key === 'Esc') {
        document.querySelectorAll('.modal.show').forEach(modal => {
            try { closeModal(modal.id); } catch (err) { /* ignore */ }
        });
    }
});

document.addEventListener('click', (e) => {
    // If click target is a modal backdrop (has class 'modal' and not inside .modal-content)
    const target = e.target;
    if (target && target.classList && target.classList.contains('modal')) {
        if (!target.querySelector('.modal-content') || !target.querySelector('.modal-content').contains(e.target)) {
            try { closeModal(target.id); } catch (err) { /* ignore */ }
        }
    }
});
(function attachCourseDelegators(){
    try {
        if (window.Courses) {
            console.log('Setting up Courses module delegators...');
            
            // تأكد من أن جميع الدوال موجودة قبل استخدام bind
            if (typeof window.Courses.openAddCourseModal === 'function') {
                window.openAddCourseModal = function() {
                    return window.Courses.openAddCourseModal();
                };
            } else {
                window.openAddCourseModal = function() {
                    console.warn('Courses.openAddCourseModal not available');
                    // Fallback implementation
                    const modal = document.getElementById('courseModal');
                    if (modal) {
                        document.getElementById('courseModalTitle').textContent = 'إضافة كورس جديد';
                        const form = document.getElementById('addCourseForm');
                        if (form) form.reset();
                        window.editingCourseId = null;
                        window.mediaItems = [];
                        window.currentPromoVideoId = null;
                        modal.style.display = 'flex';
                        modal.classList.add('show');
                        document.body.style.overflow = 'hidden';
                        if (typeof window.renderMediaGrid === 'function') {
                            setTimeout(() => {
                                window.renderMediaGrid();
                            }, 100);
                        }
                    }
                };
            }

            if (typeof window.Courses.openEditCourse === 'function') {
                window.editCourse = function(courseId) {
                    return window.Courses.openEditCourse(courseId);
                };
            }

            if (typeof window.Courses.manageCourseContent === 'function') {
                window.manageCourseContent = function(courseId, courseTitle) {
                    return window.Courses.manageCourseContent(courseId, courseTitle);
                };
            }

            if (typeof window.Courses.closeCourseModal === 'function') {
                window.closeCourseModal = function() {
                    return window.Courses.closeCourseModal();
                };
            } else {
                window.closeCourseModal = function() {
                    const modal = document.getElementById('courseModal');
                    if (modal) {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        document.body.style.overflow = 'auto';
                        window.editingCourseId = null;
                    }
                };
            }

            if (typeof window.Courses.closeCourseContentModal === 'function') {
                window.closeCourseContentModal = function() {
                    return window.Courses.closeCourseContentModal();
                };
            } else {
                window.closeCourseContentModal = function() {
                    const modal = document.getElementById('courseContentModal');
                    if (modal) {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        document.body.style.overflow = 'auto';
                        window.currentCourseId = null;
                        window.currentCourseTitle = null;
                    }
                };
            }

            // معالج نموذج الكورس
            if (typeof window.Courses.handleAddCourseSubmit === 'function') {
                window.handleAddCourseSubmit = function(e) {
                    return window.Courses.handleAddCourseSubmit(e);
                };
            }

            window.handleUpdateCourseSubmit = window.handleAddCourseSubmit;

            console.log('Courses delegators setup complete');

        } else {
            console.warn('Courses module not available, using fallbacks');
            setupFallbackFunctions();
        }
    } catch(err) {
        console.warn('attachCourseDelegators failed, using fallbacks:', err);
        setupFallbackFunctions();
    }

    // دالة للبدائل في حالة فشل التهيئة
    function setupFallbackFunctions() {
        window.openAddCourseModal = function() {
            console.log('Fallback: Opening add course modal');
            const modal = document.getElementById('courseModal');
            if (modal) {
                document.getElementById('courseModalTitle').textContent = 'إضافة كورس جديد';
                const form = document.getElementById('addCourseForm');
                if (form) {
                    form.reset();
                    // Remove any existing hidden id input
                    const existingHiddenId = form.querySelector('input[name="id"]');
                    if (existingHiddenId) {
                        existingHiddenId.remove();
                    }
                    // Clear dataset courseId
                    delete form.dataset.courseId;
                }
                window.editingCourseId = null;
                window.mediaItems = [];
                window.currentPromoVideoId = null;
                modal.style.display = 'flex';
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                if (typeof window.renderMediaGrid === 'function') {
                    setTimeout(() => {
                        window.renderMediaGrid();
                    }, 100);
                }
            }
        };

        window.editCourse = function(courseId) {
            console.log('Fallback: Edit course', courseId);
            // تنفيذ بديل للتعديل
        };

        window.manageCourseContent = function(courseId, courseTitle) {
            console.log('Fallback: Manage course content', courseId, courseTitle);
            // تنفيذ بديل لإدارة المحتوى
        };

        window.closeCourseModal = function() {
            const modal = document.getElementById('courseModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
                window.editingCourseId = null;
            }
        };

        window.closeCourseContentModal = function() {
            const modal = document.getElementById('courseContentModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
                window.currentCourseId = null;
                window.currentCourseTitle = null;
            }
        };

        window.handleAddCourseSubmit = async function(e) {
            e.preventDefault();
            console.log('Fallback: Handling course submission');
            alert('وظيفة إضافة الكورس غير متاحة حالياً. الرجاء المحاولة لاحقاً.');
        };

        window.handleUpdateCourseSubmit = window.handleAddCourseSubmit;
    }
})();

// دالة فتح نموذج إضافة كورس
function openAddCourseModal() {
    const modal = document.getElementById('courseModal');
    if (!modal) {
        console.error('Course modal not found');
        return;
    }
    
    // تعيين العنوان
    document.getElementById('courseModalTitle').textContent = 'إضافة كورس جديد';
    
    // إعادة تعيين النموذج
    const form = document.getElementById('addCourseForm');
    if (form) {
        form.reset();
        // Remove any existing hidden id input
        const existingHiddenId = form.querySelector('input[name="id"]');
        if (existingHiddenId) {
            existingHiddenId.remove();
        }
        // Clear dataset courseId
        delete form.dataset.courseId;
        form.onsubmit = handleAddCourseSubmit;
    }
    
    // إعادة تعيين متغيرات الحالة
    window.editingCourseId = null;
    window.mediaItems = [];
    window.currentPromoVideoId = null;
    
    // فتح المودال
    modal.style.display = 'flex';
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // تصيير شبكة الوسائط الفارغة
    if (typeof window.renderMediaGrid === 'function') {
        setTimeout(() => {
            window.renderMediaGrid();
        }, 100);
    }
}

// دالة معالجة إضافة/تعديل كورس
function handleAddCourseSubmit(e) {
    // Delegate to Courses module canonical handler if present to avoid duplicate implementations
    if (e && typeof e.preventDefault === 'function') e.preventDefault();
    console.log('handleAddCourseSubmit: delegating to Courses module if available');
    if (window.Courses && typeof window.Courses.handleAddCourseSubmit === 'function') {
        return window.Courses.handleAddCourseSubmit(e);
    }
    alert('وظيفة حفظ الكورس غير متاحة حالياً');
}

// دالة فتح نموذج تعديل كورس
function openEditCourseModal(courseId) {
    if (!courseId) {
        alert('معرف الكورس غير صالح');
        return;
    }

    // جلب بيانات الكورس أولاً
    fetch(`/api/courses/${courseId}`, {
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('فشل في جلب بيانات الكورس');
        return response.json();
    })
    .then(course => {
        const modal = document.getElementById('courseModal');
        if (!modal) {
            console.error('Course modal not found');
            return;
        }

        // تعيين العنوان
        document.getElementById('courseModalTitle').textContent = 'تعديل الكورس';
        
        // تعبئة البيانات
        document.getElementById('courseTitle').value = course.title || '';
        document.getElementById('courseDescription').value = course.description || '';
        document.getElementById('courseInstructor').value = course.instructor || '';
        document.getElementById('courseDuration').value = course.duration || 1;
        document.getElementById('coursePrice').value = course.price || 0;
        try {
            document.querySelectorAll('.category-input').forEach(input => {
                input.checked = course.categories && Array.isArray(course.categories) && course.categories.some(c => c.mainCategory === input.value);
            });
        } catch (e) {}
        (function(){ const el = document.getElementById('courseTags'); if (el) el.value = (course.tags || []).join(', '); })();
        document.getElementById('courseIcon').value = course.icon || '';

        // تعيين معرف الكورس للتعديل
        window.editingCourseId = courseId;

        // فتح المودال
        modal.style.display = 'flex';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';

    })
    .catch(error => {
        console.error('Error loading course:', error);
        alert(`خطأ: ${error.message}`);
    });
}

// دالة إغلاق مودال الكورس
function closeCourseModal() {
    const modal = document.getElementById('courseModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
        window.editingCourseId = null;
    }
}

// دالة إدارة محتوى الكورس
function manageCourseContent(courseId, courseTitle) {
    if (!courseId || !courseTitle) {
        alert('بيانات الكورس غير مكتملة');
        return;
    }

    // تعيين المتغيرات العامة
    window.currentCourseId = courseId;
    window.currentCourseTitle = courseTitle;

    const modal = document.getElementById('courseContentModal');
    if (!modal) {
        console.error('Course content modal not found');
        return;
    }

    // تعيين العنوان
    document.getElementById('courseContentModalTitle').textContent = `إدارة محتوى: ${courseTitle}`;

    // جلب بيانات الكورس ومحتواه
    Promise.all([
        fetch(`/api/courses/${courseId}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        }),
        fetch(`/api/courses/${courseId}/content`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
    ])
    .then(([courseResponse, contentResponse]) => {
        if (!courseResponse.ok) throw new Error('فشل في جلب بيانات الكورس');
        if (!contentResponse.ok) throw new Error('فشل في جلب محتوى الكورس');
        return Promise.all([courseResponse.json(), contentResponse.json()]);
    })
    .then(([course, courseContent]) => {
        displayCourseContent(courseContent, course);

        // فتح المودال
        modal.style.display = 'flex';
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    })
    .catch(error => {
        console.error('Error loading course content:', error);
        alert(`خطأ: ${error.message}`);
    });
}

// دالة عرض محتوى الكورس
function displayCourseContent(courseContent) {
    const container = document.getElementById('modulesContainer');
    if (!container) {
        console.error('modulesContainer not found');
        return;
    }

    if (!courseContent.units || courseContent.units.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">لا توجد وحدات لهذا الكورس</p>';
        return;
    }

    container.innerHTML = courseContent.units.map((unit, unitIndex) => `
        <div class="module-item" style="border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px;">
            <div class="module-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0;">الوحدة ${unitIndex + 1}: ${unit.title}</h4>
                <div class="module-actions">
                    <button onclick="addLessonToUnit('${window.currentCourseId}', '${unit._id}')" 
                            class="btn btn-sm btn-primary" style="margin-left: 8px;">
                        <i class="fas fa-plus"></i> إضافة درس
                    </button>
                    <button onclick="deleteUnit('${window.currentCourseId}', '${unit._id}')" 
                            class="btn btn-sm btn-danger">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
            </div>
            <div class="lessons-list" style="margin-top: 15px;">
                ${unit.lessons && unit.lessons.length > 0 ? 
                    unit.lessons.map((lesson, lessonIndex) => `
                        <div class="lesson-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                            <span>الدرس ${lessonIndex + 1}: ${lesson.title}</span>
                            <div class="lesson-actions">
                                <button onclick="editLesson('${window.currentCourseId}', '${unit._id}', '${lesson._id}')" 
                                        class="btn btn-sm btn-secondary" style="margin-left: 5px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteLesson('${window.currentCourseId}', '${unit._id}', '${lesson._id}')" 
                                        class="btn btn-sm btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('') 
                    : '<p style="text-align: center; color: #999; margin: 10px 0;">لا توجد دروس في هذه الوحدة</p>'
                }
            </div>
        </div>
    `).join('');
}

// دوال أساسية للمستخدمين
// دالة فتح مودال إضافة مستخدم
function openAddUserModal() {
    console.log('Opening add user modal');
    
    const modal = document.getElementById('addUserModal');
    if (modal) {
        modal.classList.add('show');
        modal.style.display = 'flex';
    }
    
    const form = document.getElementById('addUserForm');
    if (form) {
        form.reset();
        // Remove all previous event listeners
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        
        // Add new event listener
        document.getElementById('addUserForm').addEventListener('submit', addUser);
    }

    ModalSystem.openModal('addUserModal');
}

// دالة إغلاق مودال المستخدمين
function closeAddUserModal() {
    ModalSystem.closeModal('addUserModal');
}

// جسر الدوال - للتوافق مع HTML
function closeAddModal() {
    closeAddUserModal();
}

function openAddModal() {
    openAddUserModal();
}

// جعل الدوال متاحة بشكل عام
window.openAddUserModal = openAddUserModal;
window.closeAddUserModal = closeAddUserModal;
window.closeAddModal = closeAddModal;
window.openAddModal = openAddModal;










// ربط event listeners للعناصر التي يتم إنشاؤها ديناميكياً
function setupDynamicEventListeners() {
    console.log('Setting up dynamic event listeners...');
    
    // ربط أزرار الحذف والتعديل في جدول الكورسات
    document.addEventListener('click', function(e) {
        // Manage content button (prefer data attributes)
        if (e.target.closest('.manage-content-btn')) {
            const button = e.target.closest('.manage-content-btn');
            const courseId = button.dataset.id || button.getAttribute('data-id');
            const courseTitle = button.dataset.title || button.getAttribute('data-title') || button.closest('tr')?.cells[1]?.textContent;
            if (courseId && courseTitle) {
                e.preventDefault();
                console.log('Manage content clicked:', courseId, courseTitle);
                window.manageCourseContent(courseId, courseTitle);
            }
            return;
        }

        // Edit course button
        if (e.target.closest('.edit-course-btn')) {
            const button = e.target.closest('.edit-course-btn');
            const courseId = button.dataset.id || button.getAttribute('data-id') || button.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
            if (courseId) {
                e.preventDefault();
                console.log('Edit course clicked:', courseId);
                window.editCourse(courseId);
            }
            return;
        }

        // Delete course button — guard against duplicate calls by using data attribute handlers
        if (e.target.closest('.delete-course-btn')) {
            const button = e.target.closest('.delete-course-btn');
            const courseId = button.dataset.id || button.getAttribute('data-id') || button.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
            if (courseId) {
                e.preventDefault();
                console.log('Delete course clicked (delegated):', courseId);
                // call canonical module function once
                if (window.Courses && typeof window.Courses.deleteCourse === 'function') {
                    window.Courses.deleteCourse(courseId);
                } else if (typeof deleteCourse === 'function') {
                    deleteCourse(courseId);
                }
            }
            return;
        }
    });
}

// استدعاء تهيئة dynamic listeners بعد تحميل DOM
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(setupDynamicEventListeners, 1000);
});





// اختبار وظائف الكورسات
function testCoursesFunctionality() {
    console.log('=== TESTING COURSES FUNCTIONALITY ===');
    console.log('window.Courses:', window.Courses);
    console.log('typeof window.Courses.init:', typeof window.Courses?.init);
    console.log('typeof window.Courses.openAddCourseModal:', typeof window.Courses?.openAddCourseModal);
    console.log('typeof window.Courses.handleAddCourseSubmit:', typeof window.Courses?.handleAddCourseSubmit);
    
    // اختبار العناصر
    console.log('courseModal:', document.getElementById('courseModal'));
    console.log('addCourseForm:', document.getElementById('addCourseForm'));
    console.log('add-course-button:', document.getElementById('add-course-button'));
    
    console.log('=== TEST COMPLETE ===');
}

// تشغيل الاختبار بعد التهيئة
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(testCoursesFunctionality, 1500);
});


// التحقق من وجود جميع الـ modals
function checkModalsExistence() {
    console.log('=== CHECKING MODALS EXISTENCE ===');
    
    const modals = [
        'courseModal',
        'courseContentModal', 
        'addUserModal',
        'addLessonModal',
        'addUnitModal'
    ];
    
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        console.log(`${modalId}:`, modal ? 'EXISTS' : 'NOT FOUND');
        
        if (modal) {
            console.log(`  - display: ${modal.style.display}`);
            console.log(`  - classes: ${modal.className}`);
            console.log(`  - parent: ${modal.parentElement ? modal.parentElement.id : 'none'}`);
        }
    });
    
    console.log('=== MODALS CHECK COMPLETE ===');
}

// تشغيل التحقق بعد التهيئة
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(checkModalsExistence, 1000);
});


