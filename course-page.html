<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
   <script>
      // Ù…Ù†Ø¹ ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
      (function () {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) {
          window.location.replace("alert.html");
        }
      })();
   </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/courses-carousel.css">
    <!-- <link rel="stylesheet" href="css/all.min.css"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Marhey:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="img/loogo.png">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <title>Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ±Ø³</title>
    <style>
      :root {
        --cp-bg: #e5e7eb;
        --cp-glass-bg: rgba(255, 255, 255, 0.70);
        --cp-glass-bg-soft: rgba(255, 255, 255, 0.58);
        --cp-glass-border: rgba(148, 163, 184, 0.55);
        --cp-glass-shadow: 0 28px 70px rgba(15, 23, 42, 0.22);
        --cp-surface: rgba(255, 255, 255, 0.90);
        --cp-surface-soft: rgba(255, 255, 255, 0.80);
        --cp-border-subtle: rgba(148, 163, 184, 0.25);
        --cp-text-main: #020617;
        --cp-text-muted: #6b7280;
        --cp-primary: #2563eb;
        --cp-primary-soft: rgba(37, 99, 235, 0.14);
        --cp-primary-strong: rgba(37, 99, 235, 0.40);
        --cp-accent: #22c55e;
        --cp-radius-xl: 24px;
        --cp-radius-lg: 18px;
        --cp-radius-md: 12px;
        --cp-shadow-soft: 0 22px 50px rgba(15, 23, 42, 0.16);
      }

      body.dark,
      :root.dark-theme {
        --cp-bg: #020617;
        --cp-glass-bg: rgba(15, 23, 42, 0.84);
        --cp-glass-bg-soft: rgba(15, 23, 42, 0.78);
        --cp-glass-border: rgba(148, 163, 184, 0.50);
        --cp-glass-shadow: 0 30px 90px rgba(0, 0, 0, 0.90);
        --cp-surface: rgba(15, 23, 42, 0.94);
        --cp-surface-soft: rgba(15, 23, 42, 0.88);
        --cp-border-subtle: rgba(30, 64, 175, 0.55);
        --cp-text-main: #e5e7eb;
        --cp-text-muted: #9ca3af;
        --cp-primary-soft: rgba(59, 130, 246, 0.26);
        --cp-primary-strong: rgba(59, 130, 246, 0.60);
        --cp-shadow-soft: 0 26px 70px rgba(15, 23, 42, 0.92);
      }

      body {
        background:
          radial-gradient(circle at top left, rgba(59, 130, 246, 0.26), transparent 55%),
          radial-gradient(circle at bottom right, rgba(16, 185, 129, 0.28), transparent 60%),
          var(--cp-bg);
      }

      /* ØªØ®Ø·ÙŠØ· ØµÙØ­Ø© Ø§Ù„ÙƒÙˆØ±Ø³ */
      .course-display {
        max-width: 1240px;
        margin: 112px auto 70px;
        padding: 0 16px;
        display: grid;
        grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
        gap: 18px;
      }

      @media (max-width: 992px) {
        .course-display {
          grid-template-columns: minmax(0, 1fr);
          margin-top: 100px;
        }
      }

      @media (max-width: 640px) {
        .course-display {
          padding: 0 10px;
          margin-top: 96px;
        }
      }

      /* Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙˆØ§Ù„Ø¯Ø±ÙˆØ³) Ø¨Ù†Ù…Ø· glass */
      .course-sidebar {
        background:
          radial-gradient(circle at top, rgba(59, 130, 246, 0.22), transparent 55%),
          radial-gradient(circle at bottom, rgba(16, 185, 129, 0.22), transparent 60%),
          var(--cp-glass-bg);
        border-radius: var(--cp-radius-xl);
        border: 1px solid var(--cp-glass-border);
        box-shadow: var(--cp-glass-shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 140px);
        backdrop-filter: blur(22px) saturate(160%);
        -webkit-backdrop-filter: blur(22px) saturate(160%);
      }

      @media (max-width: 992px) {
        .course-sidebar {
          max-height: none;
        }
      }

      .sidebar-header {
        padding: 14px 16px 10px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.55);
        background:
          radial-gradient(circle at top left, rgba(59, 130, 246, 0.40), transparent 65%),
          rgba(15, 23, 42, 0.92);
        color: #e5e7eb;
      }

      .sidebar-title {
        font-size: 16px;
        font-weight: 800;
        margin: 0 0 4px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .sidebar-title::before {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.30);
      }

      .sidebar-subtitle {
        margin: 0;
        font-size: 12px;
        color: rgba(209, 213, 219, 0.9);
      }

      .progress-section {
        background: linear-gradient(
          135deg,
          rgba(15, 23, 42, 0.85) 0%,
          rgba(15, 23, 42, 0.92) 100%
        );
        padding: 14px 16px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 13px;
      }

      .progress-text {
        color: rgba(209, 213, 219, 0.95);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .progress-text::before {
        content: 'ğŸ“Š';
        font-size: 14px;
      }

      .progress-percentage {
        font-size: 15px;
        font-weight: 800;
        background: linear-gradient(135deg, #22c55e, #4ade80);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
      }

      .progress-bar {
        position: relative;
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: linear-gradient(
          135deg,
          rgba(15, 23, 42, 0.6) 0%,
          rgba(15, 23, 42, 0.5) 100%
        );
        overflow: hidden;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(148, 163, 184, 0.15);
        box-shadow: 
          inset 0 1px 2px rgba(0, 0, 0, 0.2),
          0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .progress-fill {
        position: relative;
        height: 100%;
        width: 0%;
        border-radius: inherit;
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.85) 0%,
          rgba(16, 185, 129, 0.90) 50%,
          rgba(5, 150, 105, 0.95) 100%
        );
        box-shadow: 
          0 2px 12px rgba(34, 197, 94, 0.5),
          inset 0 1px 1px rgba(255, 255, 255, 0.2);
        transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
      }

      .progress-fill::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      .modules-list {
        flex: 1;
        overflow-y: auto;
        background: rgba(15, 23, 42, 0.92);
        padding: 6px 8px 10px;
      }

      .module-item {
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 8px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background:
          radial-gradient(circle at top left, rgba(37, 99, 235, 0.4), transparent 60%),
          rgba(15, 23, 42, 0.95);
      }

      .module-header {
        padding: 9px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        color: #e5e7eb;
      }

      .module-title {
        font-size: 13px;
        font-weight: 600;
      }

      .module-toggle {
        color: rgba(148, 163, 184, 0.9);
        transition: transform 0.25s ease, color 0.25s ease;
      }

      .module-header.active .module-toggle {
        transform: rotate(180deg);
        color: #facc15;
      }

      .lessons-list {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.25s ease;
        background: rgba(15, 23, 42, 0.96);
      }

      .lessons-list.expanded {
        max-height: 480px;
      }

      .lesson-item {
        margin: 4px 6px 8px;
        padding: 8px 12px 8px 30px;
        border-radius: 11px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: rgba(15, 23, 42, 0.96);
        cursor: pointer;
        position: relative;
        transition: background 0.2s ease, border-color 0.2s ease, transform 0.15s ease;
      }

      .lesson-item:hover {
        background: rgba(37, 99, 235, 0.70);
        transform: translateY(-1px);
      }

      .lesson-item.active {
        border-color: rgba(56, 189, 248, 0.98);
        background: linear-gradient(90deg, rgba(37, 99, 235, 0.98), rgba(56, 189, 248, 0.98));
        box-shadow: 0 12px 24px rgba(37, 99, 235, 0.55);
      }

      .lesson-item.completed {
        border-color: rgba(34, 197, 94, 0.95);
        background: rgba(22, 163, 74, 0.22);
      }

      .lesson-item.completed::before {
        content: '\2713';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #4ade80;
        font-size: 13px;
      }

      .lesson-item.active::before {
        content: '\25B6';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #fefce8;
        font-size: 11px;
      }

      .lesson-title-sidebar {
        font-size: 13px;
        color: rgba(226, 232, 240, 0.95);
        margin-bottom: 2px;
      }

      .lesson-duration {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.9);
      }

      .lesson-item.active .lesson-title-sidebar,
      .lesson-item.active .lesson-duration {
        color: #fefce8;
      }

      /* Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ù…Ø· glass */
      .course-main {
        background:
          radial-gradient(circle at top right, rgba(59, 130, 246, 0.22), transparent 60%),
          radial-gradient(circle at bottom left, rgba(16, 185, 129, 0.22), transparent 60%),
          var(--cp-glass-bg-soft);
        border-radius: var(--cp-radius-xl);
        border: 1px solid var(--cp-glass-border);
        box-shadow: var(--cp-glass-shadow);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        backdrop-filter: blur(22px) saturate(160%);
        -webkit-backdrop-filter: blur(22px) saturate(160%);
      }

      .course-header {
        padding: 14px 18px 10px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.45);
        background:
          linear-gradient(135deg, rgba(37, 99, 235, 0.14), rgba(15, 23, 42, 0.02));
      }

      .course-title {
        font-size: 18px;
        font-weight: 800;
        color: var(--cp-text-main);
        margin: 0 0 4px;
      }

      .course-description {
        font-size: 13px;
        color: var(--cp-text-muted);
        line-height: 1.7;
        max-height: 3.6em;
        overflow: hidden;
        margin: 0;
      }

      .content-area {
        padding: 16px 16px 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
      }

      body.dark .content-area,
      :root.dark-theme .content-area {
        background: rgba(15, 23, 42, 0.80);
      }

      .video-container {
        background: #000;
        border-radius: var(--cp-radius-lg);
        overflow: hidden;
        position: relative;
        aspect-ratio: 16/9;
        width: 100%;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
      }

      .video-container .plyr,
      .video-container .js-player {
        width: 100%;
        height: 100%;
      }

      .plyr--video {
        --plyr-color-main: var(--cp-primary);
        border-radius: var(--cp-radius-lg);
      }

      .lesson-info {
        background: var(--cp-surface);
        border-radius: var(--cp-radius-lg);
        padding: 12px 14px 10px;
        border: 1px solid var(--cp-border-subtle);
        box-shadow: var(--cp-shadow-soft);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
      }

      .lesson-title {
        font-size: 15px;
        font-weight: 700;
        color: var(--cp-text-main);
        margin: 0 0 6px;
      }

      .lesson-description {
        font-size: 13px;
        color: var(--cp-text-muted);
        line-height: 1.7;
      }

      .navigation-buttons {
        margin-top: 4px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      .nav-btn {
        flex: 1;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, var(--cp-primary), #1d4ed8);
        color: #f9fafb;
        padding: 8px 0;
        font-size: 13px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: pointer;
        box-shadow: 0 10px 24px rgba(37, 99, 235, 0.55);
        transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      }

      .nav-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 14px 32px rgba(37, 99, 235, 0.65);
      }

      .nav-btn:disabled {
        background: rgba(148, 163, 184, 0.4);
        color: rgba(148, 163, 184, 0.95);
        box-shadow: none;
        cursor: not-allowed;
      }

      /* Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø®Ø·Ø£ */
      .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 32px 16px;
        text-align: center;
        color: var(--cp-text-muted);
      }

      .loading-spinner {
        width: 38px;
        height: 38px;
        border-radius: 999px;
        border: 4px solid rgba(148, 163, 184, 0.4);
        border-top-color: var(--cp-primary);
        animation: spin 0.75s linear infinite;
        margin-bottom: 10px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Enhanced PDF Viewer Styles */
      .pdf-container.enhanced {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.94), rgba(31, 41, 55, 0.96));
        border-radius: var(--cp-radius-lg);
        overflow: hidden;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
        position: relative;
      }

      .pdf-viewer-enhanced {
        width: 100%;
        height: 600px;
        border: none;
        background: transparent;
      }

      /* PDF Fallback Styles */
      .pdf-fallback {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(31, 41, 55, 0.98));
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #e5e7eb;
        text-align: center;
      }

      .pdf-error-message {
        max-width: 400px;
      }

      .pdf-error-message i {
        font-size: 48px;
        color: #ef4444;
        margin-bottom: 16px;
      }

      .pdf-error-message h3 {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 8px;
        color: #f9fafb;
      }

      .pdf-error-message p {
        font-size: 14px;
        color: rgba(209, 213, 219, 0.9);
        margin: 0 0 16px;
      }

      .pdf-download-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #f9fafb;
        border-radius: 999px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.45);
      }

      .pdf-download-link:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 28px rgba(239, 68, 68, 0.55);
      }

      .pdf-download-link i {
        font-size: 16px;
      }

      /* Make PDF viewer responsive */
      @media (max-width: 768px) {
        .pdf-viewer-enhanced {
          height: 400px;
        }
      }

      /* PDF Loading Overlay */
      .pdf-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(31, 41, 55, 0.94));
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        color: #e5e7eb;
        transition: opacity 0.3s ease;
      }

      .pdf-loading-spinner {
        width: 48px;
        height: 48px;
        border-radius: 999px;
        border: 4px solid rgba(148, 163, 184, 0.3);
        border-top-color: var(--cp-primary);
        animation: spin 0.8s linear infinite;
        margin-bottom: 16px;
      }

      .pdf-loading-text {
        font-size: 14px;
        font-weight: 600;
        color: rgba(209, 213, 219, 0.95);
      }

      /* External Video Fallback Styles */
      .external-video-fallback {
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(31, 41, 55, 0.98));
        color: #e5e7eb;
        text-align: center;
        padding: 20px;
      }

      .external-video-message {
        max-width: 400px;
      }

      .external-video-message i {
        font-size: 48px;
        color: var(--cp-primary);
        margin-bottom: 16px;
      }

      .external-video-message h3 {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 8px;
        color: #f9fafb;
      }

      .external-video-message p {
        font-size: 14px;
        color: rgba(209, 213, 219, 0.9);
        margin: 0 0 16px;
      }

      .external-video-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background: linear-gradient(135deg, var(--cp-primary), #1d4ed8);
        color: #f9fafb;
        border-radius: 999px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.45);
      }

      .external-video-link:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 28px rgba(37, 99, 235, 0.55);
      }

      .external-video-link i {
        font-size: 16px;
      }

      .mark-complete-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #f9fafb;
        border: none;
        border-radius: 999px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.45);
        margin-top: 12px;
      }

      .mark-complete-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 28px rgba(34, 197, 94, 0.55);
      }

      .mark-complete-btn i {
        font-size: 16px;
      }

      .external-video-message i.fab,
      .external-video-message i.fas {
        font-size: 56px;
        color: var(--cp-primary);
        margin-bottom: 16px;
      }

      .error-container {
        text-align: center;
        padding: 24px 20px;
        background: var(--cp-surface);
        border-radius: var(--cp-radius-lg);
        margin: 12px;
        border: 1px solid rgba(239, 68, 68, 0.35);
        color: var(--cp-text-main);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
      }

      .error-container i {
        font-size: 40px;
        color: #ef4444;
        margin-bottom: 10px;
      }

      .error-container a {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 7px 16px;
        border-radius: 999px;
        background: #ef4444;
        color: #f9fafb;
        text-decoration: none;
        font-size: 13px;
      }

      @media (max-width: 640px) {
        .course-header {
          padding: 10px 10px 6px;
        }
        .content-area {
          padding: 12px 10px 10px;
        }
        .navigation-buttons {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- -------------------------------------------Start Header-------------------------------- -->
    <div dir="rtl" class="header">
            <div class="container">
                <div class="logo">
                    <a href="index.html" aria-label="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"><img src="img/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹"></a>
                </div>
                <div id="list" class="links">
                    <ul>
                        <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠÙ‡</a></li>
                        <li><a href="courses.html">Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª </a></li>
                        <li><a href="portfolio.html">Ù…Ø´Ø§Ø±ÙŠØ¹Ù†Ø§ </a></li>
                        <li class="nav-dropdown"><a href="roadmap.html">Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„Ù… <i class="fa-solid fa-angle-down"></i></a>
                            <ul class="nav-dropdown-items">
                                <li><a href="frontendroadmap.html">Front End </a></li>
                                <li><a href="backendroadmap.html">Back End</a></li>
                                <li><a href="cybersecurityroadmap.html">Cyber security</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
                <div  class="bars">
                    <i id="bars" class="fa-solid fa-bars "></i>
                </div>
                <div class="icon">
                    <div id="colorMode" class="theme">
                        <i  class="fa-solid fa-moon moon"></i>
                        <i  class="fa-solid fa-sun sun"></i>
                    </div>
                    <a href="store.html" aria-label="Ø§Ù„Ù…ØªØ¬Ø±" title="Ø§Ù„Ù…ØªØ¬Ø±"><i class="fa-solid fa-store store"></i></a>
                    <a href="login.html" aria-label="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"><i class="fa-solid fa-user user"></i></a>
                </div>
            </div>
        </div>
    <!-- ---------------------------------------------End Header--------------------------------------- -->

    <!-- Course Display Interface -->
    <div class="course-display">
        <!-- Sidebar with Modules and Lessons -->
        <div class="course-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title" id="courseTitle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <p class="sidebar-subtitle" id="courseSubtitle">Ø§Ø®ØªØ± Ø¯Ø±Ø³Ø§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡</p>
            </div>
            
            <div class="progress-section">
                <div class="progress-info">
                    <span class="progress-text">Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„ÙƒÙˆØ±Ø³</span>
                    <span class="progress-percentage" id="progressPercentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div class="modules-list" id="modulesList">
                <div class="loading-container">
                    <div class="loading-spinner" aria-hidden="true"></div>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</p>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="course-main">
            <div class="course-header">
                <div class="course-title" id="mainCourseTitle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                <p class="course-description" id="mainCourseDescription">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ Ø§Ù„ÙƒÙˆØ±Ø³...</p>
            </div>
            
            <div class="content-area">
                <div id="contentContainer">
                    <div class="loading-container">
                        <div class="loading-spinner" aria-hidden="true"></div>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</p>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="nav-btn" id="prevBtn" onclick="goToPreviousLesson()" disabled>
                        <i class="fas fa-arrow-right"></i>
                        <span>Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø³Ø§Ø¨Ù‚</span>
                    </button>
                    <button class="nav-btn" id="nextBtn" onclick="goToNextLesson()" disabled>
                        <span>Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„ØªØ§Ù„ÙŠ</span>
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
            </div>
      </div>
    </div>

    <!-- Start Footer  -->
    <footer id="footer">
      <div class="container">
          <div class="social">
              <h4>Social</h4>
              <div class="img">
                  <a href="index.html" aria-label="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"><img src="img/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹" /></a>
              </div>
              <ul class="social-links">
                  <li><a target="_blank" rel="noopener" href="https://facebook.com/teamworkm3" aria-label="Facebook"><img src="img/Facebook-1.png" alt="Facebook" /></a></li>
                  <li><a target="_blank" rel="noopener" href="https://youtube.com/@twm3" aria-label="YouTube"><img src="img/Youtube-1.png" alt="YouTube" /></a></li>
                  <li><a target="_blank" rel="noopener" href="https://instagram.com/mo_hussien_20" aria-label="Instagram"><img src="img/Instagram-1.png" alt="Instagram"/></a></li>
                  <li><a target="_blank" rel="noopener" href="https://t.me/teamworkm3" aria-label="Telegram"><img src="img/Telegram-1.png" alt="Telegram" /></a></li>
              </ul>
          </div>
          <div class="pages">
              <h4>pages</h4>
              <ul>
                  <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠÙ‡</a></li>
                  <li><a href="courses.html">Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</a></li>
                  <li><a href="portfolio.html">Ù…Ø´Ø§Ø±ÙŠØ¹Ù†Ø§</a></li>
                  <li><a href="roadmap.html">Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ¹Ù„Ù…</a></li>
              </ul>
          </div>
          <div class="news">
              <h4>Blog</h4>
              <ul>
                  <li><a target="_blank" href="blog-details.html"> Ø§Ø²Ø§Ù„Ø© Ù‚ÙÙ„ Ø§Ù„Ù‡Ø§ØªÙ</a></li>
                  <li><a target="_blank" href="blog-details2.html">ØªØºÙŠÙŠØ± Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ù‡</a></li>
                  <li><a target="_blank" href="blog-details3.html">Ø§Ù„Ø±Ø¨Ø­ Ù…Ù† Ø«ØºØ±Ø§Øª Ø§Ù„ÙˆÙŠØ¨</a></li>
                  <li><a target="_blank" href="blog-details4.html"> Ø§Ø²Ø§Ù‰ ØªØ­Ù…Ù‰ Ù†ÙØ³Ùƒ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚</a></li>
              </ul>
          </div>
      </div>
      <p> all copy Rights Reserved Â© <span id="yearData"></span> , created by <span>â¤</span> by twm3</p>
      <div class="shape">
          <img class="footer-shape1" src="img/footer-shape-1.svg" alt="" />
          <img class="footer-shape2" src="img/footer-shape-2.svg" alt="" />
      </div>
  </footer>
  <!-- End Footer  -->

    <!-- Start up tp top  -->
    <div class="up">
      <i class="fa-solid fa-arrow-up"></i>
    </div>
    <!-- End up tp top  -->

    <script src="app.js"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script>window.disableGlobalPlyrAutoInit = true;</script>
    <script src="js/ui-toast.js"></script>
    <script src="js/alert-to-toast.js"></script>
    <script src="js/video-player.js"></script>
    <script>
        let currentCourse = null;
        let currentModuleIndex = 0;
        let currentLessonIndex = 0;
        let completedLessons = new Set();
        let courseData = null;
        let _plyrInstances = [];
        let isLoadingLesson = false;
        let currentUserId = null; // Add user-specific identification

        let pdfJsLoadingPromise = null;
        function ensurePdfJsLoaded() {
            if (window.pdfjsLib) return Promise.resolve();
            if (pdfJsLoadingPromise) return pdfJsLoadingPromise;
            const sources = [
                {
                    core: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js',
                    worker: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js'
                },
                {
                    core: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js',
                    worker: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js'
                },
                {
                    core: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.js',
                    worker: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.js'
                }
            ];
            pdfJsLoadingPromise = new Promise((resolve) => {
                let index = 0;
                const tryLoad = () => {
                    if (index >= sources.length) {
                        resolve(false);
                        return;
                    }
                    const { core, worker } = sources[index++];
                    const script = document.createElement('script');
                    script.src = core;
                    script.crossOrigin = 'anonymous';
                    script.onload = () => {
                        try {
                            if (window['pdfjsLib']) {
                                window.pdfjsLib.GlobalWorkerOptions.workerSrc = worker;
                                resolve(true);
                            } else {
                                tryLoad();
                            }
                        } catch (_) {
                            tryLoad();
                        }
                    };
                    script.onerror = () => {
                        tryLoad();
                    };
                    document.head.appendChild(script);
                };
                tryLoad();
            });
            return pdfJsLoadingPromise;
        }

        function getLessonLink(lesson) {
            return (
                lesson.link?.trim() ||
                lesson.fileUrl?.trim() ||
                lesson.videoUrl?.trim() ||
                lesson.externalUrl?.trim() ||
                ''
            );
        }

        function isPdfLink(rawLink) {
            if (!rawLink) return false;
            const lower = rawLink.toLowerCase();
            if (lower.endsWith('.pdf')) return true;
            try {
                const u = new URL(rawLink);
                return u.pathname.toLowerCase().endsWith('.pdf');
            } catch (_) {
                return false;
            }
        }

        function isVideoLink(rawLink) {
            if (!rawLink) return false;
            const link = rawLink.toLowerCase();
            return (
                link.includes('youtube.com/watch?v=') ||
                link.includes('youtube.com/embed') ||
                link.includes('youtu.be/') ||
                link.includes('youtube.com/shorts/') ||
                link.includes('drive.google.com/file/d/') ||
                link.includes('pexels.com/') ||
                link.includes('vimeo.com/') ||
                link.includes('dailymotion.com/') ||
                link.includes('tiktok.com/') ||
                link.includes('instagram.com/') ||
                link.includes('facebook.com/') ||
                link.includes('fb.watch/') ||
                link.includes('telegram.org/') ||
                link.includes('t.me/') ||
                link.endsWith('.mp4') ||
                link.endsWith('.mov') ||
                link.endsWith('.webm') ||
                link.endsWith('.avi') ||
                link.endsWith('.mkv') ||
                link.includes('/uploads/') ||
                link.includes('/videos/')
            );
        }

        function getPlatformName(link) {
            const lowerLink = link.toLowerCase();
            if (lowerLink.includes('pexels.com')) return 'Pexels';
            if (lowerLink.includes('vimeo.com')) return 'Vimeo';
            if (lowerLink.includes('dailymotion.com')) return 'Dailymotion';
            if (lowerLink.includes('tiktok.com')) return 'TikTok';
            if (lowerLink.includes('instagram.com')) return 'Instagram';
            if (lowerLink.includes('facebook.com') || lowerLink.includes('fb.watch')) return 'Facebook';
            if (lowerLink.includes('telegram.org') || lowerLink.includes('t.me')) return 'Telegram';
            return 'Ù…Ù†ØµØ© Ø®Ø§Ø±Ø¬ÙŠØ©';
        }

        function getPlatformIcon(link) {
            const lowerLink = link.toLowerCase();
            if (lowerLink.includes('facebook.com') || lowerLink.includes('fb.watch')) return 'fab fa-facebook';
            if (lowerLink.includes('tiktok.com')) return 'fab fa-tiktok';
            if (lowerLink.includes('instagram.com')) return 'fab fa-instagram';
            if (lowerLink.includes('telegram.org') || lowerLink.includes('t.me')) return 'fab fa-telegram';
            if (lowerLink.includes('vimeo.com')) return 'fab fa-vimeo';
            return 'fas fa-external-link-alt';
        }

        // Function to manually mark external videos as complete
        window.markExternalVideoComplete = function(moduleIndex, lessonIndex) {
            const lessonKey = `${moduleIndex}-${lessonIndex}`;
            if (!completedLessons.has(lessonKey)) {
                markLessonAsCompleted(moduleIndex, lessonIndex);
            } else {
                if (window.showToast) {
                    window.showToast('Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ù…ÙƒØªÙ…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„', {
                        type: 'info',
                        timeout: 3000,
                        title: 'Ù…Ø¹Ù„ÙˆÙ…Ø©',
                        icon: 'fas fa-check-circle'
                    });
                }
            }
        };

        // PDF Error Handling and Fallback
        function showPdfFallback(iframe, pdfSrc, lessonTitle) {
            // Hide the iframe
            iframe.style.display = 'none';

            // Show the fallback
            const fallback = iframe.nextElementSibling;
            if (fallback) {
                fallback.style.display = 'flex';
            }

            // Show error toast
            if (window.showToast) {
                window.showToast(`âš ï¸ ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ù…Ù„Ù PDF: ${lessonTitle}`, { type: 'error', timeout: 5000 });
            }

            console.error('PDF viewing failed, showing fallback for:', pdfSrc);
        }

        // Navigation functions
        function goToPreviousLesson() {
            if (currentLessonIndex > 0) {
                loadLesson(currentModuleIndex, currentLessonIndex - 1);
            }
        }

        function goToNextLesson() {
            const unit = courseData?.units?.[currentModuleIndex];
            const totalInUnit = unit?.lessons?.length || 0;
            if (currentLessonIndex < totalInUnit - 1) {
                loadLesson(currentModuleIndex, currentLessonIndex + 1);
            }
        }

        function escapeHTML(str){
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m] || m));
        }

        function renderLessonDescription(desc){
            if (!desc) return '<div class="lesson-description">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³</div>';
            const lines = String(desc).split(/\r?\n/);
            const safe = lines.map(l => escapeHTML(l)).join('<br>');
            return `<div class="lesson-description">${safe}</div>`;
        }

        function countTotalLessons() {
            let total = 0;
            if (Array.isArray(courseData?.units)) {
                courseData.units.forEach(u => {
                    if (Array.isArray(u.lessons)) total += u.lessons.length;
                });
            }
            return total;
        }

        function updateCourseSubtitle() {
            const el = document.getElementById('courseSubtitle');
            if (!el) return;
            const total = countTotalLessons();
            el.textContent = total ? `${total} Ø¯Ø±Ø³` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ø¨Ø¹Ø¯';
        }

        function renderCourseContent() {
            const modulesList = document.getElementById('modulesList');
            modulesList.innerHTML = '';

            if (!courseData.units || courseData.units.length === 0) {
                const noEl = document.createElement('div');
                noEl.style.padding = '20px';
                noEl.style.textAlign = 'center';
                noEl.style.color = 'var(--cp-text-muted)';
                noEl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ù…ØªØ§Ø­Ø©';
                modulesList.appendChild(noEl);
                return;
            }

            courseData.units.forEach((unit, moduleIndex) => {
                const moduleItem = document.createElement('div');
                moduleItem.className = 'module-item';

                const header = document.createElement('div');
                header.className = 'module-header' + (moduleIndex === 0 ? ' active' : '');
                header.addEventListener('click', () => toggleModule(moduleIndex));

                const title = document.createElement('div');
                title.className = 'module-title';
                title.textContent = unit.title || 'ÙˆØ­Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';

                const toggleIcon = document.createElement('i');
                toggleIcon.className = 'fas fa-chevron-down module-toggle';

                header.appendChild(title);
                header.appendChild(toggleIcon);

                const lessonsWrapper = document.createElement('div');
                lessonsWrapper.className = 'lessons-list' + (moduleIndex === 0 ? ' expanded' : '');
                lessonsWrapper.id = `lessons-${moduleIndex}`;

                if (Array.isArray(unit.lessons)) {
                    unit.lessons.forEach((lesson, lessonIndex) => {
                        const lessonEl = document.createElement('div');
                        lessonEl.className = 'lesson-item' + ((moduleIndex === 0 && lessonIndex === 0) ? ' active' : '');
                        if (completedLessons.has(`${moduleIndex}-${lessonIndex}`)) lessonEl.classList.add('completed');
                        lessonEl.dataset.module = moduleIndex;
                        lessonEl.dataset.lesson = lessonIndex;

                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'lesson-title-sidebar';
                        titleDiv.textContent = lesson.title || 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³';

                        const durDiv = document.createElement('div');
                        durDiv.className = 'lesson-duration';
                        durDiv.textContent = (lesson.duration ? (lesson.duration + ' Ø¯Ù‚Ø§Ø¦Ù‚') : '5 Ø¯Ù‚Ø§Ø¦Ù‚');

                        lessonEl.appendChild(titleDiv);
                        lessonEl.appendChild(durDiv);

                        lessonEl.addEventListener('click', () => selectLessonDebounced(moduleIndex, lessonIndex));

                        lessonsWrapper.appendChild(lessonEl);
                    });
                }

                moduleItem.appendChild(header);
                moduleItem.appendChild(lessonsWrapper);
                modulesList.appendChild(moduleItem);
            });

            updateProgress();
            updateCourseSubtitle();
        }

        function loadLessonContent(moduleIndex, lessonIndex, lesson) {
            const contentContainer = document.getElementById('contentContainer');
            if (!lesson) {
                console.error('Lesson is not defined');
                contentContainer.innerHTML = '<div class="error-container"><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù…ØªØ§Ø­.</p></div>';
                return;
            }

            if (isLoadingLesson) return;
            isLoadingLesson = true;

            try {
                if (Array.isArray(_plyrInstances) && _plyrInstances.length) {
                    _plyrInstances.forEach(p => { try { if (p && p.pause) p.pause(); if (p && p.destroy) p.destroy(); } catch(_) {} });
                }
            } catch(_) {}
            _plyrInstances = [];

            contentContainer.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</p>
                </div>
            `;

            setTimeout(async () => {
                try {
                    let link = getLessonLink(lesson);
                    if (!link) {
                        contentContainer.innerHTML = '<div class="error-container"><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù…ØªØ§Ø­ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.</p></div>';
                        return;
                    }

                    let html = '';

                    if (isPdfLink(link)) {
                        let pdfSrc = link;
                        if (!/^https?:\/\//.test(pdfSrc) && !pdfSrc.startsWith('/uploads/') && !pdfSrc.startsWith('/pdfjs/')) {
                            pdfSrc = '/uploads/' + pdfSrc.replace(/^\/+/, '');
                        }
                        const pdfId = `pdf-${moduleIndex}-${lessonIndex}`;
                        // Enhanced PDF viewer with better parameters for improved experience
                        html += `<div class="pdf-container enhanced" id="${pdfId}">
                            <iframe class="pdf-viewer-enhanced" src="/pdfjs/web/viewer.html?file=${encodeURIComponent(pdfSrc)}#zoom=auto&scrollbar=1&toolbar=1&navpanes=1&view=FitH" title="${lesson.title || 'Ù…Ù„Ù PDF'}"></iframe>
                        </div>`;
                        setTimeout(() => { setupPdfCompletionTracking(moduleIndex, lessonIndex, pdfId); }, 500);
                    } else if (isVideoLink(link)) {
                        // Check if it's a YouTube link
                        const isYoutube = link.includes('youtube.com') || link.includes('youtu.be');
                        // Check if it's an external video link (Pexels, Vimeo, etc.)
                        const isExternalVideo = link.includes('pexels.com/') || link.includes('vimeo.com/') || link.includes('dailymotion.com/');
                        // Check if it's a social media video link
                        const isSocialMedia = link.includes('tiktok.com/') || link.includes('instagram.com/') || link.includes('facebook.com/') || link.includes('fb.watch/') || link.includes('telegram.org/') || link.includes('t.me/');

                        if (isYoutube) {
                            let videoId = '';
                            if (link.includes('youtu.be/')) videoId = link.split('youtu.be/')[1].split('?')[0];
                            else if (link.includes('youtube.com/watch')) { try { videoId = new URL(link).searchParams.get('v'); } catch(_) {} }
                            else if (link.includes('youtube.com/embed/')) videoId = link.split('embed/')[1].split('?')[0];
                            else if (link.includes('youtube.com/shorts/')) { const m = link.match(/youtube\.com\/shorts\/([a-zA-Z0-9_-]+)/); videoId = m?.[1] || ''; }

                            if (videoId) {
                                const origin = window.location.origin;
                                const ytSrc = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&playsinline=1&rel=0&iv_load_policy=3&modestbranding=1&origin=${encodeURIComponent(origin)}`;
                                const safeTitle = (lesson && lesson.title) ? escapeHTML(String(lesson.title)) : 'YouTube video';
                                html += `<div class="video-container"><div class="plyr__video-embed"><iframe src="${ytSrc}" title="${safeTitle}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe></div></div>`;
                            } else {
                                html += `<div class='error-container'><p>Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± ØµØ§Ù„Ø­.</p></div>`;
                            }
                        } else if (isExternalVideo || isSocialMedia) {
                            // Try to embed common providers; if blocked, fallback to external link
                            const lower = link.toLowerCase();
                            const safeTitle = (lesson && lesson.title) ? escapeHTML(String(lesson.title)) : 'External video';

                            if (lower.includes('drive.google.com/file/d/') && lower.includes('/preview')) {
                                // Google Drive preview embeds
                                html += `<div class="video-container"><iframe src="${link}" title="${safeTitle}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe></div>`;
                            } else if (lower.includes('vimeo.com')) {
                                const m = link.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
                                const vid = m ? m[1] : '';
                                if (vid) {
                                    html += `<div class="video-container"><iframe src="https://player.vimeo.com/video/${vid}" title="${safeTitle}" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>`;
                                } else {
                                    const platformName = getPlatformName(link);
                                    html += `<div class=\"video-container external-video-fallback\"><div class=\"external-video-message\"><i class=\"fas fa-external-link-alt\"></i><h3>Ù…Ù‚Ø·Ø¹ ÙÙŠØ¯ÙŠÙˆ Ø®Ø§Ø±Ø¬ÙŠ</h3><p>Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù…Ù† ${platformName} ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ï¿½ï¿½Ø±Ø¶Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§</p><a href=\"${link}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"external-video-link\"><i class=\"fas fa-play-circle\"></i><span>ÙØªØ­ Ø§Ù„Ù…Ù‚Ø·Ø¹ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©</span></a></div></div>`;
                                }
                            } else if (lower.includes('dailymotion.com')) {
                                const m = link.match(/dailymotion\.com\/video\/([a-z0-9]+)/i);
                                const id = m ? m[1] : '';
                                if (id) {
                                    html += `<div class="video-container"><iframe src="https://www.dailymotion.com/embed/video/${id}" title="${safeTitle}" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>`;
                                } else {
                                    const platformName = getPlatformName(link);
                                    html += `<div class=\"video-container external-video-fallback\"><div class=\"external-video-message\"><i class=\"fas fa-external-link-alt\"></i><h3>Ù…Ù‚Ø·Ø¹ ÙÙŠØ¯ÙŠÙˆ Ø®Ø§Ø±Ø¬ÙŠ</h3><p>Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù…Ù† ${platformName} ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§</p><a href=\"${link}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"external-video-link\"><i class=\"fas fa-play-circle\"></i><span>ÙØªØ­ Ø§Ù„Ù…Ù‚Ø·Ø¹ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©</span></a></div></div>`;
                                }
                            } else if (lower.includes('facebook.com') || lower.includes('fb.watch') || lower.includes('tiktok.com') || lower.includes('instagram.com') || lower.includes('telegram.org') || lower.includes('t.me')) {
                                // Social media videos cannot be embedded due to CSP restrictions
                                // Show a nice fallback with platform-specific styling
                                const platformName = getPlatformName(link);
                                const platformIcon = getPlatformIcon(link);
                                html += `<div class="video-container external-video-fallback">
                                    <div class="external-video-message">
                                        <i class="${platformIcon}"></i>
                                        <h3>Ù…Ù‚Ø·Ø¹ ÙÙŠØ¯ÙŠÙˆ Ù…Ù† ${platformName}</h3>
                                        <p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù…Ù‚Ø§Ø·Ø¹ ${platformName} Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø£Ù…Ø§Ù†</p>
                                        <a href="${link}" target="_blank" rel="noopener noreferrer" class="external-video-link">
                                            <i class="fas fa-play-circle"></i>
                                            <span>ÙØªØ­ Ø§Ù„Ù…Ù‚Ø·Ø¹ ÙÙŠ ${platformName}</span>
                                        </a>
                                        <button class="mark-complete-btn" onclick="markExternalVideoComplete(${moduleIndex}, ${lessonIndex})">
                                            <i class="fas fa-check-circle"></i>
                                            <span>ØªØ¹Ù„ÙŠÙ… ÙƒÙ…ÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
                                        </button>
                                    </div>
                                </div>`;
                            } else {
                                // Generic attempt via oEmbed (noembed)
                                try {
                                    const resp = await fetch('https://noembed.com/embed?url=' + encodeURIComponent(link));
                                    if (resp.ok) {
                                        const data = await resp.json();
                                        if (data && data.html) {
                                            html += `<div class="video-container">${data.html}</div>`;
                                        } else {
                                            throw new Error('No oEmbed html');
                                        }
                                    } else {
                                        throw new Error('oEmbed failed');
                                    }
                                } catch (_) {
                                    const platformName = getPlatformName(link);
                                    html += `<div class="video-container external-video-fallback">
                                        <div class="external-video-message">
                                            <i class="fas fa-external-link-alt"></i>
                                            <h3>Ù…Ù‚Ø·Ø¹ ÙÙŠØ¯ÙŠÙˆ Ø®Ø§Ø±Ø¬ÙŠ</h3>
                                            <p>Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø·Ø¹ Ù…Ù† ${platformName} ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§</p>
                                            <a href="${link}" target="_blank" rel="noopener noreferrer" class="external-video-link">
                                                <i class="fas fa-play-circle"></i>
                                                <span>ÙØªØ­ Ø§Ù„Ù…Ù‚Ø·Ø¹ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                                            </a>
                                        </div>
                                    </div>`;
                                }
                            }
                        } else {
                            // Handle local video files
                            let videoSrc = link;
                            // Ensure proper path for local videos
                            if (!videoSrc.startsWith('http') && !videoSrc.startsWith('/')) {
                                videoSrc = '/' + videoSrc.replace(/^\/+/, '');
                            }
                            const safeTitle = (lesson && lesson.title) ? escapeHTML(String(lesson.title)) : 'Local video';
                            html += `<div class="video-container">
                                <video id="local-video-${moduleIndex}-${lessonIndex}" class="js-player" playsinline controls>
                                    <source src="${videoSrc}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>`;
                        }
                    } else if (link.startsWith('http')) {
                        html += `<div class="lesson-info"><p class="lesson-description"><a href="${link}" target="_blank" rel="noopener noreferrer">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ÙØªØ­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</a></p></div>`;
                    } else {
                        html += `<div class="error-container"><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ ØµØ§Ù„Ø­ Ù„Ù„Ø¹Ø±Ø¶.</p></div>`;
                    }

                    const descHtml = renderLessonDescription(lesson.description);
                    html += `<div class="lesson-info"><div class="lesson-title"></div>${descHtml}</div>`;

                    contentContainer.innerHTML = html;

                    try {
                        const titleEl = contentContainer.querySelector('.lesson-title');
                        if (titleEl){
                            titleEl.textContent = lesson.title || 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³';
                        }
                    } catch(_) {}

                    if (window.Plyr) {
                        const nodes = Array.from(contentContainer.querySelectorAll('video.js-player, .plyr, .plyr__video-embed'));
                        const created = await initPlyrSequential(nodes);
                        _plyrInstances.push(...created);
                        attachVideoCompletionHandlers(created, moduleIndex, lessonIndex);
                    }

                    updateNavigationButtons();

                } catch (err) {
                    console.error('Error loading lesson content', err);
                    contentContainer.innerHTML = '<div class="error-container"><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p></div>';
                } finally {
                    setTimeout(() => { isLoadingLesson = false; }, 250);
                }
            }, 80);
        }

        let _lastLessonClick = 0;
        function selectLessonDebounced(moduleIndex, lessonIndex) {
            const now = Date.now();
            if (now - _lastLessonClick < 300) return;
            _lastLessonClick = now;
            if (isLoadingLesson) return;
            loadLesson(moduleIndex, lessonIndex);
        }

        function initPlyrSequential(nodeList) {
            return new Promise(resolve => {
                if (!nodeList || nodeList.length === 0) return resolve([]);
                const created = [];
                let i = 0;
                function next() {
                    if (i >= nodeList.length) {
                        resolve(created);
                        return;
                    }
                    try {
                        const p = new Plyr(nodeList[i], {
                            blankVideo: '',
                            youtube: {
                                noCookie: false,
                                rel: 0,
                                iv_load_policy: 3,
                                modestbranding: 1,
                                playsinline: 1
                            }
                        });
                        created.push(p);
                    } catch (e) {
                        console.warn('Plyr init failed for node', e);
                    }
                    i++;
                    requestAnimationFrame(next);
                }
                requestAnimationFrame(next);
            });
        }

        function attachVideoCompletionHandlers(players, moduleIndex, lessonIndex) {
            if (!players || !players.length) return;
            const lessonKey = `${moduleIndex}-${lessonIndex}`;
            players.forEach(p => {
                try {
                    const container = p?.elements?.container;
                    if (container && container.dataset.completionBound === '1') return;
                    if (container) container.dataset.completionBound = '1';
                    
                    // Handle video completion
                    p.on('ended', () => {
                        if (!completedLessons.has(lessonKey)) {
                            markLessonAsCompleted(moduleIndex, lessonIndex);
                        }
                    });

                    // Also track when user watches 90% of the video
                    let hasMarkedAt90 = false;
                    p.on('timeupdate', () => {
                        if (hasMarkedAt90 || completedLessons.has(lessonKey)) return;
                        const duration = p.duration;
                        const currentTime = p.currentTime;
                        if (duration > 0 && currentTime > 0 && (currentTime / duration) >= 0.9) {
                            hasMarkedAt90 = true;
                            markLessonAsCompleted(moduleIndex, lessonIndex);
                        }
                    });
                } catch(_) {}
            });
        }

        function updateProgress() {
            const existingKeys = new Set();
            let totalLessons = 0;
            if (Array.isArray(courseData?.units)) {
                courseData.units.forEach((unit, mIdx) => {
                    if (Array.isArray(unit.lessons)) {
                        unit.lessons.forEach((_, lIdx) => {
                            existingKeys.add(`${mIdx}-${lIdx}`);
                            totalLessons += 1;
                        });
                    }
                });
            }

            // Debug: Log all existing lesson keys
            console.log('Existing lesson keys:', Array.from(existingKeys));

            const prunedCompleted = new Set();
            completedLessons.forEach(key => {
                if (existingKeys.has(key)) prunedCompleted.add(key);
            });
            completedLessons = prunedCompleted;

            // Debug: Log pruned completed lessons
            console.log('Pruned completed lessons:', Array.from(completedLessons));

            const completedCount = completedLessons.size;
            let percentage = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;
            percentage = Math.max(0, Math.min(100, percentage));

            const percEl = document.getElementById('progressPercentage');
            const fillEl = document.getElementById('progressFill');
            if (percEl) percEl.textContent = `${percentage}%`;
            if (fillEl) fillEl.style.width = `${percentage}%`;

            // Detailed debug logging
            console.log('Progress Calculation:', {
                totalLessons,
                completedCount,
                percentage,
                completedLessons: Array.from(completedLessons),
                existingLessons: Array.from(existingKeys)
            });

            // Synchronize visual completion indicators with actual completion data
            document.querySelectorAll('.lesson-item').forEach(lessonItem => {
                const moduleIndex = parseInt(lessonItem.dataset.module);
                const lessonIndex = parseInt(lessonItem.dataset.lesson);
                const lessonKey = `${moduleIndex}-${lessonIndex}`;

                if (completedLessons.has(lessonKey)) {
                    lessonItem.classList.add('completed');
                } else {
                    lessonItem.classList.remove('completed');
                }
            });

            // Force re-calculation if there's a mismatch
            const visualCompletedCount = document.querySelectorAll('.lesson-item.completed').length;
            if (visualCompletedCount !== completedCount) {
                console.warn('Mismatch detected! Visual completed:', visualCompletedCount, 'vs actual completed:', completedCount);

                // Determine which one is more likely correct
                // If we have server-loaded progress, trust the visual indicators
                // If we're calculating from scratch, trust the completedLessons set
                if (visualCompletedCount > completedCount && completedCount > 0) {
                    // Visual indicators show more completions than our set
                    // This suggests server progress was loaded and visuals were updated
                    // Trust the visual indicators in this case
                    console.log('Trusting visual indicators as they show more completions (likely from server load)');
                    const visuallyCompleted = new Set();
                    document.querySelectorAll('.lesson-item.completed').forEach(item => {
                        const moduleIndex = parseInt(item.dataset.module);
                        const lessonIndex = parseInt(item.dataset.lesson);
                        visuallyCompleted.add(`${moduleIndex}-${lessonIndex}`);
                    });
                    completedLessons = visuallyCompleted;
                } else if (completedCount > visualCompletedCount) {
                    // Our set shows more completions than visual indicators
                    // This suggests local tracking is ahead of visuals
                    // Trust our completedLessons set and update visuals
                    console.log('Trusting completedLessons set as it shows more completions (local tracking ahead)');
                    document.querySelectorAll('.lesson-item').forEach(lessonItem => {
                        const moduleIndex = parseInt(lessonItem.dataset.module);
                        const lessonIndex = parseInt(lessonItem.dataset.lesson);
                        const lessonKey = `${moduleIndex}-${lessonIndex}`;

                        if (completedLessons.has(lessonKey)) {
                            lessonItem.classList.add('completed');
                        } else {
                            lessonItem.classList.remove('completed');
                        }
                    });
                }

                // Recalculate with the correct data
                const newCompletedCount = completedLessons.size;
                const newPercentage = totalLessons > 0 ? Math.round((newCompletedCount / totalLessons) * 100) : 0;
                if (percEl) percEl.textContent = `${newPercentage}%`;
                if (fillEl) fillEl.style.width = `${newPercentage}%`;
                console.log('Recalculated progress after sync:', newPercentage + '%');
            }
        }

        function markLessonAsCompleted(moduleIndex, lessonIndex) {
            const lessonKey = `${moduleIndex}-${lessonIndex}`;
            if (completedLessons.has(lessonKey)) {
                console.log(`Lesson ${lessonKey} already completed, skipping`);
                return;
            }

            completedLessons.add(lessonKey);

            const lessonItem = document.querySelector(`[data-module="${moduleIndex}"][data-lesson="${lessonIndex}"]`);
            if (lessonItem) {
                lessonItem.classList.add('completed');
            }

            // Force immediate progress update and save
            updateProgress();
            saveProgress();

            // Show toast notification for lesson completion
            const lesson = courseData?.units?.[moduleIndex]?.lessons?.[lessonIndex];
            const lessonTitle = lesson?.title || 'Ø§Ù„Ø¯Ø±Ø³';

            // Use setTimeout to ensure toast shows after DOM updates
            setTimeout(() => {
                if (window.showToast) {
                    window.showToast(`ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ${lessonTitle} Ø¨Ù†Ø¬Ø§Ø­!`, {
                        type: 'success',
                        timeout: 5000,
                        title: 'Ø¥Ù†Ø¬Ø§Ø² Ø±Ø§Ø¦Ø¹! ğŸ‰',
                        icon: 'fas fa-trophy'
                    });
                }
            }, 100);
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const unit = courseData?.units?.[currentModuleIndex];
            const totalInUnit = unit?.lessons?.length || 0;
            if (prevBtn) prevBtn.disabled = currentLessonIndex === 0;
            if (nextBtn) nextBtn.disabled = totalInUnit === 0 || currentLessonIndex === totalInUnit - 1;
        }

        function toggleModule(moduleIndex) {
            const lessonsList = document.getElementById(`lessons-${moduleIndex}`);
            if (!lessonsList) return;
            const moduleHeader = lessonsList.previousElementSibling;
            if (moduleHeader) moduleHeader.classList.toggle('active');
            lessonsList.classList.toggle('expanded');
        }

        function loadLesson(moduleIndex, lessonIndex) {
            if (!courseData || !courseData.units || !courseData.units[moduleIndex] || !courseData.units[moduleIndex].lessons[lessonIndex]) {
                return;
            }

            const lesson = courseData.units[moduleIndex].lessons[lessonIndex];

            currentModuleIndex = moduleIndex;
            currentLessonIndex = lessonIndex;

            document.querySelectorAll('.lesson-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const currentLessonItem = document.querySelector(`[data-module="${moduleIndex}"][data-lesson="${lessonIndex}"]`);
            if (currentLessonItem) {
                currentLessonItem.classList.add('active');
            }

            loadLessonContent(moduleIndex, lessonIndex, lesson);
            updateNavigationButtons();
        }

        async function saveProgress() {
            updateProgress();
            const progressData = {
                courseId: courseId,
                userId: currentUserId,
                completedLessons: Array.from(completedLessons),
                lastAccessed: new Date().toISOString()
            };
            // Use user-specific key to prevent cross-user progress sharing
            const storageKey = `courseProgress_${currentUserId}_${courseId}`;
            localStorage.setItem(storageKey, JSON.stringify(progressData));
            console.log(`Saved user-specific progress for ${currentUserId}:`, progressData);

            // Also sync to server - send each completed lesson individually
            try {
                const token = localStorage.getItem('token');
                if (token && courseData && completedLessons.size > 0) {
                    // First, get the actual lesson IDs from course data
                    const lessonIdMap = {};
                    courseData.units?.forEach((unit, moduleIndex) => {
                        unit.lessons?.forEach((lesson, lessonIndex) => {
                            const lessonKey = `${moduleIndex}-${lessonIndex}`;
                            if (lesson._id) {
                                lessonIdMap[lessonKey] = {
                                    unitId: unit._id,
                                    lessonId: lesson._id
                                };
                            }
                        });
                    });

                    console.log('Lesson ID mapping:', lessonIdMap);

                    // Send progress for each completed lesson to ensure all are saved
                    const savePromises = Array.from(completedLessons).map(async (lessonKey) => {
                        try {
                            const [moduleIndex, lessonIndex] = lessonKey.split('-');
                            const lessonInfo = lessonIdMap[lessonKey];

                            if (!lessonInfo) {
                                console.error(`No valid lesson ID found for ${lessonKey}`);
                                return false;
                            }

                            const response = await fetch('/api/courses/progress/complete', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + token
                                },
                                body: JSON.stringify({
                                    courseId: courseId,
                                    unitId: lessonInfo.unitId,
                                    lessonId: lessonInfo.lessonId
                                })
                            });

                            if (!response.ok) {
                                const errorText = await response.text().catch(() => 'Unknown error');
                                console.error(`Failed to save lesson ${lessonKey} progress (${lessonInfo.lessonId}):`, response.status, errorText);
                                return false;
                            }
                            return true;
                        } catch (error) {
                            console.error(`Error saving lesson ${lessonKey} progress:`, error);
                            return false;
                        }
                    });

                    const results = await Promise.all(savePromises);
                    const successCount = results.filter(r => r).length;
                    console.log(`Server progress sync: ${successCount}/${completedLessons.size} lessons saved successfully`);

                    // Also update the overall course progress
                    const totalLessons = courseData.units?.reduce((sum, unit) =>
                        sum + (unit.lessons?.length || 0), 0) || 0;
                    const completedCount = completedLessons.size;
                    const progressPercent = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;

                    // Fetch updated progress summary to ensure we have latest data
                    const summaryResponse = await fetch('/api/courses/progress/summary', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });

                    if (summaryResponse.ok) {
                        const summary = await summaryResponse.json();
                        console.log('Updated progress summary from server:', summary);
                    } else {
                        console.error('Failed to fetch progress summary:', summaryResponse.status);
                    }
                }
            } catch (error) {
                console.error('Failed to sync progress to server:', error);
            }
        }

        function loadProgress() {
            // Use user-specific key to prevent cross-user progress sharing
            const storageKey = `courseProgress_${currentUserId}_${courseId}`;
            const progressData = localStorage.getItem(storageKey);

            if (progressData) {
                try {
                    const data = JSON.parse(progressData);
                    completedLessons = new Set(data.completedLessons || []);
                    console.log('Loaded user-specific progress:', {
                        userId: currentUserId,
                        courseId: courseId,
                        completedLessons: Array.from(completedLessons),
                        count: completedLessons.size
                    });

                    // First update visual completion indicators
                    completedLessons.forEach(lessonKey => {
                        const [moduleIndex, lessonIndex] = lessonKey.split('-');
                        const lessonItem = document.querySelector(`[data-module="${moduleIndex}"][data-lesson="${lessonIndex}"]`);
                        if (lessonItem) {
                            lessonItem.classList.add('completed');
                        }
                    });

                    // Then force update progress to ensure UI is synchronized
                    updateProgress();

                } catch (error) {
                    console.error('Error loading user-specific progress:', error);
                }
            } else {
                console.log('No local progress data found for user:', currentUserId, 'course:', courseId);
                // If no local progress, we'll rely on server progress
                // which will be fetched in the next step
            }
        }

        async function fetchServerProgress() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const response = await fetch('/api/courses/progress/summary', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    console.error('Failed to fetch server progress:', response.status);
                    return;
                }

                const summaries = await response.json();
                const courseSummary = Array.isArray(summaries) ? summaries.find(s => s.courseId === courseId) : null;

                if (courseSummary) {
                    // Validate server data integrity
                    const validationResult = validateServerProgressData(courseSummary);
                    if (!validationResult.valid) {
                        console.error('Invalid server progress data:', validationResult.message);
                        if (validationResult.severe) {
                            // Report this issue to the server for correction
                            reportServerDataIssue(courseSummary);
                        }
                        return;
                    }

                    const serverProgress = Math.max(0, Math.min(100, Math.round(courseSummary.progressPercent)));
                    const percEl = document.getElementById('progressPercentage');
                    const fillEl = document.getElementById('progressFill');

                    // Get current local progress calculation
                    const currentProgress = percEl ? parseInt(percEl.textContent) || 0 : 0;

                    console.log(`Server progress: ${serverProgress}%, Local progress: ${currentProgress}%`);

                    // Enhanced logic with real-time synchronization
                    if (completedLessons.size === 0 && serverProgress > 0) {
                        console.log(`Initializing progress from server: ${currentProgress}% -> ${serverProgress}%`);
                        if (percEl) percEl.textContent = `${serverProgress}%`;
                        if (fillEl) fillEl.style.width = `${serverProgress}%`;

                        // Sync with server data if available
                        if (courseSummary.completedLessons && Array.isArray(courseSummary.completedLessons)) {
                            syncWithServerCompletedLessons(courseSummary.completedLessons);
                        } else {
                            // Estimate based on percentage
                            const totalLessons = countTotalLessons();
                            if (totalLessons > 0) {
                                const estimatedCompleted = Math.round((serverProgress / 100) * totalLessons);
                                console.log(`Server indicates ~${estimatedCompleted} lessons completed`);
                            }
                        }
                    } else if (Math.abs(serverProgress - currentProgress) > 5) {
                        console.log(`Significant progress difference detected: local ${currentProgress}% vs server ${serverProgress}%`);

                        // Implement conflict resolution strategy
                        const resolution = resolveProgressConflict(currentProgress, serverProgress, courseSummary);
                        if (resolution.action === 'use_server') {
                            console.log(`Resolved conflict: Using server progress (${serverProgress}%) as more reliable`);
                            if (percEl) percEl.textContent = `${serverProgress}%`;
                            if (fillEl) fillEl.style.width = `${serverProgress}%`;

                            // Sync completed lessons from server if available
                            if (courseSummary.completedLessons) {
                                syncWithServerCompletedLessons(courseSummary.completedLessons);
                            }
                        } else {
                            console.log(`Resolved conflict: Keeping local progress (${currentProgress}%) as more accurate`);
                            // Send local progress to server to correct it
                            syncLocalProgressToServer();
                        }
                    } else {
                        console.log(`Progress is consistent: local ${currentProgress}% matches server ${serverProgress}%`);
                        // Still do periodic sync to ensure no drift
                        if (Math.random() < 0.1) { // 10% chance to sync periodically
                            syncLocalProgressToServer();
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching server progress:', error);
                // If error persists, try to recover from local storage
                if (completedLessons.size === 0) {
                    console.log('Attempting to recover progress from local storage...');
                    loadProgress();
                }
            }
        }

        function validateServerProgressData(summary) {
            // Validate the server progress data for corruption
            const errors = [];

            // Check if progress percent is within valid range
            if (typeof summary.progressPercent !== 'number' ||
                isNaN(summary.progressPercent) ||
                summary.progressPercent < 0 ||
                summary.progressPercent > 100) {
                errors.push(`Invalid progressPercent: ${summary.progressPercent} (must be 0-100)`);
            }

            // Check if completed count makes sense with total lessons
            if (typeof summary.completedCount === 'number' &&
                typeof summary.totalLessons === 'number' &&
                summary.totalLessons > 0) {
                const calculatedPercent = (summary.completedCount / summary.totalLessons) * 100;
                const percentDiff = Math.abs(calculatedPercent - (summary.progressPercent || 0));

                if (summary.completedCount > summary.totalLessons) {
                    errors.push(`Completed count (${summary.completedCount}) exceeds total lessons (${summary.totalLessons})`);
                }

                if (percentDiff > 10) { // Allow 10% tolerance for rounding
                    errors.push(`Progress percent (${summary.progressPercent}%) doesn't match completed/total ratio (${calculatedPercent.toFixed(1)}%)`);
                }
            }

            // Check for impossible values
            if (summary.completedCount > 1000 || summary.totalLessons > 1000) {
                errors.push(`Unrealistic lesson counts: completed=${summary.completedCount}, total=${summary.totalLessons}`);
            }

            // Check for negative values
            if (summary.completedCount < 0 || summary.totalLessons < 0) {
                errors.push(`Negative lesson counts detected`);
            }

            return {
                valid: errors.length === 0,
                message: errors.join('; '),
                severe: errors.some(err => err.includes('exceeds') || err.includes('Unrealistic') || err.includes('Negative'))
            };
        }

        function resolveProgressConflict(localProgress, serverProgress, serverData) {
            // Strategy for resolving conflicts between local and server progress

            // If server has more recent timestamp, prefer server
            if (serverData.updatedAt && new Date(serverData.updatedAt) > new Date(Date.now() - 300000)) {
                // Server data updated in last 5 minutes - likely more current
                return { action: 'use_server', reason: 'server_data_recent' };
            }

            // If local has more detailed tracking (individual lessons), prefer local
            if (completedLessons.size > 0 && (!serverData.completedLessons || serverData.completedLessons.length === 0)) {
                return { action: 'use_local', reason: 'local_has_detailed_tracking' };
            }

            // If server progress is higher and seems reasonable, prefer server
            if (serverProgress > localProgress && serverProgress <= 100) {
                return { action: 'use_server', reason: 'server_shows_higher_progress' };
            }

            // Default: prefer local as it's more granular and real-time
            return { action: 'use_local', reason: 'local_more_granular' };
        }

        function syncWithServerCompletedLessons(serverCompletedLessons) {
            if (!Array.isArray(serverCompletedLessons)) return;

            console.log('Syncing with server completed lessons:', serverCompletedLessons);

            // Validate each lesson key from server
            const validServerLessons = serverCompletedLessons.filter(lessonKey => {
                if (typeof lessonKey !== 'string') return false;
                const parts = lessonKey.split('-');
                return parts.length === 2 &&
                       !isNaN(parseInt(parts[0])) &&
                       !isNaN(parseInt(parts[1]));
            });

            // Merge server lessons with local lessons
            const newCompletedLessons = new Set(completedLessons);

            validServerLessons.forEach(lessonKey => {
                // Check if this lesson actually exists in our course data
                const [moduleIndex, lessonIndex] = lessonKey.split('-').map(Number);
                const unit = courseData?.units?.[moduleIndex];
                const lesson = unit?.lessons?.[lessonIndex];

                if (unit && lesson) {
                    newCompletedLessons.add(lessonKey);
                } else {
                    console.warn(`Server lesson ${lessonKey} doesn't exist in current course data`);
                }
            });

            // Only update if server provided valid additional completions
            if (newCompletedLessons.size > completedLessons.size) {
                completedLessons = newCompletedLessons;
                console.log(`Synced ${newCompletedLessons.size - completedLessons.size} additional lessons from server`);

                // Update visual indicators
                updateVisualCompletionIndicators();
                updateProgress();
                saveProgress();
            }
        }

        function updateVisualCompletionIndicators() {
            // Update all lesson items to reflect current completion status
            document.querySelectorAll('.lesson-item').forEach(lessonItem => {
                const moduleIndex = parseInt(lessonItem.dataset.module);
                const lessonIndex = parseInt(lessonItem.dataset.lesson);
                const lessonKey = `${moduleIndex}-${lessonIndex}`;

                if (completedLessons.has(lessonKey)) {
                    lessonItem.classList.add('completed');
                } else {
                    lessonItem.classList.remove('completed');
                }
            });
        }

        async function syncLocalProgressToServer() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('No auth token, cannot sync to server');
                    return;
                }

                // Get the actual lesson IDs for server sync
                const lessonIdMap = {};
                let hasValidLessonIds = false;

                if (courseData?.units) {
                    courseData.units.forEach((unit, moduleIndex) => {
                        if (unit._id && unit.lessons) {
                            unit.lessons.forEach((lesson, lessonIndex) => {
                                if (lesson._id) {
                                    const lessonKey = `${moduleIndex}-${lessonIndex}`;
                                    lessonIdMap[lessonKey] = {
                                        unitId: unit._id,
                                        lessonId: lesson._id
                                    };
                                }
                            });
                        }
                    });
                    hasValidLessonIds = Object.keys(lessonIdMap).length > 0;
                }

                if (!hasValidLessonIds) {
                    console.log('No valid lesson IDs available for server sync');
                    return;
                }

                console.log('Syncing local progress to server...');
                const completedLessonIds = [];

                // Convert our lesson keys to server format
                completedLessons.forEach(lessonKey => {
                    const lessonInfo = lessonIdMap[lessonKey];
                    if (lessonInfo) {
                        completedLessonIds.push({
                            unitId: lessonInfo.unitId,
                            lessonId: lessonInfo.lessonId
                        });
                    }
                });

                const response = await fetch('/api/courses/progress/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        courseId: courseId,
                        completedLessons: completedLessonIds,
                        progressPercent: calculateCurrentProgressPercentage()
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Successfully synced progress to server:', result);
                    if (window.showToast) {
                        window.showToast('ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†Ø¬Ø§Ø­', {
                            type: 'success',
                            timeout: 3000,
                            title: 'Ù…Ø²Ø§Ù…Ù†Ø© Ù†Ø§Ø¬Ø­Ø©'
                        });
                    }
                } else {
                    console.error('Failed to sync progress to server:', response.status);
                    const errorText = await response.text().catch(() => 'Unknown error');
                    console.error('Server response:', errorText);
                }

            } catch (error) {
                console.error('Error syncing progress to server:', error);
                // Queue for retry later
                setTimeout(syncLocalProgressToServer, 30000);
            }
        }

        function calculateCurrentProgressPercentage() {
            const totalLessons = countTotalLessons();
            const completedCount = completedLessons.size;
            return totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;
        }

        async function reportServerDataIssue(issueData) {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                console.log('Reporting server data issue to backend...');

                await fetch('/api/courses/progress/report-issue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        courseId: courseId,
                        issueType: 'data_corruption',
                        issueData: issueData,
                        clientInfo: {
                            userAgent: navigator.userAgent,
                            timestamp: new Date().toISOString(),
                            localProgress: {
                                completedCount: completedLessons.size,
                                totalLessons: countTotalLessons(),
                                progressPercent: calculateCurrentProgressPercentage()
                            }
                        }
                    })
                });

            } catch (error) {
                console.error('Failed to report server data issue:', error);
            }
        }

        function showError(message) {
            const contentContainer = document.getElementById('contentContainer');
            const modulesList = document.getElementById('modulesList');
            
            contentContainer.innerHTML = `
                <div class="error-container">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>${message}</h3>
                    <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p>
                    <a href="courses.html"><i class="fa-solid fa-arrow-right"></i><span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙƒÙˆØ±Ø³Ø§Øª</span></a>
                </div>
            `;

            if (modulesList) {
                modulesList.innerHTML = `
                    <div class="error-container">
                        <p>Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ±Ø³</p>
                    </div>
                `;
            }

            document.getElementById('progressPercentage').textContent = '0%';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('courseTitle').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£';
            document.getElementById('mainCourseTitle').textContent = 'Ø­Ø¯Ø« Ø®Ø·ï¿½ï¿½';
            document.getElementById('mainCourseDescription').textContent = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ Ø§Ù„ÙƒÙˆØ±Ø³';
        }

        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');

        async function initializeCourse() {
            const contentContainer = document.getElementById('contentContainer');
            if (!courseId) {
                showError("Ù…Ø¹Ø±Ù Ø§Ù„ÙƒÙˆØ±Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
                return;
            }

            // Initialize user ID for user-specific progress tracking
            try {
                const user = JSON.parse(localStorage.getItem("user"));
                currentUserId = user?._id || user?.id || 'anonymous';
                console.log('Initialized user ID for progress tracking:', currentUserId);
            } catch (error) {
                console.error('Error getting user ID:', error);
                currentUserId = 'anonymous';
            }

            try {
                contentContainer.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒÙˆØ±Ø³...</p>
                    </div>
                `;

                const response = await fetch(`https://twm3.org/api/courses/${courseId}`);
                
                if (!response.ok) {
                    throw new Error(`ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³: ${response.status}`);
                }

                const course = await response.json();
                
                if (!course) {
                    showError("Ø§Ù„ÙƒÙˆØ±Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
                    return;
                }
                
                courseData = course;
                currentCourse = course;
                
                document.getElementById('courseTitle').textContent = course.title;
                document.getElementById('mainCourseTitle').textContent = course.title;
                document.getElementById('mainCourseDescription').textContent = course.full_description || course.description || '';
                updateCourseSubtitle();
                document.title = course.title;
                
                renderCourseContent();
                
                if (course.units && course.units.length > 0) {
                    let foundModule = -1;
                    let foundLesson = -1;

                    for (let m = 0; m < course.units.length; m++) {
                        const unit = course.units[m];
                        if (!Array.isArray(unit.lessons)) continue;
                        for (let l = 0; l < unit.lessons.length; l++) {
                            const link = getLessonLink(unit.lessons[l]);
                            if (isVideoLink(link)) {
                                foundModule = m;
                                foundLesson = l;
                                break;
                            }
                        }
                        if (foundModule !== -1) break;
                    }

                    if (foundModule === -1) {
                        const firstUnitIndex = course.units.findIndex(u => Array.isArray(u.lessons) && u.lessons.length > 0);
                        if (firstUnitIndex !== -1) {
                            foundModule = firstUnitIndex;
                            foundLesson = 0;
                        }
                    }

                    if (foundModule !== -1 && foundLesson !== -1) {
                        loadLesson(foundModule, foundLesson);
                    }
                }
                
                // Load local progress first
                loadProgress();

                // Give a small delay to ensure local progress is fully processed
                setTimeout(() => {
                    // Then fetch server progress (but local will take precedence)
                    fetchServerProgress();
                }, 100);
                
            } catch (error) {
                console.error('Error loading course:', error);
                showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³");
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (courseId) {
                initializeCourse();
            } else {
                showError("Ù…Ø¹Ø±Ù Ø§Ù„ÙƒÙˆØ±Ø³ ØºÙŠØ± ØµØ­ÙŠØ­");
            }
        });

        function setupPdfCompletionTracking(moduleIndex, lessonIndex, pdfContainerId) {
            const lessonKey = `${moduleIndex}-${lessonIndex}`;
            if (completedLessons.has(lessonKey)) return;
            
            const container = document.getElementById(pdfContainerId);
            if (!container) return;
            
            const iframe = container.querySelector('iframe');
            if (!iframe) return;
            
            let lastPageNumber = 0;
            let totalPages = 0;
            let checkInterval = null;
            let hasReachedLastPage = false;
            
            function checkPdfProgress() {
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (!iframeWindow || !iframeWindow.PDFViewerApplication) return;
                    
                    const pdfViewer = iframeWindow.PDFViewerApplication;
                    if (!pdfViewer || !pdfViewer.pdfDocument) return;
                    
                    if (totalPages === 0 && pdfViewer.pagesCount) {
                        totalPages = pdfViewer.pagesCount;
                    }
                    
                    const currentPage = pdfViewer.page || pdfViewer.currentPageNumber || 0;
                    
                    if (currentPage !== lastPageNumber) {
                        lastPageNumber = currentPage;
                        
                        if (totalPages > 0 && currentPage >= totalPages && !hasReachedLastPage) {
                            hasReachedLastPage = true;
                            if (!completedLessons.has(lessonKey)) {
                                markLessonAsCompleted(moduleIndex, lessonIndex);
                            }
                            
                            if (checkInterval) {
                                clearInterval(checkInterval);
                                checkInterval = null;
                            }
                        }
                    }
                } catch (e) {
                    try {
                        const iframeWindow = iframe.contentWindow;
                        if (iframeWindow && iframeWindow.location && iframeWindow.location.hash) {
                            const hash = iframeWindow.location.hash;
                            const pageMatch = hash.match(/page=(\d+)/);
                            if (pageMatch) {
                                const currentPage = parseInt(pageMatch[1], 10);
                                const numPagesEl = iframe.contentDocument?.getElementById('numPages');
                                if (numPagesEl) {
                                    const totalText = numPagesEl.textContent || '';
                                    const totalMatch = totalText.match(/(\d+)/);
                                    if (totalMatch) {
                                        totalPages = parseInt(totalMatch[1], 10);
                                        if (currentPage >= totalPages && !hasReachedLastPage) {
                                            hasReachedLastPage = true;
                                            if (!completedLessons.has(lessonKey)) {
                                                markLessonAsCompleted(moduleIndex, lessonIndex);
                                            }
                                            if (checkInterval) {
                                                clearInterval(checkInterval);
                                                checkInterval = null;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } catch (e2) {
                        // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                    }
                }
            }
            
            iframe.addEventListener('load', () => {
                setTimeout(() => {
                    checkInterval = setInterval(checkPdfProgress, 1500);
                }, 3000);
            }, { once: true });
        }
    </script>
    
  </body>
</html>
