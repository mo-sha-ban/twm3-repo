<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سلة المشتريات - TeamWork M3</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Favicon -->
    <link rel="icon" href="img/loogo.png">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="css/store.css">
    <style>
        /* Cart Page Specific Styles */
        .cart-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .cart-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .back-to-store {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .back-to-store:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .cart-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .cart-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .cart-items {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .cart-summary {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .cart-item-category {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .cart-item-price {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .quantity-input {
            width: 40px;
            text-align: center;
            padding: 0.25rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
        }

        .remove-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .empty-cart {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        .empty-cart i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-cart h3 {
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-cart p {
            margin-bottom: 1.5rem;
        }

        .browse-store-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .browse-store-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .cart-summary-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .summary-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .summary-label {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .summary-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .summary-total {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 700;
        }

        .checkout-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 1rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .checkout-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .cart-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .cart-summary {
                position: static;
                margin-top: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="cart-header">
        <div class="cart-title">سلة المشتريات</div>
        <button class="back-to-store" onclick="window.location.href='store.html'">
            <i class="fas fa-arrow-left"></i> العودة إلى المتجر
        </button>
    </header>

    <!-- Main Content -->
    <main class="cart-container">
        <div class="cart-content">
            <!-- Cart Items Section -->
            <div class="cart-items" id="cart-items">
                <!-- Cart items will be loaded here -->
                <div class="loading-cart">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>جاري تحميل سلة المشتريات...</p>
                </div>
            </div>

            <!-- Cart Summary Section -->
            <div class="cart-summary" id="cart-summary">
                <h2 class="cart-summary-title">ملخص الطلب</h2>
                <div class="summary-row">
                    <span class="summary-label">المجموع الفرعي</span>
                    <span class="summary-value" id="subtotal">0.00 ج.م</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">الضريبة (0%)   الضريبه صفر لفتره محدودة </span>
                    <span class="summary-value" id="tax">0.00 ج.م</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">إجمالي الطلب</span>
                    <span class="summary-value summary-total" id="total">0.00 ج.م</span>
                </div>
                <button class="checkout-btn" id="checkout-btn" disabled>
                    <i class="fas fa-credit-card"></i> إتمام الشراء
                </button>
            </div>
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        // Cart functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Load cart items from localStorage
            loadCartItems();

            // Checkout button functionality
            const checkoutBtn = document.getElementById('checkout-btn');
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', function() {
                    if (!checkoutBtn.disabled) {
                        completePurchase();
                    }
                });
            }
        });

        // Load cart items from localStorage
        function loadCartItems() {
            const cartItemsContainer = document.getElementById('cart-items');
            if (!cartItemsContainer) return;

            try {
                // Get cart items from localStorage
                const cartData = localStorage.getItem('cartItems');
                const cartItems = cartData ? JSON.parse(cartData) : [];

                if (cartItems.length === 0) {
                    // Show empty cart message
                    cartItemsContainer.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>سلة المشتريات فارغة</h3>
                            <p>لا توجد منتجات في سلتك حالياً</p>
                            <button class="browse-store-btn" onclick="window.location.href='store.html'">
                                <i class="fas fa-store"></i> تصفح المتجر
                            </button>
                        </div>
                    `;
                    updateCartSummary([]);
                    return;
                }

                // Fetch product details for each item in cart
                const productIds = cartItems.map(item => item.productId);
                fetchProductDetails(productIds, cartItems);

            } catch (error) {
                console.error('Error loading cart items:', error);
                cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>خطأ في تحميل السلة</h3>
                        <p>حدث خطأ أثناء تحميل منتجات السلة</p>
                        <button class="browse-store-btn" onclick="window.location.href='store.html'">
                            <i class="fas fa-store"></i> تصفح المتجر
                        </button>
                    </div>
                `;
            }
        }

        // Fetch product details from API
        async function fetchProductDetails(productIds, cartItems) {
            try {
                const cartItemsContainer = document.getElementById('cart-items');
                if (!cartItemsContainer) return;

                // Show loading state
                cartItemsContainer.innerHTML = `
                    <div class="loading-cart">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>جاري تحميل تفاصيل المنتجات...</p>
                    </div>
                `;

                // Fetch all products to get details
                const response = await fetch('/api/products');
                if (!response.ok) {
                    throw new Error('فشل في تحميل تفاصيل المنتجات');
                }

                const allProducts = await response.json();

                // Create a map of products by ID for easy lookup
                const productsMap = {};
                allProducts.forEach(product => {
                    productsMap[product._id] = product;
                });

                // Render cart items with product details
                const cartItemsWithDetails = cartItems.map(cartItem => {
                    const product = productsMap[cartItem.productId];
                    if (!product) return null;

                    return {
                        ...cartItem,
                        name: product.name,
                        price: product.price || 0,
                        image: product.image || '/img/profile.png',
                        category: product.category || 'عام',
                        inStock: product.inStock !== false
                    };
                }).filter(item => item !== null);

                renderCartItems(cartItemsWithDetails);
                updateCartSummary(cartItemsWithDetails);

            } catch (error) {
                console.error('Error fetching product details:', error);
                const cartItemsContainer = document.getElementById('cart-items');
                if (cartItemsContainer) {
                    cartItemsContainer.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>خطأ في تحميل المنتجات</h3>
                            <p>تعذر تحميل تفاصيل المنتجات من الخادم</p>
                            <button class="browse-store-btn" onclick="window.location.href='store.html'">
                                <i class="fas fa-store"></i> تصفح المتجر
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Render cart items
        function renderCartItems(cartItems) {
            const cartItemsContainer = document.getElementById('cart-items');
            if (!cartItemsContainer) return;

            if (cartItems.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>سلة المشتريات فارغة</h3>
                        <p>لا توجد منتجات في سلتك حالياً</p>
                        <button class="browse-store-btn" onclick="window.location.href='store.html'">
                            <i class="fas fa-store"></i> تصفح المتجر
                        </button>
                    </div>
                `;
                return;
            }

            // Use the quantity field directly from cart items
            const uniqueItems = [];
            const itemsById = {};

            cartItems.forEach(item => {
                if (!itemsById[item.productId]) {
                    itemsById[item.productId] = { ...item };
                    uniqueItems.push(itemsById[item.productId]);
                } else {
                    // If duplicate found (shouldn't happen with proper quantity handling),
                    // add the quantities together
                    itemsById[item.productId].quantity = (itemsById[item.productId].quantity || 1) + (item.quantity || 1);
                }
            });

            cartItemsContainer.innerHTML = uniqueItems.map(item => `
                <div class="cart-item" data-product-id="${item.productId}">
                    <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${escapeHtml(item.name)}</div>
                        <div class="cart-item-category">${getCategoryName(item.category)}</div>
                        <div class="cart-item-price">${parseFloat(item.price) ? parseFloat(item.price).toFixed(2) : '0.00'} ج.م × ${item.quantity || 1} = ${parseFloat(item.price) ? (parseFloat(item.price) * (item.quantity || 1)).toFixed(2) : '0.00'} ج.م</div>
                    </div>
                    <div class="cart-item-actions">
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="decreaseQuantity('${item.productId}')">-</button>
                            <input type="text" class="quantity-input" value="${item.quantity || 1}" readonly>
                            <button class="quantity-btn" onclick="increaseQuantity('${item.productId}')">+</button>
                        </div>
                        <button class="remove-btn" onclick="removeFromCart('${item.productId}')">
                            <i class="fas fa-trash"></i> إزالة
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update cart summary
        function updateCartSummary(cartItems) {
            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (!subtotalElement || !taxElement || !totalElement || !checkoutBtn) return;

            if (cartItems.length === 0) {
                subtotalElement.textContent = '0.00 ج.م';
                taxElement.textContent = '0.00 ج.م';
                totalElement.textContent = '0.00 ج.م';
                checkoutBtn.disabled = true;
                return;
            }

            // Calculate subtotal with safe price handling
            const subtotal = cartItems.reduce((sum, item) => {
                const price = parseFloat(item.price) || 0;
                const quantity = item.quantity || 1;
                return sum + (price * quantity);
            }, 0);
            // const tax = subtotal * 0.14; // 14% tax
            const tax = subtotal * 0; // 14% tax
            // const total = subtotal + tax;
            const total = subtotal;

            subtotalElement.textContent = `${subtotal.toFixed(2)} ج.م`;
            taxElement.textContent = `${tax.toFixed(2)} ج.م`;
            totalElement.textContent = `${total.toFixed(2)} ج.م`;

            // Enable checkout button if there are items
            checkoutBtn.disabled = cartItems.length === 0;
        }

        // Increase quantity
        function increaseQuantity(productId) {
            updateCartItemQuantity(productId, 1);
        }

        // Decrease quantity
        function decreaseQuantity(productId) {
            updateCartItemQuantity(productId, -1);
        }

        // Update cart item quantity
        function updateCartItemQuantity(productId, change) {
            try {
                const cartData = localStorage.getItem('cartItems');
                let cartItems = cartData ? JSON.parse(cartData) : [];

                // Find the item in cart
                const itemIndex = cartItems.findIndex(item => item.productId === productId);
                if (itemIndex === -1) return;

                // Update quantity
                cartItems[itemIndex].quantity = (cartItems[itemIndex].quantity || 1) + change;

                // If quantity reaches 0, remove the item
                if (cartItems[itemIndex].quantity <= 0) {
                    cartItems.splice(itemIndex, 1);
                }

                // Save updated cart
                localStorage.setItem('cartItems', JSON.stringify(cartItems));

                // Reload cart display
                loadCartItems();

            } catch (error) {
                console.error('Error updating quantity:', error);
                showToast('خطأ', 'فشل في تحديث الكمية', 'error');
            }
        }

        // Remove item from cart
        function removeFromCart(productId) {
            try {
                const cartData = localStorage.getItem('cartItems');
                let cartItems = cartData ? JSON.parse(cartData) : [];

                // Filter out the item to remove
                cartItems = cartItems.filter(item => item.productId !== productId);

                // Save updated cart
                localStorage.setItem('cartItems', JSON.stringify(cartItems));

                // Reload cart display
                loadCartItems();

                showToast('نجاح', 'تم إزالة المنتج من السلة', 'success');

            } catch (error) {
                console.error('Error removing item from cart:', error);
                showToast('خطأ', 'فشل في إزالة المنتج من السلة', 'error');
            }
        }

        // Complete purchase
        function completePurchase() {
            try {
                const cartData = localStorage.getItem('cartItems');
                const cartItems = cartData ? JSON.parse(cartData) : [];

                if (cartItems.length === 0) {
                    showToast('خطأ', 'سلة المشتريات فارغة', 'error');
                    return;
                }

                // Get user info
                const user = JSON.parse(localStorage.getItem('user'));
                const token = localStorage.getItem('token');

                if (!user || !token) {
                    // Redirect to login if not authenticated
                    if (confirm('يجب تسجيل الدخول لإتمام عملية الشراء. هل تريد تسجيل الدخول الآن؟')) {
                        window.location.href = 'login.html';
                    }
                    return;
                }

                // Prepare order data
                const orderData = {
                    userId: user._id,
                    items: cartItems,
                    total: calculateTotal(cartItems),
                    status: 'completed',
                    createdAt: new Date().toISOString()
                };

                // In a real application, you would send this to your backend
                // For this demo, we'll simulate a successful purchase

                // Show success message
                showToast('نجاح', 'تم إتمام عملية الشراء بنجاح!', 'success');

                // Clear cart
                localStorage.removeItem('cartItems');

                // Update cart badge to reflect empty cart
                if (typeof updateCartBadge === 'function') {
                    updateCartBadge();
                }

                // Redirect to order confirmation
                setTimeout(() => {
                    window.location.href = 'finish-order.html';
                }, 2000);

            } catch (error) {
                console.error('Error completing purchase:', error);
                showToast('خطأ', 'فشل في إتمام عملية الشراء', 'error');
            }
        }

        // Calculate total amount
        function calculateTotal(cartItems) {
            return cartItems.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
        }

        // Get category display name
        function getCategoryName(category) {
            const categoryNames = {
                'electronics': 'إلكترونيات',
                'books': 'كتب',
                'courses': 'كورسات',
                'software': 'برمجيات',
                'hardware': 'أجهزة',
                'accessories': 'إكسسوارات',
                'general': 'عام'
            };
            return categoryNames[category] || category;
        }

        // Escape HTML for security
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Toast notification function
        function showToast(title, message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Expose functions to global scope for button handlers
        window.increaseQuantity = increaseQuantity;
        window.decreaseQuantity = decreaseQuantity;
        window.removeFromCart = removeFromCart;
    </script>
</body>
</html>