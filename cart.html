<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª â€” TeamWork M3</title>
    <link rel="icon" href="img/loogo.png">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/courses-carousel.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Default Theme (Dark) */
            --bg:#0b1220; --card:rgba(12,18,28,0.6); --glass-border:rgba(255,255,255,0.06); 
            --primary:#3b82f6; --accent:#2563eb; --text:#e6eef8; --muted:#94a3b8;
            --radius:16px; --container:1200px;
        }
        /* Inverted Theme logic matching global style */
        .dark-theme { --bg:#f6f8fb; --card:#ffffffaa; --glass-border:rgba(255,255,255,0.6); --text:#0f172a; --muted:#64748b }
        [data-theme="dark"] { --bg:#0b1220; --card:rgba(12,18,28,0.6); --glass-border:rgba(255,255,255,0.06); --text:#e6eef8; --muted:#94a3b8 }

        html,body{font-family:'Cairo',sans-serif;background:var(--bg);margin:0;color:var(--text);transition: background 0.3s ease;}
        
        .page-wrap{margin:0px auto;padding:40px 18px}
        .hero{display:flex;align-items:center;justify-content:center;gap:16px;margin:30px 0;text-align:center;flex-direction:column}
        .hero h1{margin:0;font-size:1.8rem; font-weight:800}
        .hero .sub{color:var(--muted);font-size:1rem; opacity:0.8}
        .back{background:rgba(255,255,255,0.05); border:1px solid var(--glass-border); color:var(--text); padding:8px 16px; border-radius:10px; cursor:pointer; transition:0.3s}
        .back:hover{background:var(--primary); color:#fff; border-color:var(--primary)}

        .cart-grid{display:grid;grid-template-columns:1fr;max-width:850px;margin:0 auto;gap:24px}
        .glass{background:var(--card);border-radius:var(--radius);padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.1);border:1px solid var(--glass-border);backdrop-filter:blur(16px); position:relative; overflow:hidden;}
        
        .item{display:flex;gap:16px;align-items:center;padding:16px;border-radius:12px;background:rgba(255,255,255,0.02); transition:0.3s}
        .item:hover{background:rgba(255,255,255,0.05)}
        .item img{width:110px;height:75px;object-fit:cover;border-radius:10px}
        .info{flex:1}
        .info .title{font-weight:700; font-size:1.1rem}
        .info .meta{color:var(--muted);font-size:0.9rem}

        .controls{display:flex;gap:16px;align-items:center}
        .price{font-weight:800;color:var(--primary);font-size:1.1rem}
        .qty{display:flex;align-items:center;gap:10px;background:rgba(0,0,0,0.1);padding:5px 12px;border-radius:20px}
        .qty button{background:transparent;border:none;color:var(--text); cursor:pointer; font-size:1.2rem}
        .remove{background:transparent;border:none;color:#ef4444;cursor:pointer; font-weight:700}

        .summary h3{margin:0 0 15px 0; font-weight:800}
        .row{display:flex;justify-content:space-between;align-items:center; margin-bottom:10px}
        .total{font-size:1.5rem;font-weight:800;color:var(--primary)}
        .checkout{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;padding:16px;border-radius:14px;border:none;font-weight:800;cursor:pointer;width:100%;transition:all .3s ease; font-size:1.1rem}
        .checkout:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 12px 24px rgba(37,99,235,0.4)}
        .checkout:disabled{opacity:0.5;cursor:not-allowed}

        .empty{display:flex;flex-direction:column;align-items:center;padding:40px 20px;text-align:center;color:var(--muted)}
        .empty i{font-size:4rem; margin-bottom:20px; opacity:0.3}

        /* Modal Styles */
        .checkout-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.8);opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:200}
        .checkout-modal.show{opacity:1;pointer-events:auto}
        .checkout-modal-panel{width:min(600px,94%); border-radius:20px; padding:30px; background:var(--bg); border:1px solid var(--glass-border); box-shadow:0 30px 60px rgba(0,0,0,0.3); backdrop-filter:blur(20px)}
        .modal-close{position:absolute; top:15px; right:15px; background:none; border:none; color:var(--text); font-size:1.5rem; cursor:pointer; opacity:0.6}
        
        .payment-methods { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
        .payment-option { cursor: pointer; }
        .payment-option input { display:none }
        .payment-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
            padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.03); transition: 0.3s; text-align: center; color: var(--muted);
        }
        .payment-option input:checked + .payment-card {
            background: rgba(59, 130, 246, 0.1); border-color: var(--primary); color: var(--primary);
            box-shadow: 0 8px 16px rgba(59,130,246,0.2); transform: translateY(-5px);
        }
        
        /* Disabled payment methods */
        .payment-option.disabled { cursor: not-allowed; opacity: 0.5; filter: grayscale(1); }
        .payment-option.disabled .payment-card { pointer-events: none; }
        .field label { display:block; margin-bottom:5px; font-weight:600; font-size:0.9rem }
        .field input, .field textarea {
            width:100%; padding:10px; border-radius:8px; border:1px solid var(--glass-border);
            background:rgba(0,0,0,0.2); color:white; margin-bottom:12px; outline:none;
        }

        #paymentProcessing, #paymentSuccess { text-align:center; padding:30px 0; display:none }
        .spinner { font-size: 2.5rem; color:var(--primary); animation: spin 1s linear infinite; margin-bottom:15px }
        @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
    </style>
</head>
<body>

    <div dir="rtl" class="header">
        <div class="container">
            <div class="logo">
                <a href="index.html"><img src="img/logo.png" alt="TWM3"></a>
            </div>
            <div id="list" class="links">
                <ul>
                    <li><a href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li><a href="courses.html">Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</a></li>
                    <li><a href="portfolio.html">Ù…Ø´Ø§Ø±ÙŠØ¹Ù†Ø§</a></li>
                </ul>
            </div>
            <div class="icon">
                <div id="colorMode" class="theme">
                    <i class="fa-solid fa-moon moon"></i>
                    <i class="fa-solid fa-sun sun"></i>
                </div>
                <a href="store.html" title="Ø§Ù„Ù…ØªØ¬Ø±"><i class="fa-solid fa-store store"></i></a>
                <a href="login.html" title="Ø­Ø³Ø§Ø¨ÙŠ"><i class="fa-solid fa-user user"></i></a>
            </div>
        </div>
    </div>

    <main class="page-wrap">
        <div class="hero">
            <h1>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h1>
            <p class="sub">Ø±Ø§Ø¬Ø¹ Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</p>
            <button class="back" onclick="location.href='store.html'">â† Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ³ÙˆÙ‚</button>
        </div>

        <div class="cart-grid">
            <section class="glass">
                <div class="items-list" id="itemsList"></div>
            </section>

            <aside class="glass summary">
                <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                <div class="row"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span><span id="subtotal">0.00 Ø¬.Ù…</span></div>
                <div class="row"><span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</span><span id="tax">0.00 Ø¬.Ù…</span></div>
                <hr style="border:0; border-top:1px solid var(--glass-border); margin:10px 0">
                <div class="row"><strong style="font-size:1.3rem">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</strong><span class="total" id="total">0.00 Ø¬.Ù…</span></div>
                <button id="checkoutBtn" class="checkout">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</button>
            </aside>
        </div>
    </main>

    <div id="checkoutModal" class="checkout-modal">
        <div class="checkout-modal-panel">
            <button class="modal-close" onclick="closeCheckoutModal()">âœ•</button>
            <div id="checkoutContent">
                <h2 style="margin:0 0 15px 0">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨</h2>
                <div id="orderPreview" style="background:rgba(0,0,0,0.1); padding:12px; border-radius:10px; margin-bottom:15px; max-height:120px; overflow-y:auto; font-size:0.85rem">
                    <ul id="checkoutItemsList" style="margin:0; padding-right:20px"></ul>
                </div>

                <form id="checkoutForm" onsubmit="event.preventDefault(); processPayment();">
                    <div class="field"><label>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="chkName" required></div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                        <div class="field"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input id="chkEmail" type="email" required></div>
                        <div class="field"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="chkPhone" required></div>
                    </div>
                    
                    <label style="font-weight:700; margin-bottom:8px; display:block">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                    <div class="payment-methods" id="paymentMethodsContainer">
                        <label class="payment-option disabled" title="Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±">
                            <input type="radio" name="payment" value="wallet" disabled>
                            <div class="payment-card"><i class="fas fa-wallet"></i><span>Ù…Ø­ÙØ¸Ø©</span></div>
                        </label>
                        <label class="payment-option disabled" title="Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±">
                            <input type="radio" name="payment" value="card" disabled>
                            <div class="payment-card"><i class="fas fa-credit-card"></i><span>Ø¨Ø·Ø§Ù‚Ø©</span></div>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="payment" value="telegram" checked required>
                            <div class="payment-card"><i class="fab fa-telegram"></i><span>ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</span></div>
                        </label>
                    </div>

                    <div class="field"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="chkNotes" rows="2"></textarea></div>
                    <button type="submit" class="checkout">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
                </form>
            </div>

            <div id="paymentProcessing"><div class="spinner"><i class="fas fa-circle-notch"></i></div><h3>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</h3></div>
            <div id="paymentSuccess"><div style="font-size:3rem; color:#10b981; margin-bottom:10px">âœ“</div><h3>ØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</h3></div>
        </div>
    </div>

    <script src="/js/socket.io.min.js"></script>
    <script src="js/ui-toast.js"></script>
    <script src="/js/theme-manager.js"></script>
    <script>
        const cartUl = document.getElementById('itemsList');
        const subtotalEl = document.getElementById('subtotal');
        const totalEl = document.getElementById('total');
        const checkoutBtn = document.getElementById('checkoutBtn');

        function formatPrice(v){ return Number(v).toFixed(2) + ' Ø¬.Ù…'; }

        async function loadCart(){
            const raw = JSON.parse(localStorage.getItem('cart') || '[]');
            if(!raw.length) {
                cartUl.innerHTML = '<div class="empty"><h3>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</h3></div>';
                updateSummary(0);
                return;
            }

            const enriched = await Promise.all(raw.map(async (it) => {
                if (!it) return it;
                try {
                    const id = it.productId || it.id;
                    if (!id) return it;

                    // Try products API first
                    let res = await fetch(`/api/products/${id}`);
                    if (!res.ok) {
                        // Fallback to courses API
                        res = await fetch(`/api/courses/${id}`);
                    }

                    if (res.ok) {
                        const p = await res.json();
                        return {
                            ...it,
                            title: p.title || p.name || it.title || it.name,
                            price: p.price !== undefined ? p.price : it.price,
                            image: p.image || it.image,
                            qty: it.qty || it.quantity || 1,
                            category: p.category || it.category
                        };
                    }
                } catch (e) {
                    console.error('Error enriching cart item:', e);
                }
                // Final fallback if both APIs fail or throw
                return {
                    ...it,
                    title: it.title || it.name || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    qty: it.qty || it.quantity || 1
                };
            }));

            renderCart(enriched);
        }

        function renderCart(cart){
            cartUl.innerHTML = '';
            let subtotal = 0;
            cart.forEach((it, idx) => {
                subtotal += (it.price||0) * (it.qty||1);
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <img src="${it.image || '/img/placeholder.png'}" alt="">
                    <div class="info">
                        <div class="title">${it.title || it.name || 'Ù…Ù†ØªØ¬'}</div>
                        <div class="meta">${it.category || ''}</div>
                    </div>
                    <div class="controls">
                        <div class="price">${formatPrice(it.price)}</div>
                        <div class="qty">
                            <button onclick="changeQty(${idx}, -1)">-</button>
                            <span>${it.qty || it.quantity || 1}</span>
                            <button onclick="changeQty(${idx}, 1)">+</button>
                        </div>
                        <button class="remove" onclick="removeItem(${idx})">Ø­Ø°Ù</button>
                    </div>
                `;
                cartUl.appendChild(div);
            });
            updateSummary(subtotal);
        }

        function updateSummary(total){
            subtotalEl.textContent = formatPrice(total);
            totalEl.textContent = formatPrice(total);
            checkoutBtn.disabled = total === 0;
        }

        window.changeQty = (idx, delta) => {
            const c = JSON.parse(localStorage.getItem('cart') || '[]');
            if(c[idx]) { 
                const currentQty = c[idx].qty || c[idx].quantity || 1;
                c[idx].qty = Math.max(1, currentQty + delta);
                c[idx].quantity = c[idx].qty;
                localStorage.setItem('cart', JSON.stringify(c)); 
                loadCart(); 
            }
        }
        window.removeItem = (idx) => {
            const c = JSON.parse(localStorage.getItem('cart') || '[]');
            c.splice(idx,1); localStorage.setItem('cart', JSON.stringify(c)); loadCart();
        }

        const modal = document.getElementById('checkoutModal');
        checkoutBtn.onclick = () => {
            modal.classList.add('show');
            const c = JSON.parse(localStorage.getItem('cart') || '[]');
            document.getElementById('checkoutItemsList').innerHTML = c.map(it => `<li>${it.title || it.name} (${it.qty || it.quantity || 1}x)</li>`).join('');
        };
        window.closeCheckoutModal = () => modal.classList.remove('show');

        // Payment method selection feedback
        document.getElementById('paymentMethodsContainer').addEventListener('click', (e) => {
            const option = e.target.closest('.payment-option.disabled');
            if (option) {
                if (window.showToast) {
                    window.showToast('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù….', { type: 'warning', title: 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±' });
                } else {
                    alert('Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø­Ø§Ù„ÙŠØ§Ù‹.');
                }
            }
        });

        async function processPayment(){
            const method = document.querySelector('input[name="payment"]:checked').value;
            const name = document.getElementById('chkName').value;
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');

            document.getElementById('checkoutContent').style.display = 'none';
            document.getElementById('paymentProcessing').style.display = 'block';

            if(method === 'telegram') {
                const text = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù†: ${name}%0AğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${cart.map(i => (i.title || i.name) + '(' + (i.qty || i.quantity || 1) + 'x)').join(', ')}`;
                window.open(`https://t.me/mo_hussien_20?text=${text}`, '_blank');
            }

            await new Promise(r => setTimeout(r, 2000));
            document.getElementById('paymentProcessing').style.display = 'none';
            document.getElementById('paymentSuccess').style.display = 'block';
            setTimeout(() => { localStorage.removeItem('cart'); window.location.href='index.html'; }, 2000);
        }

        loadCart();
    </script>
</body>
</html>